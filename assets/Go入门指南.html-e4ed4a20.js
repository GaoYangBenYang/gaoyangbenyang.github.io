import{_ as i,X as l,Y as u,Z as n,$ as s,a0 as a,a2 as o,a1 as t,E as c}from"./framework-e0039b7c.js";const d="/assets/images/Go入门指南/1.1.designers_of_Go.jpg?raw=true",r="/assets/images/Go入门指南/1.2.Go_logo.jpg?raw=true",k="/assets/images/Go入门指南/1.3.influences_on_go.jpg?raw=true",v="/assets/images/Go入门指南/2.1.gc.jpg?raw=true",m="/assets/images/Go入门指南/2.3.allbasherror.jpg?raw=true",b="/assets/images/Go入门指南/2.3.allbash.jpg?raw=true",g="/assets/images/Go入门指南/3.2.liteide.jpg?raw=true",f="/assets/images/Go入门指南/3.2.goclipse.jpg?raw=true",h="/assets/images/Go入门指南/4.4.2_fig4.1.jpg?raw=true",y="/assets/images/Go入门指南/4.4.2_fig4.2.jpg?raw=true",w="/assets/images/Go入门指南/4.4.2_fig4.3.jpg?raw=true",q="/assets/images/Go入门指南/4.9_fig4.4.jpg?raw=true",_="/assets/images/Go入门指南/4.9_fig4.5.jpg?raw=true",x="/assets/images/Go入门指南/7.1_fig7.1.jpg?raw=true",G="/assets/images/Go入门指南/7.2_fig7.2.jpg?raw=true",P="/assets/images/Go入门指南/7.2_fig7.2.1.jpg?raw=true",S="/assets/images/Go入门指南/7.2_fig7.3.jpg?raw=true",T="/assets/images/Go入门指南/7.6_fig7.4.jpg",C="/assets/images/Go入门指南/image-20200721081402315.jpg",A="/assets/images/Go入门指南/10.1_fig10.1-1.jpg?raw=true",O="/assets/images/Go入门指南/10.1_fig10.1-2.jpg?raw=true",I="/assets/images/Go入门指南/10.1_fig10.2.jpg?raw=true",F="/assets/images/Go入门指南/10.1_fig10.3.jpg?raw=true",N="/assets/images/Go入门指南/10.1_fig10.4.jpg?raw=true",E="/assets/images/Go入门指南/10.6.9_fig10.4.jpg?raw=true",R="/assets/images/Go入门指南/10.7_fig.jpg?raw=true",M="/assets/images/Go入门指南/11.1_fig11.1.jpg?raw=true",L="/assets/images/Go入门指南/14.2_fig14.1.jpg?raw=true",B="/assets/images/Go入门指南/14.2_fig14.2.jpg?raw=true",W={},D=t('<h2 id="前言" tabindex="-1"><a class="header-anchor" href="#前言" aria-hidden="true">#</a> 前言</h2><p>用更少的代码，更短的编译时间，创建运行更快的程序，享受更多的乐趣</p><p>对于学习 Go 编程语言的爱好者来说，这本书无疑是最适合你的一本书籍，这里包含了当前最全面的学习资源。本书通过对官方的在线文档、名人博客、书籍、相关文章以及演讲的资料收集和整理，并结合我自身在软件工程、编程语言和数据库开发的授课经验，将这些零碎的知识点组织成系统化的概念和技术分类来进行讲解。</p><p>随着软件规模的不断扩大，诸多的学者和谷歌的开发者们在公司内部的软件开发过程中开始经历大量的挫折，在诸多问题上都不能给出令人满意的解决方案，尤其是在使用 C++ 来开发大型的服务端软件时，情况更是不容乐观。由于二进制文件一般都是非常巨大的，因此需要耗费大量的时间在编译这些文件上，同时编程语言的设计思想也已经非常陈旧，这些情况都充分证明了现有的编程语言已不符合时下的生产环境。尽管硬件在过去的几十年中有了飞速的发展，但人们依旧没有找到机会去改变 C++ 在软件开发的重要地位，并在实际开发过程中忍受着它所带来的令人头疼的一些问题。因此学者们坐下来总结出了现在生产环境与软件开发之间的主要矛盾，并尝试设计一门全新的编程语言来解决这些问题。</p><p>以下就是他们讨论得出的对编程语言的设计要求：</p><ul><li>能够以更快的速度开发软件</li><li>开发出的软件能够很好地在现代的多核计算机上工作</li><li>开发出的软件能够很好地在网络环境下工作</li><li>使人们能够享受软件开发的过程</li></ul><p>Go 语言就在这样的环境下诞生了，它让人感觉像是 Python 或 Ruby 这样的动态语言，但却又拥有像 C 或者 Java 这类语言的高性能和安全性。</p><p>Go 语言出现的目的是希望在编程领域创造最实用的方式来进行软件开发。它并不是要用奇怪的语法和晦涩难懂的概念来从根本上推翻已有的编程语言，而是建立并改善了 C、Java、C# 中的许多语法风格。它提倡通过接口来针对面向对象编程，通过 goroutine 和 channel 来支持并发和并行编程。</p><p>这本书是为那些想要学习 Go 这门全新的，迷人的和充满希望的编程语言的开发者量身定做的。当然，你在学习 Go 语言之前需要具备一些关于编程的基础知识和经验，并且拥有合适的学习环境，但你并不需要对 C 或者 Java 或其它类似的语言有非常深入的了解。</p><p>对于那些熟悉 C 或者面向对象编程语言的开发者，我们将会在本书中用 Go 和一些编程语言的相关概念进行比较（书中会使用大家所熟知的缩写 “OO” 来表示面向对象）。</p><p>本书将会从最基础的概念讲起，同时也会讨论一些类似在应用 goroutine 和 channel 时有多少种不同的模式，如何在 Go 语言中使用谷歌 API，如何操作内存，如何在 Go 语言中进行程序测试和如何使用模板来开发 Web 应用这些高级概念和技巧。</p><p>在本书的第一部分，我们将会讨论 Go 语言的起源（第 1 章），以及如何安装 Go 语言（第 2 章）和开发环境（第 3 章）。</p><p>在本书的第二部分，我们将会带领你贯穿 Go 语言的核心思想，譬如简单与复杂类型（第 4、7、8 章），控制结构（第 5 章），函数（第 6 章），结构与方法（第 10 章）和接口（第 11 章）。我们会对 Go 语言的函数式和面向对象编程进行透彻的讲解，包括如何使用 Go 语言来构造大型项目（第 9 章）。</p><p>在本书的第三部分，你将会学习到如何处理不同格式的文件（第 12 章）和如何在 Go 语言中巧妙地使用错误处理机制（第 13 章）。然后我们会对 Go 语言中最值得称赞的设计 goroutine 和 channel 进行并发和多核应用的基本技巧的讲解（第 14 章）。最后，我们会讨论如何将 Go 语言应用到分布式和 Web 应用中的相关网络技巧（第 15 章）。</p><p>我们会在本书的第四部分向你展示许多 Go 语言的开发模式和一些编码规范，以及一些非常有用的代码片段（第 18 章）。在前面章节完成对所有的 Go 语言技巧的学习之后，你将会学习如何构造一个完整 Go 语言项目（第 19 章），然后我们会介绍一些关于 Go 语言在云（Google App Engine）方面的应用（第 20 章）。在本书的最后一章（第 21 章），我们会讨论一些在全世界范围内已经将 Go 语言投入实际开发的公司和组织。本书将会在最后给出一些对 Go 语言爱好者的引用，Go 相关包和工具的参考，以及章节练习的答案和所有参考资源和文献的清单。</p><p>Go 语言有一个被称之为 “没有废物” 的宗旨，就是将一切没有必要的东西都去掉，不能去掉的就无底线地简化，同时追求最大程度的自动化。他完美地诠释了敏捷编程的 KISS 秘诀：短小精悍！</p><p>Go 语言通过改善或去除在 C、C++ 或 Java 中的一些所谓“开放”特性来让开发者们的工作更加便利。这里只举例其中的几个，比如对于变量的默认初始化，内存分配与自动回收，以及更简洁却不失健壮的控制结构。同时我们也会发现 Go 语言旨在减少不必要的编码工作，这使得 Go 语言的代码更加简洁，从而比传统的面向对象语言更容易阅读和理解。</p><p>与 C++ 或 Java 这些有着庞大体系的语言相比，Go 语言简洁到可以将它整个的装入你的大脑中，而且比学习 Scala（Java 的并发语言）有更低的门槛，真可谓是 21 世纪的 C 语言！</p><p>作为一门系统编程语言，你不应该为 Go 语言的大多数代码示例和练习都和控制台有着密不可分的关系而感到惊奇，因为提供平台依赖性的 GUI（用户界面）框架并不是一个简单的任务。有许多由第三方发起的 GUI 框架项目正在如火如荼地进行中，或许我们会在不久的将来看到一些可用的 Go 语言 GUI 框架。不过现阶段的 Go 语言已经提供了大量有关 Web 方面的功能，我们可以通过它强大的 http 和 template 包来达到 Web 应用的 GUI 实现。</p><p>我们会经常涉及到一些关于 Go 语言的编码规范，了解和使用这些已经被广泛认同的规范应该是你学习阶段最重要的实践。我会在书中尽量使用已经讲解的概念或者技巧来解释相关的代码示例，以避免你在不了解某些高级概念的情况下而感到迷茫。</p><p>我们通过 227 个完整的代码示例和书中的解释说明来对所有涉及到的概念和技巧进行彻底的讲解，你可以下载这些代码到你的电脑上运行，从而加深对概念的理解。</p><p>本书会尽可能地将前后章节的内容联系起来，当然这也同时要求你通过学习不同的知识来对一个问题提出尽可能多的解决方案。记住，学习一门新语言的最佳方式就是实践，运行它的代码，修改并尝试更多的方案。因此，你绝对不可以忽略书中的 130 个代码练习，这将对你学习好 Go 语言有很大的帮助。比如，我们就为斐波那契算法提供了 13 个不同的版本，而这些版本都使用了不同的概念和技巧。</p>',22),U={href:"https://sites.google.com/site/thewaytogo2012/",target:"_blank",rel:"noopener noreferrer"},j=t('<p>为了让你在成为 Go 语言大师的道路上更加顺利，我们会专注于一些特别的章节以提供 Go 语言开发模式的最佳实践，同时也会帮助初学者逃离一些语言的陷阱。第 18 章可以作为你在开发时的一个参考手册，因为当中包含了众多的有价值的代码片段以及相关的解释说明。</p><p>最后要说明的是，你可以通过完整的索引来快速定位你需要阅读的章节。书中所有的代码都在 Go1.4 版本下测试通过。</p><p>这里有一段来自在 C++、Java 和 Python 领域众所周知的专家 Bruce Eckel 的评论：</p><p>“作为一个有着 C/C++ 背景的开发者，我在使用 Go 语言时仿佛呼吸到了新鲜空气一般，令人心旷神怡。我认为使用 Go 语言进行系统编程开发比使用 C++ 有着更显著的优势，因为它在解决一些很难用 C++ 解决的问题的同时，让我的工作变得更加高效。我并不是说 C++ 的存在是一个错误，相反地，我认为这是历史发展的必然结果。当我深陷在 C 语言这门略微比汇编语言好一点的泥潭时，我坚信任何语言的构造都不可能支持大型项目的开发。像垃圾回收或并发语言支持这类东西，在当时都是极其荒谬的主意，根本没有人在乎。C++ 向大型项目开发迈出了重要的第一步，带领我们走进这个广袤无垠的世界。很庆幸 Stroustrup 做了让 C++ 兼容 C 语言以能够让其编译 C 程序这个正确的决定。我们当时需要 C++ 的出现。”</p><p>“之后我们学到了更多。我们毫无疑问地接受了垃圾回收，异常处理和虚拟机这些当年人们认为只有疯子才会想的东西。C++ 的复杂程度（新版的 C++ 甚至更加复杂）极大的影响了软件开发的高效性，这使得它再也不再适合这个时代。人们不再像过往那样认同在 C++ 中兼容使用 C 语言的方法，认为这些工作只是在浪费时间，牺牲人们的努力。就在此时，Go 语言已经成功地解决了 C++ 中那些本打算解决却未能解决的关键问题。”</p><p>我非常想要向发明这门精湛的语言的 Go 开发团队表示真挚的感谢，尤其是团队的领导者 Rob Pike、Russ Cox 和 Andrew Gerrand，他们阐述的例子和说明都非常的完美。同时，我还要感谢 Miek Gieben、Frank Muller、Ryanne Dolan 和 Satish V.J. 给予我巨大的帮助，还有那些 golang-nuts 邮件列表里的所有的成员。</p><p>欢迎来到 Go 语言开发的奇妙世界！</p><h2 id="第-1-章-go-语言的起源与发展" tabindex="-1"><a class="header-anchor" href="#第-1-章-go-语言的起源与发展" aria-hidden="true">#</a> 第 1 章：Go 语言的起源与发展</h2><h3 id="_1-1-起源与发展" tabindex="-1"><a class="header-anchor" href="#_1-1-起源与发展" aria-hidden="true">#</a> 1.1 起源与发展</h3><p>Go 语言起源 2007 年，并于 2009 年正式对外发布。它从 2009 年 9 月 21 日开始作为谷歌公司 20% 兼职项目，即相关员工利用 20% 的空余时间来参与 Go 语言的研发工作。该项目的三位领导者均是著名的 IT 工程师：Robert Griesemer，参与开发 Java HotSpot 虚拟机；Rob Pike，Go 语言项目总负责人，贝尔实验室 Unix 团队成员，参与的项目包括 Plan 9，Inferno 操作系统和 Limbo 编程语言；Ken Thompson，贝尔实验室 Unix 团队成员，C 语言、Unix 和 Plan 9 的创始人之一，与 Rob Pike 共同开发了 UTF-8 字符集规范。自 2008 年 1 月起，Ken Thompson 就开始研发一款以 C 语言为目标结果的编译器来拓展 Go 语言的设计思想。</p><p><strong>这是一个由计算机领域 “发明之父” 所组成的黄金团队，他们对系统编程语言，操作系统和并行都有着非常深刻的见解</strong></p><figure><img src="'+d+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>',12),V=n("p",null,"在 2008 年年中，Go 语言的设计工作接近尾声，一些员工开始以全职工作状态投入到这个项目的编译器和运行实现上。Ian Lance Taylor 也加入到了开发团队中，并于 2008 年 5 月创建了一个 gcc 前端。",-1),H=n("p",null,"Russ Cox 加入开发团队后着手语言和类库方面的开发，也就是 Go 语言的标准包。在 2009 年 10 月 30 日，Rob Pike 以 Google Techtalk 的形式第一次向人们宣告了 Go 语言的存在。",-1),z=n("p",null,"直到 2009 年 11 月 10 日，开发团队将 Go 语言项目以 BSD-style 授权（完全开源）正式公布了 Linux 和 Mac OS X 平台上的版本。Hector Chu 于同年 11 月 22 日公布了 Windows 版本。",-1),J={href:"http://www.ohloh.net",target:"_blank",rel:"noopener noreferrer"},X={href:"http://www.tiobe.com",target:"_blank",rel:"noopener noreferrer"},K=n("p",null,"时间轴：",-1),$=n("ul",null,[n("li",null,"2007 年 9 月 21 日：雏形设计"),n("li",null,"2009 年 11 月 10日：首次公开发布"),n("li",null,"2010 年 1 月 8 日：当选 2009 年年度语言"),n("li",null,"2010 年 5 月：谷歌投入使用"),n("li",null,"2011 年 5 月 5 日：Google App Engine 支持 Go 语言")],-1),Y=n("p",null,"从 2010 年 5 月起，谷歌开始将 Go 语言投入到后端基础设施的实际开发中，例如开发用于管理后端复杂环境的项目。有句话叫 “吃你自己的狗食”，这也体现了谷歌确实想要投资这门语言，并认为它是有生产价值的。",-1),Z={href:"http://golang.org",target:"_blank",rel:"noopener noreferrer"},Q={href:"https://github.com/golang/go",target:"_blank",rel:"noopener noreferrer"},nn={href:"https://github.com/golang/go/issues",target:"_blank",rel:"noopener noreferrer"},sn=n("p",null,"Go 通过以下的 Logo 来展示它的速度，并以囊地鼠 (Gopher) 作为它的吉祥物。",-1),an=n("figure",null,[n("img",{src:r,alt:"",tabindex:"0",loading:"lazy"}),n("figcaption")],-1),en={href:"http://groups.google.com/group/golang-nuts/",target:"_blank",rel:"noopener noreferrer"},tn={href:"https://groups.google.com/forum/#!forum/google-appengine-go",target:"_blank",rel:"noopener noreferrer"},pn={href:"http://go-lang.cat-v.org/",target:"_blank",rel:"noopener noreferrer"},on={href:"http://irc.freenode.net",target:"_blank",rel:"noopener noreferrer"},cn={href:"https://twitter.com/golang",target:"_blank",rel:"noopener noreferrer"},ln={href:"http://www.linkedin.com/groups?gid=2524765&trk=myg_ugrp_ovr",target:"_blank",rel:"noopener noreferrer"},un={href:"http://en.wikipedia.org/wiki/Go_(programming_language)",target:"_blank",rel:"noopener noreferrer"},dn={href:"https://gowalker.org",target:"_blank",rel:"noopener noreferrer"},rn={href:"http://tour.golang.org/",target:"_blank",rel:"noopener noreferrer"},kn=n("code",null,"go install go-tour.googlecode.com/hg/gotour",-1),vn={href:"https://tour.go-zh.org/welcome/1",target:"_blank",rel:"noopener noreferrer"},mn=n("code",null,"go install https://bitbucket.org/mikespook/go-tour-zh/gotour",-1),bn=t('<h3 id="_1-2-语言的主要特性与发展的环境和影响因素" tabindex="-1"><a class="header-anchor" href="#_1-2-语言的主要特性与发展的环境和影响因素" aria-hidden="true">#</a> 1.2 语言的主要特性与发展的环境和影响因素</h3><h4 id="_1-2-1-影响-go-语言发展的早期编程语言" tabindex="-1"><a class="header-anchor" href="#_1-2-1-影响-go-语言发展的早期编程语言" aria-hidden="true">#</a> 1.2.1 影响 Go 语言发展的早期编程语言</h4><p>正如 “21 世纪的 C 语言” 这句话所说，Go 语言并不是凭空而造的，而是和 C++、Java 和 C# 一样属于 C 系。不仅如此，设计者们还汲取了其它编程语言的精粹部分融入到 Go 语言当中。</p><p>在声明和包的设计方面，Go 语言受到 Pascal、Modula 和 Oberon 系语言的影响；在并发原理的设计上，Go 语言从同样受到 Tony Hoare 的 CSP（通信序列进程 <em>Communicating Sequential Processes</em>）理论影响的 Limbo 和 Newsqueak 的实践中借鉴了一些经验，并使用了和 Erlang 类似的机制。</p><p>这是一门完全开源的编程语言，因为它使用 BSD 授权许可，所以任何人都可以进行商业软件的开发而不需要支付任何费用。</p><p>尽管为了能够让目前主流的开发者们能够对 Go 语言中的类 C 语言的语法感到非常亲切而易于转型，但是它在极大程度上简化了这些语法，使得它们比 C/C++ 的语法更加简洁和干净。同时，Go 语言也拥有一些动态语言的特性，这使得使用 Python 和 Ruby 的开发者们在使用 Go 语言的时候感觉非常容易上手。</p><p>下图展示了一些其它编程语言对 Go 语言的影响：</p><figure><img src="'+k+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>图 1.3 其它编程语言对 Go 语言的影响</p><h4 id="_1-2-2-为什么要创造一门编程语言" tabindex="-1"><a class="header-anchor" href="#_1-2-2-为什么要创造一门编程语言" aria-hidden="true">#</a> 1.2.2 为什么要创造一门编程语言</h4><ul><li>C/C++ 的发展速度无法跟上计算机发展的脚步，十多年来也没有出现一门与时代相符的主流系统编程语言，因此人们需要一门新的系统编程语言来弥补这个空缺，尤其是在计算机信息时代。</li><li>相比计算机性能的提升，软件开发领域不被认为发展得足够快或者比硬件发展得更加成功（有许多项目均以失败告终），同时应用程序的体积始终在不断地扩大，这就迫切地需要一门具备更高层次概念的低级语言来突破现状。</li><li>在 Go 语言出现之前，开发者们总是面临非常艰难的抉择，究竟是使用执行速度快但是编译速度并不理想的语言（如：C++），还是使用编译速度较快但执行效率不佳的语言（如：.NET、Java），或者说开发难度较低但执行速度一般的动态语言呢？显然，Go 语言在这 3 个条件之间做到了最佳的平衡：快速编译，高效执行，易于开发。</li></ul><h4 id="_1-2-3-go-语言的发展目标" tabindex="-1"><a class="header-anchor" href="#_1-2-3-go-语言的发展目标" aria-hidden="true">#</a> 1.2.3 Go 语言的发展目标</h4><p>Go 语言的主要目标是将静态语言的安全性和高效性与动态语言的易开发性进行有机结合，达到完美平衡，从而使编程变得更加有乐趣，而不是在艰难抉择中痛苦前行。</p><p>因此，Go 语言是一门类型安全和内存安全的编程语言。虽然 Go 语言中仍有指针的存在，但并不允许进行指针运算。</p><p>Go 语言的另一个目标是对于网络通信、并发和并行编程的极佳支持，从而更好地利用大量的分布式和多核的计算机，这一点对于谷歌内部的使用来说就非常重要了。设计者通过 goroutine 这种轻量级线程的概念来实现这个目标，然后通过 channel 来实现各个 goroutine 之间的通信。他们实现了分段栈增长和 goroutine 在线程基础上多路复用技术的自动化。</p><p>这个特性显然是 Go 语言最强有力的部分，不仅支持了日益重要的多核与多处理器计算机，也弥补了现存编程语言在这方面所存在的不足。</p><p>Go 语言中另一个非常重要的特性就是它的构建速度（编译和链接到机器代码的速度），一般情况下构建一个程序的时间只需要数百毫秒到几秒。作为大量使用 C++ 来构建基础设施的谷歌来说，无疑从根本上摆脱了 C++ 在构建速度上非常不理想的噩梦。这不仅极大地提升了开发者的生产力，同时也使得软件开发过程中的代码测试环节更加紧凑，而不必浪费大量的时间在等待程序的构建上。</p><p>依赖管理是现今软件开发的一个重要组成部分，但是 C 语言中“头文件”的概念却导致越来越多因为依赖关系而使得构建一个大型的项目需要长达几个小时的时间。人们越来越需要一门具有严格的、简洁的依赖关系分析系统从而能够快速编译的编程语言。这正是 Go 语言采用包模型的根本原因，这个模型通过严格的依赖关系检查机制来加快程序构建的速度，提供了非常好的可量测性。</p><p>整个 Go 语言标准库的编译时间一般都在 20 秒以内，其它的常规项目也只需要半秒钟的时间来完成编译工作。这种闪电般的编译速度甚至比编译 C 语言或者 Fortran 更加快，使得编译这一环节不再成为在软件开发中困扰开发人员的问题。在这之前，动态语言将快速编译作为自身的一大亮点，像 C++ 那样的静态语言一般都有非常漫长的编译和链接工作。而同样作为静态语言的 Go 语言，通过自身优良的构建机制，成功地去除了这个弊端，使得程序的构建过程变得微不足道，拥有了像脚本语言和动态语言那样的高效开发的能力。</p><p>另外，Go 语言在执行速度方面也可以与 C/C++ 相提并论。</p><p>由于内存问题（通常称为内存泄漏）长期以来一直伴随着 C++ 的开发者们，Go 语言的设计者们认为内存管理不应该是开发人员所需要考虑的问题。因此尽管 Go 语言像其它静态语言一样执行本地代码，但它依旧运行在某种意义上的虚拟机，以此来实现高效快速的垃圾回收（使用了一个简单的标记-清除算法）。</p><p>尽管垃圾回收并不容易实现，但考虑这将是未来并发应用程序发展的一个重要组成部分，Go 语言的设计者们还是完成了这项艰难的任务。</p><p>Go 语言还能够在运行时进行反射相关的操作。</p><p>使用 <code>go install</code> 能够很轻松地对第三方包进行部署。</p><p>此外，Go 语言还支持调用由 C 语言编写的海量库文件（<a href="">第 3.9 节</a>），从而能够将过去开发的软件进行快速迁移。</p><h4 id="_1-2-4-指导设计原则" tabindex="-1"><a class="header-anchor" href="#_1-2-4-指导设计原则" aria-hidden="true">#</a> 1.2.4 指导设计原则</h4><p>Go语言通过减少关键字的数量（25 个）来简化编码过程中的混乱和复杂度。干净、整齐和简洁的语法也能够提高程序的编译速度，因为这些关键字在编译过程中少到甚至不需要符号表来协助解析。</p><p>这些方面的工作都是为了减少编码的工作量，甚至可以与 Java 的简化程度相比较。</p><p>Go 语言有一种极简抽象艺术家的感觉，因为它只提供了一到两种方法来解决某个问题，这使得开发者们的代码都非常容易阅读和理解。众所周知，代码的可读性是软件工程里最重要的一部分（ <strong>译者注：代码是写给人看的，不是写给机器看的</strong> ）。</p><p>这些设计理念没有建立其它概念之上，所以并不会因为牵扯到一些概念而将某个概念复杂化，他们之间是相互独立的。</p>',30),gn={href:"http://golang.org/doc/go_spec.html",target:"_blank",rel:"noopener noreferrer"},fn=n("p",null,[s("它不像 Ruby 那样通过实现过程来定义编码规范。作为一门具有明确编码规范的语言，它要求可以采用不同的编译器如 gc 和 gccgo（"),n("a",{href:""},"第 2.1 节"),s("）进行编译工作，这对语言本身拥有更好的编码规范起到很大帮助。")],-1),hn={href:"http://en.wikipedia.org/wiki/LALR_parser",target:"_blank",rel:"noopener noreferrer"},yn={href:"https://github.com/golang/go/blob/master/src%2Fcmd%2Finternal%2Fgc%2Fgo.y",target:"_blank",rel:"noopener noreferrer"},wn=n("code",null,"src/cmd/internal/gc/go.y",-1),qn=t('<h4 id="_1-2-5-语言的特性" tabindex="-1"><a class="header-anchor" href="#_1-2-5-语言的特性" aria-hidden="true">#</a> 1.2.5 语言的特性</h4><p>Go 语言从本质上（程序和结构方面）来实现并发编程。</p><p>因为 Go 语言没有类和继承的概念，所以它和 Java 或 C++ 看起来并不相同。但是它通过接口 (interface) 的概念来实现多态性。Go 语言有一个清晰易懂的轻量级类型系统，在类型之间也没有层级之说。因此可以说这是一门混合型的语言。</p><p>在传统的面向对象语言中，使用面向对象编程技术显得非常臃肿，它们总是通过复杂的模式来构建庞大的类型层级，这违背了编程语言应该提升生产力的宗旨。</p><p>函数是 Go 语言中的基本构件，它们的使用方法非常灵活。在<a href="">第六章</a>，我们会看到 Go 语言在函数式编程方面的基本概念。</p><p>Go 语言使用静态类型，所以它是类型安全的一门语言，加上通过构建到本地代码，程序的执行速度也非常快。</p><p>作为强类型语言，隐式的类型转换是不被允许的，记住一条原则：让所有的东西都是显式的。</p><p>Go 语言其实也有一些动态语言的特性（通过关键字 <code>var</code>），所以它对那些逃离 Java 和 .Net 世界而使用 Python、Ruby、PHP 和 JavaScript 的开发者们也具有很大的吸引力。</p><p>Go 语言支持交叉编译，比如说你可以在运行 Linux 系统的计算机上开发运行 Windows 下运行的应用程序。这是第一门完全支持 UTF-8 的编程语言，这不仅体现在它可以处理使用 UTF-8 编码的字符串，就连它的源码文件格式都是使用的 UTF-8 编码。Go 语言做到了真正的国际化！</p><h4 id="_1-2-6-语言的用途" tabindex="-1"><a class="header-anchor" href="#_1-2-6-语言的用途" aria-hidden="true">#</a> 1.2.6 语言的用途</h4><p>Go 语言被设计成一门应用于搭载 Web 服务器，存储集群或类似用途的巨型中央服务器的系统编程语言。对于高性能分布式系统领域而言，Go 语言无疑比大多数其它语言有着更高的开发效率。它提供了海量并行的支持，这对于游戏服务端的开发而言是再好不过了。</p>',11),_n={href:"http://en.wikipedia.org/wiki/Complex_event_processing",target:"_blank",rel:"noopener noreferrer"},xn=n("p",null,"但是 Go 语言同时也是一门可以用于实现一般目标的语言，例如对于文本的处理，前端展现，甚至像使用脚本一样使用它。",-1),Gn=n("p",null,"值得注意的是，因为垃圾回收和自动内存分配的原因，Go 语言不适合用来开发对实时性要求很高的软件。",-1),Pn=n("p",null,"越来越多的谷歌内部的大型分布式应用程序都开始使用 Go 语言来开发，例如谷歌地球的一部分代码就是由 Go 语言完成的。",-1),Sn={href:"http://go-lang.cat-v.org/organizations-using-go",target:"_blank",rel:"noopener noreferrer"},Tn=n("a",{href:""},"第 21 章",-1),Cn=t('<p>在 Chrome 浏览器中内置了一款 Go 语言的编译器用于本地客户端 (NaCl)，这很可能会被用于在 Chrome OS 中执行 Go 语言开发的应用程序。</p><p>Go 语言可以在 Intel 或 ARM 处理器上运行，因此它也可以在安卓系统下运行，例如 Nexus 系列的产品。</p><p>在 Google App Engine 中使用 Go 语言：2011 年 5 月 5 日，官方发布了用于开发运行在 Google App Engine 上的 Web 应用的 Go SDK，在此之前，开发者们只能选择使用 Python 或者 Java。这主要是 David Symonds 和 Nigel Tao 努力的成果。目前最新的稳定版是基于 Go 1.4 的 SDK 1.9.18，于 2015 年 2 月 18 日发布。当前 Go 语言的稳定版本是 Go 1.4.2。</p><h4 id="_1-2-7-关于特性缺失" tabindex="-1"><a class="header-anchor" href="#_1-2-7-关于特性缺失" aria-hidden="true">#</a> 1.2.7 关于特性缺失</h4><p>许多能够在大多数面向对象语言中使用的特性 Go 语言都没有支持，但其中的一部分可能会在未来被支持。</p><ul><li>为了简化设计，不支持函数重载和操作符重载</li><li>为了避免在 C/C++ 开发中的一些 Bug 和混乱，不支持隐式转换</li><li>Go 语言通过另一种途径实现面向对象设计（第 <a href="">10</a>-<a href="">11</a> 章）来放弃类和类型的继承</li><li>尽管在接口的使用方面（<a href="">第 11 章</a>）可以实现类似变体类型的功能，但本身不支持变体类型</li><li>不支持动态加载代码</li><li>不支持动态链接库</li><li>不支持泛型</li><li>通过 <code>recover()</code> 和 <code>panic()</code> 来替代异常机制（第 <a href="">13.2</a>-<a href="">13.3</a> 节）</li><li>不支持静态变量</li></ul>',6),An={href:"http://golang.org/doc/go_faq.html",target:"_blank",rel:"noopener noreferrer"},On=t('<h4 id="_1-2-8-使用-go-语言编程" tabindex="-1"><a class="header-anchor" href="#_1-2-8-使用-go-语言编程" aria-hidden="true">#</a> 1.2.8 使用 Go 语言编程</h4><p>如果你有其它语言的编程经历（面向对象编程语言，如：Java、C#、Object-C、Python、Ruby），在你进入到 Go 语言的世界之后，你将会像迷恋你的 X 语言一样无法自拔。Go 语言使用了与其它语言不同的设计模式，所以当你尝试将你的X语言的代码迁移到 Go 语言时，你将会非常失望，所以你需要从头开始，用 Go 的理念来思考。</p><p>如果你在至高点使用 Go 的理念来重新审视和分析一个问题，你通常会找到一个适用于 Go 语言的优雅的解决方案。</p><h4 id="_1-2-9-小结" tabindex="-1"><a class="header-anchor" href="#_1-2-9-小结" aria-hidden="true">#</a> 1.2.9 小结</h4><p>这里列举一些 Go 语言的必杀技：</p><ul><li>简化问题，易于学习</li><li>内存管理，简洁语法，易于使用</li><li>快速编译，高效开发</li><li>高效执行</li><li>并发支持，轻松驾驭</li><li>静态类型</li><li>标准类库，规范统一</li><li>易于部署</li><li>文档全面</li><li>免费开源</li></ul><h2 id="第-2-章-安装与运行环境" tabindex="-1"><a class="header-anchor" href="#第-2-章-安装与运行环境" aria-hidden="true">#</a> 第 2 章：安装与运行环境</h2><h3 id="_2-1-平台与架构" tabindex="-1"><a class="header-anchor" href="#_2-1-平台与架构" aria-hidden="true">#</a> 2.1 平台与架构</h3><p>Go 语言开发团队开发了适用于以下操作系统的编译器：</p><ul><li>Linux</li><li>FreeBSD</li><li>Mac OS X（也称为 Darwin）</li></ul><p>目前有2个版本的编译器：Go 原生编译器 gc 和非原生编译器 gccgo，这两款编译器都是在类 Unix 系统下工作 。其中，gc 版本的编译器已经被移植到 Windows 平台上，并集成在主要发行版中，你也可以通过安装 MinGW 从而在 Windows 平台下使用 gcc 编译器。这两个编译器都是以单通道的形式工作。</p><p>你可以获取以下平台上的 Go 1.4 源码和二进制文件：</p><ul><li>Linux 2.6+：amd64、386 和 arm 架构</li><li>Mac OS X (Snow Leopard + Lion) ：amd64 和 386 架构</li><li>Windows 2000+：amd64 和 386 架构</li></ul><p>对于非常底层的纯 Go 语言代码或者包而言，在各个操作系统平台上的可移植性是非常强的，只需要将源码拷贝到相应平台上进行编译即可，或者可以使用交叉编译来构建目标平台的应用程序（<a href="">第 2.2 节</a>）。但如果你打算使用 cgo 或者类似文件监控系统的软件，就需要根据实际情况进行相应地修改了。</p>',14),In=n("p",null,"Go 原生编译器 gc：",-1),Fn=n("p",null,"主要基于 Ken Thompson 先前在 Plan 9 操作系统上使用的 C 工具链。",-1),Nn=n("p",null,[s("Go 语言的编译器和链接器都是使用 C 语言编写并产生本地代码，Go 不存在自我引导之类的功能。因此如果使用一个有不同指令集的编译器来构建 Go 程序，就需要针对操作系统和处理器架构（32 位操作系统或 64 位操作系统）进行区别对待。（ "),n("strong",null,"译者注：Go从1.5版本开始已经实现自举。Go语言的编译器和链接器都是Go语言编写的"),s("）")],-1),En=n("p",null,"这款编译器使用非分代、无压缩和并行的方式进行编译，它的编译速度要比 gccgo 更快，产生更好的本地代码，但编译后的程序不能够使用 gcc 进行链接。",-1),Rn=n("p",null,"编译器目前支持以下基于 Intel 或 AMD 处理器架构的程序构建。",-1),Mn=n("figure",null,[n("img",{src:v,alt:"",tabindex:"0",loading:"lazy"}),n("figcaption")],-1),Ln=t(`<p>当你第一次看到这套命名系统的时候你会觉得很奇葩，不过这些命名都是来自于 Plan 9 项目。</p><pre><code> g = 编译器：将源代码编译为项目代码（程序文本）
 l = 链接器：将项目代码链接到可执行的二进制文件（机器代码）
</code></pre><p>（相关的 C 编译器名称为 6c、8c 和 5c，相关的汇编器名称为 6a、8a 和 5a）</p><p><strong>标记 (Flags)</strong> 是指可以通过命令行设置可选参数来影响编译器或链接器的构建过程或得到一个特殊的目标结果。</p><p>可用的编译器标记如下：</p><pre><code> flags:
 -I 针对包的目录搜索
 -d 打印声明信息
 -e 不限制错误打印的个数
 -f 打印栈结构
 -h 发生错误时进入恐慌（panic）状态
 -o 指定输出文件名 // 详见第3.4节
 -S 打印产生的汇编代码
 -V 打印编译器版本 // 详见第2.3节
 -u 禁止使用 unsafe 包中的代码
 -w 打印归类后的语法解析树
 -x 打印 lex tokens
</code></pre><p>从 Go 1.0.3 版本开始，不再使用 <code>8g</code>，<code>8l</code> 之类的指令进行程序的构建，取而代之的是统一的 <code>go build</code> 和 <code>go install</code> 等命令，而这些指令会自动调用相关的编译器或链接器。</p>`,7),Bn={href:"https://github.com/golang/go/tree/master/src/cmd",target:"_blank",rel:"noopener noreferrer"},Wn=n("code",null,"$GOROOT/src/cmd",-1),Dn={href:"https://github.com/golang/go/blob/master/src%2Fcmd%2Finternal%2Fgc%2Fgo.y",target:"_blank",rel:"noopener noreferrer"},Un=n("code",null,"$GOROOT/src/cmd/gc/go.y",-1),jn=n("code",null,"y.tab.{c,h}",-1),Vn={href:"https://github.com/golang/go/blob/master/src/make.bash",target:"_blank",rel:"noopener noreferrer"},Hn=n("code",null,"$GOROOT/src/make.bash",-1),zn=n("p",null,[s("大部分的目录都包含了名为 "),n("code",null,"doc.go"),s(" 的文件，这个文件提供了更多详细的信息。")],-1),Jn=t('<li><p>gccgo 编译器：</p><p>一款相对于 gc 而言更加传统的编译器，使用 GCC 作为后端。GCC 是一款非常流行的 GNU 编译器，它能够构建基于众多处理器架构的应用程序。编译速度相对 gc 较慢，但产生的本地代码运行要稍微快一点。它同时也提供一些与 C 语言之间的互操作性。</p><p>从 Go 1 版本开始，gc 和 gccgo 在编译方面都有等价的功能。</p></li><li><p>文件扩展名与包 (package)：</p><p>Go 语言源文件的扩展名很显然就是 <code>.go</code>。</p><p>C 文件使用后缀名 <code>.c</code>，汇编文件使用后缀名 <code>.s</code>。所有的源代码文件都是通过包 (packages) 来组织。包含可执行代码的包文件在被压缩后使用扩展名 <code>.a</code>（AR 文档）。</p><p>Go 语言的标准库（<a href="">第 9.1 节</a>）包文件在被安装后就是使用这种格式的文件。</p><p><strong>注意</strong> 当你在创建目录时，文件夹名称永远不应该包含空格，而应该使用下划线 &quot;_&quot; 或者其它一般符号代替。</p></li>',2),Xn=t('<h3 id="_2-2-go-环境变量" tabindex="-1"><a class="header-anchor" href="#_2-2-go-环境变量" aria-hidden="true">#</a> 2.2 Go 环境变量</h3><p>Go 开发环境依赖于一些操作系统环境变量，你最好在安装 Go 之前就已经设置好他们。如果你使用的是 Windows 的话，你完全不用进行手动设置，Go 将被默认安装在目录 <code>c:/go</code> 下。这里列举几个最为重要的环境变量：</p><ul><li><strong>$GOROOT</strong> 表示 Go 在你的电脑上的安装位置，它的值一般都是 <code>HOME/go</code>，当然，你也可以安装在别的地方。</li><li><strong>$GOARCH</strong> 表示目标机器的处理器架构，它的值可以是 386、amd64 或 arm。</li><li><strong>$GOOS</strong> 表示目标机器的操作系统，它的值可以是 darwin、freebsd、linux 或 windows。</li><li><strong>$GOBIN</strong> 表示编译器和链接器的安装位置，默认是<code>GOROOT/bin</code>，如果你使用的是 Go 1.0.3 及以后的版本，一般情况下你可以将它的值设置为空，Go 将会使用前面提到的默认值。</li></ul><p>目标机器是指你打算运行你的 Go 应用程序的机器。</p><p>Go 编译器支持交叉编译，也就是说你可以在一台机器上构建能够在不同操作系统和处理器架构上运行的应用程序，也就是说编写源代码的机器可以和目标机器有完全不同的特性（操作系统与处理器架构）。</p><p>为了区分本地机器和目标机器，你可以使用 <code>$GOHOSTOS</code> 和 <code>$GOHOSTARCH</code> 设置本地机器的操作系统名称和编译体系结构，这两个变量只有在进行交叉编译的时候才会用到，如果你不进行显示设置，他们的值会和本地机器（<code>$GOOS</code> 和 <code>$GOARCH</code>）一样。</p><ul><li><strong>$GOPATH</strong> 默认采用和 <code>GOROOT</code> 一样的值，但从 Go 1.1 版本开始，你必须修改为其它路径。它可以包含多个 Go 语言源码文件、包文件和可执行文件的路径，而这些路径下又必须分别包含三个规定的目录：<code>src</code>、<code>pkg</code> 和 <code>bin</code>，这三个目录分别用于存放源码文件、包文件和可执行文件。</li><li><strong>$GOARM</strong> 专门针对基于 arm 架构的处理器，它的值可以是 5 或 6，默认为 6。</li><li><strong>$GOMAXPROCS</strong> 用于设置应用程序可使用的处理器个数与核数，详见 <a href="">第 14.1.3 节</a>。</li></ul>',7),Kn={href:"http://go-lang.cat-v.org/os-ports",target:"_blank",rel:"noopener noreferrer"},$n=n("h3",{id:"_2-3-在-linux-上安装-go",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_2-3-在-linux-上安装-go","aria-hidden":"true"},"#"),s(" 2.3 在 Linux 上安装 Go")],-1),Yn={href:"http://golang.org/doc/install",target:"_blank",rel:"noopener noreferrer"},Zn=n("p",null,"我们接下来也会带你一步步地完成安装过程。",-1),Qn=t(`<li><p>设置 Go 环境变量</p><p>我们在 Linux 系统下一般通过文件 <code>$HOME/.bashrc</code> 配置自定义环境变量，根据不同的发行版也可能是文件 <code>$HOME/.profile</code>，然后使用 gedit 或 vi 来编辑文件内容。</p><pre><code> export GOROOT=$HOME/go
</code></pre><p>为了确保相关文件在文件系统的任何地方都能被调用，你还需要添加以下内容：</p><pre><code> export PATH=$PATH:$GOROOT/bin
</code></pre><p>在开发 Go 项目时，你还需要一个环境变量来保存你的工作目录。</p><pre><code> export GOPATH=$HOME/Applications/Go
</code></pre><p><code>$GOPATH</code> 可以包含多个工作目录，取决于你的个人情况。如果你设置了多个工作目录，那么当你在之后使用 <code>go get</code>（远程包安装命令）时远程包将会被安装在第一个目录下。</p><p>在完成这些设置后，你需要在终端输入指令 <code>source .bashrc</code> 以使这些环境变量生效。然后重启终端，输入 <code>go env</code> 和 <code>env</code> 来检查环境变量是否设置正确。</p></li><li><p>安装 C 工具</p><p>Go 的工具链是用 C 语言编写的，因此在安装 Go 之前你需要先安装相关的 C 工具。如果你使用的是 Ubuntu 的话，你可以在终端输入以下指令（ <strong>译者注：由于网络环境的特殊性，你可能需要将每个工具分开安装</strong> ）。</p><pre><code> sudo apt-get install bison ed gawk gcc libc6-dev make
</code></pre><p>你可以在其它发行版上使用 RPM 之类的工具。</p></li>`,2),ns=n("p",null,"获取 Go 源代码",-1),ss={href:"https://golang.org/dl/",target:"_blank",rel:"noopener noreferrer"},as={href:"http://www.golangtc.com/download",target:"_blank",rel:"noopener noreferrer"},es=n("code",null,"go",-1),ts=n("code",null,"$GOROOT",-1),ps=n("pre",null,[n("code",null,` wget https://storage.googleapis.com/golang/go<VERSION>.src.tar.gz
 tar -zxvf go<VERSION>.src.tar.gz
 sudo mv go $GOROOT
`)],-1),os=t(`<p>构建 Go</p><p>在终端使用以下指令来进行编译工作。</p><pre><code> cd $GOROOT/src
 ./all.bash
</code></pre><p><strong>编译注意事项</strong></p><p>编译时如果出现如下报错：</p><figure><img src="`+m+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>可能是因为 <code>$GOROOT_BOOTSTRAP</code> 变量没有设置。这个目录在安装 Go 1.5 版本及之后的版本时需要设置。</p><p>由于在 1.4 版本后，Go 编译器实现了自举，即通过 1.4 版本来编译安装之后版本的编译器。如果不设置该环境变量的话，会产生这样一个错误 <code>Set $GOROOT_BOOTSTRAP to a working Go tree &gt;= Go 1.4.</code> 。</p><p>设置 <code>$GOROOT_BOOTSTRAP</code> 变量：</p><pre><code> export GOROOT_BOOTSTRAP=$HOME/go1.4
</code></pre><p>设置完成后，下载 1.4 版本的源码到该目录：</p><pre><code> git clone https://github.com/golang/go.git $HOME/go1.4
 git checkout -b release-branch.go1.4 origin/release-branch.go1.4
</code></pre><p>进入 1.4 的文件夹后，进行编译：</p><pre><code> cd $HOME/go1.4/src
 ./make.bash
</code></pre><p>1.4 编译安装好之后，进入 <code>$GOROOT</code> 文件夹，真正开始编译安装 Go：</p><pre><code> cd $HOME/go/src
 ./all.bash
</code></pre><p>在完成编译之后（通常在 1 分钟以内，如果你在 B 型树莓派上编译，一般需要 1 个小时），你会在终端看到如下信息被打印：</p><figure><img src="`+b+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>',18),cs=t(`<p><strong>注意事项</strong></p><p>在测试 <code>net/http</code> 包时有一个测试会尝试连接 <code>google.com</code>，你可能会看到如下所示的一个无厘头的错误报告：</p><pre><code> ‘make[2]: Leaving directory \`/localusr/go/src/pkg/net’
</code></pre><p>如果你正在使用一个带有防火墙的机器，我建议你可以在编译过程中暂时关闭防火墙，以避免不必要的错误。</p><p>解决这个问题的另一个办法是通过设置环境变量 <code>$DISABLE_NET_TESTS</code> 来告诉构建工具忽略 <code>net/http</code> 包的相关测试：</p><pre><code> export DISABLE_NET_TESTS=1
</code></pre><p>如果你完全不想运行包的测试，你可以直接运行 <code>./make.bash</code> 来进行单纯的构建过程。</p>`,7),is=t(`<li><p>测试安装</p><p>使用你最喜爱的编辑器来输入以下内容，并保存为文件名 <code>hello_world1.go</code>。</p><p>示例 2.1 <a href="examples/chapter_2/hello_world1.go">hello_world1.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;world&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>切换相关目录到下，然后执行指令 <code>go run hello_world1.go</code>，将会打印信息：<code>Hello, world</code>。</p></li><li><p>验证安装版本</p><p>你可以通过在终端输入指令 <code>go version</code> 来打印 Go 的版本信息。</p><p>如果你想要通过 Go 代码在运行时检测版本，可以通过以下例子实现。</p><p>示例 2.2 <a href="examples/chapter_2/version.go">version.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;runtime&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s&quot;</span><span class="token punctuation">,</span> runtime<span class="token punctuation">.</span><span class="token function">Version</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这段代码将会输出 <code>go1.4.2</code> 或类似字符串。</p></li>`,2),ls=n("p",null,"更新版本",-1),us={href:"http://golang.org/doc/devel/release.html",target:"_blank",rel:"noopener noreferrer"},ds=n("p",null,"当前最新的稳定版 Go 1 系列于 2012 年 3 月 28 日发布。",-1),rs=n("p",null,"Go 的源代码有以下三个分支：",-1),ks=n("pre",null,[n("code",null,` - Go release：最新稳定版，实际开发最佳选择
 - Go weekly：包含最近更新的版本，一般每周更新一次
 - Go tip：永远保持最新的版本，相当于内测版
`)],-1),vs=n("p",null,"当你在使用不同的版本时，注意官方博客发布的信息，因为你所查阅的文档可能和你正在使用的版本不相符。",-1),ms=n("h3",{id:"_2-4-在-mac-os-x-上安装-go",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_2-4-在-mac-os-x-上安装-go","aria-hidden":"true"},"#"),s(" 2.4 在 Mac OS X 上安装 Go")],-1),bs=n("p",null,"如果你想要在你的 Mac 系统上安装 Go，则必须使用 Intel 64 位处理器，Go 不支持 PowerPC 处理器。",-1),gs={href:"https://codedr-go-ppc.googlecode.com/hg/",target:"_blank",rel:"noopener noreferrer"},fs=n("p",null,[n("strong",null,"注意事项")],-1),hs=n("p",null,"在 Mac 系统下使用到的 C 工具链是 Xcode 的一部分，因此你需要通过安装 Xcode 来完成这些工具的安装。你并不需要安装完整的 Xcode，而只需要安装它的命令行工具部分。",-1),ys={href:"http://golang.org/dl/",target:"_blank",rel:"noopener noreferrer"},ws=n("p",null,"通过源代码编译安装的过程与环境变量的配置与在 Linux 系统非常相似，因此不再赘述。",-1),qs=n("h3",{id:"_2-5-在-windows-上安装-go",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_2-5-在-windows-上安装-go","aria-hidden":"true"},"#"),s(" 2.5 在 Windows 上安装 Go")],-1),_s={href:"http://golang.org/dl/",target:"_blank",rel:"noopener noreferrer"},xs=t('<p>前期的 Windows 移植工作由 Hector Chu 完成，但目前的发行版已经由 Joe Poirier 全职维护。</p><p>在完成安装包的安装之后，你只需要配置 <code>$GOPATH</code> 这一个环境变量就可以开始使用 Go 语言进行开发了，其它的环境变量安装包均会进行自动设置。在默认情况下，Go 将会被安装在目录 <code>c:\\go</code> 下，但如果你在安装过程中修改安装目录，则可能需要手动修改所有的环境变量的值。</p><p>如果你想要测试安装，则可以使用指令 <code>go run</code> 运行 <a href="examples/chapter_2/hello_world1.go">hello_world1.go</a>。</p><p>如果发生错误 <code>fatal error: can’t find import: fmt</code> 则说明你的环境变量没有配置正确。</p>',4),Gs={href:"http://sourceforge.net/projects/mingw/files/Automated%20MinGW%20Installer/",target:"_blank",rel:"noopener noreferrer"},Ps={href:"http://tdm-gcc.tdragon.net/",target:"_blank",rel:"noopener noreferrer"},Ss=n("p",null,[n("strong",null,"在 Windows 下运行在虚拟机里的 Linux 系统上安装 Go"),s("：")],-1),Ts={href:"http://www.vmware.com",target:"_blank",rel:"noopener noreferrer"},Cs={href:"http://www.vmware.com/products/player/",target:"_blank",rel:"noopener noreferrer"},As=n("h3",{id:"_2-6-安装目录清单",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_2-6-安装目录清单","aria-hidden":"true"},"#"),s(" 2.6 安装目录清单")],-1),Os=n("p",null,[s("你的 Go 安装目录 ("),n("code",null,"$GOROOT"),s(") 的文件夹结构应该如下所示：")],-1),Is={href:"http://README.md",target:"_blank",rel:"noopener noreferrer"},Fs=t('<ul><li><code>/bin</code>：包含可执行文件，如：编译器，Go 工具</li><li><code>/doc</code>：包含文档模版</li><li><code>/lib</code>：包含示例程序，代码工具，本地文档等</li><li><code>/misc</code>：包含与支持 Go 编辑器有关的配置文件以及 cgo 的示例</li><li><code>/os_arch</code>：包含标准库的包的对象文件 (<code>.a</code>)</li><li><code>/src</code>：包含源代码构建脚本和标准库的包的完整源代码（Go 是一门开源语言）</li><li><code>/src/cmd</code>：包含 Go 和 C 的编译器和命令行脚本</li></ul><h3 id="_2-7-go-运行时-runtime" tabindex="-1"><a class="header-anchor" href="#_2-7-go-运行时-runtime" aria-hidden="true">#</a> 2.7 Go 运行时 (runtime)</h3><p>尽管 Go 编译器产生的是本地可执行代码，这些代码仍旧运行在 Go 的 runtime（这部分的代码可以在 <code>runtime</code> 包中找到）当中。这个 runtime 类似 Java 和 .NET 语言所用到的虚拟机，它负责管理包括内存分配、垃圾回收（<a href="">第 10.8 节</a>）、栈处理、goroutine、channel、切片 (slice)、map 和反射 (reflection) 等等。</p>',3),Ns={href:"https://github.com/golang/go/tree/master/src/runtime",target:"_blank",rel:"noopener noreferrer"},Es=n("code",null,"$GOROOT/src/runtime",-1),Rs=n("p",null,[n("strong",null,"垃圾回收器"),s(" Go 拥有简单却高效的标记-清除回收器。它的主要思想来源于 IBM 的可复用垃圾回收器，旨在打造一个高效、低延迟的并发回收器。目前 gccgo 还没有回收器，同时适用 gc 和 gccgo 的新回收器正在研发中。使用一门具有垃圾回收功能的编程语言不代表你可以避免内存分配所带来的问题，分配和回收内容都是消耗 CPU 资源的一种行为。")],-1),Ms=n("p",null,"Go 的可执行文件都比相对应的源代码文件要大很多，这恰恰说明了 Go 的 runtime 嵌入到了每一个可执行文件当中。当然，在部署到数量巨大的集群时，较大的文件体积也是比较头疼的问题。但总的来说，Go 的部署工作还是要比 Java 和 Python 轻松得多。因为 Go 不需要依赖任何其它文件，它只需要一个单独的静态文件，这样你也不会像使用其它语言一样在各种不同版本的依赖文件之间混淆。",-1),Ls=n("h3",{id:"_2-8-go-解释器",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_2-8-go-解释器","aria-hidden":"true"},"#"),s(" 2.8 Go 解释器")],-1),Bs={href:"https://github.com/sbinet/igo",target:"_blank",rel:"noopener noreferrer"},Ws=n("h2",{id:"第-3-章-编辑器、集成开发环境与其它工具",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#第-3-章-编辑器、集成开发环境与其它工具","aria-hidden":"true"},"#"),s(" 第 3 章：编辑器、集成开发环境与其它工具")],-1),Ds=n("p",null,"因为 Go 语言还是一门相对年轻的编程语言，所以不管是在集成开发环境 (IDE) 还是相关的插件方面，发展都不是很成熟。不过目前还是有一些 IDE 能够较好地支持 Go 的开发，有些开发工具甚至是跨平台的，你可以在 Linux、Mac OS X 或者 Windows 下工作。",-1),Us={href:"http://go-lang.cat-v.org/text-editors/",target:"_blank",rel:"noopener noreferrer"},js=t('<h3 id="_3-1-go-开发环境的基本要求" tabindex="-1"><a class="header-anchor" href="#_3-1-go-开发环境的基本要求" aria-hidden="true">#</a> 3.1 Go 开发环境的基本要求</h3><p>这里有一个可以用来开发 Go 的集成开发环境，你期待有以下哪些特性，从而替代你使用文本编辑器写代码和命令行编译与链接程序的方式？</p><ol><li>语法高亮是必不可少的功能，这也是每个开发工具都提供配置文件来实现自定义配置的原因。</li><li>可以自动保存代码，至少在每次编译前都会保存。</li><li>可以显示代码所在的行数。</li><li>拥有较好的项目文件纵览和导航能力，可以同时编辑多个源文件并设置书签，能够匹配括号，能够跳转到某个函数或类型的定义部分。</li><li>完美的查找和替换功能，替换之前最好还能预览结果。</li><li>可以注释或取消注释选中的一行或多行代码。</li><li>当有编译错误时，双击错误提示可以跳转到发生错误的位置。</li><li>跨平台，能够在 Linux、Mac OS X 和 Windows 下工作，这样就可以专注于一个开发环境。</li><li>最好是免费的，不过有些开发者还是希望能够通过支付一定金额以获得更好的开发环境。</li><li>最好是开源的。</li><li>能够通过插件架构来轻易扩展和替换某个功能。</li><li>尽管集成开发环境本身就是非常复杂的，但一定要让人感觉操作方便。</li><li>能够通过代码模版来简化编码过程从而提升编码速度。</li><li>使用 Go 项目的概念来浏览和管理项目中的文件，同时还要拥有构建系统的概念，这样才能更加方便的构建、清理或运行我们建立的程序或项目。构建出的程序需要能够通过命令行或 IDE 内部的控制台运行。</li><li>拥有断点、检查变量值、单步执行、逐过程执行标识库中代码的能力。</li><li>能够方便的存取最近使用过的文件或项目。</li><li>拥有对包、类型、变量、函数和方法的智能代码补全的功能。</li><li>能够对项目或包中的代码建立抽象语法树视图 (AST-view)。</li><li>内置 Go 的相关工具。</li><li>能够方便完整地查阅 Go 文档。</li><li>能够方便地在不同的 Go 环境之间切换。</li><li>能够导出不同格式的代码文件，如：PDF，HTML 或格式化后的代码。</li><li>针对一些特定的项目有项目模板，如：Web 应用，App Engine 项目，从而能够更快地开始开发工作。</li><li>具备代码重构的能力。</li><li>集成像 hg 或 git 这样的版本控制工具。</li><li>集成 Google App Engine 开发及调试的功能。</li></ol><h3 id="_3-2-编辑器和集成开发环境" tabindex="-1"><a class="header-anchor" href="#_3-2-编辑器和集成开发环境" aria-hidden="true">#</a> 3.2 编辑器和集成开发环境</h3><p>这些编辑器包含了代码高亮和其它与 Go 有关的一些使用工具：Emacs、Vim、Xcode 6、KD Kate、TextWrangler、BBEdit、McEdit、TextMate、TextPad、JEdit、SciTE、Nano、Notepad++、Geany、SlickEdit、Visual Studio Code、IntelliJ IDEA 和 Sublime Text 2。</p><p>你可以将 Linux 的文本编辑器 GEdit 改造成一个很好的 Go 开发工具。</p>',6),Vs={href:"http://www.sublimetext.com",target:"_blank",rel:"noopener noreferrer"},Hs={href:"https://github.com/DisposaBoy/GoSublime",target:"_blank",rel:"noopener noreferrer"},zs=n("p",null,"这里还有一些更加高级的 Go 开发工具，其中一些是以插件的形式利用本身是作为开发 Java 的工具。",-1),Js={href:"https://github.com/go-lang-plugin-org/go-lang-idea-plugin",target:"_blank",rel:"noopener noreferrer"},Xs={href:"https://github.com/visualfc/liteide",target:"_blank",rel:"noopener noreferrer"},Ks={href:"https://github.com/GoClipse/goclipse",target:"_blank",rel:"noopener noreferrer"},$s=n("p",null,"如果你对集成开发环境都不是很熟悉，那就使用 LiteIDE 吧，另外使用 GoClipse 或者 IntelliJ Idea Plugin 也是不错的选择。",-1),Ys=n("p",null,[n("strong",null,"代码补全"),s(" 一般都是通过内置 GoCode 实现的（如：LieteIDE、GoClipse），如果需要手动安装 GoCode，在命令行输入指令 "),n("code",null,"go get -u github.com/nsf/gocode"),s(" 即可（务必事先配置好 Go 环境变量） 。")],-1),Zs=n("p",null,"接下来会对这三个集成开发环境做更加详细的说明。",-1),Qs=n("h4",{id:"_3-2-1-liteide",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_3-2-1-liteide","aria-hidden":"true"},"#"),s(" 3.2.1 LiteIDE")],-1),na={href:"https://github.com/visualfc/liteide",target:"_blank",rel:"noopener noreferrer"},sa=n("p",null,"LiteIDE 是一款非常好用的轻量级 Go 集成开发环境（基于 QT、Kate 和 SciTE），包含了跨平台开发及其它必要的特性，对代码编写、自动补全和运行调试都有极佳的支持。它采用了 Go 项目的概念来对项目文件进行浏览和管理，它还支持在各个 Go 开发环境之间随意切换以及交叉编译的功能。",-1),aa=n("p",null,"同时，它具备了抽象语法树视图的功能，可以清楚地纵览项目中的常量、变量、函数、不同类型以及他们的属性和方法。",-1),ea=n("figure",null,[n("img",{src:g,alt:"",tabindex:"0",loading:"lazy"}),n("figcaption")],-1),ta=n("p",null,"图 3.1 LiteIDE 代码编辑界面和抽象语法树视图",-1),pa=n("h4",{id:"_3-2-2-goclipse",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_3-2-2-goclipse","aria-hidden":"true"},"#"),s(" 3.2.2 GoClipse")],-1),oa={href:"https://github.com/GoClipse/goclipse",target:"_blank",rel:"noopener noreferrer"},ca=t('<p>其依附于著名的 Eclipse 这个大型开发环境，虽然需要安装 JVM 运行环境，但却可以很容易地享有 Eclipse 本身所具有的诸多功能。这是一个非常好的编辑器，完善的代码补全、抽象语法树视图、项目管理和程序调试功能。</p><figure><img src="'+f+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>图 3.2 GoClipse 代码编辑界面、抽象语法树视图和项目管理</p><h3 id="_3-3-调试器" tabindex="-1"><a class="header-anchor" href="#_3-3-调试器" aria-hidden="true">#</a> 3.3 调试器</h3><p>应用程序的开发过程中调试是必不可少的一个环节，因此有一个好的调试器是非常重要的，可惜的是，Go 在这方面的发展还不是很完善。目前可用的调试器是 gdb，最新版均以内置在集成开发环境 LiteIDE 和 GoClipse 中，但是该调试器的调试方式并不灵活且操作难度较大。</p><p>如果你不想使用调试器，你可以按照下面的一些有用的方法来达到基本调试的目的：</p><ol><li><p>在合适的位置使用打印语句输出相关变量的值（<code>print</code>/<code>println</code> 和 <code>fmt.Print</code>/<code>fmt.Println</code>/<code>fmt.Printf</code>）。</p></li><li><p>在 <code>fmt.Printf</code> 中使用下面的说明符来打印有关变量的相关信息：</p><ul><li><code>%+v</code> 打印包括字段在内的实例的完整信息</li><li><code>%#v</code> 打印包括字段和限定类型名称在内的实例的完整信息</li><li><code>%T</code> 打印某个类型的完整说明</li></ul></li><li><p>使用 <code>panic()</code> 语句（<a href="">第 13.2 节</a>）来获取栈跟踪信息（直到 <code>panic()</code> 时所有被调用函数的列表）。</p></li><li><p>使用关键字 <code>defer</code> 来跟踪代码执行过程（<a href="">第 6.4 节</a>）。</p></li></ol><h3 id="_3-4-构建并运行-go-程序" tabindex="-1"><a class="header-anchor" href="#_3-4-构建并运行-go-程序" aria-hidden="true">#</a> 3.4 构建并运行 Go 程序</h3><p>在大多数 IDE 中，每次构建程序之前都会自动调用源码格式化工具 <code>gofmt</code> 并保存格式化后的源文件。如果构建成功则不会输出任何信息，而当发生编译时错误时，则会指明源码中具体第几行出现了什么错误，如：<code>a declared and not used</code>。一般情况下，你可以双击 IDE 中的错误信息直接跳转到发生错误的那一行。</p><p>如果程序执行一切顺利并成功退出后，将会在控制台输出 <code>Program exited with code 0</code>。</p><p>从 Go 1 版本开始，使用 Go 自带的更加方便的工具来构建应用程序：</p><ul><li><code>go build</code> 编译自身包和依赖包</li><li><code>go install</code> 编译并安装自身包和依赖包</li></ul><h3 id="_3-5-格式化代码" tabindex="-1"><a class="header-anchor" href="#_3-5-格式化代码" aria-hidden="true">#</a> 3.5 格式化代码</h3><p>Go 开发团队不想要 Go 语言像许多其它语言那样总是在为代码风格而引发无休止的争论，浪费大量宝贵的开发时间，因此他们制作了一个工具：<code>go fmt</code> (gofmt)。这个工具可以将你的源代码格式化成符合官方统一标准的风格，属于语法风格层面上的小型重构。遵循统一的代码风格是 Go 开发中无可撼动的铁律，因此你必须在编译或提交版本管理系统之前使用 gofmt 来格式化你的代码。</p><p>尽管这种做法也存在一些争论，但使用 gofmt 后你不再需要自成一套代码风格而是和所有人使用相同的规则。这不仅增强了代码的可读性，而且在接手外部 Go 项目时，可以更快地了解其代码的含义。此外，大多数开发工具也都内置了这一功能。</p><p>Go 对于代码的缩进层级方面使用 tab 还是空格并没有强制规定，一个 tab 可以代表 4 个或 8 个空格。在实际开发中，1 个 tab 应该代表 4 个空格，而在本身的例子当中，每个 tab 代表 8 个空格。至于开发工具方面，一般都是直接使用 tab 而不替换成空格。</p><p>在命令行输入 <code>gofmt –w program.go</code> 会格式化该源文件的代码然后将格式化后的代码覆盖原始内容（如果不加参数 <code>-w</code> 则只会打印格式化后的结果而不重写文件）；<code>gofmt -w *.go</code> 会格式化并重写所有 Go 源文件；<code>gofmt map1</code> 会格式化并重写 <code>map1</code> 目录及其子目录下的所有 Go 源文件。</p><p><code>gofmt</code> 也可以通过在参数 <code>-r</code> 后面加入用双引号括起来的替换规则实现代码的简单重构，规则的格式：<code>&lt;原始内容&gt; -&gt; &lt;替换内容&gt;</code>。</p><p>实例：</p><pre><code>gofmt -r &#39;(a) -&gt; a&#39; –w *.go
</code></pre><p>上面的代码会将源文件中没有意义的括号去掉。</p><pre><code>gofmt -r &#39;a[n:len(a)] -&gt; a[n:]&#39; –w *.go
</code></pre><p>上面的代码会将源文件中多余的 <code>len(a)</code> 去掉。（ <strong>译者注：了解切片 (slice) 之后就明白这为什么是多余的了</strong> ）</p><pre><code>gofmt –r &#39;A.Func1(a,b) -&gt; A.Func2(b,a)&#39; –w *.go
</code></pre><p>上面的代码会将源文件中符合条件的函数的参数调换位置。</p>`,25),ia=n("code",null,"gofmt",-1),la={href:"http://golang.org/cmd/gofmt/",target:"_blank",rel:"noopener noreferrer"},ua=n("h3",{id:"_3-6-生成代码文档",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_3-6-生成代码文档","aria-hidden":"true"},"#"),s(" 3.6 生成代码文档")],-1),da=n("p",null,"godoc 工具会从 Go 程序和包文件中提取顶级声明的首行注释以及每个对象的相关注释，并生成相关文档。",-1),ra={href:"http://golang.org",target:"_blank",rel:"noopener noreferrer"},ka=t("<p><strong>一般用法</strong></p><ul><li><code>go doc package</code> 获取包的文档注释，例如：<code>go doc fmt</code> 会显示使用 godoc 生成的 <code>fmt</code> 包的文档注释。</li><li><code>go doc package/subpackage</code> 获取子包的文档注释，例如：<code>go doc container/list</code>。</li><li><code>go doc package function</code> 获取某个函数在某个包中的文档注释，例如：<code>go doc fmt Printf</code> 会显示有关 <code>fmt.Printf()</code> 的使用说明。</li></ul>",2),va=n("code",null,"../go/src",-1),ma=n("code",null,"godoc -http=:6060",-1),ba={href:"http://localhost:6060",target:"_blank",rel:"noopener noreferrer"},ga=n("p",null,[s("godoc 也可以用于生成非标准库的 Go 源码文件的文档注释（"),n("a",{href:""},"第 9.6 章"),s("）。")],-1),fa=n("code",null,"godoc",-1),ha={href:"http://golang.org/cmd/godoc/",target:"_blank",rel:"noopener noreferrer"},ya={href:"https://gowalker.org",target:"_blank",rel:"noopener noreferrer"},wa=t('<h3 id="_3-7-其它工具" tabindex="-1"><a class="header-anchor" href="#_3-7-其它工具" aria-hidden="true">#</a> 3.7 其它工具</h3><p>Go 自带的工具集主要使用脚本和 Go 语言自身编写的，目前版本的 Go 实现了以下三个工具：</p><ul><li><code>go install</code> 是安装 Go 包的工具，类似 Ruby 中的 rubygems。主要用于安装非标准库的包文件，将源代码编译成对象文件。</li><li><code>go fix</code> 用于将你的 Go 代码从旧的发行版迁移到最新的发行版，它主要负责简单的、重复的、枯燥无味的修改工作，如果像 API 等复杂的函数修改，工具则会给出文件名和代码行数的提示以便让开发人员快速定位并升级代码。Go 开发团队一般也使用这个工具升级 Go 内置工具以及 谷歌内部项目的代码。<code>go fix</code> 之所以能够正常工作是因为 Go 在标准库就提供生成抽象语法树和通过抽象语法树对代码进行还原的功能。该工具会尝试更新当前目录下的所有 Go 源文件，并在完成代码更新后在控制台输出相关的文件名称。</li><li><code>go test</code> 是一个轻量级的单元测试框架（<a href="">第 13 章</a>）。</li></ul><h3 id="_3-8-go-性能说明" tabindex="-1"><a class="header-anchor" href="#_3-8-go-性能说明" aria-hidden="true">#</a> 3.8 Go 性能说明</h3><p>根据 Go 开发团队和基本的算法测试，Go 语言与 C 语言的性能差距大概在 10%~20% 之间（ <strong>译者注：由于出版时间限制，该数据应为 2013 年 3 月 28 日之前产生</strong> ）。虽然没有官方的性能标准，但是与其它各个语言相比已经拥有非常出色的表现。</p><p>如果说 Go 语言的执行效率大约比 C++ 慢 20% 也许更有实际意义。保守估计在相同的环境和执行目标的情况下，Go 程序比 Java 或 Scala 应用程序要快上 2 倍，并比这两门语言占用的内存降低了 70% 。在很多情况下这种比较是没有意义的，而像谷歌这样拥有成千上万台服务器的公司都抛弃 C++ 而开始将 Go 用于生产环境才足够说明它本身所具有的优势。</p>',6),qa={href:"http://VB.NET",target:"_blank",rel:"noopener noreferrer"},_a=n("p",null,"如果说 Go 比 C++ 要慢 20%，那么 Go 就要比任何非静态和编译型语言快 2 到 10 倍，并且能够更加高效地使用内存。",-1),xa={href:"http://shootout.alioth.debian.org/",target:"_blank",rel:"noopener noreferrer"},Ga=n("p",null,"这里有一些评测结果：",-1),Pa=n("p",null,"比较 Go 和 Python 在简单的 web 服务器方面的性能，单位为传输量每秒：",-1),Sa={href:"http://web.py",target:"_blank",rel:"noopener noreferrer"},Ta={href:"http://web.py",target:"_blank",rel:"noopener noreferrer"},Ca={href:"http://web.py",target:"_blank",rel:"noopener noreferrer"},Aa=n("li",null,[n("p",null,"Go 和 Python 在一般开发的平均水平测试中，Go 要比 Python 3 快 25 倍左右，少占用三分之二的内存，但比 Python 大概多写一倍的代码（详见引用 27）。")],-1),Oa=n("li",null,[n("p",null,"根据 Robert Hundt（2011 年 6 月，详见引用 28）的文章对 C++、Java、Go 和 Scala，以及 Go 开发团队的反应（详见引用 29），可以得出以下结论："),n("ul",null,[n("li",null,"Go 和 Scala 之间具有更多的可比性（都使用更少的代码），而 C++ 和 Java 都使用非常冗长的代码。"),n("li",null,"Go 的编译速度要比绝大多数语言都要快，比 Java 和 C++ 快 5 至 6 倍，比 Scala 快 10 倍。"),n("li",null,"Go 的二进制文件体积是最大的（每个可执行文件都包含 runtime）。"),n("li",null,"在最理想的情况下，Go 能够和 C++ 一样快，比 Scala 快 2 至 3 倍，比 Java 快 5 至 10 倍。"),n("li",null,"Go 在内存管理方面也可以和 C++ 相媲美，几乎只需要 Scala 所使用的一半，是Java的五分之一左右。")])],-1),Ia=n("h3",{id:"_3-9-与其它语言进行交互",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_3-9-与其它语言进行交互","aria-hidden":"true"},"#"),s(" 3.9 与其它语言进行交互")],-1),Fa=n("h4",{id:"_3-9-1-与-c-进行交互",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#_3-9-1-与-c-进行交互","aria-hidden":"true"},"#"),s(" 3.9.1 与 C 进行交互")],-1),Na={href:"http://golang.org/cmd/cgo",target:"_blank",rel:"noopener noreferrer"},Ea=t(`<p>如果你想要在你的 Go 程序中使用 cgo，则必须在单独的一行使用 <code>import &quot;C&quot;</code> 来导入，一般来说你可能还需要 <code>import &quot;unsafe&quot;</code>。</p><p>然后，你可以在 <code>import &quot;C&quot;</code> 之前使用注释（单行或多行注释均可）的形式导入 C 语言库（甚至有效的 C 语言代码），它们之间没有空行，例如：</p><pre><code>// #include &lt;stdio.h&gt;
// #include &lt;stdlib.h&gt;
import &quot;C&quot;
</code></pre><p>名称 &quot;C&quot; 并不属于标准库的一部分，这只是 cgo 集成的一个特殊名称用于引用 C 的命名空间。在这个命名空间里所包含的 C 类型都可以被使用，例如 <code>C.uint</code>、<code>C.long</code> 等等，还有 libc 中的函数 <code>C.random()</code> 等也可以被调用。</p><p>当你想要使用某个类型作为 C 中函数的参数时，必须将其转换为 C 中的类型，反之亦然，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> i <span class="token builtin">int</span>
C<span class="token punctuation">.</span><span class="token function">uint</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> 		<span class="token comment">// 从 Go 中的 int 转换为 C 中的无符号 int</span>
<span class="token function">int</span><span class="token punctuation">(</span>C<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 从 C 中 random() 函数返回的 long 转换为 Go 中的 int</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下面的 2 个 Go 函数 <code>Random()</code> 和 <code>Seed()</code> 分别调用了 C 中的 <code>C.random()</code> 和 <code>C.srandom()</code>。</p><p>示例 3.2 <a href="examples/chapter_3/CandGo/c1.go">c1.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> rand

<span class="token comment">// #include &lt;stdlib.h&gt;</span>
<span class="token keyword">import</span> <span class="token string">&quot;C&quot;</span>

<span class="token keyword">func</span> <span class="token function">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">int</span><span class="token punctuation">(</span>C<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Seed</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	C<span class="token punctuation">.</span><span class="token function">srandom</span><span class="token punctuation">(</span>C<span class="token punctuation">.</span><span class="token function">uint</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>C 当中并没有明确的字符串类型，如果你想要将一个 <code>string</code> 类型的变量从 Go 转换到 C 时，可以使用 <code>C.CString(s)</code>；同样，可以使用 <code>C.GoString(cs)</code> 从 C 转换到 Go 中的 <code>string</code> 类型。</p><p>Go 的内存管理机制无法管理通过 C 代码分配的内存。</p><p>开发人员需要通过手动调用 <code>C.free</code> 来释放变量的内存：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">defer</span> C<span class="token punctuation">.</span><span class="token function">free</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>Cvariable<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>这一行最好紧跟在使用 C 代码创建某个变量之后，这样就不会忘记释放内存了。下面的代码展示了如何使用 cgo 创建变量、使用并释放其内存：</p><p>示例 3.3 <a href="examples/chapter_3/CandGo/c2.go">c2.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> <span class="token builtin">print</span>

<span class="token comment">// #include &lt;stdio.h&gt;</span>
<span class="token comment">// #include &lt;stdlib.h&gt;</span>
<span class="token keyword">import</span> <span class="token string">&quot;C&quot;</span>
<span class="token keyword">import</span> <span class="token string">&quot;unsafe&quot;</span>

<span class="token keyword">func</span> <span class="token function">Print</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	cs <span class="token operator">:=</span> C<span class="token punctuation">.</span><span class="token function">CString</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> C<span class="token punctuation">.</span><span class="token function">free</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">)</span>
	C<span class="token punctuation">.</span><span class="token function">fputs</span><span class="token punctuation">(</span>cs<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">*</span>C<span class="token punctuation">.</span>FILE<span class="token punctuation">)</span><span class="token punctuation">(</span>C<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>构建 cgo 包</strong></p><p>你可以在使用将会在第 9.5 节讲到的 Makefile 文件（因为我们使用了一个独立的包），除了使用变量 <code>GOFILES</code> 之外，还需要使用变量 <code>CGOFILES</code> 来列出需要使用 cgo 编译的文件列表。例如，示例 3.2 中的代码就可以使用包含以下内容的 <code>Makefile</code> 文件来编译，你可以使用 <code>gomake</code> 或 <code>make</code>：</p><pre><code>include $(GOROOT)/src/Make.inc
TARG=rand
CGOFILES=\\
c1.go\\
include $(GOROOT)/src/Make.pkg
</code></pre><h4 id="_3-9-2-与-c-进行交互" tabindex="-1"><a class="header-anchor" href="#_3-9-2-与-c-进行交互" aria-hidden="true">#</a> 3.9.2 与 C++ 进行交互</h4><p>SWIG（简化封装器和接口生成器）支持在 Linux 系统下使用 Go 代码调用 C 或者 C++ 代码。这里有一些使用 SWIG 的注意事项：</p><ul><li>编写需要封装的库的 SWIG 接口。</li><li>SWIG 会产生 C 的存根函数。</li><li>这些库可以使用 cgo 来调用。</li><li>相关的 Go 文件也可以被自动生成。</li></ul><p>这类接口支持方法重载、多重继承以及使用 Go 代码实现 C++ 的抽象类。</p><p>目前使用 SWIG 存在的一个问题是它无法支持所有的 C++ 库，比如说它就无法解析 TObject.h。</p><h2 id="第-4-章-基本结构和基本数据类型" tabindex="-1"><a class="header-anchor" href="#第-4-章-基本结构和基本数据类型" aria-hidden="true">#</a> 第 4 章：基本结构和基本数据类型</h2><h3 id="_4-1-文件名、关键字与标识符" tabindex="-1"><a class="header-anchor" href="#_4-1-文件名、关键字与标识符" aria-hidden="true">#</a> 4.1 文件名、关键字与标识符</h3><p>Go 的源文件以 <code>.go</code> 为后缀名存储在计算机中，这些文件名均由小写字母组成，如 <code>scanner.go</code> 。如果文件名由多个部分组成，则使用下划线 <code>_</code> 对它们进行分隔，如 <code>scanner_test.go</code> 。文件名不包含空格或其他特殊字符。</p><p>一个源文件可以包含任意多行的代码，Go 本身没有对源文件的大小进行限制。</p><p>你会发现在 Go 代码中的几乎所有东西都有一个名称或标识符。另外，Go 语言也是区分大小写的，这与 C 家族中的其它语言相同。有效的标识符必须以字母（可以使用任何 UTF-8 编码的字符或 <code>_</code>）开头，然后紧跟着 0 个或多个字符或 Unicode 数字，如：X56、group1、_x23、i、өԑ12。</p><p>以下是无效的标识符：</p><ul><li>1ab（以数字开头）</li><li>case（Go 语言的关键字）</li><li>a+b（运算符是不允许的）</li></ul><p><code>_</code> 本身就是一个特殊的标识符，被称为空白标识符。它可以像其他标识符那样用于变量的声明或赋值（任何类型都可以赋值给它），但任何赋给这个标识符的值都将被抛弃，因此这些值不能在后续的代码中使用，也不可以使用这个标识符作为变量对其它变量进行赋值或运算。</p><p>在编码过程中，你可能会遇到没有名称的变量、类型或方法。虽然这不是必须的，但有时候这样做可以极大地增强代码的灵活性，这些变量被统称为匿名变量。</p><p>下面列举了 Go 代码中会使用到的 25 个关键字或保留字：</p><table class="table table-bordered table-striped table-condensed"><tr><td>break</td><td>default</td><td>func</td><td>interface</td><td>select</td></tr><tr><td>case</td><td>defer</td><td>go</td><td>map</td><td>struct</td></tr><tr><td>chan</td><td>else</td><td>goto</td><td>package</td><td>switch</td></tr><tr><td>const</td><td>fallthrough</td><td>if</td><td>range</td><td>type</td></tr><tr><td>continue</td><td>for</td><td>import</td><td>return</td><td>var</td></tr></table><p>之所以刻意地将 Go 代码中的关键字保持的这么少，是为了简化在编译过程第一步中的代码解析。和其它语言一样，关键字不能够作标识符使用。</p><p>除了以上介绍的这些关键字，Go 语言还有 36 个预定义标识符，其中包含了基本类型的名称和一些基本的内置函数（<a href="">第 6.5 节</a>），它们的作用都将在接下来的章节中进行进一步地讲解。</p><table class="table table-bordered table-striped table-condensed"><tr><td>append</td><td>bool</td><td>byte</td><td>cap</td><td>close</td><td>complex</td><td>complex64</td><td>complex128</td><td>uint16</td></tr><tr><td>copy</td><td>false</td><td>float32</td><td>float64</td><td>imag</td><td>int</td><td>int8</td><td>int16</td><td>uint32</td></tr><tr><td>int32</td><td>int64</td><td>iota</td><td>len</td><td>make</td><td>new</td><td>nil</td><td>panic</td><td>uint64</td></tr><tr><td>print</td><td>println</td><td>real</td><td>recover</td><td>string</td><td>true</td><td>uint</td><td>uint8</td><td>uintptr</td></tr></table><p>程序一般由关键字、常量、变量、运算符、类型和函数组成。</p><p>程序中可能会使用到这些分隔符：括号 <code>()</code>，中括号 <code>[]</code> 和大括号 <code>{}</code>。</p><p>程序中可能会使用到这些标点符号：<code>.</code>、<code>,</code>、<code>;</code>、<code>:</code> 和 <code>…</code>。</p><p>程序的代码通过语句来实现结构化。每个语句不需要像 C 家族中的其它语言一样以分号 <code>;</code> 结尾，因为这些工作都将由 Go 编译器自动完成。</p><p>如果你打算将多个语句写在同一行，它们则必须使用 <code>;</code> 人为区分，但在实际开发中我们并不鼓励这种做法。</p><h3 id="_4-2-go-程序的基本结构和要素" tabindex="-1"><a class="header-anchor" href="#_4-2-go-程序的基本结构和要素" aria-hidden="true">#</a> 4.2 Go 程序的基本结构和要素</h3><p>示例 4.1 <a href="">hello_world.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;hello, world&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-2-1-包的概念、导入与可见性" tabindex="-1"><a class="header-anchor" href="#_4-2-1-包的概念、导入与可见性" aria-hidden="true">#</a> 4.2.1 包的概念、导入与可见性</h4><p>包是结构化代码的一种方式：每个程序都由包（通常简称为 pkg）的概念组成，可以使用自身的包或者从其它包中导入内容。</p><p>如同其它一些编程语言中的类库或命名空间的概念，每个 Go 文件都属于且仅属于一个包。一个包可以由许多以 <code>.go</code> 为扩展名的源文件组成，因此文件名和包名一般来说都是不相同的。</p><p>你必须在源文件中非注释的第一行指明这个文件属于哪个包，如：<code>package main</code>。<code>package main</code> 表示一个可独立执行的程序，每个 Go 应用程序都包含一个名为 <code>main</code> 的包。</p><p>一个应用程序可以包含不同的包，而且即使你只使用 main 包也不必把所有的代码都写在一个巨大的文件里：你可以用一些较小的文件，并且在每个文件非注释的第一行都使用 <code>package main</code> 来指明这些文件都属于 <code>main</code> 包。如果你打算编译包名不是为 main 的源文件，如 <code>pack1</code>，编译后产生的对象文件将会是 <code>pack1.a</code> 而不是可执行程序。另外要注意的是，所有的包名都应该使用小写字母。</p><p><strong>标准库</strong></p><p>在 Go 的安装文件里包含了一些可以直接使用的包，即标准库。在 Windows 下，标准库的位置在 Go 根目录下的子目录 <code>pkg\\windows_386</code> 中；在 Linux 下，标准库在 Go 根目录下的子目录 <code>pkg\\linux_amd64</code> 中（如果是安装的是 32 位，则在 <code>linux_386</code> 目录中）。一般情况下，标准包会存放在 <code>$GOROOT/pkg/$GOOS_$GOARCH/</code> 目录下。</p><p>Go 的标准库包含了大量的包（如：<code>fmt</code> 和 <code>os</code>），但是你也可以创建自己的包（<a href="">第 9 章</a>）。</p><p>如果想要构建一个程序，则包和包内的文件都必须以正确的顺序进行编译。包的依赖关系决定了其构建顺序。</p><p>属于同一个包的源文件必须全部被一起编译，一个包即是编译时的一个单元，因此根据惯例，每个目录都只包含一个包。</p><p><strong>如果对一个包进行更改或重新编译，所有引用了这个包的客户端程序都必须全部重新编译。</strong></p><p>Go 中的包模型采用了显式依赖关系的机制来达到快速编译的目的，编译器会从后缀名为 <code>.o</code> 的对象文件（需要且只需要这个文件）中提取传递依赖类型的信息。</p><p>如果 <code>A.go</code> 依赖 <code>B.go</code>，而 <code>B.go</code> 又依赖 <code>C.go</code>：</p><ul><li>编译 <code>C.go</code>, <code>B.go</code>, 然后是 <code>A.go</code>.</li><li>为了编译 <code>A.go</code>, 编译器读取的是 <code>B.o</code> 而不是 <code>C.o</code>.</li></ul><p>这种机制对于编译大型的项目时可以显著地提升编译速度。</p><p><strong>每一段代码只会被编译一次</strong></p><p>一个 Go 程序是通过 <code>import</code> 关键字将一组包链接在一起。</p><p><code>import &quot;fmt&quot;</code> 告诉 Go 编译器这个程序需要使用 <code>fmt</code> 包（的函数，或其他元素），<code>fmt</code> 包实现了格式化 IO（输入/输出）的函数。包名被封闭在半角双引号 <code>&quot;&quot;</code> 中。如果你打算从已编译的包中导入并加载公开声明的方法，不需要插入已编译包的源代码。</p><p>如果需要多个包，它们可以被分别导入：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>
<span class="token keyword">import</span> <span class="token string">&quot;os&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>或：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span><span class="token punctuation">;</span> <span class="token keyword">import</span> <span class="token string">&quot;os&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>但是还有更短且更优雅的方法（被称为因式分解关键字，该方法同样适用于 <code>const</code>、<code>var</code> 和 <code>type</code> 的声明或定义）：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token punctuation">(</span>
   <span class="token string">&quot;fmt&quot;</span>
   <span class="token string">&quot;os&quot;</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>它甚至还可以更短的形式，但使用 gofmt 后将会被强制换行：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">&quot;fmt&quot;</span><span class="token punctuation">;</span> <span class="token string">&quot;os&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>当你导入多个包时，最好按照字母顺序排列包名，这样做更加清晰易读。</p><p>如果包名不是以 <code>.</code> 或 <code>/</code> 开头，如 <code>&quot;fmt&quot;</code> 或者 <code>&quot;container/list&quot;</code>，则 Go 会在全局文件进行查找；如果包名以 <code>./</code> 开头，则 Go 会在相对目录中查找；如果包名以 <code>/</code> 开头（在 Windows 下也可以这样使用），则会在系统的绝对路径中查找。</p><p><em>译者注：以相对路径在GOPATH下导入包会产生报错信息</em></p><p><em>报错信息：local import &quot;./XXX&quot; in non-local package</em></p>`,76),Ra={href:"https://golang.org/cmd/go/#hdr-Relative_import_paths",target:"_blank",rel:"noopener noreferrer"},Ma=t(`<p><em>注解：在GOPATH外可以以相对路径的形式执行go build（go install 不可以）</em></p><p>导入包即等同于包含了这个包的所有的代码对象。</p><p>除了符号 <code>_</code>，包中所有代码对象的标识符必须是唯一的，以避免名称冲突。但是相同的标识符可以在不同的包中使用，因为可以使用包名来区分它们。</p><p>包通过下面这个被编译器强制执行的规则来决定是否将自身的代码对象暴露给外部文件：</p><p><strong>可见性规则</strong></p><p>当标识符（包括常量、变量、类型、函数名、结构字段等等）以一个大写字母开头，如：Group1，那么使用这种形式的标识符的对象就可以被外部包的代码所使用（客户端程序需要先导入这个包），这被称为导出（像面向对象语言中的 public）；标识符如果以小写字母开头，则对包外是不可见的，但是它们在整个包的内部是可见并且可用的（像面向对象语言中的 private ）。</p><p>（大写字母可以使用任何 Unicode 编码的字符，比如希腊文，不仅仅是 ASCII 码中的大写字母）。</p><p>因此，在导入一个外部包后，能够且只能够访问该包中导出的对象。</p><p>假设在包 <code>pack1</code> 中我们有一个变量或函数叫做 <code>Thing</code>（以 T 开头，所以它能够被导出），那么在当前包中导入 <code>pack1</code> 包，<code>Thing</code> 就可以像面向对象语言那样使用点标记来调用：<code>pack1.Thing</code>（pack1 在这里是不可以省略的）。</p><p>因此包也可以作为命名空间使用，帮助避免命名冲突（名称冲突）：两个包中的同名变量的区别在于它们的包名，例如 <code>pack1.Thing</code> 和 <code>pack2.Thing</code>。</p><p>你可以通过使用包的别名来解决包名之间的名称冲突，或者说根据你的个人喜好对包名进行重新设置，如：<code>import fm &quot;fmt&quot;</code>。下面的代码展示了如何使用包的别名：</p><p>示例 4.2 <a href="examples/chapter_4/alias.go">alias.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> fm <span class="token string">&quot;fmt&quot;</span> <span class="token comment">// alias3</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   fm<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;hello, world&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>注意事项</strong></p><p>如果你导入了一个包却没有使用它，则会在构建程序时引发错误，如 <code>imported and not used: os</code>，这正是遵循了 Go 的格言：“没有不必要的代码！”。</p><p><strong>包的分级声明和初始化</strong></p><p>你可以在使用 <code>import</code> 导入包之后定义或声明 0 个或多个常量 (const)、变量 (var) 和类型 (type)，这些对象的作用域都是全局的（在本包范围内），所以可以被本包中所有的函数调用（如 <a href="examples/chapter_4/gotemplate.go">gotemplate.go</a> 源文件中的 <code>c</code> 和 <code>v</code>），然后声明一个或多个函数 (func)。</p><h4 id="_4-2-2-函数" tabindex="-1"><a class="header-anchor" href="#_4-2-2-函数" aria-hidden="true">#</a> 4.2.2 函数</h4><p>这是定义一个函数最简单的格式：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">functionName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>你可以在括号 <code>()</code> 中写入 0 个或多个函数的参数（使用逗号 <code>,</code> 分隔），每个参数的名称后面必须紧跟着该参数的类型。</p><p><code>main()</code> 函数是每一个可执行程序所必须包含的，一般来说都是在启动后第一个执行的函数（如果有 <code>init()</code> 函数则会先执行该函数）。如果你的 <code>main</code> 包的源代码没有包含 <code>main()</code> 函数，则会引发构建错误 <code>undefined: main.main</code>。<code>main()</code> 函数既没有参数，也没有返回类型（与 C 家族中的其它语言恰好相反）。如果你不小心为 <code>main()</code> 函数添加了参数或者返回类型，将会引发构建错误：</p><pre><code>func main must have no arguments and no return values results.
</code></pre><p>在程序开始执行并完成初始化后，第一个调用（程序的入口点）的函数是 <code>main.main()</code>（如：C 语言），该函数一旦返回就表示程序已成功执行并立即退出。</p><p>函数里的代码（函数体）使用大括号 <code>{}</code> 括起来。</p><p>左大括号 <code>{</code> 必须与方法的声明放在同一行，这是编译器的强制规定，否则你在使用 gofmt 时就会出现错误提示：</p><pre><code>\`build-error: syntax error: unexpected semicolon or newline before {\`
</code></pre><p>（这是因为编译器会产生 <code>func main() ;</code> 这样的结果，很明显这是错误的）</p><p><strong>Go 语言虽然看起来不使用分号作为语句的结束，但实际上这一过程是由编译器自动完成，因此才会引发像上面这样的错误</strong></p><p>右大括号 <code>}</code> 需要被放在紧接着函数体的下一行。如果你的函数非常简短，你也可以将它们放在同一行：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Sum</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> a <span class="token operator">+</span> b <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>对于大括号 <code>{}</code> 的使用规则在任何时候都是相同的（如：<code>if</code> 语句等）。</p><p>因此符合规范的函数一般写成如下的形式：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">functionName</span><span class="token punctuation">(</span>parameter_list<span class="token punctuation">)</span> <span class="token punctuation">(</span>return_value_list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   …
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中：</p><ul><li><code>parameter_list</code> 的形式为 <code>(param1 type1, param2 type2, …)</code></li><li><code>return_value_list</code> 的形式为 <code>(ret1 type1, ret2 type2, …)</code></li></ul><p>只有当某个函数需要被外部包调用的时候才使用大写字母开头，并遵循 Pascal 命名法；否则就遵循骆驼命名法，即第一个单词的首字母小写，其余单词的首字母大写。</p><p>下面这一行调用了 <code>fmt</code> 包中的 <code>Println</code> 函数，可以将字符串输出到控制台，并在最后自动增加换行字符 <code>\\n</code>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>fmt<span class="token punctuation">.</span>Println（<span class="token string">&quot;hello, world&quot;</span>）
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>使用 <code>fmt.Print(&quot;hello, world\\n&quot;)</code> 可以得到相同的结果。</p><p><code>Print</code> 和 <code>Println</code> 这两个函数也支持使用变量，如：<code>fmt.Println(arr)</code>。如果没有特别指定，它们会以默认的打印格式将变量 <code>arr</code> 输出到控制台。</p><p>单纯地打印一个字符串或变量甚至可以使用预定义的方法来实现，如：<code>print</code>、<code>println：print(&quot;ABC&quot;)</code>、<code>println(&quot;ABC&quot;)</code>、<code>println(i)</code>（带一个变量 <code>i</code>）。</p><p>这些函数只可以用于调试阶段，在部署程序的时候务必将它们替换成 <code>fmt</code> 中的相关函数。</p><p>当被调用函数的代码执行到结束符 <code>}</code> 或返回语句时就会返回，然后程序继续执行调用该函数之后的代码。</p><p>程序正常退出的代码为 <code>0</code> 即 <code>Program exited with code 0</code>；如果程序因为异常而被终止，则会返回非零值，如：<code>1</code>。这个数值可以用来测试是否成功执行一个程序。</p><h4 id="_4-2-3-注释" tabindex="-1"><a class="header-anchor" href="#_4-2-3-注释" aria-hidden="true">#</a> 4.2.3 注释</h4><p>示例 4.2 <a href="examples/chapter_4/hello_world2.go">hello_world2.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span> <span class="token comment">// Package implementing formatted I/O.</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Καλημέρα κόσμε; or こんにちは 世界\\n&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面这个例子通过打印 <code>Καλημέρα κόσμε; or こんにちは 世界</code> 展示了如何在 Go 中使用国际化字符，以及如何使用注释。</p><p>注释不会被编译，但可以通过 godoc 来使用（<a href="">第 3.6 节</a>）。</p><p>单行注释是最常见的注释形式，你可以在任何地方使用以 <code>//</code> 开头的单行注释。多行注释也叫块注释，均已以 <code>/*</code> 开头，并以 <code>*/</code> 结尾，且不可以嵌套使用，多行注释一般用于包的文档描述或注释成块的代码片段。</p><p>每一个包应该有相关注释，在 <code>package</code> 语句之前的块注释将被默认认为是这个包的文档说明，其中应该提供一些相关信息并对整体功能做简要的介绍。一个包可以分散在多个文件中，但是只需要在其中一个进行注释说明即可。当开发人员需要了解包的一些情况时，自然会用 godoc 来显示包的文档说明，在首行的简要注释之后可以用成段的注释来进行更详细的说明，而不必拥挤在一起。另外，在多段注释之间应以空行分隔加以区分。</p><p>示例：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// Package superman implements methods for saving the world.</span>
<span class="token comment">//</span>
<span class="token comment">// Experience has shown that a small number of procedures can prove</span>
<span class="token comment">// helpful when attempting to save the world.</span>
<span class="token keyword">package</span> superman
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>几乎所有全局作用域的类型、常量、变量、函数和被导出的对象都应该有一个合理的注释。如果这种注释（称为文档注释）出现在函数前面，例如函数 Abcd，则要以 <code>&quot;Abcd...&quot;</code> 作为开头。</p><p>示例：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// enterOrbit causes Superman to fly into low Earth orbit, a position</span>
<span class="token comment">// that presents several possibilities for planet salvation.</span>
<span class="token keyword">func</span> <span class="token function">enterOrbit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
   <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>godoc 工具（<a href="">第 3.6 节</a>）会收集这些注释并产生一个技术文档。</p><h4 id="_4-2-4-类型" tabindex="-1"><a class="header-anchor" href="#_4-2-4-类型" aria-hidden="true">#</a> 4.2.4 类型</h4><p>变量（或常量）包含数据，这些数据可以有不同的数据类型，简称类型。使用 <code>var</code> 声明的变量的值会自动初始化为该类型的零值。类型定义了某个变量的值的集合与可对其进行操作的集合。</p><p>类型可以是基本类型，如：<code>int</code>、<code>float</code>、<code>bool</code>、<code>string</code>；结构化的（复合的），如：<code>struct</code>、<code>array</code>、切片 (slice)、<code>map</code>、通道 (channel)；只描述类型的行为的，如：<code>interface</code>。</p><p>结构化的类型没有真正的值，它使用 <code>nil</code> 作为默认值（在 Objective-C 中是 nil，在 Java 中是 null，在 C 和 C++ 中是 NULL 或 0）。值得注意的是，Go 语言中不存在类型继承。</p><p>函数也可以是一个确定的类型，就是以函数作为返回类型。这种类型的声明要写在函数名和可选的参数列表之后，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> FunctionName <span class="token punctuation">(</span>a typea<span class="token punctuation">,</span> b typeb<span class="token punctuation">)</span> typeFunc
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>你可以在函数体中的某处返回使用类型为 <code>typeFunc</code> 的变量 <code>var</code>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">return</span> <span class="token keyword">var</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>一个函数可以拥有多返回值，返回类型之间需要使用逗号分割，并使用小括号 <code>()</code> 将它们括起来，如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> FunctionName <span class="token punctuation">(</span>a typea<span class="token punctuation">,</span> b typeb<span class="token punctuation">)</span> <span class="token punctuation">(</span>t1 type1<span class="token punctuation">,</span> t2 type2<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>示例： 函数 <code>Atoi()</code>（<a href="">第 4.7 节</a>）：<code>func Atoi(s string) (i int, err error)</code></p><p>返回的形式：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">return</span> var1<span class="token punctuation">,</span> var2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>这种多返回值一般用于判断某个函数是否执行成功 (true/false) 或与其它返回值一同返回错误消息（详见之后的并行赋值）。</p><p>使用 <code>type</code> 关键字可以定义你自己的类型，你可能想要定义一个结构体（<a href="">第 10 章</a>），但是也可以定义一个已经存在的类型的别名，如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> IZ <span class="token builtin">int</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>这里并不是真正意义上的别名，因为使用这种方法定义之后的类型可以拥有更多的特性，且在类型转换时必须显式转换。</strong></p><p>然后我们可以使用下面的方式声明变量：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> a IZ <span class="token operator">=</span> <span class="token number">5</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>这里我们可以看到 <code>int</code> 是变量 <code>a</code> 的底层类型，这也使得它们之间存在相互转换的可能（<a href="">第 4.2.6 节</a>）。</p><p>如果你有多个类型需要定义，可以使用因式分解关键字的方式，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> <span class="token punctuation">(</span>
   IZ <span class="token builtin">int</span>
   FZ <span class="token builtin">float64</span>
   STR <span class="token builtin">string</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>每个值都必须在经过编译后属于某个类型（编译器必须能够推断出所有值的类型），因为 Go 语言是一种静态类型语言。</p><h4 id="_4-2-5-go-程序的一般结构" tabindex="-1"><a class="header-anchor" href="#_4-2-5-go-程序的一般结构" aria-hidden="true">#</a> 4.2.5 Go 程序的一般结构</h4><p>下面的程序可以被顺利编译但什么都做不了，不过这很好地展示了一个 Go 程序的首选结构。这种结构并没有被强制要求，编译器也不关心 <code>main()</code> 函数在前还是变量的声明在前，但使用统一的结构能够在从上至下阅读 Go 代码时有更好的体验。</p><p>所有的结构将在这一章或接下来的章节中进一步地解释说明，但总体思路如下：</p><ul><li>在完成包的 <code>import</code> 之后，开始对常量、变量和类型的定义或声明。</li><li>如果存在 <code>init()</code> 函数的话，则对该函数进行定义（这是一个特殊的函数，每个含有该函数的包都会首先执行这个函数）。</li><li>如果当前包是 <code>main</code> 包，则定义 <code>main()</code> 函数。</li><li>然后定义其余的函数，首先是类型的方法，接着是按照 <code>main()</code> 函数中先后调用的顺序来定义相关函数，如果有很多函数，则可以按照字母顺序来进行排序。</li></ul><p>示例 4.4 <a href="examples/chapter_4/gotemplate.go">gotemplate.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
   <span class="token string">&quot;fmt&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> c <span class="token operator">=</span> <span class="token string">&quot;C&quot;</span>

<span class="token keyword">var</span> v <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">5</span>

<span class="token keyword">type</span> T <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// initialization of package</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">var</span> a <span class="token builtin">int</span>
   <span class="token function">Func1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token comment">// ...</span>
   fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>t T<span class="token punctuation">)</span> <span class="token function">Method1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">//...</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Func1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// exported function Func1</span>
   <span class="token comment">//...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Go 程序的执行（程序启动）顺序如下：</p><ol><li>按顺序导入所有被 <code>main</code> 包引用的其它包，然后在每个包中执行如下流程：</li><li>如果该包又导入了其它的包，则从第一步开始递归执行，但是每个包只会被导入一次。</li><li>然后以相反的顺序在每个包中初始化常量和变量，如果该包含有 <code>init()</code> 函数的话，则调用该函数。</li><li>在完成这一切之后，<code>main</code> 也执行同样的过程，最后调用 <code>main()</code> 函数开始执行程序。</li></ol><h4 id="_4-2-6-类型转换" tabindex="-1"><a class="header-anchor" href="#_4-2-6-类型转换" aria-hidden="true">#</a> 4.2.6 类型转换</h4><p>在必要以及可行的情况下，一个类型的值可以被转换成另一种类型的值。由于 Go 语言不存在隐式类型转换，因此所有的转换都必须显式说明，就像调用一个函数一样（类型在这里的作用可以看作是一种函数）：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>valueOfTypeB <span class="token operator">=</span> <span class="token function">typeB</span><span class="token punctuation">(</span>valueOfTypeA<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>类型 B 的值 = 类型 B(类型 A 的值)</strong></p><p>示例：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>a <span class="token operator">:=</span> <span class="token number">5.0</span>
b <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>但这只能在定义正确的情况下转换成功，例如从一个取值范围较小的类型转换到一个取值范围较大的类型（例如将 <code>int16</code> 转换为 <code>int32</code>）。当从一个取值范围较大的转换到取值范围较小的类型时（例如将 <code>int32</code> 转换为 <code>int16</code> 或将 <code>float32</code> 转换为 <code>int</code>），会发生精度丢失（截断）的情况。当编译器捕捉到非法的类型转换时会引发编译时错误，否则将引发运行时错误。</p><p>具有相同底层类型的变量之间可以相互转换：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> a IZ <span class="token operator">=</span> <span class="token number">5</span>
c <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
d <span class="token operator">:=</span> <span class="token function">IZ</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-2-7-go-命名规范" tabindex="-1"><a class="header-anchor" href="#_4-2-7-go-命名规范" aria-hidden="true">#</a> 4.2.7 Go 命名规范</h4><p>干净、可读的代码和简洁性是 Go 追求的主要目标。通过 gofmt 来强制实现统一的代码风格。Go 语言中对象的命名也应该是简洁且有意义的。像 Java 和 Python 中那样使用混合着大小写和下划线的冗长的名称会严重降低代码的可读性。名称不需要指出自己所属的包，因为在调用的时候会使用包名作为限定符。返回某个对象的函数或方法的名称一般都是使用名词，没有 <code>Get...</code> 之类的字符，如果是用于修改某个对象，则使用 <code>SetName()</code>。有必须要的话可以使用大小写混合的方式，如 <code>MixedCaps()</code> 或 <code>mixedCaps()</code>，而不是使用下划线来分割多个名称。</p><h3 id="_4-3-常量" tabindex="-1"><a class="header-anchor" href="#_4-3-常量" aria-hidden="true">#</a> 4.3 常量</h3><p>常量使用关键字 <code>const</code> 定义，用于存储不会改变的数据。</p><p>存储在常量中的数据类型只可以是布尔型、数字型（整数型、浮点型和复数）和字符串型。</p><p>常量的定义格式：<code>const identifier [type] = value</code>，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">const</span> Pi <span class="token operator">=</span> <span class="token number">3.14159</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>在 Go 语言中，你可以省略类型说明符 <code>[type]</code>，因为编译器可以根据变量的值来推断其类型。</p><ul><li>显式类型定义： <code>const b string = &quot;abc&quot;</code></li><li>隐式类型定义： <code>const b = &quot;abc&quot;</code></li></ul><p>一个没有指定类型的常量被使用时，会根据其使用环境而推断出它所需要具备的类型。换句话说，未定义类型的常量会在必要时刻根据上下文来获得相关类型。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> n <span class="token builtin">int</span>
<span class="token function">f</span><span class="token punctuation">(</span>n <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token comment">// 无类型的数字型常量 “5” 它的类型在这里变成了 int</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>常量的值必须是能够在编译时就能够确定的；你可以在其赋值表达式中涉及计算过程，但是所有用于计算的值必须在编译期间就能获得。</p><ul><li>正确的做法：<code>const c1 = 2/3</code></li><li>错误的做法：<code>const c2 = getNumber()</code> // 引发构建错误: <code>getNumber() used as value</code></li></ul><p><strong>因为在编译期间自定义函数均属于未知，因此无法用于常量的赋值，但内置函数可以使用，如：<code>len()</code>。</strong></p><p>数字型的常量是没有大小和符号的，并且可以使用任何精度而不会导致溢出：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">const</span> Ln2 <span class="token operator">=</span> <span class="token number">0.693147180559945309417232121458</span>\\
			<span class="token number">176568075500134360255254120680009</span>
<span class="token keyword">const</span> Log2E <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">/</span>Ln2 <span class="token comment">// this is a precise reciprocal</span>
<span class="token keyword">const</span> Billion <span class="token operator">=</span> <span class="token number">1e9</span> <span class="token comment">// float constant</span>
<span class="token keyword">const</span> hardEight <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">97</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>根据上面的例子我们可以看到，反斜杠 <code>\\</code> 可以在常量表达式中作为多行的连接符使用。</p><p>与各种类型的数字型变量相比，你无需担心常量之间的类型转换问题，因为它们都是非常理想的数字。</p><p>不过需要注意的是，当常量赋值给一个精度过小的数字型变量时，可能会因为无法正确表达常量所代表的数值而导致溢出，这会在编译期间就引发错误。另外，常量也允许使用并行赋值的形式：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">const</span> beef<span class="token punctuation">,</span> two<span class="token punctuation">,</span> c <span class="token operator">=</span> <span class="token string">&quot;eat&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;veg&quot;</span>
<span class="token keyword">const</span> Monday<span class="token punctuation">,</span> Tuesday<span class="token punctuation">,</span> Wednesday<span class="token punctuation">,</span> Thursday<span class="token punctuation">,</span> Friday<span class="token punctuation">,</span> Saturday <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span>
<span class="token keyword">const</span> <span class="token punctuation">(</span>
	Monday<span class="token punctuation">,</span> Tuesday<span class="token punctuation">,</span> Wednesday <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span>
	Thursday<span class="token punctuation">,</span> Friday<span class="token punctuation">,</span> Saturday <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>常量还可以用作枚举：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">const</span> <span class="token punctuation">(</span>
	Unknown <span class="token operator">=</span> <span class="token number">0</span>
	Female <span class="token operator">=</span> <span class="token number">1</span>
	Male <span class="token operator">=</span> <span class="token number">2</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>现在，数字 <code>0</code>、<code>1</code> 和 <code>2</code> 分别代表未知性别、女性和男性。这些枚举值可以用于测试某个变量或常量的实际值，比如使用 switch/case 结构（<a href="">第 5.3 节</a>）。</p><p>在这个例子中，<code>iota</code> 可以被用作枚举值：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">const</span> <span class="token punctuation">(</span>
	a <span class="token operator">=</span> <span class="token boolean">iota</span>
	b <span class="token operator">=</span> <span class="token boolean">iota</span>
	c <span class="token operator">=</span> <span class="token boolean">iota</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第一个 <code>iota</code> 等于 0，每当 <code>iota</code> 在新的一行被使用时，它的值都会自动加 1，并且没有赋值的常量默认会应用上一行的赋值表达式：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 赋值一个常量时，之后没赋值的常量都会应用上一行的赋值表达式</span>
<span class="token keyword">const</span> <span class="token punctuation">(</span>
	a <span class="token operator">=</span> <span class="token boolean">iota</span>  <span class="token comment">// a = 0</span>
	b         <span class="token comment">// b = 1</span>
	c         <span class="token comment">// c = 2</span>
	d <span class="token operator">=</span> <span class="token number">5</span>     <span class="token comment">// d = 5   </span>
	e         <span class="token comment">// e = 5</span>
<span class="token punctuation">)</span>

<span class="token comment">// 赋值两个常量，iota 只会增长一次，而不会因为使用了两次就增长两次</span>
<span class="token keyword">const</span> <span class="token punctuation">(</span>
	Apple<span class="token punctuation">,</span> Banana <span class="token operator">=</span> <span class="token boolean">iota</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">iota</span> <span class="token operator">+</span> <span class="token number">2</span> <span class="token comment">// Apple=1 Banana=2</span>
	Cherimoya<span class="token punctuation">,</span> Durian                  <span class="token comment">// Cherimoya=2 Durian=3</span>
	Elderberry<span class="token punctuation">,</span> Fig                    <span class="token comment">// Elderberry=3, Fig=4</span>

<span class="token punctuation">)</span>

<span class="token comment">// 使用 iota 结合 位运算 表示资源状态的使用案例</span>
<span class="token keyword">const</span> <span class="token punctuation">(</span>
	Open <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token boolean">iota</span>  <span class="token comment">// 0001</span>
	Close             <span class="token comment">// 0010</span>
	Pending           <span class="token comment">// 0100</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
	<span class="token boolean">_</span>           <span class="token operator">=</span> <span class="token boolean">iota</span>             <span class="token comment">// 使用 _ 忽略不需要的 iota</span>
	KB <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">*</span> <span class="token boolean">iota</span><span class="token punctuation">)</span>          <span class="token comment">// 1 &lt;&lt; (10*1)</span>
	MB                             <span class="token comment">// 1 &lt;&lt; (10*2)</span>
	GB                             <span class="token comment">// 1 &lt;&lt; (10*3)</span>
	TB                             <span class="token comment">// 1 &lt;&lt; (10*4)</span>
	PB                             <span class="token comment">// 1 &lt;&lt; (10*5)</span>
	EB                             <span class="token comment">// 1 &lt;&lt; (10*6)</span>
	ZB                             <span class="token comment">// 1 &lt;&lt; (10*7)</span>
	YB                             <span class="token comment">// 1 &lt;&lt; (10*8)</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（<strong>译者注：关于 <code>iota</code> 的使用涉及到非常复杂多样的情况，这里作者解释的并不清晰，因为很难对 <code>iota</code> 的用法进行直观的文字描述</strong>）</p><p><code>iota</code> 也可以用在表达式中，如：<code>iota + 50</code>。在每遇到一个新的常量块或单个常量声明时， <code>iota</code> 都会重置为 0（ <strong>简单地讲，每遇到一次 const 关键字，<code>iota</code> 就重置为 0</strong> ）。</p><p>当然，常量之所以为常量就是恒定不变的量，因此我们无法在程序运行过程中修改它的值；如果你在代码中试图修改常量的值则会引发编译错误。</p><h3 id="_4-4-变量" tabindex="-1"><a class="header-anchor" href="#_4-4-变量" aria-hidden="true">#</a> 4.4 变量</h3><h4 id="_4-4-1-简介" tabindex="-1"><a class="header-anchor" href="#_4-4-1-简介" aria-hidden="true">#</a> 4.4.1 简介</h4><p>声明变量的一般形式是使用 <code>var</code> 关键字：<code>var identifier type</code>。</p><p>需要注意的是，Go 和许多编程语言不同，它在声明变量时将变量的类型放在变量的名称之后。Go 为什么要选择这么做呢？</p>`,132),La=n("code",null,"int* a, b;",-1),Ba=n("code",null,"a",-1),Wa=n("code",null,"b",-1),Da={href:"http://blog.golang.org/2010/07/gos-declaration-syntax.html",target:"_blank",rel:"noopener noreferrer"},Ua=t(`<p>而在 Go 中，则可以很轻松地将它们都声明为指针类型：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> a<span class="token punctuation">,</span> b <span class="token operator">*</span><span class="token builtin">int</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>其次，这种语法能够按照从左至右的顺序阅读，使得代码更加容易理解。</p><p>示例：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> a <span class="token builtin">int</span>
<span class="token keyword">var</span> b <span class="token builtin">bool</span>
<span class="token keyword">var</span> str <span class="token builtin">string</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>你也可以改写成这种形式：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> <span class="token punctuation">(</span>
	a <span class="token builtin">int</span>
	b <span class="token builtin">bool</span>
	str <span class="token builtin">string</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这种因式分解关键字的写法一般用于声明全局变量。</p><p>当一个变量被声明之后，系统自动赋予它该类型的零值：<code>int</code> 为 <code>0</code>，<code>float32(64)</code> 为 <code>0.0</code>，bool 为 <code>false</code>，<code>string</code> 为空字符串，指针为 <code>nil</code>。记住，所有的内存在 Go 中都是经过初始化的。</p><p>变量的命名规则遵循骆驼命名法，即首个单词小写，每个新单词的首字母大写，例如：<code>numShips</code> 和 <code>startDate</code>。</p><p>但如果你的全局变量希望能够被外部包所使用，则需要将首个单词的首字母也大写（第 4.2 节：可见性规则）。</p><p>一个变量（常量、类型或函数）在程序中都有一定的作用范围，称之为作用域。如果一个变量在函数体外声明，则被认为是全局变量，可以在整个包甚至外部包（被导出后）使用，不管你声明在哪个源文件里或在哪个源文件里调用该变量。</p><p>在函数体内声明的变量称之为局部变量，它们的作用域只在函数体内，参数和返回值变量也是局部变量。在 <a href="">第 5 章</a>，我们将会学习到像 <code>if</code> 和 <code>for</code> 这些控制结构，而在这些结构中声明的变量的作用域只在相应的代码块内。一般情况下，局部变量的作用域可以通过代码块（用大括号括起来的部分）判断。</p><p>尽管变量的标识符必须是唯一的，但你可以在某个代码块的内层代码块中使用相同名称的变量，则此时外部的同名变量将会暂时隐藏（结束内部代码块的执行后隐藏的外部同名变量又会出现，而内部同名变量则被释放），你任何的操作都只会影响内部代码块的局部变量。</p><p>变量可以编译期间就被赋值，赋值给变量使用运算符等号 <code>=</code>，当然你也可以在运行时对变量进行赋值操作。</p><p>示例：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>a <span class="token operator">=</span> <span class="token number">15</span>
b <span class="token operator">=</span> <span class="token boolean">false</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>一般情况下，当变量a和变量b之间类型相同时，才能进行如 <code>a = b</code> 的赋值。</p><p>声明与赋值（初始化）语句也可以组合起来。</p><p>示例：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> identifier <span class="token punctuation">[</span><span class="token keyword">type</span><span class="token punctuation">]</span> <span class="token operator">=</span> value
<span class="token keyword">var</span> a <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">15</span>
<span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">5</span>
<span class="token keyword">var</span> b <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token keyword">var</span> str <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">&quot;Go says hello to the world!&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>但是 Go 编译器的智商已经高到可以根据变量的值来自动推断其类型，这有点像 Ruby 和 Python 这类动态语言，只不过它们是在运行时进行推断，而 Go 是在编译时就已经完成推断过程。因此，你还可以使用下面的这些形式来声明及初始化变量：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">15</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">&quot;Go says hello to the world!&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>或：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> <span class="token punctuation">(</span>
	a <span class="token operator">=</span> <span class="token number">15</span>
	b <span class="token operator">=</span> <span class="token boolean">false</span>
	str <span class="token operator">=</span> <span class="token string">&quot;Go says hello to the world!&quot;</span>
	numShips <span class="token operator">=</span> <span class="token number">50</span>
	city <span class="token builtin">string</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>不过自动推断类型并不是任何时候都适用的，当你想要给变量的类型并不是自动推断出的某种类型时，你还是需要显式指定变量的类型，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> n <span class="token builtin">int64</span> <span class="token operator">=</span> <span class="token number">2</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>然而，<code>var a</code> 这种语法是不正确的，因为编译器没有任何可以用于自动推断类型的依据。变量的类型也可以在运行时实现自动推断，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> <span class="token punctuation">(</span>
	HOME <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">Getenv</span><span class="token punctuation">(</span><span class="token string">&quot;HOME&quot;</span><span class="token punctuation">)</span>
	USER <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">Getenv</span><span class="token punctuation">(</span><span class="token string">&quot;USER&quot;</span><span class="token punctuation">)</span>
	GOROOT <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">Getenv</span><span class="token punctuation">(</span><span class="token string">&quot;GOROOT&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这种写法主要用于声明包级别的全局变量，当你在函数体内声明局部变量时，应使用简短声明语法 <code>:=</code>，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>a <span class="token operator">:=</span> <span class="token number">1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>下面这个例子展示了如何通过 <code>runtime</code> 包在运行时获取所在的操作系统类型，以及如何通过 <code>os</code> 包中的函数 <code>os.Getenv()</code> 来获取环境变量中的值，并保存到 <code>string</code> 类型的局部变量 <code>path</code> 中。</p><p>示例 4.5 <a href="examples/chapter_4/goos.go">goos.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
   <span class="token string">&quot;runtime&quot;</span>
	<span class="token string">&quot;os&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> goos <span class="token builtin">string</span> <span class="token operator">=</span> runtime<span class="token punctuation">.</span>GOOS
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The operating system is: %s\\n&quot;</span><span class="token punctuation">,</span> goos<span class="token punctuation">)</span>
	path <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Getenv</span><span class="token punctuation">(</span><span class="token string">&quot;PATH&quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Path is %s\\n&quot;</span><span class="token punctuation">,</span> path<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果你在 Windows 下运行这段代码，则会输出 <code>The operating system is: windows</code> 以及相应的环境变量的值；如果你在 Linux 下运行这段代码，则会输出 <code>The operating system is: linux</code> 以及相应的的环境变量的值。</p><p>这里用到了 <code>Printf</code> 的格式化输出的功能（<a href="">第 4.4.3 节</a>）。</p><h4 id="_4-4-2-值类型和引用类型" tabindex="-1"><a class="header-anchor" href="#_4-4-2-值类型和引用类型" aria-hidden="true">#</a> 4.4.2 值类型和引用类型</h4><p>程序中所用到的内存在计算机中使用一堆箱子来表示（这也是人们在讲解它的时候的画法），这些箱子被称为“字”。根据不同的处理器以及操作系统类型，所有的字都具有 32 位（4 字节）或 64 位（8 字节）的相同长度；所有的字都使用相关的内存地址来进行表示（以十六进制数表示）。</p><p>所有像 <code>int</code>、<code>float</code>、<code>bool</code> 和 <code>string</code> 这些基本类型都属于值类型，使用这些类型的变量直接指向存在内存中的值： <img src="`+h+'" alt="" loading="lazy"></p><p>另外，像数组（<a href="">第 7 章</a>）和结构（<a href="./10.0md">第 10 章</a>）这些复合类型也是值类型。</p><p>当使用等号 <code>=</code> 将一个变量的值赋值给另一个变量时，如：<code>j = i</code>，实际上是在内存中将 <code>i</code> 的值进行了拷贝： <img src="'+y+'" alt="" loading="lazy"></p><p>你可以通过 <code>&amp;i</code> 来获取变量 <code>i</code> 的内存地址（<a href="">第 4.9 节</a>），例如：<code>0xf840000040</code>（每次的地址都可能不一样）。值类型的变量的值存储在栈中。</p><p>内存地址会根据机器的不同而有所不同，甚至相同的程序在不同的机器上执行后也会有不同的内存地址。因为每台机器可能有不同的存储器布局，并且位置分配也可能不同。</p><p>更复杂的数据通常会需要使用多个字，这些数据一般使用引用类型保存。</p><p>一个引用类型的变量 <code>r1</code> 存储的是 <code>r1</code> 的值所在的内存地址（数字），或内存地址中第一个字所在的位置。 <img src="'+w+`" alt="" loading="lazy"></p><p>这个内存地址被称之为指针（你可以从上图中很清晰地看到，<a href="">第 4.9 节</a> 将会详细说明），这个指针实际上也被存在另外的某一个字中。</p><p>同一个引用类型的指针指向的多个字可以是在连续的内存地址中（内存布局是连续的），这也是计算效率最高的一种存储形式；也可以将这些字分散存放在内存中，每个字都指示了下一个字所在的内存地址。</p><p>当使用赋值语句 <code>r2 = r1</code> 时，只有引用（地址）被复制。</p><p>如果 <code>r1</code> 的值被改变了，那么这个值的所有引用都会指向被修改后的内容，在这个例子中，<code>r2</code> 也会受到影响。</p><p>在 Go 语言中，指针（<a href="">第 4.9 节</a>）属于引用类型，其它的引用类型还包括 slices（<a href="">第 7 章</a>），maps（<a href="">第 8 章</a>）和 channel（<a href="">第 13 章</a>）。被引用的变量会存储在堆中，以便进行垃圾回收，且比栈拥有更大的内存空间。</p><h4 id="_4-4-3-打印" tabindex="-1"><a class="header-anchor" href="#_4-4-3-打印" aria-hidden="true">#</a> 4.4.3 打印</h4><p>函数 <code>Printf</code> 可以在 <code>fmt</code> 包外部使用，这是因为它以大写字母 P 开头，该函数主要用于打印输出到控制台。通常使用的格式化字符串作为第一个参数：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Printf</span><span class="token punctuation">(</span>format <span class="token builtin">string</span><span class="token punctuation">,</span> list of variables to be printed<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>在示例 4.5 中，格式化字符串为：<code>&quot;The operating system is: %s\\n&quot;</code>。</p><p>这个格式化字符串可以含有一个或多个的格式化标识符，例如：<code>%..</code>，其中 <code>..</code> 可以被不同类型所对应的标识符替换，如 <code>%s</code> 代表字符串标识符、<code>%v</code> 代表使用类型的默认输出格式的标识符。这些标识符所对应的值从格式化字符串后的第一个逗号开始按照相同顺序添加，如果参数超过 1 个则同样需要使用逗号分隔。使用这些占位符可以很好地控制格式化输出的文本。</p><p>函数 <code>fmt.Sprintf</code> 与 <code>Printf</code> 的作用是完全相同的，不过前者将格式化后的字符串以返回值的形式返回给调用者，因此你可以在程序中使用包含变量的字符串，具体例子可以参见示例 15.4 <a href="examples/chapter_15/simple_tcp_server.go">simple_tcp_server.go</a>。</p><p>函数 <code>fmt.Print</code> 和 <code>fmt.Println</code> 会自动使用格式化标识符 <code>%v</code> 对字符串进行格式化，两者都会在每个参数之间自动增加空格，而后者还会在字符串的最后加上一个换行符。例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;Hello:&quot;</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>将输出：<code>Hello: 23</code>。</p><h4 id="_4-4-4-简短形式-使用-赋值操作符" tabindex="-1"><a class="header-anchor" href="#_4-4-4-简短形式-使用-赋值操作符" aria-hidden="true">#</a> 4.4.4 简短形式，使用 := 赋值操作符</h4><p>我们知道可以在变量的初始化时省略变量的类型而由系统自动推断，而这个时候再在 Example 4.4.1 的最后一个声明语句写上 <code>var</code> 关键字就显得有些多余了，因此我们可以将它们简写为 <code>a := 50</code> 或 <code>b := false</code>。</p><p><code>a</code> 和 <code>b</code> 的类型（<code>int</code> 和 <code>bool</code>）将由编译器自动推断。</p><p>这是使用变量的首选形式，但是它只能被用在函数体内，而不可以用于全局变量的声明与赋值。使用操作符 <code>:=</code> 可以高效地创建一个新的变量，称之为初始化声明。</p><p><strong>注意事项</strong></p><p>如果在相同的代码块中，我们不可以再次对于相同名称的变量使用初始化声明，例如：<code>a := 20</code> 就是不被允许的，编译器会提示错误 <code>no new variables on left side of :=</code>，但是 <code>a = 20</code> 是可以的，因为这是给相同的变量赋予一个新的值。</p><p>如果你在定义变量 <code>a</code> 之前使用它，则会得到编译错误 <code>undefined: a</code>。</p><p>如果你声明了一个局部变量却没有在相同的代码块中使用它，同样会得到编译错误，例如下面这个例子当中的变量 <code>a</code>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">var</span> a <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">&quot;abc&quot;</span>
   fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;hello, world&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>尝试编译这段代码将得到错误 <code>a declared and not used</code>。</p><p>此外，单纯地给 <code>a</code> 赋值也是不够的，这个值必须被使用，所以使用 <code>fmt.Println(&quot;hello, world&quot;, a)</code> 会移除错误。</p><p>但是全局变量是允许声明但不使用。</p><p>其他的简短形式为：</p><p>同一类型的多个变量可以声明在同一行，如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c <span class="token builtin">int</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>(这是将类型写在标识符后面的一个重要原因)</p><p>多变量可以在同一行进行赋值，如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">&quot;abc&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>上面这行假设了变量 <code>a</code>，<code>b</code> 和 <code>c</code> 都已经被声明，否则的话应该这样使用：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c <span class="token operator">:=</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">&quot;abc&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>右边的这些值以相同的顺序赋值给左边的变量，所以 <code>a</code> 的值是 <code>5</code>， <code>b</code> 的值是 <code>7</code>，<code>c</code> 的值是 <code>&quot;abc&quot;</code>。</p><p>这被称为 <strong>并行</strong> 或 <strong>同时</strong> 赋值。</p><p>如果你想要交换两个变量的值，则可以简单地使用 <code>a, b = b, a</code>。</p><p>(在 Go 语言中，这样省去了使用交换函数的必要)</p><p>空白标识符 <code>_</code> 也被用于抛弃值，如值 <code>5</code> 在：<code>_, b = 5, 7</code> 中被抛弃。</p><p><code>_</code> 实际上是一个只写变量，你不能得到它的值。这样做是因为 Go 语言中你必须使用所有被声明的变量，但有时你并不需要使用从一个函数得到的所有返回值。</p><p>并行赋值也被用于当一个函数返回多个返回值时，比如这里的 <code>val</code> 和错误 <code>err</code> 是通过调用 <code>Func1</code> 函数同时得到：<code>val, err = Func1(var1)</code>。</p><h4 id="_4-4-5-init-函数" tabindex="-1"><a class="header-anchor" href="#_4-4-5-init-函数" aria-hidden="true">#</a> 4.4.5 init 函数</h4><p>变量除了可以在全局声明中初始化，也可以在 <code>init()</code> 函数中初始化。这是一类非常特殊的函数，它不能够被人为调用，而是在每个包完成初始化后自动执行，并且执行优先级比 <code>main()</code> 函数高。</p><p>每个源文件可以包含多个 <code>init()</code> 函数，同一个源文件中的 <code>init()</code> 函数会按照从上到下的顺序执行，如果一个包有多个源文件包含 <code>init()</code> 函数的话，则官方鼓励但不保证以文件名的顺序调用。初始化总是以单线程并且按照包的依赖关系顺序执行。</p><p>一个可能的用途是在开始执行程序之前对数据进行检验或修复，以保证程序状态的正确性。</p><p>示例 4.6 <a href="examples/chapter_4/init.go">init.go</a>:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> trans

<span class="token keyword">import</span> <span class="token string">&quot;math&quot;</span>

<span class="token keyword">var</span> Pi <span class="token builtin">float64</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   Pi <span class="token operator">=</span> <span class="token number">4</span> <span class="token operator">*</span> math<span class="token punctuation">.</span><span class="token function">Atan</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// init() function computes Pi</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在它的 <code>init()</code> 函数中计算变量 <code>Pi</code> 的初始值。</p><p>示例 4.7 <a href="examples/chapter_4/user_init.go">user_init.go</a> 中导入了包 <code>trans</code>（需要 <code>init.go</code> 目录为 <code>./trans/init.go</code> ）并且使用到了变量 <code>Pi</code>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
   <span class="token string">&quot;fmt&quot;</span>
   <span class="token string">&quot;./trans&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> twoPi <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> trans<span class="token punctuation">.</span>Pi

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;2*Pi = %g\\n&quot;</span><span class="token punctuation">,</span> twoPi<span class="token punctuation">)</span> <span class="token comment">// 2*Pi = 6.283185307179586</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>init()</code> 函数也经常被用在当一个程序开始之前调用后台执行的 goroutine，如下面这个例子当中的 <code>backend()</code>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// setup preparations</span>
   <span class="token keyword">go</span> <span class="token function">backend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>练习</strong> 推断以下程序的输出，并解释你的答案，然后编译并执行它们。</p><p>练习 4.1 <a href="examples/chapter_4/local_scope.go">local_scope.go</a>:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token string">&quot;G&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token function">n</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token function">m</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token function">n</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">n</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">m</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   a <span class="token operator">:=</span> <span class="token string">&quot;O&quot;</span>
   <span class="token function">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>练习 4.2 <a href="examples/chapter_4/global_scope.go">global_scope.go</a>:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token string">&quot;G&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token function">n</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token function">m</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token function">n</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">n</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token function">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">m</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   a <span class="token operator">=</span> <span class="token string">&quot;O&quot;</span>
   <span class="token function">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>练习 4.3 <a href="examples/chapter_4/function_calls_function.go">function_calls_function.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">var</span> a <span class="token builtin">string</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   a <span class="token operator">=</span> <span class="token string">&quot;G&quot;</span>
   <span class="token function">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
   <span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   a <span class="token operator">:=</span> <span class="token string">&quot;O&quot;</span>
   <span class="token function">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
   <span class="token function">f2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">f2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token function">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-5-基本类型和运算符" tabindex="-1"><a class="header-anchor" href="#_4-5-基本类型和运算符" aria-hidden="true">#</a> 4.5 基本类型和运算符</h3><p>我们将在这个部分讲解有关布尔型、数字型和字符型的相关知识。</p><p>表达式是一种特定的类型的值，它可以由其它的值以及运算符组合而成。每个类型都定义了可以和自己结合的运算符集合，如果你使用了不在这个集合中的运算符，则会在编译时获得编译错误。</p><p>一元运算符只可以用于一个值的操作（作为后缀），而二元运算符则可以和两个值或者操作数结合（作为中缀）。</p><p>只有两个类型相同的值才可以和二元运算符结合，另外要注意的是，Go 是强类型语言，因此不会进行隐式转换，任何不同类型之间的转换都必须显式说明（第 4.2 节）。Go 不存在像 C 那样的运算符重载，表达式的解析顺序是从左至右。</p><p>你可以在第 4.5.3 节找到有关运算符优先级的相关信息，优先级越高的运算符在条件相同的情况下将被优先执行。但是你可以通过使用括号将其中的表达式括起来，以人为地提升某个表达式的运算优先级。</p><h4 id="_4-5-1-布尔类型-bool" tabindex="-1"><a class="header-anchor" href="#_4-5-1-布尔类型-bool" aria-hidden="true">#</a> 4.5.1 布尔类型 bool</h4><p>一个简单的例子：<code>var b bool = true</code>。</p><p>布尔型的值只可以是常量 true 或者 false。</p><p>两个类型相同的值可以使用相等 <code>==</code> 或者不等 <code>!=</code> 运算符来进行比较并获得一个布尔型的值。</p><p>当相等运算符两边的值是完全相同的值的时候会返回 <code>true</code>，否则返回 <code>false</code>，并且只有在两个的值的类型相同的情况下才可以使用。</p><p>示例：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> aVar <span class="token operator">=</span> <span class="token number">10</span>
aVar <span class="token operator">==</span> <span class="token number">5</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">false</span>
aVar <span class="token operator">==</span> <span class="token number">10</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当不等运算符两边的值是不同的时候会返回 <code>true</code>，否则返回 <code>false</code>。</p><p>示例：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> aVar <span class="token operator">=</span> <span class="token number">10</span>
aVar <span class="token operator">!=</span> <span class="token number">5</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>
aVar <span class="token operator">!=</span> <span class="token number">10</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">false</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Go 对于值之间的比较有非常严格的限制，只有两个类型相同的值才可以进行比较，如果值的类型是接口（interface，<a href="">第 11 章</a>），它们也必须都实现了相同的接口。如果其中一个值是常量，那么另外一个值的类型必须和该常量类型相兼容的。如果以上条件都不满足，则其中一个值的类型必须在被转换为和另外一个值的类型相同之后才可以进行比较。</p><p>布尔型的常量和变量也可以通过和逻辑运算符（非 <code>!</code>、与 <code>&amp;&amp;</code>、或 <code>||</code>）结合来产生另外一个布尔值，这样的逻辑语句就其本身而言，并不是一个完整的 Go 语句。</p><p>逻辑值可以被用于条件结构中的条件语句（<a href="">第 5 章</a>），以便测试某个条件是否满足。另外，与 <code>&amp;&amp;</code>、或 <code>||</code> 与相等 <code>==</code> 或不等 <code>!=</code> 属于二元运算符，而非 <code>!</code> 属于一元运算符。在接下来的内容中，我们会使用 T 来代表条件符合的语句，用 F 来代表条件不符合的语句。</p><p>Go 语言中包含以下逻辑运算符：</p><p>非运算符：<code>!</code></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token operator">!</span>T <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">false</span>
<span class="token operator">!</span>F <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>非运算符用于取得和布尔值相反的结果。</p><p>与运算符：<code>&amp;&amp;</code></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>T <span class="token operator">&amp;&amp;</span> T <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>
T <span class="token operator">&amp;&amp;</span> F <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">false</span>
F <span class="token operator">&amp;&amp;</span> T <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">false</span>
F <span class="token operator">&amp;&amp;</span> F <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">false</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>只有当两边的值都为 <code>true</code> 的时候，和运算符的结果才是 <code>true</code>。</p><p>或运算符：<code>||</code></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>T <span class="token operator">||</span> T <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>
T <span class="token operator">||</span> F <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>
F <span class="token operator">||</span> T <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">true</span>
F <span class="token operator">||</span> F <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">false</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>只有当两边的值都为 <code>false</code> 的时候，或运算符的结果才是 <code>false</code>，其中任意一边的值为 <code>true</code> 就能够使得该表达式的结果为 <code>true</code>。</p><p>在 Go 语言中，<code>&amp;&amp;</code> 和 <code>||</code> 是具有快捷性质的运算符，当运算符左边表达式的值已经能够决定整个表达式的值的时候（<code>&amp;&amp;</code> 左边的值为 <code>false</code>，<code>||</code> 左边的值为 <code>true</code>），运算符右边的表达式将不会被执行。利用这个性质，如果你有多个条件判断，应当将计算过程较为复杂的表达式放在运算符的右侧以减少不必要的运算。</p><p>利用括号同样可以升级某个表达式的运算优先级。</p><p>在格式化输出时，你可以使用 <code>%t</code> 来表示你要输出的值为布尔型。</p><p>布尔值（以及任何结果为布尔值的表达式）最常用在条件结构的条件语句中，例如：if、for 和 switch 结构（第 5 章）。</p><p>对于布尔值的好的命名能够很好地提升代码的可读性，例如以 <code>is</code> 或者 <code>Is</code> 开头的 <code>isSorted</code>、<code>isFinished</code>、<code>isVisible</code>，使用这样的命名能够在阅读代码的获得阅读正常语句一样的良好体验，例如标准库中的 <code>unicode.IsDigit(ch)</code>（<a href="">第 4.5.5 节</a>）。</p><h4 id="_4-5-2-数字类型" tabindex="-1"><a class="header-anchor" href="#_4-5-2-数字类型" aria-hidden="true">#</a> 4.5.2 数字类型</h4><h5 id="_4-5-2-1-整型-int-和浮点型-float" tabindex="-1"><a class="header-anchor" href="#_4-5-2-1-整型-int-和浮点型-float" aria-hidden="true">#</a> 4.5.2.1 整型 int 和浮点型 float</h5>`,140),ja={href:"http://en.wikipedia.org/wiki/Two's_complement",target:"_blank",rel:"noopener noreferrer"},Va=t(`<p>Go 也有基于架构的类型，例如：<code>int</code>、<code>uint</code> 和 <code>uintptr</code>。</p><p>这些类型的长度都是根据运行程序所在的操作系统类型所决定的：</p><ul><li><code>int</code> 和 <code>uint</code> 在 32 位操作系统上，它们均使用 32 位（4 个字节），在 64 位操作系统上，它们均使用 64 位（8 个字节）。</li><li><code>uintptr</code> 的长度被设定为足够存放一个指针即可。</li></ul><p>Go 语言中没有 float 类型。（Go语言中只有 <code>float32</code> 和 <code>float64</code>）没有 double 类型。</p><p>与操作系统架构无关的类型都有固定的大小，并在类型的名称中就可以看出来：</p><p>整数：</p><ul><li><code>int8</code>（-128 -&gt; 127）</li><li><code>int16</code>（-32768 -&gt; 32767）</li><li><code>int32</code>（-2,147,483,648 -&gt; 2,147,483,647）</li><li><code>int64</code>（-9,223,372,036,854,775,808 -&gt; 9,223,372,036,854,775,807）</li></ul><p>无符号整数：</p><ul><li><code>uint8</code>（0 -&gt; 255）</li><li><code>uint16</code>（0 -&gt; 65,535）</li><li><code>uint32</code>（0 -&gt; 4,294,967,295）</li><li><code>uint64</code>（0 -&gt; 18,446,744,073,709,551,615）</li></ul><p>浮点型（IEEE-754 标准）：</p><ul><li><code>float32</code>（+- 1e-45 -&gt; +- 3.4 * 1e38）</li><li><code>float64</code>（+- 5 * 1e-324 -&gt; 107 * 1e308）</li></ul><p><code>int</code> 型是计算最快的一种类型。</p><p>整型的零值为 <code>0</code>，浮点型的零值为 <code>0.0</code>。</p><p><code>float32</code> 精确到小数点后 7 位，<code>float64</code> 精确到小数点后 15 位。由于精确度的缘故，你在使用 <code>==</code> 或者 <code>!=</code> 来比较浮点数时应当非常小心。你最好在正式使用前测试对于精确度要求较高的运算。</p><p>你应该尽可能地使用 <code>float64</code>，因为 <code>math</code> 包中所有有关数学运算的函数都会要求接收这个类型。</p><p>你可以通过增加前缀 0 来表示 8 进制数（如：077），增加前缀 0x 来表示 16 进制数（如：<code>0xFF</code>），以及使用 <code>e</code> 来表示 10 的连乘（如： 1e3 = 1000，或者 6.022e23 = 6.022 x 1e23）。</p><p>你可以使用 <code>a := uint64(0)</code> 来同时完成类型转换和赋值操作，这样 <code>a</code> 的类型就是 <code>uint64</code>。</p><p>Go 中不允许不同类型之间的混合使用，但是对于常量的类型限制非常少，因此允许常量之间的混合使用，下面这个程序很好地解释了这个现象（该程序无法通过编译）：</p><p>示例 4.8 <a href="examples/chapter_4/type_mixing.go">type_mixing.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> a <span class="token builtin">int</span>
	<span class="token keyword">var</span> b <span class="token builtin">int32</span>
	a <span class="token operator">=</span> <span class="token number">15</span>
	b <span class="token operator">=</span> a <span class="token operator">+</span> a	 <span class="token comment">// 编译错误</span>
	b <span class="token operator">=</span> b <span class="token operator">+</span> <span class="token number">5</span>    <span class="token comment">// 因为 5 是常量，所以可以通过编译</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果你尝试编译该程序，则将得到编译错误 <code>cannot use a + a (type int) as type int32 in assignment</code>。</p><p>同样地，<code>int16</code> 也不能够被隐式转换为 <code>int32</code>。</p><p>下面这个程序展示了通过显式转换来避免这个问题（<a href="">第 4.2 节</a>）。</p><p>示例 4.9 <a href="examples/chapter_4/casting.go">casting.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> n <span class="token builtin">int16</span> <span class="token operator">=</span> <span class="token number">34</span>
	<span class="token keyword">var</span> m <span class="token builtin">int32</span>
	<span class="token comment">// compiler error: cannot use n (type int16) as type int32 in assignment</span>
	<span class="token comment">//m = n</span>
	m <span class="token operator">=</span> <span class="token function">int32</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>

	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;32 bit int is: %d\\n&quot;</span><span class="token punctuation">,</span> m<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;16 bit int is: %d\\n&quot;</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>32 bit int is: 34
16 bit int is: 34
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>格式化说明符</strong></p><p>在格式化字符串里，<code>%d</code> 用于格式化整数（<code>%x</code> 和 <code>%X</code> 用于格式化 16 进制表示的数字），<code>%g</code> 用于格式化浮点型（<code>%f</code> 输出浮点数，<code>%e</code> 输出科学计数表示法），<code>%0nd</code> 用于规定输出长度为 n 的整数，其中开头的数字 0 是必须的。</p><p><code>%n.mg</code> 用于表示数字 n 并精确到小数点后 m 位，除了使用 g 之外，还可以使用 e 或者 f，例如：使用格式化字符串 <code>%5.2e</code> 来输出 3.4 的结果为 <code>3.40e+00</code>。</p><p><strong>数字值转换</strong></p><p>当进行类似 <code>a32bitInt = int32(a32Float)</code> 的转换时，小数点后的数字将被丢弃。这种情况一般发生当从取值范围较大的类型转换为取值范围较小的类型时，或者你可以写一个专门用于处理类型转换的函数来确保没有发生精度的丢失。下面这个例子展示如何安全地从 <code>int</code> 型转换为 <code>int8</code>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Uint8FromInt</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">uint8</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token number">0</span> <span class="token operator">&lt;=</span> n <span class="token operator">&amp;&amp;</span> n <span class="token operator">&lt;=</span> math<span class="token punctuation">.</span>MaxUint8 <span class="token punctuation">{</span> <span class="token comment">// conversion is safe</span>
		<span class="token keyword">return</span> <span class="token function">uint8</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;%d is out of the uint8 range&quot;</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>或者安全地从 <code>float64</code> 转换为 <code>int</code>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">IntFromFloat64</span><span class="token punctuation">(</span>x <span class="token builtin">float64</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> math<span class="token punctuation">.</span>MinInt32 <span class="token operator">&lt;=</span> x <span class="token operator">&amp;&amp;</span> x <span class="token operator">&lt;=</span> math<span class="token punctuation">.</span>MaxInt32 <span class="token punctuation">{</span> <span class="token comment">// x lies in the integer range</span>
		whole<span class="token punctuation">,</span> fraction <span class="token operator">:=</span> math<span class="token punctuation">.</span><span class="token function">Modf</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
		<span class="token keyword">if</span> fraction <span class="token operator">&gt;=</span> <span class="token number">0.5</span> <span class="token punctuation">{</span>
			whole<span class="token operator">++</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token function">int</span><span class="token punctuation">(</span>whole<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%g is out of the int32 range&quot;</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>不过如果你实际存的数字超出你要转换到的类型的取值范围的话，则会引发 <code>panic</code>（<a href="">第 13.2 节</a>）。</p><p><strong>问题 4.1</strong> <code>int</code> 和 <code>int64</code> 是相同的类型吗？</p><h5 id="_4-5-2-2-复数" tabindex="-1"><a class="header-anchor" href="#_4-5-2-2-复数" aria-hidden="true">#</a> 4.5.2.2 复数</h5><p>Go 拥有以下复数类型：</p><pre><code>complex64 (32 位实数和虚数)
complex128 (64 位实数和虚数)
</code></pre><p>复数使用 <code>re+imI</code> 来表示，其中 <code>re</code> 代表实数部分，<code>im</code> 代表虚数部分，<code>I</code> 代表根号负 1。</p><p>示例：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> c1 <span class="token builtin">complex64</span> <span class="token operator">=</span> <span class="token number">5</span> <span class="token operator">+</span> <span class="token number">10i</span>
fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The value is: %v&quot;</span><span class="token punctuation">,</span> c1<span class="token punctuation">)</span>
<span class="token comment">// 输出： 5 + 10i</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果 <code>re</code> 和 <code>im</code> 的类型均为 <code>float32</code>，那么类型为 <code>complex64</code> 的复数 <code>c</code> 可以通过以下方式来获得：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>c <span class="token operator">=</span> <span class="token function">complex</span><span class="token punctuation">(</span>re<span class="token punctuation">,</span> im<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>函数 <code>real(c)</code> 和 <code>imag(c)</code> 可以分别获得相应的实数和虚数部分。</p><p>在使用格式化说明符时，可以使用 <code>%v</code> 来表示复数，但当你希望只表示其中的一个部分的时候需要使用 <code>%f</code>。</p><p>复数支持和其它数字类型一样的运算。当你使用等号 <code>==</code> 或者不等号 <code>!=</code> 对复数进行比较运算时，注意对精确度的把握。<code>cmath</code> 包中包含了一些操作复数的公共方法。如果你对内存的要求不是特别高，最好使用 <code>complex128</code> 作为计算类型，因为相关函数都使用这个类型的参数。</p><h5 id="_4-5-2-3-位运算" tabindex="-1"><a class="header-anchor" href="#_4-5-2-3-位运算" aria-hidden="true">#</a> 4.5.2.3 位运算</h5><p>位运算只能用于整数类型的变量，且需当它们拥有等长位模式时。</p><p><code>%b</code> 是用于表示位的格式化标识符。</p><p><strong>二元运算符</strong></p><ul><li><p>按位与 <code>&amp;</code>：</p><p>对应位置上的值经过和运算结果，具体参见和运算符（第 4.5.1 节），并将 T (true) 替换为 <code>1</code>，将 F (false) 替换为 <code>0</code></p><pre><code>  1 &amp; 1 -&gt; 1
  1 &amp; 0 -&gt; 0
  0 &amp; 1 -&gt; 0
  0 &amp; 0 -&gt; 0
</code></pre></li><li><p>按位或 <code>|</code>：</p><p>对应位置上的值经过或运算结果，具体参见或运算符（第 4.5.1 节），并将 T (true) 替换为 <code>1</code>，将 F (false) 替换为 <code>0</code></p><pre><code>  1 | 1 -&gt; 1
  1 | 0 -&gt; 1
  0 | 1 -&gt; 1
  0 | 0 -&gt; 0
</code></pre></li><li><p>按位异或 <code>^</code>：</p><p>对应位置上的值根据以下规则组合：</p><pre><code>  1 ^ 1 -&gt; 0
  1 ^ 0 -&gt; 1
  0 ^ 1 -&gt; 1
  0 ^ 0 -&gt; 0
</code></pre></li><li><p>位清除 <code>&amp;^</code>：将指定位置上的值设置为 <code>0</code>。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> x <span class="token builtin">uint8</span> <span class="token operator">=</span> <span class="token number">15</span>
	<span class="token keyword">var</span> y <span class="token builtin">uint8</span> <span class="token operator">=</span> <span class="token number">4</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%08b\\n&quot;</span><span class="token punctuation">,</span> x <span class="token operator">&amp;^</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 00001011</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><p><strong>一元运算符</strong></p><ul><li><p>按位补足 <code>^</code>：</p><p>该运算符与异或运算符一同使用，即 <code>m^x</code>，对于无符号 <code>x</code> 使用 “全部位设置为 1” 的规则，对于有符号 <code>x</code> 时使用 <code>m=-1</code>。例如：</p><pre><code>  ^10 = -01 ^ 10 = -11
</code></pre></li><li><p>位左移 <code>&lt;&lt;</code>：</p><ul><li><p>用法：<code>bitP &lt;&lt; n</code>。</p></li><li><p><code>bitP</code> 的位向左移动 <code>n</code> 位，右侧空白部分使用 0 填充；如果 <code>n</code> 等于 2，则结果是 2 的相应倍数，即 2 的 <code>n</code> 次方。例如：</p><pre><code>  1 &lt;&lt; 10 // 等于 1 KB
  1 &lt;&lt; 20 // 等于 1 MB
  1 &lt;&lt; 30 // 等于 1 GB
</code></pre></li></ul></li><li><p>位右移 <code>&gt;&gt;</code>：</p><ul><li>用法：<code>bitP &gt;&gt; n</code>。</li><li><code>bitP</code> 的位向右移动 <code>n</code> 位，左侧空白部分使用 0 填充；如果 <code>n</code> 等于 2，则结果是当前值除以 2 的 n 次方。</li></ul></li></ul><p>当希望把结果赋值给第一个操作数时，可以简写为 <code>a &lt;&lt;= 2</code> 或者 <code>b ^= a &amp; 0xffffffff</code>。</p><p><strong>位左移常见实现存储单位的用例</strong></p><p>使用位左移与 <code>iota</code> 计数配合可优雅地实现存储单位的常量枚举：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> ByteSize <span class="token builtin">float64</span>
<span class="token keyword">const</span> <span class="token punctuation">(</span>
	<span class="token boolean">_</span> <span class="token operator">=</span> <span class="token boolean">iota</span> <span class="token comment">// 通过赋值给空白标识符来忽略值</span>
	KB ByteSize <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token operator">*</span><span class="token boolean">iota</span><span class="token punctuation">)</span>
	MB
	GB
	TB
	PB
	EB
	ZB
	YB
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>在通讯中使用位左移表示标识的用例</strong></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> BitFlag <span class="token builtin">int</span>
<span class="token keyword">const</span> <span class="token punctuation">(</span>
	Active BitFlag <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token boolean">iota</span> <span class="token comment">// 1 &lt;&lt; 0 == 1</span>
	Send <span class="token comment">// 1 &lt;&lt; 1 == 2</span>
	Receive <span class="token comment">// 1 &lt;&lt; 2 == 4</span>
<span class="token punctuation">)</span>

flag <span class="token operator">:=</span> Active <span class="token operator">|</span> Send <span class="token comment">// == 3</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="_4-5-2-4-逻辑运算符" tabindex="-1"><a class="header-anchor" href="#_4-5-2-4-逻辑运算符" aria-hidden="true">#</a> 4.5.2.4 逻辑运算符</h5><p>Go 中拥有以下逻辑运算符：<code>==</code>、<code>!=</code>（第 4.5.1 节）、<code>&lt;</code>、<code>&lt;=</code>、<code>&gt;</code>、<code>&gt;=</code>。</p><p>它们之所以被称为逻辑运算符是因为它们的运算结果总是为布尔值 <code>bool</code>。例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>b3 <span class="token operator">:=</span> <span class="token number">10</span> <span class="token operator">&gt;</span> <span class="token number">5</span> <span class="token comment">// b3 is true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h5 id="_4-5-2-5-算术运算符" tabindex="-1"><a class="header-anchor" href="#_4-5-2-5-算术运算符" aria-hidden="true">#</a> 4.5.2.5 算术运算符</h5><p>常见可用于整数和浮点数的二元运算符有 <code>+</code>、<code>-</code>、<code>*</code> 和 <code>/</code>。</p><p>（相对于一般规则而言，Go 在进行字符串拼接时允许使用对运算符 <code>+</code> 的重载，但 Go 本身不允许开发者进行自定义的运算符重载）</p><p><code>/</code> 对于整数运算而言，结果依旧为整数，例如：<code>9 / 4 -&gt; 2</code>。</p><p>取余运算符只能作用于整数：<code>9 % 4 -&gt; 1</code>。</p><p>整数除以 0 可能导致程序崩溃，将会导致运行时的恐慌状态（如果除以 0 的行为在编译时就能被捕捉到，则会引发编译错误）；<a href="">第 13 章</a> 将会详细讲解如何正确地处理此类情况。</p><p>浮点数除以 <code>0.0</code> 会返回一个无穷尽的结果，使用 <code>+Inf</code> 表示。</p><p><strong>练习 4.4</strong> 尝试编译 <a href="exercises/chapter_4/divby0.go">divby0.go</a>。</p><p>你可以将语句 <code>b = b + a</code> 简写为 <code>b += a</code>，同样的写法也可用于 <code>-=</code>、<code>*=</code>、<code>/=</code>、<code>%=</code>。</p><p>对于整数和浮点数，你可以使用一元运算符 <code>++</code>（递增）和 <code>--</code>（递减），但只能用于后缀：</p><pre><code>i++ -&gt; i += 1 -&gt; i = i + 1
i-- -&gt; i -= 1 -&gt; i = i - 1
</code></pre><p>同时，带有 <code>++</code> 和 <code>--</code> 的只能作为语句，而非表达式，因此 <code>n = i++</code> 这种写法是无效的，其它像 <code>f(i++)</code> 或者 <code>a[i]=b[i++]</code> 这些可以用于 C、C++ 和 Java 中的写法在 Go 中也是不允许的。</p><p>在运算时 <strong>溢出</strong> 不会产生错误，Go 会简单地将超出位数抛弃。如果你需要范围无限大的整数或者有理数（意味着只被限制于计算机内存），你可以使用标准库中的 <code>big</code> 包，该包提供了类似 <code>big.Int</code> 和 <code>big.Rat</code> 这样的类型（<a href="">第 9.4 节</a>）。</p><h5 id="_4-5-2-6-随机数" tabindex="-1"><a class="header-anchor" href="#_4-5-2-6-随机数" aria-hidden="true">#</a> 4.5.2.6 随机数</h5><p>一些像游戏或者统计学类的应用需要用到随机数。<code>rand</code> 包实现了伪随机数的生成。</p><p>示例 4.10 <a href="examples/chapter_4/random.go">random.go</a> 演示了如何生成 10 个非负随机数：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;math/rand&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		a <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d / &quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		r <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d / &quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	timens <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Nanosecond</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	rand<span class="token punctuation">.</span><span class="token function">Seed</span><span class="token punctuation">(</span>timens<span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%2.2f / &quot;</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token operator">*</span>rand<span class="token punctuation">.</span><span class="token function">Float32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可能的输出：</p><pre><code>816681689 / 1325201247 / 623951027 / 478285186 / 1654146165 /
1951252986 / 2029250107 / 762911244 / 1372544545 / 591415086 / / 3 / 0 / 6 / 4 / 2 /22.10
/ 65.77 / 65.89 / 16.85 / 75.56 / 46.90 / 55.24 / 55.95 / 25.58 / 70.61 /
</code></pre>`,84),Ha=n("p",null,[s("函数 "),n("code",null,"rand.Float32"),s(" 和 "),n("code",null,"rand.Float64"),s(" 返回介于 "),n("span",{class:"katex"},[n("span",{class:"katex-mathml"},[n("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[n("semantics",null,[n("mrow",null,[n("mo",{stretchy:"false"},"["),n("mn",null,"0.0"),n("mo",{separator:"true"},","),n("mn",null,"1.0"),n("mo",{stretchy:"false"},")")]),n("annotation",{encoding:"application/x-tex"},"[0.0, 1.0)")])])]),n("span",{class:"katex-html","aria-hidden":"true"},[n("span",{class:"base"},[n("span",{class:"strut",style:{height:"1em","vertical-align":"-0.25em"}}),n("span",{class:"mopen"},"["),n("span",{class:"mord"},"0.0"),n("span",{class:"mpunct"},","),n("span",{class:"mspace",style:{"margin-right":"0.1667em"}}),n("span",{class:"mord"},"1.0"),n("span",{class:"mclose"},")")])])]),s(" 之间的伪随机数，其中包括 "),n("code",null,"0.0"),s(" 但不包括 "),n("code",null,"1.0"),s("。函数 "),n("code",null,"rand.Intn"),s(" 返回介于 "),n("span",{class:"katex"},[n("span",{class:"katex-mathml"},[n("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[n("semantics",null,[n("mrow",null,[n("mo",{stretchy:"false"},"["),n("mn",null,"0"),n("mo",{separator:"true"},","),n("mi",null,"n"),n("mo",{stretchy:"false"},")")]),n("annotation",{encoding:"application/x-tex"},"[0, n)")])])]),n("span",{class:"katex-html","aria-hidden":"true"},[n("span",{class:"base"},[n("span",{class:"strut",style:{height:"1em","vertical-align":"-0.25em"}}),n("span",{class:"mopen"},"["),n("span",{class:"mord"},"0"),n("span",{class:"mpunct"},","),n("span",{class:"mspace",style:{"margin-right":"0.1667em"}}),n("span",{class:"mord mathnormal"},"n"),n("span",{class:"mclose"},")")])])]),s(" 之间的伪随机数。")],-1),za=t(`<p>你可以使用 <code>rand.Seed(value)</code> 函数来提供伪随机数的生成种子，一般情况下都会使用当前时间的纳秒级数字（第 4.8 节）。</p><h4 id="_4-5-3-运算符与优先级" tabindex="-1"><a class="header-anchor" href="#_4-5-3-运算符与优先级" aria-hidden="true">#</a> 4.5.3 运算符与优先级</h4><p>有些运算符拥有较高的优先级，二元运算符的运算方向均是从左至右。下表列出了所有运算符以及它们的优先级，由上至下代表优先级由高到低：</p><pre><code>优先级 	运算符
 7 		^ !
 6 		* / % &lt;&lt; &gt;&gt; &amp; &amp;^
 5 		+ - | ^
 4 		== != &lt; &lt;= &gt;= &gt;
 3 		&lt;-
 2 		&amp;&amp;
 1 		||
</code></pre><p>当然，你可以通过使用括号来临时提升某个表达式的整体运算优先级。</p><h4 id="_4-5-4-类型别名" tabindex="-1"><a class="header-anchor" href="#_4-5-4-类型别名" aria-hidden="true">#</a> 4.5.4 类型别名</h4><p>当你在使用某个类型时，你可以给它起另一个名字，然后你就可以在你的代码中使用新的名字（用于简化名称或解决名称冲突）。</p><p>在 <code>type TZ int</code> 中，<code>TZ</code> 就是 <code>int</code> 类型的新名称（用于表示程序中的时区），然后就可以使用 <code>TZ</code> 来操作 <code>int</code> 类型的数据。</p><p>示例 4.11 <a href="examples/chapter_4/type.go">type.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">type</span> TZ <span class="token builtin">int</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> a<span class="token punctuation">,</span> b TZ <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span>
	c <span class="token operator">:=</span> a <span class="token operator">+</span> b
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;c has the value: %d&quot;</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token comment">// 输出：c has the value: 7</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实际上，类型别名得到的新类型并非和原类型完全相同，新类型不会拥有原类型所附带的方法（<a href="">第 10 章</a>）；<code>TZ</code> 可以自定义一个方法用来输出更加人性化的时区信息。</p><p><strong>练习 4.5</strong> 定义一个 <code>string</code> 的类型别名 <code>Rope</code>，并声明一个该类型的变量。</p><h4 id="_4-5-5-字符类型" tabindex="-1"><a class="header-anchor" href="#_4-5-5-字符类型" aria-hidden="true">#</a> 4.5.5 字符类型</h4><p>严格来说，这并不是 Go 语言的一个类型，字符只是整数的特殊用例。<code>byte</code> 类型是 <code>uint8</code> 的别名，对于只占用 1 个字节的传统 ASCII 编码的字符来说，完全没有问题。例如：<code>var ch byte = &#39;A&#39;</code>；字符使用单引号括起来。</p><p>在 ASCII 码表中，<code>&#39;A&#39;</code> 的值是 <code>65</code>，而使用 16 进制表示则为 <code>41</code>，所以下面的写法是等效的：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> ch <span class="token builtin">byte</span> <span class="token operator">=</span> <span class="token number">65</span> 或 <span class="token keyword">var</span> ch <span class="token builtin">byte</span> <span class="token operator">=</span> <span class="token char">&#39;\\x41&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>（<code>\\x</code> 总是紧跟着长度为 2 的 16 进制数）</p><p>另外一种可能的写法是 <code>\\</code> 后面紧跟着长度为 3 的 8 进制数，例如：<code>\\377</code>。</p><p>不过 Go 同样支持 Unicode（UTF-8），因此字符同样称为 Unicode 代码点或者 runes，并在内存中使用 <code>int</code> 来表示。在文档中，一般使用格式 <code>U+hhhh</code> 来表示，其中 <code>h</code> 表示一个 16 进制数。其实 <code>rune</code> 也是 Go 当中的一个类型，并且是 <code>int32</code> 的别名。</p><p>在书写 Unicode 字符时，需要在 16 进制数之前加上前缀 <code>\\u</code> 或者 <code>\\U</code>。</p><p>因为 Unicode 至少占用 2 个字节，所以我们使用 <code>int16</code> 或者 <code>int</code> 类型来表示。如果需要使用到 4 字节，则会加上 <code>\\U</code> 前缀；前缀 <code>\\u</code> 则总是紧跟着长度为 4 的 16 进制数，前缀 <code>\\U</code> 紧跟着长度为 8 的 16 进制数。</p><p>示例 4.12 <a href="examples/chapter_4/char.go">char.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> ch <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token char">&#39;\\u0041&#39;</span>
<span class="token keyword">var</span> ch2 <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token char">&#39;\\u03B2&#39;</span>
<span class="token keyword">var</span> ch3 <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token char">&#39;\\U00101234&#39;</span>
fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d - %d - %d\\n&quot;</span><span class="token punctuation">,</span> ch<span class="token punctuation">,</span> ch2<span class="token punctuation">,</span> ch3<span class="token punctuation">)</span> <span class="token comment">// integer</span>
fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%c - %c - %c\\n&quot;</span><span class="token punctuation">,</span> ch<span class="token punctuation">,</span> ch2<span class="token punctuation">,</span> ch3<span class="token punctuation">)</span> <span class="token comment">// character</span>
fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%X - %X - %X\\n&quot;</span><span class="token punctuation">,</span> ch<span class="token punctuation">,</span> ch2<span class="token punctuation">,</span> ch3<span class="token punctuation">)</span> <span class="token comment">// UTF-8 bytes</span>
fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%U - %U - %U&quot;</span><span class="token punctuation">,</span> ch<span class="token punctuation">,</span> ch2<span class="token punctuation">,</span> ch3<span class="token punctuation">)</span> <span class="token comment">// UTF-8 code point</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>65 - 946 - 1053236
A - β - r
41 - 3B2 - 101234
U+0041 - U+03B2 - U+101234
</code></pre><p>格式化说明符 <code>%c</code> 用于表示字符；当和字符配合使用时，<code>%v</code> 或 <code>%d</code> 会输出用于表示该字符的整数；<code>%U</code> 输出格式为 <code>U+hhhh</code> 的字符串（另一个示例见<a href="">第 5.4.4 节</a>）。</p><p>包 <code>unicode</code> 包含了一些针对测试字符的非常有用的函数（其中 <code>ch</code> 代表字符）：</p><ul><li>判断是否为字母：<code>unicode.IsLetter(ch)</code></li><li>判断是否为数字：<code>unicode.IsDigit(ch)</code></li><li>判断是否为空白符号：<code>unicode.IsSpace(ch)</code></li></ul><p>这些函数返回单个布尔值。包 <code>utf8</code> 拥有更多与 <code>rune</code> 类型相关的函数。</p><h3 id="_4-6-字符串" tabindex="-1"><a class="header-anchor" href="#_4-6-字符串" aria-hidden="true">#</a> 4.6 字符串</h3><p>字符串是 UTF-8 字符的一个序列（当字符为 ASCII 码时则占用 1 个字节，其它字符根据需要占用 2-4 个字节）。UTF-8 是被广泛使用的编码格式，是文本文件的标准编码，其它包括 XML 和 JSON 在内，也都使用该编码。由于该编码对占用字节长度的不定性，Go 中的字符串里面的字符也可能根据需要占用 1 至 4 个字节（示例见<a href="">第 4.6 节</a>），这与其它语言如 C++、Java 或者 Python 不同（Java 始终使用 2 个字节）。Go 这样做的好处是不仅减少了内存和硬盘空间占用，同时也不用像其它语言那样需要对使用 UTF-8 字符集的文本进行编码和解码。</p><p>字符串是一种值类型，且值不可变，即创建某个文本后你无法再次修改这个文本的内容；更深入地讲，字符串是字节的定长数组。</p><p>Go 支持以下 2 种形式的字面值：</p><ul><li><p>解释字符串：</p><p>该类字符串使用双引号括起来，其中的相关的转义字符将被替换，这些转义字符包括：</p><ul><li><code>\\n</code>：换行符</li><li><code>\\r</code>：回车符</li><li><code>\\t</code>：tab 键</li><li><code>\\u</code> 或 <code>\\U</code>：Unicode 字符</li><li><code>\\\\</code>：反斜杠自身</li></ul></li><li><p>非解释字符串：</p><p>该类字符串使用反引号括起来，支持换行，例如：</p><pre><code>  \`This is a raw string \\n\` 中的 \`\\n\\\` 会被原样输出。
</code></pre></li></ul><p>和 C/C++不一样，Go 中的字符串是根据长度限定，而非特殊字符 <code>\\0</code>。</p><p><code>string</code> 类型的零值为长度为零的字符串，即空字符串 <code>&quot;&quot;</code>。</p><p>一般的比较运算符（<code>==</code>、<code>!=</code>、<code>&lt;</code>、<code>&lt;=</code>、<code>&gt;=</code>、<code>&gt;</code>）通过在内存中按字节比较来实现字符串的对比。你可以通过函数 <code>len()</code> 来获取字符串所占的字节长度，例如：<code>len(str)</code>。</p><p>字符串的内容（纯字节）可以通过标准索引法来获取，在中括号 <code>[]</code> 内写入索引，索引从 0 开始计数：</p><ul><li>字符串 <code>str</code> 的第 1 个字节：<code>str[0]</code></li><li>第 <code>i</code> 个字节：<code>str[i - 1]</code></li><li>最后 1 个字节：<code>str[len(str)-1]</code></li></ul><p>需要注意的是，这种转换方案只对纯 ASCII 码的字符串有效。</p><p><strong>注意事项</strong> 获取字符串中某个字节的地址的行为是非法的，例如：<code>&amp;str[i]</code>。</p><p><strong>字符串拼接符 <code>+</code></strong></p><p>两个字符串 <code>s1</code> 和 <code>s2</code> 可以通过 <code>s := s1 + s2</code> 拼接在一起。</p><p><code>s2</code> 追加在 <code>s1</code> 尾部并生成一个新的字符串 <code>s</code>。</p><p>你可以通过以下方式来对代码中多行的字符串进行拼接：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>str <span class="token operator">:=</span> <span class="token string">&quot;Beginning of the string &quot;</span> <span class="token operator">+</span>
	<span class="token string">&quot;second part of the string&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>由于编译器行尾自动补全分号的缘故，加号 <code>+</code> 必须放在第一行。</p><p>拼接的简写形式 <code>+=</code> 也可以用于字符串：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>s <span class="token operator">:=</span> <span class="token string">&quot;hel&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;lo,&quot;</span>
s <span class="token operator">+=</span> <span class="token string">&quot;world!&quot;</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token comment">//输出 “hello, world!”</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在循环中使用加号 <code>+</code> 拼接字符串并不是最高效的做法，更好的办法是使用函数 <code>strings.Join()</code>（<a href="">第 4.7.10 节</a>），有没有更好的办法了？有！使用字节缓冲（<code>bytes.Buffer</code>）拼接更加给力（<a href="">第 7.2.6 节</a>）！</p><p>在<a href="">第 7 章</a>，我们会讲到通过将字符串看作是字节 (<code>byte</code>) 的切片 (slice) 来实现对其标准索引法的操作。会在<a href="">第 5.4.1 节</a> 中讲到的 <code>for</code> 循环只会根据索引返回字符串中的纯字节，而在<a href="">第 5.4.4 节</a>（以及<a href="">第 7.6.1 节</a> 的示例）将会展示如何使用 for-range 循环来实现对 Unicode 字符串的迭代操作。在下一节，我们会学习到许多有关字符串操作的函数和方法，同时 <code>fmt</code> 包中的 <code>fmt.Sprint(x)</code> 也可以格式化生成并返回你所需要的字符串（<a href="">第 4.4.3 节</a>）。</p><p><strong>练习 4.6</strong> <a href="exercises/chapter_4/count_characters.go">count_characters.go</a></p><p>创建一个用于统计字节和字符 (rune) 的程序，并对字符串 <code>asSASA ddd dsjkdsjs dk</code> 进行分析，然后再分析 <code>asSASA ddd dsjkdsjsこん dk</code>，最后解释两者不同的原因（提示：使用 <code>unicode/utf8</code> 包）。</p><h3 id="_4-7-strings-和-strconv-包" tabindex="-1"><a class="header-anchor" href="#_4-7-strings-和-strconv-包" aria-hidden="true">#</a> 4.7 strings 和 strconv 包</h3><p>作为一种基本数据结构，每种语言都有一些对于字符串的预定义处理函数。Go 中使用 <code>strings</code> 包来完成对字符串的主要操作。</p><h4 id="_4-7-1-前缀和后缀" tabindex="-1"><a class="header-anchor" href="#_4-7-1-前缀和后缀" aria-hidden="true">#</a> 4.7.1 前缀和后缀</h4><p><code>HasPrefix()</code> 判断字符串 <code>s</code> 是否以 <code>prefix</code> 开头：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> prefix <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>HasSuffix()</code> 判断字符串 <code>s</code> 是否以 <code>suffix</code> 结尾：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>strings<span class="token punctuation">.</span><span class="token function">HasSuffix</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> suffix <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>示例 4.13 <a href="examples/chapter_4/presuffix.go">presuffix.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;strings&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> str <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">&quot;This is an example of a string&quot;</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;T/F? Does the string \\&quot;%s\\&quot; have prefix %s? &quot;</span><span class="token punctuation">,</span> str<span class="token punctuation">,</span> <span class="token string">&quot;Th&quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%t\\n&quot;</span><span class="token punctuation">,</span> strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">&quot;Th&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>T/F? Does the string &quot;This is an example of a string&quot; have prefix Th? true
</code></pre><p>这个例子同样演示了转义字符 <code>\\</code> 和格式化字符串的使用。</p><h4 id="_4-7-2-字符串包含关系" tabindex="-1"><a class="header-anchor" href="#_4-7-2-字符串包含关系" aria-hidden="true">#</a> 4.7.2 字符串包含关系</h4><p><code>Contains()</code> 判断字符串 <code>s</code> 是否包含 <code>substr</code>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> substr <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="_4-7-3-判断子字符串或字符在父字符串中出现的位置-索引" tabindex="-1"><a class="header-anchor" href="#_4-7-3-判断子字符串或字符在父字符串中出现的位置-索引" aria-hidden="true">#</a> 4.7.3 判断子字符串或字符在父字符串中出现的位置（索引）</h4><p><code>Index()</code> 返回字符串 <code>str</code> 在字符串 <code>s</code> 中的索引（<code>str</code> 的第一个字符的索引），<code>-1</code> 表示字符串 <code>s</code> 不包含字符串 <code>str</code>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>strings<span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> str <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">int</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>LastIndex()</code> 返回字符串 <code>str</code> 在字符串 <code>s</code> 中最后出现位置的索引（<code>str</code> 的第一个字符的索引），<code>-1</code> 表示字符串 <code>s</code> 不包含字符串 <code>str</code>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>strings<span class="token punctuation">.</span><span class="token function">LastIndex</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> str <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">int</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>如果需要查询非 ASCII 编码的字符在父字符串中的位置，建议使用以下函数来对字符进行定位：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>strings<span class="token punctuation">.</span><span class="token function">IndexRune</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">,</span> r <span class="token builtin">rune</span><span class="token punctuation">)</span> <span class="token builtin">int</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><pre><code>注: 原文为 &quot;If ch is a non-ASCII character use strings.IndexRune(s string, ch int) int.&quot;
该方法在最新版本的 Go 中定义为 func IndexRune(s string, r rune) int
实际使用中的第二个参数 rune 可以是 rune 或 int, 例如 strings.IndexRune(&quot;chicken&quot;, 99) 或 strings.IndexRune(&quot;chicken&quot;, rune(&#39;k&#39;))
</code></pre><p>示例 4.14 <a href="examples/chapter_4/index_in_string.go">index_in_string.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;strings&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> str <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">&quot;Hi, I&#39;m Marc, Hi.&quot;</span>

	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The position of \\&quot;Marc\\&quot; is: &quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d\\n&quot;</span><span class="token punctuation">,</span> strings<span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">&quot;Marc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The position of the first instance of \\&quot;Hi\\&quot; is: &quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d\\n&quot;</span><span class="token punctuation">,</span> strings<span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">&quot;Hi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The position of the last instance of \\&quot;Hi\\&quot; is: &quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d\\n&quot;</span><span class="token punctuation">,</span> strings<span class="token punctuation">.</span><span class="token function">LastIndex</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">&quot;Hi&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The position of \\&quot;Burger\\&quot; is: &quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d\\n&quot;</span><span class="token punctuation">,</span> strings<span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">&quot;Burger&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>The position of &quot;Marc&quot; is: 8
The position of the first instance of &quot;Hi&quot; is: 0
The position of the last instance of &quot;Hi&quot; is: 14
The position of &quot;Burger&quot; is: -1
</code></pre><h4 id="_4-7-4-字符串替换" tabindex="-1"><a class="header-anchor" href="#_4-7-4-字符串替换" aria-hidden="true">#</a> 4.7.4 字符串替换</h4><p><code>Replace()</code> 用于将字符串 <code>str</code> 中的前 <code>n</code> 个字符串 <code>old</code> 替换为字符串 <code>new</code>，并返回一个新的字符串，如果 <code>n = -1</code> 则替换所有字符串 <code>old</code> 为字符串 <code>new</code>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>strings<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> old<span class="token punctuation">,</span> <span class="token builtin">new</span> <span class="token builtin">string</span><span class="token punctuation">,</span> n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="_4-7-5-统计字符串出现次数" tabindex="-1"><a class="header-anchor" href="#_4-7-5-统计字符串出现次数" aria-hidden="true">#</a> 4.7.5 统计字符串出现次数</h4><p><code>Count()</code> 用于计算字符串 <code>str</code> 在字符串 <code>s</code> 中出现的非重叠次数：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>strings<span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> str <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">int</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>示例 4.15 <a href="examples/chapter_4/count_substring.go">count_substring.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;strings&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> str <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">&quot;Hello, how is it going, Hugo?&quot;</span>
	<span class="token keyword">var</span> manyG <span class="token operator">=</span> <span class="token string">&quot;gggggggggg&quot;</span>

	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Number of H&#39;s in %s is: &quot;</span><span class="token punctuation">,</span> str<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d\\n&quot;</span><span class="token punctuation">,</span> strings<span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">&quot;H&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Number of double g&#39;s in %s is: &quot;</span><span class="token punctuation">,</span> manyG<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d\\n&quot;</span><span class="token punctuation">,</span> strings<span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span>manyG<span class="token punctuation">,</span> <span class="token string">&quot;gg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>Number of H&#39;s in Hello, how is it going, Hugo? is: 2
Number of double g’s in gggggggggg is: 5
</code></pre><h4 id="_4-7-6-重复字符串" tabindex="-1"><a class="header-anchor" href="#_4-7-6-重复字符串" aria-hidden="true">#</a> 4.7.6 重复字符串</h4><p><code>Repeat()</code> 用于重复 <code>count</code> 次字符串 <code>s</code> 并返回一个新的字符串：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>strings<span class="token punctuation">.</span><span class="token function">Repeat</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> count <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>示例 4.16 <a href="examples/chapter_4/repeat_string.go">repeat_string.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;strings&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> origS <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">&quot;Hi there! &quot;</span>
	<span class="token keyword">var</span> newS <span class="token builtin">string</span>

	newS <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">Repeat</span><span class="token punctuation">(</span>origS<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The new repeated string is: %s\\n&quot;</span><span class="token punctuation">,</span> newS<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>The new repeated string is: Hi there! Hi there! Hi there!
</code></pre><h4 id="_4-7-7-修改字符串大小写" tabindex="-1"><a class="header-anchor" href="#_4-7-7-修改字符串大小写" aria-hidden="true">#</a> 4.7.7 修改字符串大小写</h4><p><code>ToLower()</code> 将字符串中的 Unicode 字符全部转换为相应的小写字符：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>strings<span class="token punctuation">.</span><span class="token function">ToLower</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token builtin">string</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>ToUpper()</code> 将字符串中的 Unicode 字符全部转换为相应的大写字符：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>strings<span class="token punctuation">.</span><span class="token function">ToUpper</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token builtin">string</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>示例 4.17 <a href="examples/chapter_4/toupper_lower.go">toupper_lower.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;strings&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> orig <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">&quot;Hey, how are you George?&quot;</span>
	<span class="token keyword">var</span> lower <span class="token builtin">string</span>
	<span class="token keyword">var</span> upper <span class="token builtin">string</span>

	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The original string is: %s\\n&quot;</span><span class="token punctuation">,</span> orig<span class="token punctuation">)</span>
	lower <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">ToLower</span><span class="token punctuation">(</span>orig<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The lowercase string is: %s\\n&quot;</span><span class="token punctuation">,</span> lower<span class="token punctuation">)</span>
	upper <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">ToUpper</span><span class="token punctuation">(</span>orig<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The uppercase string is: %s\\n&quot;</span><span class="token punctuation">,</span> upper<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>The original string is: Hey, how are you George?
The lowercase string is: hey, how are you george?
The uppercase string is: HEY, HOW ARE YOU GEORGE?
</code></pre><h4 id="_4-7-8-修剪字符串" tabindex="-1"><a class="header-anchor" href="#_4-7-8-修剪字符串" aria-hidden="true">#</a> 4.7.8 修剪字符串</h4><p>你可以使用 <code>strings.TrimSpace(s)</code> 来剔除字符串开头和结尾的空白符号；如果你想要剔除指定字符，则可以使用 <code>strings.Trim(s, &quot;cut&quot;)</code> 来将开头和结尾的 <code>cut</code> 去除掉。该函数的第二个参数可以包含任何字符，如果你只想剔除开头或者结尾的字符串，则可以使用 <code>TrimLeft()</code> 或者 <code>TrimRight()</code> 来实现。</p><h4 id="_4-7-9-分割字符串" tabindex="-1"><a class="header-anchor" href="#_4-7-9-分割字符串" aria-hidden="true">#</a> 4.7.9 分割字符串</h4><p><code>strings.Fields(s)</code> 将会利用 1 个或多个空白符号来作为动态长度的分隔符将字符串分割成若干小块，并返回一个 slice，如果字符串只包含空白符号，则返回一个长度为 0 的 slice。</p><p><code>strings.Split(s, sep)</code> 用于自定义分割符号来对指定字符串进行分割，同样返回 slice。</p><p>因为这 2 个函数都会返回 slice，所以习惯使用 for-range 循环来对其进行处理（第 7.3 节）。</p><h4 id="_4-7-10-拼接-slice-到字符串" tabindex="-1"><a class="header-anchor" href="#_4-7-10-拼接-slice-到字符串" aria-hidden="true">#</a> 4.7.10 拼接 slice 到字符串</h4><p><code>Join()</code> 用于将元素类型为 string 的 slice 使用分割符号来拼接组成一个字符串：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>strings<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>sl <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> sep <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>示例 4.18 <a href="examples/chapter_4/strings_splitjoin.go">strings_splitjoin.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;strings&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	str <span class="token operator">:=</span> <span class="token string">&quot;The quick brown fox jumps over the lazy dog&quot;</span>
	sl <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Fields</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Splitted in slice: %v\\n&quot;</span><span class="token punctuation">,</span> sl<span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> val <span class="token operator">:=</span> <span class="token keyword">range</span> sl <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s - &quot;</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	str2 <span class="token operator">:=</span> <span class="token string">&quot;GO1|The ABC of Go|25&quot;</span>
	sl2 <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>str2<span class="token punctuation">,</span> <span class="token string">&quot;|&quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Splitted in slice: %v\\n&quot;</span><span class="token punctuation">,</span> sl2<span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> val <span class="token operator">:=</span> <span class="token keyword">range</span> sl2 <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s - &quot;</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	str3 <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>sl2<span class="token punctuation">,</span><span class="token string">&quot;;&quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;sl2 joined by ;: %s\\n&quot;</span><span class="token punctuation">,</span> str3<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>Splitted in slice: [The quick brown fox jumps over the lazy dog]
The - quick - brown - fox - jumps - over - the - lazy - dog -
Splitted in slice: [GO1 The ABC of Go 25]
GO1 - The ABC of Go - 25 -
sl2 joined by ;: GO1;The ABC of Go;25
</code></pre>`,119),Ja={href:"http://golang.org/pkg/strings/",target:"_blank",rel:"noopener noreferrer"},Xa={href:"http://docs.studygolang.com/pkg/strings/",target:"_blank",rel:"noopener noreferrer"},Ka=t(`<h4 id="_4-7-11-从字符串中读取内容" tabindex="-1"><a class="header-anchor" href="#_4-7-11-从字符串中读取内容" aria-hidden="true">#</a> 4.7.11 从字符串中读取内容</h4><p>函数 <code>strings.NewReader(str)</code> 用于生成一个 <code>Reader</code> 并读取字符串中的内容，然后返回指向该 <code>Reader</code> 的指针，从其它类型读取内容的函数还有：</p><ul><li><code>Read()</code> 从 <code>[]byte</code> 中读取内容。</li><li><code>ReadByte()</code> 和 <code>ReadRune()</code> 从字符串中读取下一个 <code>byte</code> 或者 <code>rune</code>。</li></ul><h4 id="_4-7-12-字符串与其它类型的转换" tabindex="-1"><a class="header-anchor" href="#_4-7-12-字符串与其它类型的转换" aria-hidden="true">#</a> 4.7.12 字符串与其它类型的转换</h4><p>与字符串相关的类型转换都是通过 <code>strconv</code> 包实现的。</p><p>该包包含了一些变量用于获取程序运行的操作系统平台下 <code>int</code> 类型所占的位数，如：<code>strconv.IntSize</code>。</p><p>任何类型 <strong><code>T</code></strong> 转换为字符串总是成功的。</p><p>针对从数字类型转换到字符串，Go 提供了以下函数：</p><ul><li><code>strconv.Itoa(i int) string</code> 返回数字 <code>i</code> 所表示的字符串类型的十进制数。</li><li><code>strconv.FormatFloat(f float64, fmt byte, prec int, bitSize int) string</code> 将 64 位浮点型的数字转换为字符串，其中 <code>fmt</code> 表示格式（其值可以是 <code>&#39;b&#39;</code>、<code>&#39;e&#39;</code>、<code>&#39;f&#39;</code> 或 <code>&#39;g&#39;</code>），<code>prec</code> 表示精度，<code>bitSize</code> 则使用 32 表示 <code>float32</code>，用 64 表示 <code>float64</code>。</li></ul><p>将字符串转换为其它类型 <strong><code>tp</code></strong> 并不总是可能的，可能会在运行时抛出错误 <code>parsing &quot;…&quot;: invalid argument</code>。</p><p>针对从字符串类型转换为数字类型，Go 提供了以下函数：</p><ul><li><code>strconv.Atoi(s string) (i int, err error)</code> 将字符串转换为 <code>int</code> 型。</li><li><code>strconv.ParseFloat(s string, bitSize int) (f float64, err error)</code> 将字符串转换为 <code>float64</code> 型。</li></ul><p>利用多返回值的特性，这些函数会返回 2 个值，第 1 个是转换后的结果（如果转换成功），第 2 个是可能出现的错误，因此，我们一般使用以下形式来进行从字符串到其它类型的转换：</p><pre><code>val, err = strconv.Atoi(s)
</code></pre><p>在下面这个示例中，我们忽略可能出现的转换错误：</p><p>示例 4.19 <a href="examples/chapter_4/string_conversion.go">string_conversion.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;strconv&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> orig <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">&quot;666&quot;</span>
	<span class="token keyword">var</span> an <span class="token builtin">int</span>
	<span class="token keyword">var</span> newS <span class="token builtin">string</span>

	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The size of ints is: %d\\n&quot;</span><span class="token punctuation">,</span> strconv<span class="token punctuation">.</span>IntSize<span class="token punctuation">)</span>	  

	an<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> strconv<span class="token punctuation">.</span><span class="token function">Atoi</span><span class="token punctuation">(</span>orig<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The integer is: %d\\n&quot;</span><span class="token punctuation">,</span> an<span class="token punctuation">)</span> 
	an <span class="token operator">=</span> an <span class="token operator">+</span> <span class="token number">5</span>
	newS <span class="token operator">=</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>an<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The new string is: %s\\n&quot;</span><span class="token punctuation">,</span> newS<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>64 位系统：
The size of ints is: 64
32 位系统：
The size of ints is: 32
The integer is: 666
The new string is: 671
</code></pre><p>在第 5.1 节，我们将会利用 <code>if</code> 语句来对可能出现的错误进行分类处理。</p>`,20),$a={href:"http://golang.org/pkg/strconv/",target:"_blank",rel:"noopener noreferrer"},Ya={href:"http://docs.studygolang.com/pkg/strconv/",target:"_blank",rel:"noopener noreferrer"},Za=t(`<h3 id="_4-8-时间和日期" tabindex="-1"><a class="header-anchor" href="#_4-8-时间和日期" aria-hidden="true">#</a> 4.8 时间和日期</h3><p><code>time</code> 包为我们提供了一个数据类型 <code>time.Time</code>（作为值使用）以及显示和测量时间和日期的功能函数。</p><p>当前时间可以使用 <code>time.Now()</code> 获取，或者使用 <code>t.Day()</code>、<code>t.Minute()</code> 等等来获取时间的一部分；你甚至可以自定义时间格式化字符串，例如： <code>fmt.Printf(&quot;%02d.%02d.%4d\\n&quot;, t.Day(), t.Month(), t.Year())</code> 将会输出 <code>21.07.2011</code>。</p><p><code>Duration</code> 类型表示两个连续时刻所相差的纳秒数，类型为 <code>int64</code>。<code>Location</code> 类型映射某个时区的时间，UTC 表示通用协调世界时间。</p><p>包中的一个预定义函数 <code>func (t Time) Format(layout string) string</code> 可以根据一个格式化字符串来将一个时间 <code>t</code> 转换为相应格式的字符串，你可以使用一些预定义的格式，如：<code>time.ANSIC</code> 或 <code>time.RFC822</code>。</p><p>一般的格式化设计是通过对于一个标准时间的格式化描述来展现的，这听起来很奇怪（<code>02 Jan 2006 15:04</code> 是 Go 语言的诞生时间且自定义格式化时必须以此时间为基准），但看下面这个例子你就会一目了然：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">&quot;02 Jan 2006 15:04&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>输出：</p><pre><code>21 Jul 2011 10:31
</code></pre>`,9),Qa={href:"http://golang.org/pkg/time/",target:"_blank",rel:"noopener noreferrer"},ne={href:"http://docs.studygolang.com/pkg/time/",target:"_blank",rel:"noopener noreferrer"},se=t(`<p>示例 4.20 <a href="examples/chapter_4/time.go">time.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> week time<span class="token punctuation">.</span>Duration
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	t <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token comment">// e.g. Wed Dec 21 09:52:14 +0100 RST 2011</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%02d.%02d.%4d\\n&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">Day</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">Month</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">Year</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">// 21.12.2011</span>
	t <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">UTC</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token comment">// Wed Dec 21 08:52:14 +0000 UTC 2011</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// Wed Dec 21 09:52:14 +0100 RST 2011</span>
	<span class="token comment">// calculating times:</span>
	week <span class="token operator">=</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">7</span> <span class="token operator">*</span> <span class="token number">1e9</span> <span class="token comment">// must be in nanosec</span>
	week_from_now <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span>week<span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>week_from_now<span class="token punctuation">)</span> <span class="token comment">// Wed Dec 28 08:52:14 +0000 UTC 2011</span>
	<span class="token comment">// formatting times:</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>RFC822<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 21 Dec 11 0852 UTC</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>ANSIC<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// Wed Dec 21 08:56:34 2011</span>
	<span class="token comment">// The time must be 2006-01-02 15:04:05</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">&quot;02 Jan 2006 15:04&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 21 Dec 2011 08:52</span>
	s <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">&quot;20060102&quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">&quot;=&gt;&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span>
	<span class="token comment">// Wed Dec 21 08:52:14 +0000 UTC 2011 =&gt; 20111221</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出的结果已经写在每行 <code>//</code> 的后面。</p><p>如果你需要在应用程序在经过一定时间或周期执行某项任务（事件处理的特例），则可以使用 <code>time.After()</code> 或者 <code>time.Ticker</code>：我们将会在 <a href="">第 14.5 节</a> 讨论这些有趣的事情。 另外，<code>time.Sleep(d Duration)</code> 可以实现对某个进程（实质上是 goroutine）时长为 <code>d</code> 的暂停。</p><h3 id="_4-9-指针" tabindex="-1"><a class="header-anchor" href="#_4-9-指针" aria-hidden="true">#</a> 4.9 指针</h3><p>不像 Java 和 .NET，Go 语言为程序员提供了控制数据结构的指针的能力；但是，你不能进行指针运算。通过给予程序员基本内存布局，Go 语言允许你控制特定集合的数据结构、分配的数量以及内存访问模式，这些对构建运行良好的系统是非常重要的：指针对于性能的影响是不言而喻的，而如果你想要做的是系统编程、操作系统或者网络应用，指针更是不可或缺的一部分。</p><p>由于各种原因，指针对于使用面向对象编程的现代程序员来说可能显得有些陌生，不过我们将会在这一小节对此进行解释，并在未来的章节中展开深入讨论。</p><p>程序在内存中存储它的值，每个内存块（或字）有一个地址，通常用十六进制数表示，如：<code>0x6b0820</code> 或 <code>0xf84001d7f0</code>。</p><p>Go 语言的取地址符是 <code>&amp;</code>，放到一个变量前使用就会返回相应变量的内存地址。</p><p>下面的代码片段（示例 4.9 <a href="examples/chapter_4/pointer.go">pointer.go</a>）可能输出 <code>An integer: 5, its location in memory: 0x6b0820</code>（这个值随着你每次运行程序而变化）。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> i1 <span class="token operator">=</span> <span class="token number">5</span>
fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;An integer: %d, it&#39;s location in memory: %p\\n&quot;</span><span class="token punctuation">,</span> i1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>i1<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>这个地址可以存储在一个叫做指针的特殊数据类型中，在本例中这是一个指向 int 的指针，即 <code>i1</code>：此处使用 <code>*int</code> 表示。如果我们想调用指针 <code>intP</code>，我们可以这样声明它：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> intP <span class="token operator">*</span><span class="token builtin">int</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>然后使用 <code>intP = &amp;i1</code> 是合法的，此时 <code>intP</code> 指向 <code>i1</code>。</p><p>（指针的格式化标识符为 <code>%p</code>）</p><p><code>intP</code> 存储了 <code>i1</code> 的内存地址；它指向了 <code>i1</code> 的位置，它引用了变量 <code>i1</code>。</p><p><strong>一个指针变量可以指向任何一个值的内存地址</strong> 它指向那个值的内存地址，在 32 位机器上占用 4 个字节，在 64 位机器上占用 8 个字节，并且与它所指向的值的大小无关。当然，可以声明指针指向任何类型的值来表明它的原始性或结构性；你可以在指针类型前面加上 <code>*</code> 号（前缀）来获取指针所指向的内容，这里的 <code>*</code> 号是一个类型更改器。使用一个指针引用一个值被称为间接引用。</p><p>当一个指针被定义后没有分配到任何变量时，它的值为 <code>nil</code>。</p><p>一个指针变量通常缩写为 <code>ptr</code>。</p><p><strong>注意事项</strong></p><p>在书写表达式类似 <code>var p *type</code> 时，切记在 * 号和指针名称间留有一个空格，因为 <code>- var p*type</code> 是语法正确的，但是在更复杂的表达式中，它容易被误认为是一个乘法表达式！</p><p>符号 * 可以放在一个指针前，如 <code>*intP</code>，那么它将得到这个指针指向地址上所存储的值；这被称为反引用（或者内容或者间接引用）操作符；另一种说法是指针转移。</p><p>对于任何一个变量 <code>var</code>， 如下表达式都是正确的：<code>var == *(&amp;var)</code>。</p><p>现在，我们应当能理解 pointer.go 的全部内容及其输出：</p><p>示例 4.21 <a href="examples/chapter_4/pointer.go">pointer.go</a>:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> i1 <span class="token operator">=</span> <span class="token number">5</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;An integer: %d, its location in memory: %p\\n&quot;</span><span class="token punctuation">,</span> i1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>i1<span class="token punctuation">)</span>
	<span class="token keyword">var</span> intP <span class="token operator">*</span><span class="token builtin">int</span>
	intP <span class="token operator">=</span> <span class="token operator">&amp;</span>i1
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The value at memory location %p is %d\\n&quot;</span><span class="token punctuation">,</span> intP<span class="token punctuation">,</span> <span class="token operator">*</span>intP<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>An integer: 5, its location in memory: 0x24f0820
The value at memory location 0x24f0820 is 5
</code></pre><p>我们可以用下图来表示内存使用的情况：</p><figure><img src="`+q+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>程序 string_pointer.go 为我们展示了指针对 <code>string</code> 的例子。</p><p>它展示了分配一个新的值给 <code>*p</code> 并且更改这个变量自己的值（这里是一个字符串）。</p><p>示例 4.22 <a href="examples/chapter_4/string_pointer.go">string_pointer.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	s <span class="token operator">:=</span> <span class="token string">&quot;good bye&quot;</span>
	<span class="token keyword">var</span> p <span class="token operator">*</span><span class="token builtin">string</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>s
	<span class="token operator">*</span>p <span class="token operator">=</span> <span class="token string">&quot;ciao&quot;</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Here is the pointer p: %p\\n&quot;</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token comment">// prints address</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Here is the string *p: %s\\n&quot;</span><span class="token punctuation">,</span> <span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token comment">// prints string</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Here is the string s: %s\\n&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span> <span class="token comment">// prints same string</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>Here is the pointer p: 0x2540820
Here is the string *p: ciao
Here is the string s: ciao
</code></pre><p>通过对 <code>*p</code> 赋另一个值来更改“对象”，这样 <code>s</code> 也会随之更改。</p><p>内存示意图如下：</p><figure><img src="`+_+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p><strong>注意事项</strong></p><p>你不能获取字面量或常量的地址，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">const</span> i <span class="token operator">=</span> <span class="token number">5</span>
ptr <span class="token operator">:=</span> <span class="token operator">&amp;</span>i <span class="token comment">//error: cannot take the address of i</span>
ptr2 <span class="token operator">:=</span> <span class="token operator">&amp;</span><span class="token number">10</span> <span class="token comment">//error: cannot take the address of 10</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,42),ae=n("code",null,"pointer+2",-1),ee={href:"http://VB.NET",target:"_blank",rel:"noopener noreferrer"},te=t(`<p>因此 <code>p++</code> 在 Go 语言的代码中是不合法的。</p><p>指针的一个高级应用是你可以传递一个变量的引用（如函数的参数），这样不会传递变量的拷贝。指针传递是很廉价的，只占用 4 个或 8 个字节。当程序在工作中需要占用大量的内存，或很多变量，或者两者都有，使用指针会减少内存占用和提高效率。被指向的变量也保存在内存中，直到没有任何指针指向它们，所以从它们被创建开始就具有相互独立的生命周期。</p><p>另一方面（虽然不太可能），由于一个指针导致的间接引用（一个进程执行了另一个地址），指针的过度频繁使用也会导致性能下降。</p><p>指针也可以指向另一个指针，并且可以进行任意深度的嵌套，导致你可以有多级的间接引用，但在大多数情况这会使你的代码结构不清晰。</p><p>如我们所见，在大多数情况下 Go 语言可以使程序员轻松创建指针，并且隐藏间接引用，如：自动反向引用。</p><p>对一个空指针的反向引用是不合法的，并且会使程序崩溃：</p><p>示例 4.23 <a href="examples/chapter_4/testcrash.go">testcrash.go</a>:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> p <span class="token operator">*</span><span class="token builtin">int</span> <span class="token operator">=</span> <span class="token boolean">nil</span>
	<span class="token operator">*</span>p <span class="token operator">=</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
<span class="token comment">// in Windows: stops only with: &lt;exit code=&quot;-1073741819&quot; msg=&quot;process crashed&quot;/&gt;</span>
<span class="token comment">// runtime error: invalid memory address or nil pointer dereference</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>问题 4.2</strong> 列举 Go 语言中 <code>*</code> 号的所有用法。</p><h2 id="第-5-章-控制结构" tabindex="-1"><a class="header-anchor" href="#第-5-章-控制结构" aria-hidden="true">#</a> 第 5 章：控制结构</h2><p>到目前为止，我们看到的 Go 程序都是从 <code>main()</code> 函数开始执行，然后按顺序执行该函数体中的代码。但我们经常会需要只有在满足一些特定情况时才执行某些代码，也就是说在代码里进行条件判断。针对这种需求，Go 提供了下面这些条件结构和分支结构：</p><ul><li><code>if</code>-<code>else</code> 结构</li><li><code>switch</code> 结构</li><li><code>select</code> 结构，用于 channel 的选择（<a href="">第 14.4 节</a>）</li></ul><p>可以使用迭代或循环结构来重复执行一次或多次某段代码（任务）：</p><ul><li><code>for</code> (<code>range</code>) 结构</li></ul><p>一些如 <code>break</code> 和 <code>continue</code> 这样的关键字可以用于中途改变循环的状态。</p><p>此外，你还可以使用 <code>return</code> 来结束某个函数的执行，或使用 <code>goto</code> 和标签来调整程序的执行位置。</p><p>Go 完全省略了 <code>if</code>、<code>switch</code> 和 <code>for</code> 结构中条件语句两侧的括号，相比 Java、C++ 和 C# 中减少了很多视觉混乱的因素，同时也使你的代码更加简洁。</p><h3 id="_5-1-if-else-结构" tabindex="-1"><a class="header-anchor" href="#_5-1-if-else-结构" aria-hidden="true">#</a> 5.1 if-else 结构</h3><p>if 是用于测试某个条件（布尔型或逻辑型）的语句，如果该条件成立，则会执行 if 后由大括号括起来的代码块，否则就忽略该代码块继续执行后续的代码。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> condition <span class="token punctuation">{</span>
	<span class="token comment">// do something	</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果存在第二个分支，则可以在上面代码的基础上添加 <code>else</code> 关键字以及另一代码块，这个代码块中的代码只有在条件不满足时才会执行。<code>if</code> 和 <code>else</code> 后的两个代码块是相互独立的分支，只可能执行其中一个。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> condition <span class="token punctuation">{</span>
	<span class="token comment">// do something	</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
	<span class="token comment">// do something	</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果存在第三个分支，则可以使用下面这种三个独立分支的形式：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> condition1 <span class="token punctuation">{</span>
	<span class="token comment">// do something	</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> condition2 <span class="token punctuation">{</span>
	<span class="token comment">// do something else	</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
	<span class="token comment">// catch-all or default</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>else-if 分支的数量是没有限制的，但是为了代码的可读性，还是不要在 <code>if</code> 后面加入太多的 else-if 结构。如果你必须使用这种形式，则把尽可能先满足的条件放在前面。</p><p>即使当代码块之间只有一条语句时，大括号也不可被省略（尽管有些人并不赞成，但这还是符合了软件工程原则的主流做法）。</p><p>关键字 <code>if</code> 和 <code>else</code> 之后的左大括号 <code>{</code> 必须和关键字在同一行，如果你使用了 else-if 结构，则前段代码块的右大括号 <code>}</code> 必须和 else-if 关键字在同一行。这两条规则都是被编译器强制规定的。</p><p>非法的 Go 代码:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> x<span class="token punctuation">{</span>
<span class="token punctuation">}</span>
<span class="token keyword">else</span> <span class="token punctuation">{</span>	<span class="token comment">// 无效的</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>要注意的是，在你使用 <code>gofmt</code> 格式化代码之后，每个分支内的代码都会缩进 4 个或 8 个空格，或者是 1 个 tab，并且右大括号与对应的 <code>if</code> 关键字垂直对齐。</p><p>在有些情况下，条件语句两侧的括号是可以被省略的；当条件比较复杂时，则可以使用括号让代码更易读。条件允许是符合条件，需使用 <code>&amp;&amp;</code>、<code>||</code> 或 <code>!</code>，你可以使用括号来提升某个表达式的运算优先级，并提高代码的可读性。</p><p>一种可能用到条件语句的场景是测试变量的值，在不同的情况执行不同的语句，不过将在第 5.3 节讲到的 switch 结构会更适合这种情况。</p><p>示例 5.1 <a href="examples/chapter_5/booleans.go">booleans.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	bool1 <span class="token operator">:=</span> <span class="token boolean">true</span>
	<span class="token keyword">if</span> bool1 <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The value is true\\n&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The value is false\\n&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>The value is true
</code></pre><p><strong>注意事项</strong> 这里不需要使用 <code>if bool1 == true</code> 来判断，因为 <code>bool1</code> 本身已经是一个布尔类型的值。</p><p>这种做法一般都用在测试 <code>true</code> 或者有利条件时，但你也可以使用取反 <code>!</code> 来判断值的相反结果，如：<code>if !bool1</code> 或者 <code>if !(condition)</code>。后者的括号大多数情况下是必须的，如这种情况：<code>if !(var1 == var2)</code>。</p><p>当 if 结构内有 <code>break</code>、<code>continue</code>、<code>goto</code> 或者 <code>return</code> 语句时，Go 代码的常见写法是省略 <code>else</code> 部分（另见<a href="">第 5.2 节</a>）。无论满足哪个条件都会返回 <code>x</code> 或者 <code>y</code> 时，一般使用以下写法：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> condition <span class="token punctuation">{</span>
	<span class="token keyword">return</span> x
<span class="token punctuation">}</span>
<span class="token keyword">return</span> y
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>注意事项</strong> 不要同时在 if-else 结构的两个分支里都使用 <code>return</code> 语句，这将导致编译报错 <code>function ends without a return statement</code>（你可以认为这是一个编译器的 Bug 或者特性）。（ <strong>译者注：该问题已经在 Go 1.1 中被修复或者说改进</strong> ）</p><p>这里举一些有用的例子：</p><ol><li><p>判断一个字符串是否为空：</p><ul><li><code>if str == &quot;&quot; { ... }</code></li><li><code>if len(str) == 0 {...}</code></li></ul></li><li><p>判断运行 Go 程序的操作系统类型，这可以通过常量 <code>runtime.GOOS</code> 来判断（<a href="">第 2.2 节</a>）。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> runtime<span class="token punctuation">.</span>GOOS <span class="token operator">==</span> <span class="token string">&quot;windows&quot;</span>	 <span class="token punctuation">{</span>
	<span class="token punctuation">.</span>	<span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// Unix-like</span>
	<span class="token punctuation">.</span>	<span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这段代码一般被放在 <code>init()</code> 函数中执行。这儿还有一段示例来演示如何根据操作系统来决定输入结束的提示：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> prompt <span class="token operator">=</span> <span class="token string">&quot;Enter a digit, e.g. 3 &quot;</span><span class="token operator">+</span> <span class="token string">&quot;or %s to quit.&quot;</span>

<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> runtime<span class="token punctuation">.</span>GOOS <span class="token operator">==</span> <span class="token string">&quot;windows&quot;</span> <span class="token punctuation">{</span>
		prompt <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span>prompt<span class="token punctuation">,</span> <span class="token string">&quot;Ctrl+Z, Enter&quot;</span><span class="token punctuation">)</span>		
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">//Unix-like</span>
		prompt <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span>prompt<span class="token punctuation">,</span> <span class="token string">&quot;Ctrl+D&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>函数 <code>Abs()</code> 用于返回一个整型数字的绝对值:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Abs</span><span class="token punctuation">(</span>x <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
<span class="token keyword">if</span> x <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">-</span>x
<span class="token punctuation">}</span>
<span class="token keyword">return</span> x	
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><code>isGreater</code> 用于比较两个整型数字的大小:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">isGreater</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> x <span class="token operator">&gt;</span> y <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span>	
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><p>在第四种情况中，<code>if</code> 可以包含一个初始化语句（如：给一个变量赋值）。这种写法具有固定的格式（在初始化语句后方必须加上分号）：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> initialization<span class="token punctuation">;</span> condition <span class="token punctuation">{</span>
	<span class="token comment">// do something</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>例如:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>val <span class="token operator">:=</span> <span class="token number">10</span>
<span class="token keyword">if</span> val <span class="token operator">&gt;</span> max <span class="token punctuation">{</span>
	<span class="token comment">// do something</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>你也可以这样写:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> val <span class="token operator">:=</span> <span class="token number">10</span><span class="token punctuation">;</span> val <span class="token operator">&gt;</span> max <span class="token punctuation">{</span>
	<span class="token comment">// do something</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>但要注意的是，使用简短方式 <code>:=</code> 声明的变量的作用域只存在于 <code>if</code> 结构中（在 <code>if</code> 结构的大括号之间，如果使用 if-else 结构则在 <code>else</code> 代码块中变量也会存在）。如果变量在 <code>if</code> 结构之前就已经存在，那么在 <code>if</code> 结构中，该变量原来的值会被隐藏。最简单的解决方案就是不要在初始化语句中声明变量（见<a href="">5.2 节的例 3</a> 了解更多)。</p><p>示例 5.2 <a href="examples/chapter_5/ifelse.go">ifelse.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> first <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">10</span>
	<span class="token keyword">var</span> cond <span class="token builtin">int</span>

	<span class="token keyword">if</span> first <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;first is less than or equal to 0\\n&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> first <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> first <span class="token operator">&lt;</span> <span class="token number">5</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;first is between 0 and 5\\n&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;first is 5 or greater\\n&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> cond <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span> cond <span class="token operator">&gt;</span> <span class="token number">10</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;cond is greater than 10\\n&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;cond is not greater than 10\\n&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>first is 5 or greater
cond is not greater than 10
</code></pre><p>下面的代码片段展示了如何通过在初始化语句中获取函数 <code>process()</code> 的返回值，并在条件语句中作为判定条件来决定是否执行 <code>if</code> 结构中的代码：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> value <span class="token operator">:=</span> <span class="token function">process</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> value <span class="token operator">&gt;</span> max <span class="token punctuation">{</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-测试多返回值函数的错误" tabindex="-1"><a class="header-anchor" href="#_5-2-测试多返回值函数的错误" aria-hidden="true">#</a> 5.2 测试多返回值函数的错误</h3><p>Go 语言的函数经常使用两个返回值来表示执行是否成功：返回某个值以及 <code>true</code> 表示成功；返回零值（或 <code>nil</code>）和 <code>false</code> 表示失败（<a href="">第 4.4 节</a>）。当不使用 <code>true</code> 或 <code>false</code> 的时候，也可以使用一个 <code>error</code> 类型的变量来代替作为第二个返回值：成功执行的话，<code>error</code> 的值为 <code>nil</code>，否则就会包含相应的错误信息（Go 语言中的错误类型为 <code>error</code>: <code>var err error</code>，我们将会在<a href="">第 13 章</a> 进行更多地讨论）。这样一来，就很明显需要用一个 <code>if</code> 语句来测试执行结果；由于其符号的原因，这样的形式又称之为“逗号 ok 模式”(comma, ok pattern)。</p><p>在<a href="">第 4.7 节</a> 的程序 <a href="examples/chapter_4/string_conversion.go">string_conversion.go</a> 中，函数 <code>strconv.Atoi()</code> 的作用是将一个字符串转换为一个整数。之前我们忽略了相关的错误检查：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>anInt<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> strconv<span class="token punctuation">.</span><span class="token function">Atoi</span><span class="token punctuation">(</span>origStr<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>如果 <code>origStr</code> 不能被转换为整数，<code>anInt</code> 的值会变成 <code>0</code> 而 <code>_</code> 无视了错误，程序会继续运行。</p><p>这样做是非常不好的：程序应该在最接近的位置检查所有相关的错误，至少需要暗示用户有错误发生并对函数进行返回，甚至中断程序。</p><p>我们在第二个版本中对代码进行了改进：</p><p>示例 1：</p><p>示例 5.3 <a href="examples/chapter_5/string_conversion2.go">string_conversion2.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;strconv&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> orig <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">&quot;ABC&quot;</span>
	<span class="token comment">// var an int</span>
	<span class="token keyword">var</span> newS <span class="token builtin">string</span>
	<span class="token comment">// var err error</span>

	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The size of ints is: %d\\n&quot;</span><span class="token punctuation">,</span> strconv<span class="token punctuation">.</span>IntSize<span class="token punctuation">)</span>	  
	<span class="token comment">// anInt, err = strconv.Atoi(origStr)</span>
	an<span class="token punctuation">,</span> err <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">Atoi</span><span class="token punctuation">(</span>orig<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;orig %s is not an integer - exiting with error\\n&quot;</span><span class="token punctuation">,</span> orig<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span> 
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The integer is %d\\n&quot;</span><span class="token punctuation">,</span> an<span class="token punctuation">)</span>
	an <span class="token operator">=</span> an <span class="token operator">+</span> <span class="token number">5</span>
	newS <span class="token operator">=</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>an<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The new string is: %s\\n&quot;</span><span class="token punctuation">,</span> newS<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这是测试 <code>err</code> 变量是否包含一个真正的错误（<code>if err != nil</code>）的习惯用法。如果确实存在错误，则会打印相应的错误信息然后通过 <code>return</code> 提前结束函数的执行。我们还可以使用携带返回值的 <code>return</code> 形式，例如 <code>return err</code>。这样一来，函数的调用者就可以检查函数执行过程中是否存在错误了。</p><p><strong>习惯用法</strong></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>value<span class="token punctuation">,</span> err <span class="token operator">:=</span> pack1<span class="token punctuation">.</span><span class="token function">Function1</span><span class="token punctuation">(</span>param1<span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;An error occured in pack1.Function1 with parameter %v&quot;</span><span class="token punctuation">,</span> param1<span class="token punctuation">)</span>
	<span class="token keyword">return</span> err
<span class="token punctuation">}</span>
<span class="token comment">// 未发生错误，继续执行：</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>由于本例的函数调用者属于 <code>main</code> 函数，所以程序会直接停止运行。</p><p>如果我们想要在错误发生的同时终止程序的运行，我们可以使用 <code>os</code> 包的 <code>Exit</code> 函数：</p><p><strong>习惯用法</strong></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Program stopping with error %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（此处的退出代码 <code>1</code> 可以使用外部脚本获取到）</p><p>有时候，你会发现这种习惯用法被连续重复地使用在某段代码中。</p><p>当没有错误发生时，代码继续运行就是唯一要做的事情，所以 <code>if</code> 语句块后面不需要使用 <code>else</code> 分支。</p><p>示例 2：我们尝试通过 <code>os.Open</code> 方法打开一个名为 <code>name</code> 的只读文件：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>f<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> err
<span class="token punctuation">}</span>
<span class="token function">doSomething</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token comment">// 当没有错误发生时，文件对象被传入到某个函数中</span>
doSomething
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>练习 5.1</strong> 尝试改写 <a href="examples/chapter_5/string_conversion2.go">string_conversion2.go</a> 中的代码，要求使用 <code>:=</code> 方法来对 <code>err</code> 进行赋值，哪些地方可以被修改？</p><p>示例 3：可以将错误的获取放置在 <code>if</code> 语句的初始化部分：</p><p><strong>习惯用法</strong></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> err <span class="token operator">:=</span> file<span class="token punctuation">.</span><span class="token function">Chmod</span><span class="token punctuation">(</span><span class="token number">0664</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token keyword">return</span> err
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>示例 4：或者将 ok-pattern 的获取放置在 <code>if</code> 语句的初始化部分，然后进行判断：</p><p><strong>习惯用法</strong></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> value<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token function">readData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
…
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>注意事项</strong></p><p>如果您像下面一样，没有为多返回值的函数准备足够的变量来存放结果：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">mySqrt</span><span class="token punctuation">(</span>f <span class="token builtin">float64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>v <span class="token builtin">float64</span><span class="token punctuation">,</span> ok <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> f <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span> <span class="token comment">// error case</span>
	<span class="token keyword">return</span> math<span class="token punctuation">.</span><span class="token function">Sqrt</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">true</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	t <span class="token operator">:=</span> <span class="token function">mySqrt</span><span class="token punctuation">(</span><span class="token number">25.0</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>您会得到一个编译错误：<code>multiple-value mySqrt() in single-value context</code>。</p><p>正确的做法是：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>t<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token function">mySqrt</span><span class="token punctuation">(</span><span class="token number">25.0</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> ok <span class="token punctuation">{</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>注意事项 2</strong></p><p>当您将字符串转换为整数时，且确定转换一定能够成功时，可以将 <code>Atoi()</code> 函数进行一层忽略错误的封装：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> atoi <span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	n<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> strconv<span class="token punctuation">.</span><span class="token function">Atoi</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实际上，<code>fmt</code> 包（<a href="">第 4.4.3 节</a>）最简单的打印函数也有 2 个返回值：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>count<span class="token punctuation">,</span> err <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token comment">// number of bytes printed, nil or 0, error</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>当打印到控制台时，可以将该函数返回的错误忽略；但当输出到文件流、网络流等具有不确定因素的输出对象时，应该始终检查是否有错误发生（另见<a href="">练习 6.1b</a>）。</p><h3 id="_5-3-switch-结构" tabindex="-1"><a class="header-anchor" href="#_5-3-switch-结构" aria-hidden="true">#</a> 5.3 switch 结构</h3><p>相比较 C 和 Java 等其它语言而言，Go 语言中的 <code>switch</code> 结构使用上更加灵活。它接受任意形式的表达式：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">switch</span> var1 <span class="token punctuation">{</span>
	<span class="token keyword">case</span> val1<span class="token punctuation">:</span>
		<span class="token operator">...</span>
	<span class="token keyword">case</span> val2<span class="token punctuation">:</span>
		<span class="token operator">...</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>变量 <code>var1</code> 可以是任何类型，而 <code>val1</code> 和 <code>val2</code> 则可以是同类型的任意值。类型不被局限于常量或整数，但必须是相同的类型；或者最终结果为相同类型的表达式。前花括号 <code>{</code> 必须和 <code>switch</code> 关键字在同一行。</p><p>您可以同时测试多个可能符合条件的值，使用逗号分割它们，例如：<code>case val1, val2, val3</code>。</p><p>每一个 <code>case</code> 分支都是唯一的，从上至下逐一测试，直到匹配为止。（ Go 语言使用快速的查找算法来测试 <code>switch</code> 条件与 <code>case</code> 分支的匹配情况，直到算法匹配到某个 <code>case</code> 或者进入 <code>default</code> 条件为止。）</p><p>一旦成功地匹配到某个分支，在执行完相应代码后就会退出整个 <code>switch</code> 代码块，也就是说您不需要特别使用 <code>break</code> 语句来表示结束。</p><p>因此，程序也不会自动地去执行下一个分支的代码。如果在执行完每个分支的代码后，还希望继续执行后续分支的代码，可以使用 <code>fallthrough</code> 关键字来达到目的。</p><p>因此：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">switch</span> i <span class="token punctuation">{</span>
	<span class="token keyword">case</span> <span class="token number">0</span><span class="token punctuation">:</span> <span class="token comment">// 空分支，只有当 i == 0 时才会进入分支</span>
	<span class="token keyword">case</span> <span class="token number">1</span><span class="token punctuation">:</span>
		<span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 当 i == 0 时函数不会被调用</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>并且：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">switch</span> i <span class="token punctuation">{</span>
	<span class="token keyword">case</span> <span class="token number">0</span><span class="token punctuation">:</span> <span class="token keyword">fallthrough</span>
	<span class="token keyword">case</span> <span class="token number">1</span><span class="token punctuation">:</span>
		<span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 当 i == 0 时函数也会被调用</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 <code>case ...:</code> 语句之后，您不需要使用花括号将多行语句括起来，但您可以在分支中进行任意形式的编码。当代码块只有一行时，可以直接放置在 <code>case</code> 语句之后。</p><p>您同样可以使用 <code>return</code> 语句来提前结束代码块的执行。当您在 <code>switch</code> 语句块中使用 <code>return</code> 语句，并且您的函数是有返回值的，您还需要在 switch 之后添加相应的 <code>return</code> 语句以确保函数始终会返回。</p><p>可选的 <code>default</code> 分支可以出现在任何顺序，但最好将它放在最后。它的作用类似与 if-else 语句中的 <code>else</code>，表示不符合任何已给出条件时，执行相关语句。</p><p>示例 5.4 <a href="examples/chapter_5/switch1.go">switch1.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> num1 <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">100</span>

	<span class="token keyword">switch</span> num1 <span class="token punctuation">{</span>
	<span class="token keyword">case</span> <span class="token number">98</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">:</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;It&#39;s equal to 98&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token number">100</span><span class="token punctuation">:</span> 
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;It&#39;s equal to 100&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;It&#39;s not equal to 98 or 100&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>It&#39;s equal to 100
</code></pre><p>在第 12.1 节，我们会使用 <code>switch</code> 语句判断从键盘输入的字符（详见<a href="">第 12.2 节</a> 的 <a href="./examples/chapter_12/switch.go">switch.go</a>）。<code>switch</code> 语句的第二种形式是不提供任何被判断的值（实际上默认为判断是否为 <code>true</code>），然后在每个 <code>case</code> 分支中进行测试不同的条件。当任一分支的测试结果为 <code>true</code> 时，该分支的代码会被执行。这看起来非常像链式的 if-else 语句，但是在测试条件非常多的情况下，提供了可读性更好的书写方式。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">switch</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> condition1<span class="token punctuation">:</span>
		<span class="token operator">...</span>
	<span class="token keyword">case</span> condition2<span class="token punctuation">:</span>
		<span class="token operator">...</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">switch</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> i <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
		<span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">case</span> i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
		<span class="token function">f2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">case</span> i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
		<span class="token function">f3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>任何支持进行相等判断的类型都可以作为测试表达式的条件，包括 <code>int</code>、<code>string</code>、指针等。</p><p>示例 5.4 <a href="examples/chapter_5/switch2.go">switch2.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> num1 <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">7</span>

	<span class="token keyword">switch</span> <span class="token punctuation">{</span>
	    <span class="token keyword">case</span> num1 <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
		    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Number is negative&quot;</span><span class="token punctuation">)</span>
	    <span class="token keyword">case</span> num1 <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> num1 <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">:</span>
		    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Number is between 0 and 10&quot;</span><span class="token punctuation">)</span>
	    <span class="token keyword">default</span><span class="token punctuation">:</span>
		    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Number is 10 or greater&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>Number is between 0 and 10
</code></pre><p>switch 语句的第三种形式是包含一个初始化语句：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">switch</span> initialization <span class="token punctuation">{</span>
	<span class="token keyword">case</span> val1<span class="token punctuation">:</span>
		<span class="token operator">...</span>
	<span class="token keyword">case</span> val2<span class="token punctuation">:</span>
		<span class="token operator">...</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这种形式可以非常优雅地进行条件判断：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">switch</span> result <span class="token operator">:=</span> <span class="token function">calculate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> result <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
		<span class="token operator">...</span>
	<span class="token keyword">case</span> result <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
		<span class="token operator">...</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token comment">// 0</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在下面这个代码片段中，变量 <code>a</code> 和 <code>b</code> 被平行初始化，然后作为判断条件：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">switch</span> a<span class="token punctuation">,</span> b <span class="token operator">:=</span> x<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> y<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> a <span class="token operator">&lt;</span> b<span class="token punctuation">:</span> t <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
	<span class="token keyword">case</span> a <span class="token operator">==</span> b<span class="token punctuation">:</span> t <span class="token operator">=</span> <span class="token number">0</span>
	<span class="token keyword">case</span> a <span class="token operator">&gt;</span> b<span class="token punctuation">:</span> t <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>switch</code> 语句还可以被用于 type-switch（详见<a href="">第 11.4 节</a>）来判断某个 <code>interface</code> 变量中实际存储的变量类型。</p><p><strong>问题 5.1：</strong></p><p>请说出下面代码片段输出的结果：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>	k <span class="token operator">:=</span> <span class="token number">6</span>
	<span class="token keyword">switch</span> k <span class="token punctuation">{</span>
	<span class="token keyword">case</span> <span class="token number">4</span><span class="token punctuation">:</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;was &lt;= 4&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">fallthrough</span>
	<span class="token keyword">case</span> <span class="token number">5</span><span class="token punctuation">:</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;was &lt;= 5&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">fallthrough</span>
	<span class="token keyword">case</span> <span class="token number">6</span><span class="token punctuation">:</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;was &lt;= 6&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">fallthrough</span>
	<span class="token keyword">case</span> <span class="token number">7</span><span class="token punctuation">:</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;was &lt;= 7&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">fallthrough</span>
	<span class="token keyword">case</span> <span class="token number">8</span><span class="token punctuation">:</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;was &lt;= 8&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">fallthrough</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;default case&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>练习 5.2：</strong> <a href="exercises/chapter_5/season.go">season.go</a>：</p><p>写一个 <code>Season()</code> 函数，要求接受一个代表月份的数字，然后返回所代表月份所在季节的名称（不用考虑月份的日期）。</p><h3 id="_5-4-for-结构" tabindex="-1"><a class="header-anchor" href="#_5-4-for-结构" aria-hidden="true">#</a> 5.4 for 结构</h3><p>如果想要重复执行某些语句，Go 语言中您只有 <code>for</code> 结构可以使用。不要小看它，这个 <code>for</code> 结构比其它语言中的更为灵活。</p><p><strong>注意事项</strong> 其它许多语言中也没有发现和 do-while 完全对等的 <code>for</code> 结构，可能是因为这种需求并不是那么强烈。</p><h4 id="_5-4-1-基于计数器的迭代" tabindex="-1"><a class="header-anchor" href="#_5-4-1-基于计数器的迭代" aria-hidden="true">#</a> 5.4.1 基于计数器的迭代</h4><p>文件 for1.go 中演示了最简单的基于计数器的迭代，基本形式为：</p><pre><code>for 初始化语句; 条件语句; 修饰语句 {}
</code></pre><p>示例 5.6 <a href="examples/chapter_5/for1.go">for1.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;This is the %d iteration\\n&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>This is the 0 iteration
This is the 1 iteration
This is the 2 iteration
This is the 3 iteration
This is the 4 iteration
</code></pre><p>由花括号括起来的代码块会被重复执行已知次数，该次数是根据计数器（此例为 <code>i</code>）决定的。循环开始前，会执行且仅会执行一次初始化语句 <code>i := 0;</code>；这比在循环之前声明更为简短。紧接着的是条件语句 <code>i &lt; 5;</code>，在每次循环开始前都会进行判断，一旦判断结果为 <code>false</code>，则退出循环体。最后一部分为修饰语句 <code>i++</code>，一般用于增加或减少计数器。</p><p>这三部分组成的循环的头部，它们之间使用分号 <code>;</code> 相隔，但并不需要括号 <code>()</code> 将它们括起来。例如：<code>for (i = 0; i &lt; 10; i++) { }</code>，这是无效的代码！</p><p>同样的，左花括号 <code>{</code> 必须和 for 语句在同一行，计数器的生命周期在遇到右花括号 <code>}</code> 时便终止。一般习惯使用 i、j、z 或 ix 等较短的名称命名计数器。</p><p>特别注意，永远不要在循环体内修改计数器，这在任何语言中都是非常差的实践！</p><p>您还可以在循环中同时使用多个计数器：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">for</span> i<span class="token punctuation">,</span> j <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">,</span> N<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> j<span class="token punctuation">;</span> i<span class="token punctuation">,</span> j <span class="token operator">=</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> j<span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>这得益于 Go 语言具有的平行赋值的特性（可以查看<a href="">第 7 章</a> <a href="./examples/chapter_7/string_reverse.go">string_reverse.go</a> 中反转数组的示例）。</p><p>您可以将两个 for 循环嵌套起来：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">for</span> i<span class="token operator">:=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> j<span class="token operator">:=</span><span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span> j<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token function">println</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果您使用 for 循环迭代一个 Unicode 编码的字符串，会发生什么？</p><p>示例 5.7 <a href="examples/chapter_5/for_string.go">for_string.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	str <span class="token operator">:=</span> <span class="token string">&quot;Go is a beautiful language!&quot;</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The length of str is: %d\\n&quot;</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> ix <span class="token operator">:=</span><span class="token number">0</span><span class="token punctuation">;</span> ix <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span> ix<span class="token operator">++</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Character on position %d is: %c \\n&quot;</span><span class="token punctuation">,</span> ix<span class="token punctuation">,</span> str<span class="token punctuation">[</span>ix<span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	str2 <span class="token operator">:=</span> <span class="token string">&quot;日本語&quot;</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The length of str2 is: %d\\n&quot;</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>str2<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> ix <span class="token operator">:=</span><span class="token number">0</span><span class="token punctuation">;</span> ix <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>str2<span class="token punctuation">)</span><span class="token punctuation">;</span> ix<span class="token operator">++</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Character on position %d is: %c \\n&quot;</span><span class="token punctuation">,</span> ix<span class="token punctuation">,</span> str2<span class="token punctuation">[</span>ix<span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>The length of str is: 27
Character on position 0 is: G 
Character on position 1 is: o 
Character on position 2 is:   
Character on position 3 is: i 
Character on position 4 is: s 
Character on position 5 is:   
Character on position 6 is: a 
Character on position 7 is:   
Character on position 8 is: b 
Character on position 9 is: e 
Character on position 10 is: a 
Character on position 11 is: u 
Character on position 12 is: t 
Character on position 13 is: i 
Character on position 14 is: f 
Character on position 15 is: u 
Character on position 16 is: l 
Character on position 17 is:   
Character on position 18 is: l 
Character on position 19 is: a 
Character on position 20 is: n 
Character on position 21 is: g 
Character on position 22 is: u 
Character on position 23 is: a 
Character on position 24 is: g 
Character on position 25 is: e 
Character on position 26 is: ! 
The length of str2 is: 9
Character on position 0 is: æ 
Character on position 1 is:  
Character on position 2 is: ¥ 
Character on position 3 is: æ 
Character on position 4 is:  
Character on position 5 is: ¬ 
Character on position 6 is: è 
Character on position 7 is: ª 
Character on position 8 is:  
</code></pre><p>如果我们打印 <code>str</code> 和 <code>str2</code> 的长度，会分别得到 <code>27</code> 和 <code>9</code>。</p><p>由此我们可以发现，ASCII 编码的字符占用 1 个字节，既每个索引都指向不同的字符，而非 ASCII 编码的字符（占有 2 到 4 个字节）不能单纯地使用索引来判断是否为同一个字符。我们会在<a href="">第 5.4.4 节</a> 解决这个问题。</p><h5 id="练习题" tabindex="-1"><a class="header-anchor" href="#练习题" aria-hidden="true">#</a> 练习题</h5><p><strong>练习 5.4</strong> <a href="exercises/chapter_5/for_loop.go">for_loop.go</a></p><ol><li>使用 <code>for</code> 结构创建一个简单的循环。要求循环 15 次然后使用 <code>fmt</code> 包来打印计数器的值。</li><li>使用 <code>goto</code> 语句重写循环，要求不能使用 <code>for</code> 关键字。</li></ol><p><strong>练习 5.5</strong> <a href="exercises/chapter_5/for_character.go">for_character.go</a></p><p>创建一个程序，要求能够打印类似下面的结果（尾行达 25 个字符为止）：</p><pre><code>G
GG
GGG
GGGG
GGGGG
GGGGGG
</code></pre><ol><li>使用 2 层嵌套 for 循环。</li><li>仅用 1 层 for 循环以及字符串连接。</li></ol><p><strong>练习 5.6</strong> <a href="exercises/chapter_5/bitwise_complement.go">bitwise_complement.go</a></p><p>使用按位补码从 0 到 10，使用位表达式 <code>%b</code> 来格式化输出。</p><p><strong>练习 5.7</strong> Fizz-Buzz 问题：<a href="exercises/chapter_5/fizzbuzz.go">fizzbuzz.go</a></p><p>写一个从 1 打印到 100 的程序，但是每当遇到 3 的倍数时，不打印相应的数字，但打印一次 &quot;Fizz&quot;。遇到 5 的倍数时，打印 <code>Buzz</code> 而不是相应的数字。对于同时为 3 和 5 的倍数的数，打印 <code>FizzBuzz</code>（提示：使用 switch 语句）。</p><p><strong>练习 5.8</strong> <a href="exercises/chapter_5/rectangle_stars.go">rectangle_stars.go</a></p><p>使用 <code>*</code> 符号打印宽为 20，高为 10 的矩形。</p><h4 id="_5-4-2-基于条件判断的迭代" tabindex="-1"><a class="header-anchor" href="#_5-4-2-基于条件判断的迭代" aria-hidden="true">#</a> 5.4.2 基于条件判断的迭代</h4><p>for 结构的第二种形式是没有头部的条件判断迭代（类似其它语言中的 while 循环），基本形式为：<code>for 条件语句 {}</code>。</p><p>您也可以认为这是没有初始化语句和修饰语句的 for 结构，因此 <code>;;</code> 便是多余的了。</p><p>Listing 5.8 <a href="examples/chapter_5/for2.go">for2.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> i <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">5</span>

	<span class="token keyword">for</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		i <span class="token operator">=</span> i <span class="token operator">-</span> <span class="token number">1</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The variable i is now: %d\\n&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>The variable i is now: 4
The variable i is now: 3
The variable i is now: 2
The variable i is now: 1
The variable i is now: 0
The variable i is now: -1
</code></pre><h4 id="_5-4-3-无限循环" tabindex="-1"><a class="header-anchor" href="#_5-4-3-无限循环" aria-hidden="true">#</a> 5.4.3 无限循环</h4><p>条件语句是可以被省略的，如 <code>i:=0; ; i++</code> 或 <code>for { }</code> 或 <code>for ;; { }</code>（<code>;;</code> 会在使用 gofmt 时被移除）：这些循环的本质就是无限循环。最后一个形式也可以被改写为 <code>for true { }</code>，但一般情况下都会直接写 <code>for { }</code>。</p><p>如果 for 循环的头部没有条件语句，那么就会认为条件永远为 true，因此循环体内必须有相关的条件判断以确保会在某个时刻退出循环。</p><p>想要直接退出循环体，可以使用 break 语句（第 5.5 节）或 return 语句直接返回（第 6.1 节）。</p><p>但这两者之间有所区别，break 只是退出当前的循环体，而 return 语句提前对函数进行返回，不会执行后续的代码。</p><p>无限循环的经典应用是服务器，用于不断等待和接受新的请求。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">for</span> t<span class="token punctuation">,</span> err <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">Token</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span><span class="token punctuation">;</span> t<span class="token punctuation">,</span> err <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">Token</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-4-4-for-range-结构" tabindex="-1"><a class="header-anchor" href="#_5-4-4-for-range-结构" aria-hidden="true">#</a> 5.4.4 for-range 结构</h4><p>这是 Go 特有的一种的迭代结构，您会发现它在许多情况下都非常有用。它可以迭代任何一个集合（包括数组和 <code>map</code>，详见第 <a href="">7</a> 和 <a href="">8</a> 章）。语法上很类似其它语言中的 foreach 语句，但您依旧可以获得每次迭代所对应的索引。一般形式为：<code>for ix, val := range coll { }</code>。</p><p>要注意的是，<code>val</code> 始终为集合中对应索引的值拷贝，因此它一般只具有只读性质，对它所做的任何修改都不会影响到集合中原有的值（<strong>译者注：如果 <code>val</code> 为指针，则会产生指针的拷贝，依旧可以修改集合中的原值</strong>）。一个字符串是 Unicode 编码的字符（或称之为 <code>rune</code>）集合，因此您也可以用它迭代字符串：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">for</span> pos<span class="token punctuation">,</span> char <span class="token operator">:=</span> <span class="token keyword">range</span> str <span class="token punctuation">{</span>
<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>每个 <code>rune</code> 字符和索引在 for-range 循环中是一一对应的。它能够自动根据 UTF-8 规则识别 Unicode 编码的字符。</p><p>示例 5.9 <a href="examples/chapter_5/range_string.go">range_string.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	str <span class="token operator">:=</span> <span class="token string">&quot;Go is a beautiful language!&quot;</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The length of str is: %d\\n&quot;</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> pos<span class="token punctuation">,</span> char <span class="token operator">:=</span> <span class="token keyword">range</span> str <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Character on position %d is: %c \\n&quot;</span><span class="token punctuation">,</span> pos<span class="token punctuation">,</span> char<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	str2 <span class="token operator">:=</span> <span class="token string">&quot;Chinese: 日本語&quot;</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The length of str2 is: %d\\n&quot;</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>str2<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> pos<span class="token punctuation">,</span> char <span class="token operator">:=</span> <span class="token keyword">range</span> str2 <span class="token punctuation">{</span>
    	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;character %c starts at byte position %d\\n&quot;</span><span class="token punctuation">,</span> char<span class="token punctuation">,</span> pos<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;index int(rune) rune    char bytes&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> index<span class="token punctuation">,</span> <span class="token builtin">rune</span> <span class="token operator">:=</span> <span class="token keyword">range</span> str2 <span class="token punctuation">{</span>
    	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%-2d      %d      %U &#39;%c&#39; % X\\n&quot;</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> <span class="token builtin">rune</span><span class="token punctuation">,</span> <span class="token builtin">rune</span><span class="token punctuation">,</span> <span class="token builtin">rune</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token builtin">rune</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>The length of str is: 27
Character on position 0 is: G 
Character on position 1 is: o 
Character on position 2 is:   
Character on position 3 is: i 
Character on position 4 is: s 
Character on position 5 is:   
Character on position 6 is: a 
Character on position 7 is:   
Character on position 8 is: b 
Character on position 9 is: e 
Character on position 10 is: a 
Character on position 11 is: u 
Character on position 12 is: t 
Character on position 13 is: i 
Character on position 14 is: f 
Character on position 15 is: u 
Character on position 16 is: l 
Character on position 17 is:   
Character on position 18 is: l 
Character on position 19 is: a 
Character on position 20 is: n 
Character on position 21 is: g 
Character on position 22 is: u 
Character on position 23 is: a 
Character on position 24 is: g 
Character on position 25 is: e 
Character on position 26 is: ! 

The length of str2 is: 18
character C starts at byte position 0
character h starts at byte position 1
character i starts at byte position 2
character n starts at byte position 3
character e starts at byte position 4
character s starts at byte position 5
character e starts at byte position 6
character : starts at byte position 7
character   starts at byte position 8
character 日 starts at byte position 9
character 本 starts at byte position 12
character 語 starts at byte position 15

index int(rune) rune    char bytes
0       67      U+0043 &#39;C&#39; 43
1       104      U+0068 &#39;h&#39; 68
2       105      U+0069 &#39;i&#39; 69
3       110      U+006E &#39;n&#39; 6E
4       101      U+0065 &#39;e&#39; 65
5       115      U+0073 &#39;s&#39; 73
6       101      U+0065 &#39;e&#39; 65
7       58      U+003A &#39;:&#39; 3A
8       32      U+0020 &#39; &#39; 20
9       26085      U+65E5 &#39;日&#39; E6 97 A5
12      26412      U+672C &#39;本&#39; E6 9C AC
15      35486      U+8A9E &#39;語&#39; E8 AA 9E
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>请将输出结果和 Listing 5.7（<a href="examples/chapter_5/for_string.go">for_string.go</a>）进行对比。</p><p>我们可以看到，常用英文字符使用 1 个字节表示，而汉字（<strong>译者注：严格来说，“Chinese: 日本語”的 Chinese 应该是 Japanese</strong>）使用 3 个字符表示。</p><p><strong>练习 5.9</strong> 以下程序的输出结果是什么？</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> v <span class="token builtin">int</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d &quot;</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span>
	v <span class="token operator">=</span> <span class="token number">5</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>问题 5.2：</strong> 请描述以下 for 循环的输出结果：</p><ol><li></li></ol><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Value of i is now:&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li></li></ol><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Value of i:&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li></li></ol><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>s <span class="token operator">:=</span> <span class="token string">&quot;&quot;</span>
<span class="token keyword">for</span> <span class="token punctuation">;</span> s <span class="token operator">!=</span> <span class="token string">&quot;aaaaa&quot;</span><span class="token punctuation">;</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Value of s:&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span>
	s <span class="token operator">=</span> s <span class="token operator">+</span> <span class="token string">&quot;a&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li></li></ol><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">for</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> s <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span> <span class="token operator">&amp;&amp;</span> j <span class="token operator">&lt;</span> <span class="token number">100</span> <span class="token operator">&amp;&amp;</span> s <span class="token operator">!=</span> <span class="token string">&quot;aaaaa&quot;</span><span class="token punctuation">;</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span>
	s <span class="token operator">=</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> j<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> s <span class="token operator">+</span> <span class="token string">&quot;a&quot;</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Value of i, j, s:&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> s<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-5-break-与-continue" tabindex="-1"><a class="header-anchor" href="#_5-5-break-与-continue" aria-hidden="true">#</a> 5.5 break 与 continue</h3><p>您可以使用 <code>break</code> 语句重写 <a href="examples/chapter_5/for2.go">for2.go</a> 的代码：</p><p>示例 5.10 <a href="examples/chapter_5/for3.go">for3.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">for</span> <span class="token punctuation">{</span>
	i <span class="token operator">=</span> i <span class="token operator">-</span> <span class="token number">1</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The variable i is now: %d\\n&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
	<span class="token keyword">if</span> i <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">break</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>因此每次迭代都会对条件进行检查（<code>i &lt; 0</code>），以此判断是否需要停止循环。如果退出条件满足，则使用 <code>break</code> 语句退出循环。</p><p>一个 <code>break</code> 的作用范围为该语句出现后的最内部的结构，它可以被用于任何形式的 <code>for</code> 循环（计数器、条件判断等）。但在 <code>switch</code> 或 <code>select</code> 语句中（详见<a href="">第 13 章</a>），<code>break</code> 语句的作用结果是跳过整个代码块，执行后续的代码。</p><p>下面的示例中包含了嵌套的循环体（for4.go），<code>break</code> 只会退出最内层的循环：</p><p>示例 5.11 <a href="examples/chapter_5/for4.go">for4.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i<span class="token operator">:=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> j<span class="token operator">:=</span><span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span> j<span class="token operator">++</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> j<span class="token operator">&gt;</span><span class="token number">5</span> <span class="token punctuation">{</span>
			    <span class="token keyword">break</span>   
			<span class="token punctuation">}</span>
			<span class="token function">print</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot;  &quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>012345 012345 012345
</code></pre><p>关键字 <code>continue</code> 忽略剩余的循环体而直接进入下一次循环的过程，但不是无条件执行下一次循环，执行之前依旧需要满足循环的判断条件。</p><p>示例 5.12 <a href="examples/chapter_5/for5.go">for5.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">5</span> <span class="token punctuation">{</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		<span class="token function">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
		<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>0 1 2 3 4 6 7 8 9
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>显然，<code>5</code> 被跳过了。</p><p>另外，关键字 <code>continue</code> 只能被用于 <code>for</code> 循环中。</p><h3 id="_5-6-标签与-goto" tabindex="-1"><a class="header-anchor" href="#_5-6-标签与-goto" aria-hidden="true">#</a> 5.6 标签与 goto</h3><p><code>for</code>、<code>switch</code> 或 <code>select</code> 语句都可以配合标签 (label) 形式的标识符使用，即某一行第一个以冒号 (<code>:</code>) 结尾的单词（gofmt 会将后续代码自动移至下一行）。</p><p>示例 5.13 <a href="examples/chapter_5/for6.go">for6.go</a>：</p><p>（标签的名称是大小写敏感的，为了提升可读性，一般建议使用全部大写字母）</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

LABEL1<span class="token punctuation">:</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> j <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">;</span> j<span class="token operator">++</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> j <span class="token operator">==</span> <span class="token number">4</span> <span class="token punctuation">{</span>
				<span class="token keyword">continue</span> LABEL1
			<span class="token punctuation">}</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;i is: %d, and j is: %d\\n&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>本例中，<code>continue</code> 语句指向 <code>LABEL1</code>，当执行到该语句的时候，就会跳转到 <code>LABEL1</code> 标签的位置。</p><p>您可以看到当 <code>j==4</code> 和 <code>j==5</code> 的时候，没有任何输出：标签的作用对象为外部循环，因此 <code>i</code> 会直接变成下一个循环的值，而此时 <code>j</code> 的值就被重设为 <code>0</code>，即它的初始值。如果将 <code>continue</code> 改为 <code>break</code>，则不会只退出内层循环，而是直接退出外层循环了。另外，还可以使用 <code>goto</code> 语句和标签配合使用来模拟循环。</p><p>示例 5.14 <a href="examples/chapter_5/goto.go">goto.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	i<span class="token operator">:=</span><span class="token number">0</span>
	HERE<span class="token punctuation">:</span>
		<span class="token function">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
		i<span class="token operator">++</span>
		<span class="token keyword">if</span> i<span class="token operator">==</span><span class="token number">5</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">goto</span> HERE
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面的代码会输出 <code>01234</code>。</p><p>使用逆向的 <code>goto</code> 会很快导致意大利面条式的代码，所以不应当使用而选择更好的替代方案。</p><p><strong>特别注意</strong> 使用标签和 <code>goto</code> 语句是不被鼓励的：它们会很快导致非常糟糕的程序设计，而且总有更加可读的替代方案来实现相同的需求。</p><p>一个建议使用 <code>goto</code> 语句的示例会在<a href="">第 15.1 章</a> 的 <a href="./examples/chapter_15/simple_tcp_server.go">simple_tcp_server.go</a> 中出现：示例中在发生读取错误时，使用 goto 来跳出无限读取循环并关闭相应的客户端链接。</p><p>定义但未使用标签会导致编译错误：<code>label … defined and not used</code>。</p><p>如果您必须使用 <code>goto</code>，应当只使用正序的标签（标签位于 <code>goto</code> 语句之后），但注意标签和 <code>goto</code> 语句之间不能出现定义新变量的语句，否则会导致编译失败。</p><p>示例 5.15 <a href="examples/chapter_5/got2o.go">goto2.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// compile error goto2.go:8: goto TARGET jumps over declaration of b at goto2.go:8</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		a <span class="token operator">:=</span> <span class="token number">1</span>
		<span class="token keyword">goto</span> TARGET <span class="token comment">// compile error</span>
		b <span class="token operator">:=</span> <span class="token number">9</span>
	TARGET<span class="token punctuation">:</span>  
		b <span class="token operator">+=</span> a
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;a is %v *** b is %v&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>问题 5.3</strong> 请描述下面 <code>for</code> 循环的输出：</p><ol><li></li></ol><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>i <span class="token operator">:=</span> <span class="token number">0</span>
<span class="token keyword">for</span> <span class="token punctuation">{</span> <span class="token comment">//since there are no checks, this is an infinite loop</span>
	<span class="token keyword">if</span> i <span class="token operator">&gt;=</span> <span class="token number">3</span> <span class="token punctuation">{</span> <span class="token keyword">break</span> <span class="token punctuation">}</span>
	<span class="token comment">//break out of this for loop when this condition is met</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Value of i is:&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
	i<span class="token operator">++</span>
<span class="token punctuation">}</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;A statement just after for loop.&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li></li></ol><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">7</span> <span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> i<span class="token operator">%</span><span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span> <span class="token keyword">continue</span> <span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Odd:&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="第-6-章-函数-function" tabindex="-1"><a class="header-anchor" href="#第-6-章-函数-function" aria-hidden="true">#</a> 第 6 章：函数 (function)</h2><p>函数是 Go 里面的基本代码块：Go 函数的功能非常强大，以至于被认为拥有函数式编程语言的多种特性。在这一章，我们将对 <a href="">第 4.2.2 节</a> 所简要描述的函数进行详细的讲解。</p><h3 id="_6-1-介绍" tabindex="-1"><a class="header-anchor" href="#_6-1-介绍" aria-hidden="true">#</a> 6.1 介绍</h3><p>每一个程序都包含很多的函数：函数是基本的代码块。</p><p>Go是编译型语言，所以函数编写的顺序是无关紧要的；鉴于可读性的需求，最好把 <code>main()</code> 函数写在文件的前面，其他函数按照一定逻辑顺序进行编写（例如函数被调用的顺序）。</p><p>编写多个函数的主要目的是将一个需要很多行代码的复杂问题分解为一系列简单的任务（那就是函数）来解决。而且，同一个任务（函数）可以被调用多次，有助于代码重用。</p><p>（事实上，好的程序是非常注意 DRY 原则的，即不要重复你自己 (Don&#39;t Repeat Yourself)，意思是执行特定任务的代码只能在程序里面出现一次。）</p><p>当函数执行到代码块最后一行（<code>}</code> 之前）或者 <code>return</code> 语句的时候会退出，其中 <code>return</code> 语句可以带有零个或多个参数；这些参数将作为返回值（参考 <a href="">第 6.2 节</a>）供调用者使用。简单的 <code>return</code> 语句也可以用来结束 <code>for</code> 死循环，或者结束一个协程 (goroutine)。</p><p>Go 里面有三种类型的函数：</p><ul><li>普通的带有名字的函数</li><li>匿名函数或者lambda函数（参考 <a href="">第 6.8 节</a>）</li><li>方法（Methods，参考 <a href="">第 10.6 节</a>）</li></ul><p>除了 <code>main()</code>、<code>init()</code> 函数外，其它所有类型的函数都可以有参数与返回值。函数参数、返回值以及它们的类型被统称为函数签名。</p><p>作为提醒，提前介绍一个语法：</p><p>这样是不正确的 Go 代码：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">g</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>它必须是这样的：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">g</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>函数被调用的基本格式如下：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>pack1<span class="token punctuation">.</span><span class="token function">Function</span><span class="token punctuation">(</span>arg1<span class="token punctuation">,</span> arg2<span class="token punctuation">,</span> …<span class="token punctuation">,</span> argn<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>Function</code> 是 <code>pack1</code> 包里面的一个函数，括号里的是被调用函数的实参 (argument)：这些值被传递给被调用函数的<em>形参</em>（parameter，参考<a href="">第 6.2 节</a>）。函数被调用的时候，这些实参将被复制（简单而言）然后传递给被调用函数。函数一般是在其他函数里面被调用的，这个其他函数被称为调用函数 (calling function)。函数能多次调用其他函数，这些被调用函数按顺序（简单而言）执行，理论上，函数调用其他函数的次数是无穷的（直到函数调用栈被耗尽）。</p><p>一个简单的函数调用其他函数的例子：</p><p>示例 6.1 <a href="examples/chapter_6/greeting.go">greeting.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;In main before calling greeting&quot;</span><span class="token punctuation">)</span>
    <span class="token function">greeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;In main after calling greeting&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">greeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;In greeting: Hi!!!!!&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>代码输出：</p><pre><code>In main before calling greeting
In greeting: Hi!!!!!
In main after calling greeting
</code></pre><p>函数可以将其他函数调用作为它的参数，只要这个被调用函数的返回值个数、返回值类型和返回值的顺序与调用函数所需求的实参是一致的，例如：</p><p>假设 <code>f1</code> 需要 3 个参数 <code>f1(a, b, c int)</code>，同时 <code>f2</code> 返回 3 个参数 <code>f2(a, b int) (int, int, int)</code>，就可以这样调用 <code>f1</code>：<code>f1(f2(a, b))</code>。</p><p>函数重载 (function overloading) 指的是可以编写多个同名函数，只要它们拥有不同的形参/或者不同的返回值，在 Go 里面函数重载是不被允许的。这将导致一个编译错误：</p><pre><code>funcName redeclared in this book, previous declaration at lineno
</code></pre><p>Go 语言不支持这项特性的主要原因是函数重载需要进行多余的类型匹配影响性能；没有重载意味着只是一个简单的函数调度。所以你需要给不同的函数使用不同的名字，我们通常会根据函数的特征对函数进行命名（参考 <a href="">第 11.12.5 节</a>）。</p><p>如果需要申明一个在外部定义的函数，你只需要给出函数名与函数签名，不需要给出函数体：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">flushICache</span><span class="token punctuation">(</span>begin<span class="token punctuation">,</span> end <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token comment">// implemented externally</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>函数也可以以申明的方式被使用，作为一个函数类型</strong>，就像：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> binOp <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>在这里，不需要函数体 <code>{}</code>。</p><p>函数是一等值 (first-class value)：它们可以赋值给变量，就像 <code>add := binOp</code> 一样。</p><p>这个变量知道自己指向的函数的签名，所以给它赋一个具有不同签名的函数值是不可能的。</p><p>函数值 (functions value) 之间可以相互比较：如果它们引用的是相同的函数或者都是 <code>nil</code> 的话，则认为它们是相同的函数。函数不能在其它函数里面声明（不能嵌套），不过我们可以通过使用匿名函数（参考 <a href="">第 6.8 节</a>）来破除这个限制。</p><p>目前 Go 没有泛型 (generic) 的概念，也就是说它不支持那种支持多种类型的函数。不过在大部分情况下可以通过接口 (interface)，特别是空接口与类型选择（type switch，参考 <a href="">第 11.12 节</a>）与/或者通过使用反射（reflection，参考 <a href="">第 6.8 节</a>）来实现相似的功能。使用这些技术将导致代码更为复杂、性能更为低下，所以在非常注意性能的的场合，最好是为每一个类型单独创建一个函数，而且代码可读性更强。</p><h3 id="_6-2-函数参数与返回值" tabindex="-1"><a class="header-anchor" href="#_6-2-函数参数与返回值" aria-hidden="true">#</a> 6.2 函数参数与返回值</h3><p>函数能够接收参数供自己使用，也可以返回零个或多个值（我们通常把返回多个值称为返回一组值）。相比与 C、C++、Java 和 C#，多值返回是 Go 的一大特性，为我们判断一个函数是否正常执行（参考 <a href="">第 5.2 节</a>）提供了方便。</p><p>我们通过 <code>return</code> 关键字返回一组值。事实上，任何一个有返回值（单个或多个）的函数都必须以 <code>return</code> 或 <code>panic</code>（参考 <a href="">第 13 章</a>）结尾。</p><p>在函数块里面，<code>return</code> 之后的语句都不会执行。如果一个函数需要返回值，那么这个函数里面的每一个代码分支 (code-path) 都要有 <code>return</code> 语句。</p><p>问题 6.1：下面的函数将不会被编译，为什么呢？大家可以试着纠正过来。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>st <span class="token operator">*</span>Stack<span class="token punctuation">)</span> <span class="token function">Pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
    v <span class="token operator">:=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> ix <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>st<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> ix <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> ix<span class="token operator">--</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> v <span class="token operator">=</span> st<span class="token punctuation">[</span>ix<span class="token punctuation">]</span><span class="token punctuation">;</span> v <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            st<span class="token punctuation">[</span>ix<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword">return</span> v
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>    
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>函数定义时，它的形参一般是有名字的，不过我们也可以定义没有形参名的函数，只有相应的形参类型，就像这样：<code>func f(int, int, float64)</code>。</p><p>没有参数的函数通常被称为 <strong>niladic</strong> 函数 (niladic function)，就像 <code>main.main()</code>。</p><h4 id="_6-2-1-按值传递-call-by-value-按引用传递-call-by-reference" tabindex="-1"><a class="header-anchor" href="#_6-2-1-按值传递-call-by-value-按引用传递-call-by-reference" aria-hidden="true">#</a> 6.2.1 按值传递 (call by value) 按引用传递 (call by reference)</h4><p>Go 默认使用按值传递来传递参数，也就是传递参数的副本。函数接收参数副本之后，在使用变量的过程中可能对副本的值进行更改，但不会影响到原来的变量，比如 <code>Function(arg1)</code>。</p><p>如果你希望函数可以直接修改参数的值，而不是对参数的副本进行操作，你需要将参数的地址（变量名前面添加 <code>&amp;</code> 符号，比如 <code>&amp;variable</code>）传递给函数，这就是按引用传递，比如 <code>Function(&amp;arg1)</code>，此时传递给函数的是一个指针。如果传递给函数的是一个指针，指针的值（一个地址）会被复制，但指针的值所指向的地址上的值不会被复制；我们可以通过这个指针的值来修改这个值所指向的地址上的值。（<strong>译者注：指针也是变量类型，有自己的地址和值，通常指针的值指向一个变量的地址。所以，按引用传递也是按值传递。</strong>）</p><p>几乎在任何情况下，传递指针（一个32位或者64位的值）的消耗都比传递副本来得少。</p><p>在函数调用时，像切片 (slice)、字典 (map)、接口 (interface)、通道 (channel) 这样的引用类型都是默认使用引用传递（即使没有显式的指出指针）。</p><p>有些函数只是完成一个任务，并没有返回值。我们仅仅是利用了这种函数的副作用 (side-effect)，就像输出文本到终端，发送一个邮件或者是记录一个错误等。</p><p>但是绝大部分的函数还是带有返回值的。</p><p>如下，simple_function.go 里的 <code>MultiPly3Nums</code> 函数带有三个形参，分别是 <code>a</code>、<code>b</code>、<code>c</code>，还有一个 <code>int</code> 类型的返回值（被注释的代码具有和未注释部分同样的功能，只是多引入了一个本地变量）：</p><p>示例 6.2 <a href="examples/chapter_6/simple_function.go">simple_function.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Multiply 2 * 5 * 6 = %d\\n&quot;</span><span class="token punctuation">,</span> <span class="token function">MultiPly3Nums</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// var i1 int = MultiPly3Nums(2, 5, 6)</span>
    <span class="token comment">// fmt.Printf(&quot;MultiPly 2 * 5 * 6 = %d\\n&quot;, i1)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">MultiPly3Nums</span><span class="token punctuation">(</span>a <span class="token builtin">int</span><span class="token punctuation">,</span> b <span class="token builtin">int</span><span class="token punctuation">,</span> c <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
    <span class="token comment">// var product int = a * b * c</span>
    <span class="token comment">// return product</span>
    <span class="token keyword">return</span> a <span class="token operator">*</span> b <span class="token operator">*</span> c
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出显示：</p><pre><code>Multiply 2 * 5 * 6 = 60
</code></pre><p>如果一个函数需要返回四到五个值，我们可以传递一个切片给函数（如果返回值具有相同类型）或者是传递一个结构体（如果返回值具有不同的类型）。因为传递一个指针允许直接修改变量的值，消耗也更少。</p><p>问题 6.2：</p><p>如下的两个函数调用有什么不同：</p><pre><code>(A) func DoSomething(a *A) {
        b = a
    }

(B) func DoSomething(a A) {
        b = &amp;a
    }
</code></pre><h4 id="_6-2-2-命名的返回值-named-return-variables" tabindex="-1"><a class="header-anchor" href="#_6-2-2-命名的返回值-named-return-variables" aria-hidden="true">#</a> 6.2.2 命名的返回值 (named return variables)</h4><p>如下 multiple_return.go 里的函数带有一个 <code>int</code> 参数，返回两个 <code>int</code> 值；其中一个函数的返回值在函数调用时就已经被赋予了一个初始零值。</p><p><code>getX2AndX3</code> 与 <code>getX2AndX3_2</code> 两个函数演示了如何使用非命名返回值与命名返回值的特性。当需要返回多个非命名返回值时，需要使用 <code>()</code> 把它们括起来，比如 <code>(int, int)</code>。</p><p>命名返回值作为结果形参 (result parameters) 被初始化为相应类型的零值，当需要返回的时候，我们只需要一条简单的不带参数的 <code>return</code> 语句。需要注意的是，即使只有一个命名返回值，也需要使用 <code>()</code> 括起来（参考<a href="">第 6.6 节</a> 的 <a href="./examples/chapter_6/fibonacci.go">fibonacci.go</a> 函数）。</p><p>示例 6.3 <a href="examples/chapter_6/multiple_return.go">multiple_return.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">var</span> num <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">10</span>
<span class="token keyword">var</span> numx2<span class="token punctuation">,</span> numx3 <span class="token builtin">int</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    numx2<span class="token punctuation">,</span> numx3 <span class="token operator">=</span> <span class="token function">getX2AndX3</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>
    <span class="token function">PrintValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    numx2<span class="token punctuation">,</span> numx3 <span class="token operator">=</span> <span class="token function">getX2AndX3_2</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>
    <span class="token function">PrintValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">PrintValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;num = %d, 2x num = %d, 3x num = %d\\n&quot;</span><span class="token punctuation">,</span> num<span class="token punctuation">,</span> numx2<span class="token punctuation">,</span> numx3<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">getX2AndX3</span><span class="token punctuation">(</span>input <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">2</span> <span class="token operator">*</span> input<span class="token punctuation">,</span> <span class="token number">3</span> <span class="token operator">*</span> input
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">getX2AndX3_2</span><span class="token punctuation">(</span>input <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>x2 <span class="token builtin">int</span><span class="token punctuation">,</span> x3 <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    x2 <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> input
    x3 <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">*</span> input
    <span class="token comment">// return x2, x3</span>
    <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出结果：</p><pre><code>num = 10, 2x num = 20, 3x num = 30    
num = 10, 2x num = 20, 3x num = 30 
</code></pre><p>提示：</p><p>虽然 <code>return</code> 或 <code>return var</code> 都是可以的，但是 <code>return var = expression</code>（表达式） 会引发一个编译错误：</p><p><code>syntax error: unexpected =, expecting semicolon or newline or }</code>。</p><p>即使函数使用了命名返回值，你依旧可以无视它而返回明确的值。</p><p>任何一个非命名返回值（使用非命名返回值是很糟的编程习惯）在 <code>return</code> 语句里面都要明确指出包含返回值的变量或是一个可计算的值（就像上面警告所指出的那样）。</p><p><strong>尽量使用命名返回值：会使代码更清晰、更简短，同时更加容易读懂。</strong></p><p>练习 6.1 <a href="exercises/chapter_6/mult_returnval.go">mult_returnval.go</a></p><p>编写一个函数，接收两个整数，然后返回它们的和、积与差。编写两个版本，一个是非命名返回值，一个是命名返回值。</p><p>练习 6.2 <a href="exercises/chapter_6/error_returnval.go">error_returnval.go</a></p><p>编写一个名字为 <code>MySqrt()</code> 的函数，计算一个 <code>float64</code> 类型浮点数的平方根，如果参数是一个负数的话将返回一个错误。编写两个版本，一个是非命名返回值，一个是命名返回值。</p><h4 id="_6-2-3-空白符-blank-identifier" tabindex="-1"><a class="header-anchor" href="#_6-2-3-空白符-blank-identifier" aria-hidden="true">#</a> 6.2.3 空白符 (blank identifier)</h4><p>空白符用来匹配一些不需要的值，然后丢弃掉，下面的 blank_identifier.go 就是很好的例子。</p><p><code>ThreeValues</code> 是拥有三个返回值的不需要任何参数的函数，在下面的例子中，我们将第一个与第三个返回值赋给了 <code>i1</code> 与 <code>f1</code>。第二个返回值赋给了空白符 <code>_</code>，然后自动丢弃掉。</p><p>示例 6.4 <a href="examples/chapter_6/blank_identifier.go">blank_identifier.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> i1 <span class="token builtin">int</span>
    <span class="token keyword">var</span> f1 <span class="token builtin">float32</span>
    i1<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> f1 <span class="token operator">=</span> <span class="token function">ThreeValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The int: %d, the float: %f \\n&quot;</span><span class="token punctuation">,</span> i1<span class="token punctuation">,</span> f1<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">ThreeValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">float32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7.5</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出结果：</p><pre><code>The int: 5, the float: 7.500000
</code></pre><p>另外一个示例，函数接收两个参数，比较它们的大小，然后按小-大的顺序返回这两个数，示例代码为 minmax.go。</p><p>示例 6.5 <a href="examples/chapter_6/minmax.go">minmax.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> min<span class="token punctuation">,</span> max <span class="token builtin">int</span>
    min<span class="token punctuation">,</span> max <span class="token operator">=</span> <span class="token function">MinMax</span><span class="token punctuation">(</span><span class="token number">78</span><span class="token punctuation">,</span> <span class="token number">65</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Minmium is: %d, Maximum is: %d\\n&quot;</span><span class="token punctuation">,</span> min<span class="token punctuation">,</span> max<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">MinMax</span><span class="token punctuation">(</span>a <span class="token builtin">int</span><span class="token punctuation">,</span> b <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>min <span class="token builtin">int</span><span class="token punctuation">,</span> max <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> a <span class="token operator">&lt;</span> b <span class="token punctuation">{</span>
        min <span class="token operator">=</span> a
        max <span class="token operator">=</span> b
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// a = b or a &lt; b</span>
        min <span class="token operator">=</span> b
        max <span class="token operator">=</span> a
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出结果：</p><pre><code>Minimum is: 65, Maximum is 78
</code></pre><h4 id="_6-2-4-改变外部变量-outside-variable" tabindex="-1"><a class="header-anchor" href="#_6-2-4-改变外部变量-outside-variable" aria-hidden="true">#</a> 6.2.4 改变外部变量 (outside variable)</h4><p>传递指针给函数不但可以节省内存（因为没有复制变量的值），而且赋予了函数直接修改外部变量的能力，所以被修改的变量不再需要使用 <code>return</code> 返回。如下的例子，<code>reply</code> 是一个指向 <code>int</code> 变量的指针，通过这个指针，我们在函数内修改了这个 <code>int</code> 变量的数值。</p><p>示例 6.6 <a href="examples/chapter_6/side_effect.go">side_effect.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;fmt&quot;</span>
<span class="token punctuation">)</span>

<span class="token comment">// this function changes reply:</span>
<span class="token keyword">func</span> <span class="token function">Multiply</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">int</span><span class="token punctuation">,</span> reply <span class="token operator">*</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">*</span>reply <span class="token operator">=</span> a <span class="token operator">*</span> b
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    n <span class="token operator">:=</span> <span class="token number">0</span>
    reply <span class="token operator">:=</span> <span class="token operator">&amp;</span>n
    <span class="token function">Multiply</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> reply<span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Multiply:&quot;</span><span class="token punctuation">,</span> <span class="token operator">*</span>reply<span class="token punctuation">)</span> <span class="token comment">// Multiply: 50</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这仅仅是个指导性的例子，当需要在函数内改变一个占用内存比较大的变量时，性能优势就更加明显了。然而，如果不小心使用的话，传递一个指针很容易引发一些不确定的事，所以，我们要十分小心那些可以改变外部变量的函数，在必要时，需要添加注释以便其他人能够更加清楚的知道函数里面到底发生了什么。</p><h3 id="_6-3-传递变长参数" tabindex="-1"><a class="header-anchor" href="#_6-3-传递变长参数" aria-hidden="true">#</a> 6.3 传递变长参数</h3><p>如果函数的最后一个参数是采用 <code>...type</code> 的形式，那么这个函数就可以处理一个变长的参数，这个长度可以为 0，这样的函数称为变参函数。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">myFunc</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> arg <span class="token operator">...</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>这个函数接受一个类似于切片 (slice) 的参数（详见<a href="">第 7 章</a>），该参数可以通过<a href="">第 5.4.4 节</a> 中提到的 <code>for</code> 循环结构迭代。</p><p>示例函数和调用：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Greeting</span><span class="token punctuation">(</span>prefix <span class="token builtin">string</span><span class="token punctuation">,</span> who <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span>
<span class="token function">Greeting</span><span class="token punctuation">(</span><span class="token string">&quot;hello:&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Joe&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Anna&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Eileen&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>在 <code>Greeting()</code> 函数中，变量 <code>who</code> 的值为 <code>[]string{&quot;Joe&quot;, &quot;Anna&quot;, &quot;Eileen&quot;}</code>。</p><p>如果参数被存储在一个 slice 类型的变量 <code>slice</code> 中，则可以通过 <code>slice...</code> 的形式来传递参数，调用变参函数。</p><p>示例 6.7 <a href="examples/chapter_6/varnumpar.go">varnumpar.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	x <span class="token operator">:=</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The minimum is: %d\\n&quot;</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>
	slice <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">}</span>
	x <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>slice<span class="token operator">...</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The minimum in the slice is: %d&quot;</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">min</span><span class="token punctuation">(</span>s <span class="token operator">...</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token number">0</span>
	<span class="token punctuation">}</span>
	min <span class="token operator">:=</span> s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> s <span class="token punctuation">{</span>
		<span class="token keyword">if</span> v <span class="token operator">&lt;</span> min <span class="token punctuation">{</span>
			min <span class="token operator">=</span> v
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> min
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>The minimum is: 0
The minimum in the slice is: 1
</code></pre><p><strong>练习 6.3</strong> <a href="exercises/chapter_6/varargs.go">varargs.go</a></p><p>写一个函数，该函数接受一个变长参数并对每个元素进行换行打印。</p><p>一个接受变长参数的函数可以将这个参数作为其它函数的参数进行传递：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">F1</span><span class="token punctuation">(</span>s <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">F2</span><span class="token punctuation">(</span>s<span class="token operator">...</span><span class="token punctuation">)</span>
	<span class="token function">F3</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">F2</span><span class="token punctuation">(</span>s <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">F3</span><span class="token punctuation">(</span>s <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>变长参数可以作为对应类型的 slice 进行二次传递。</p><p>但是如果变长参数的类型并不是都相同的呢？使用 5 个参数来进行传递并不是很明智的选择，有 2 种方案可以解决这个问题：</p><ol><li><p>使用结构（详见<a href="">第 10 章</a>）：</p><p>定义一个结构类型，假设它叫 <code>Options</code>，用以存储所有可能的参数：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Options <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	par1 type1<span class="token punctuation">,</span>
	par2 type2<span class="token punctuation">,</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>函数 <code>F1()</code> 可以使用正常的参数 <code>a</code> 和 <code>b</code>，以及一个没有任何初始化的 <code>Options</code> 结构： <code>F1(a, b, Options {})</code>。如果需要对选项进行初始化，则可以使用 <code>F1(a, b, Options {par1:val1, par2:val2})</code>。</p></li><li><p>使用空接口：</p><p>如果一个变长参数的类型没有被指定，则可以使用默认的空接口 <code>interface{}</code>，这样就可以接受任何类型的参数（详见<a href="">第 11.9 节</a> ）。该方案不仅可以用于长度未知的参数，还可以用于任何不确定类型的参数。一般而言我们会使用一个 for-range 循环以及 <code>switch</code> 结构对每个参数的类型进行判断：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">typecheck</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>values … <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> value <span class="token operator">:=</span> <span class="token keyword">range</span> values <span class="token punctuation">{</span>
		<span class="token keyword">switch</span> v <span class="token operator">:=</span> value<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> <span class="token builtin">int</span><span class="token punctuation">:</span> …
			<span class="token keyword">case</span> float<span class="token punctuation">:</span> …
			<span class="token keyword">case</span> <span class="token builtin">string</span><span class="token punctuation">:</span> …
			<span class="token keyword">case</span> <span class="token builtin">bool</span><span class="token punctuation">:</span> …
			<span class="token keyword">default</span><span class="token punctuation">:</span> …
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><h3 id="_6-4-defer-和追踪" tabindex="-1"><a class="header-anchor" href="#_6-4-defer-和追踪" aria-hidden="true">#</a> 6.4 defer 和追踪</h3><p>关键字 <code>defer</code> 允许我们推迟到函数返回之前（或任意位置执行 <code>return</code> 语句之后）一刻才执行某个语句或函数（为什么要在返回之后才执行这些语句？因为 <code>return</code> 语句同样可以包含一些操作，而不是单纯地返回某个值）。</p><p>关键字 <code>defer</code> 的用法类似于面向对象编程语言 Java 和 C# 的 finally 语句块，它一般用于释放某些已分配的资源。</p><p>示例 6.8 <a href="examples/chapter_6/defer.go">defer.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">function1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">function1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;In function1 at the top\\n&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">function2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;In function1 at the bottom!\\n&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">function2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Function2: Deferred until the end of the calling function!&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>In Function1 at the top
In Function1 at the bottom!
Function2: Deferred until the end of the calling function!
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>请将 <code>defer</code> 关键字去掉并对比输出结果。</p><p>使用 <code>defer</code> 的语句同样可以接受参数，下面这个例子就会在执行 <code>defer</code> 语句时打印 <code>0</code>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	i <span class="token operator">:=</span> <span class="token number">0</span>
	<span class="token keyword">defer</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
	i<span class="token operator">++</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当有多个 <code>defer</code> 行为被注册时，它们会以逆序执行（类似栈，即后进先出）：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token keyword">defer</span> fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d &quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面的代码将会输出：<code>4 3 2 1 0</code>。</p><p>关键字 <code>defer</code> 允许我们进行一些函数执行完成后的收尾工作，例如：</p><ol><li>关闭文件流 （详见 <a href="">第 12.2 节</a>）</li></ol><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// open a file  </span>
<span class="token keyword">defer</span> file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>解锁一个加锁的资源 （详见 <a href="">第 9.3 节</a>）</li></ol><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
<span class="token keyword">defer</span> mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>打印最终报告</li></ol><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token function">printHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
<span class="token keyword">defer</span> <span class="token function">printFooter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li>关闭数据库链接</li></ol><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// open a database connection  </span>
<span class="token keyword">defer</span> <span class="token function">disconnectFromDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>合理使用 <code>defer</code> 语句能够使得代码更加简洁。</p><p>以下代码模拟了上面描述的第 4 种情况：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">doDBOperations</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">connectToDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;ok, connected to db&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">disconnectFromDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;ok, disconnected from db&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">doDBOperations</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">connectToDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Defering the database disconnect.&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">disconnectFromDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//function called here with defer</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Doing some DB operations ...&quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Oops! some crash or network error ...&quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Returning from function here!&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token comment">//terminate the program</span>
	<span class="token comment">// deferred function executed here just before actually returning, even if</span>
	<span class="token comment">// there is a return or abnormal termination before</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>ok, connected to db
Defering the database disconnect.
Doing some DB operations ...
Oops! some crash or network error ...
Returning from function here!
ok, disconnected from db
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>使用 <code>defer</code> 语句实现代码追踪</strong></p><p>一个基础但十分实用的实现代码执行追踪的方案就是在进入和离开某个函数打印相关的消息，即可以提炼为下面两个函数：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">trace</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;entering:&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">untrace</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;leaving:&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>以下代码展示了何时调用这两个函数：</p><p>示例 6.10 <a href="examples/chapter_6/defer_tracing.go">defer_tracing.go</a>:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">trace</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span>   <span class="token punctuation">{</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;entering:&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">untrace</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;leaving:&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span> <span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">untrace</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;in a&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">untrace</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;in b&quot;</span><span class="token punctuation">)</span>
	<span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>entering: b
in b
entering: a
in a
leaving: a
leaving: b
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面的代码还可以修改为更加简便的版本（示例 6.11 <a href="examples/chapter_6/defer_tracing2.go">defer_tracing2.go</a>）：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">trace</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;entering:&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span>
	<span class="token keyword">return</span> s
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">un</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;leaving:&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> <span class="token function">un</span><span class="token punctuation">(</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;in a&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> <span class="token function">un</span><span class="token punctuation">(</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;in b&quot;</span><span class="token punctuation">)</span>
	<span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>使用 <code>defer</code> 语句来记录函数的参数与返回值</strong></p><p>下面的代码展示了另一种在调试时使用 <code>defer</code> 语句的手法（示例 6.12 <a href="examples/chapter_6/defer_logvalues.go">defer_logvalues.go</a>）：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;io&quot;</span>
	<span class="token string">&quot;log&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">func1</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;func1(%q) = %d, %v&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">,</span> n<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token number">7</span><span class="token punctuation">,</span> io<span class="token punctuation">.</span>EOF
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">func1</span><span class="token punctuation">(</span><span class="token string">&quot;Go&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>Output: 2011/10/04 10:46:11 func1(&quot;Go&quot;) = 7, EOF
</code></pre><h3 id="_6-5-内置函数" tabindex="-1"><a class="header-anchor" href="#_6-5-内置函数" aria-hidden="true">#</a> 6.5 内置函数</h3><p>Go 语言拥有一些不需要进行导入操作就可以使用的内置函数。它们有时可以针对不同的类型进行操作，例如：<code>len()</code>、<code>cap()</code> 和 <code>append()</code>，或必须用于系统级的操作，例如：<code>panic()</code>。因此，它们需要直接获得编译器的支持。</p><p>以下是一个简单的列表，我们会在后面的章节中对它们进行逐个深入的讲解。</p><table><thead><tr><th>名称</th><th>说明</th></tr></thead><tbody><tr><td><code>close()</code></td><td>用于管道通信</td></tr><tr><td><code>len()</code>、<code>cap()</code></td><td><code>len()</code> 用于返回某个类型的长度或数量（字符串、数组、切片、<code>map</code> 和管道）；<code>cap()</code> 是容量的意思，用于返回某个类型的最大容量（只能用于数组、切片和管道，不能用于 <code>map</code>）</td></tr><tr><td><code>new()</code>、<code>make()</code></td><td><code>new()</code> 和 <code>make()</code> 均是用于分配内存：<code>new()</code> 用于值类型和用户定义的类型，如自定义结构，<code>make</code> 用于内置引用类型（切片、<code>map</code> 和管道）。它们的用法就像是函数，但是将类型作为参数：<code>new(type)</code>、<code>make(type)</code>。<code>new(T)</code> 分配类型 <code>T</code> 的零值并返回其地址，也就是指向类型 <code>T</code> 的指针（详见<a href="">第 10.1 节</a>）。它也可以被用于基本类型：<code>v := new(int)</code>。<code>make(T)</code> 返回类型 <code>T</code> 的初始化之后的值，因此它比 <code>new()</code> 进行更多的工作（详见<a href="">第 7.2.3/4 节</a>、<a href="">第 8.1.1 节</a>和<a href="">第 14.2.1 节</a>）。<strong><code>new()</code> 是一个函数，不要忘记它的括号</strong>。</td></tr><tr><td><code>copy()</code>、<code>append()</code></td><td>用于复制和连接切片</td></tr><tr><td><code>panic()</code>、<code>recover()</code></td><td>两者均用于错误处理机制</td></tr><tr><td><code>print()</code>、<code>println()</code></td><td>底层打印函数（详见<a href="">第 4.2 节</a>），在部署环境中建议使用 <code>fmt</code> 包</td></tr><tr><td><code>complex()</code>、<code>real ()</code>、<code>imag()</code></td><td>用于创建和操作复数（详见<a href="">第 4.5.2.2 节</a>）</td></tr></tbody></table><h3 id="_6-6-递归函数" tabindex="-1"><a class="header-anchor" href="#_6-6-递归函数" aria-hidden="true">#</a> 6.6 递归函数</h3><p>当一个函数在其函数体内调用自身，则称之为递归。最经典的例子便是计算斐波那契数列，即前两个数为 1，从第三个数开始每个数均为前两个数之和。</p><p>数列如下所示：</p><pre><code>1, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89, 144, 233, 377, 610, 987, 1597, 2584, 4181, 6765, 10946, …
</code></pre><p>下面的程序可用于生成该数列（示例 6.13 <a href="examples/chapter_6/fibonacci.go">fibonacci.go</a>）：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	result <span class="token operator">:=</span> <span class="token number">0</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		result <span class="token operator">=</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;fibonacci(%d) is: %d\\n&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> result<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>res <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> n <span class="token operator">&lt;=</span> <span class="token number">1</span> <span class="token punctuation">{</span>
		res <span class="token operator">=</span> <span class="token number">1</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		res <span class="token operator">=</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span>n<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>fibonacci(0) is: 1
fibonacci(1) is: 1
fibonacci(2) is: 2
fibonacci(3) is: 3
fibonacci(4) is: 5
fibonacci(5) is: 8
fibonacci(6) is: 13
fibonacci(7) is: 21
fibonacci(8) is: 34
fibonacci(9) is: 55
fibonacci(10) is: 89
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>许多问题都可以使用优雅的递归来解决，比如说著名的快速排序算法。</p>`,423),pe={href:"https://zh.wikipedia.org/wiki/%E6%83%B0%E6%80%A7%E6%B1%82%E5%80%BC",target:"_blank",rel:"noopener noreferrer"},oe=n("a",{href:""},"第 14.8 节",-1),ce=n("a",{href:""},"练习 14.12",-1),ie=t(`<p>Go 语言中也可以使用相互调用的递归函数：多个函数之间相互调用形成闭环。因为 Go 语言编译器的特殊性，这些函数的声明顺序可以是任意的。下面这个简单的例子展示了函数 <code>odd()</code> 和 <code>even()</code> 之间的相互调用（示例 6.14 <a href="examples/chapter_6/mut_recurs.go">mut_recurs.go</a>）：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d is even: is %t\\n&quot;</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token function">even</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 16 is even: is true</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d is odd: is %t\\n&quot;</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">,</span> <span class="token function">odd</span><span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">// 17 is odd: is true</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d is odd: is %t\\n&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token function">odd</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">// 18 is odd: is false</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">even</span><span class="token punctuation">(</span>nr <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> nr <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token function">odd</span><span class="token punctuation">(</span><span class="token function">RevSign</span><span class="token punctuation">(</span>nr<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">odd</span><span class="token punctuation">(</span>nr <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> nr <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token function">even</span><span class="token punctuation">(</span><span class="token function">RevSign</span><span class="token punctuation">(</span>nr<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">RevSign</span><span class="token punctuation">(</span>nr <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> nr <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>nr
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> nr
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="练习题-1" tabindex="-1"><a class="header-anchor" href="#练习题-1" aria-hidden="true">#</a> 练习题</h5><p><strong>练习 6.4</strong> <a href="exercises/chapter_6/fibonacci2.go">fibonacci2.go</a></p><p>重写本节中生成斐波那契数列的程序并返回两个命名返回值（详见<a href="">第 6.2 节</a>），即数列中的位置和对应的值，例如 5 与 4，89 与 10。</p><p><strong>练习 6.5</strong> <a href="exercises/chapter_6/10to1_recursive.go">10to1_recursive.go</a></p><p>使用递归函数从 10 打印到 1。</p><p><strong>练习 6.6</strong> <a href="exercises/chapter_6/factorial.go">factorial.go</a></p><p>实现一个输出前 30 个整数的阶乘的程序。</p><p>n 的阶乘定义为：<code>n! = n * (n-1)!, 0! = 1</code>，因此它非常适合使用递归函数来实现。</p><p>然后，使用命名返回值来实现这个程序的第二个版本。</p><p>特别注意的是，使用 <code>int</code> 类型最多只能计算到 12 的阶乘，因为一般情况下 <code>int</code> 类型的大小为 32 位，继续计算会导致溢出错误。那么，如何才能解决这个问题呢？</p><p>最好的解决方案就是使用 <code>big</code> 包（详见<a href="">第 9.4 节</a>）。</p><h3 id="_6-7-将函数作为参数" tabindex="-1"><a class="header-anchor" href="#_6-7-将函数作为参数" aria-hidden="true">#</a> 6.7 将函数作为参数</h3><p>函数可以作为其它函数的参数进行传递，然后在其它函数内调用执行，一般称之为回调。下面是一个将函数作为参数的简单例子（<a href="examples/chapter_6/function_parameter.go">function_parameter.go</a>）：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">callback</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> Add<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Add</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The sum of %d and %d is: %d\\n&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> a<span class="token operator">+</span>b<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">callback</span><span class="token punctuation">(</span>y <span class="token builtin">int</span><span class="token punctuation">,</span> f <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">f</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// this becomes Add(1, 2)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>The sum of 1 and 2 is: 3
</code></pre><p>将函数作为参数的最好的例子是函数 <code>strings.IndexFunc()</code>：</p><p>该函数的签名是 <code>func IndexFunc(s string, f func(c rune) bool) int</code>，它的返回值是字符串 s 中第一个使函数 <code>f(c)</code> 返回 <code>true</code> 的 Unicode 字符的索引值。如果找不到，则返回 -1。</p><p>例如 <code>strings.IndexFunc(line, unicode.IsSpace)</code> 就会返回 <code>line</code> 中第一个空白字符的索引值。当然，您也可以书写自己的函数：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">IsAscii</span><span class="token punctuation">(</span>c <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> c <span class="token operator">&gt;</span> <span class="token number">255</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在<a href="">第 14.10.1 节</a> 中，我们将会根据一个客户端/服务端程序作为示例对这个用法进行深入讨论。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> binOp <span class="token keyword">func</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span>
<span class="token keyword">func</span> <span class="token function">run</span><span class="token punctuation">(</span>op binOp<span class="token punctuation">,</span> req <span class="token operator">*</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span> … <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>练习 6.7</strong> <a href="exercises/chapter_6/strings_map.go">strings_map.go</a></p><p>包 <code>strings</code> 中的 <code>Map()</code> 函数和 <code>strings.IndexFunc()</code> 一样都是非常好的使用例子。请学习它的源代码并基于该函数书写一个程序，要求将指定文本内的所有非 ASCII 字符替换成问号 <code>&#39;?&#39;</code> 或空格 <code>&#39; &#39;</code>。您需要怎么做才能删除这些字符呢？</p><h3 id="_6-8-闭包" tabindex="-1"><a class="header-anchor" href="#_6-8-闭包" aria-hidden="true">#</a> 6.8 闭包</h3><p>当我们不希望给函数起名字的时候，可以使用匿名函数，例如：<code>func(x, y int) int { return x + y }</code>。</p><p>这样的一个函数不能够独立存在（编译器会返回错误：<code>non-declaration statement outside function body</code>），但可以被赋值于某个变量，即保存函数的地址到变量中：<code>fplus := func(x, y int) int { return x + y }</code>，然后通过变量名对函数进行调用：<code>fplus(3,4)</code>。</p><p>当然，您也可以直接对匿名函数进行调用：<code>func(x, y int) int { return x + y } (3, 4)</code>。</p><p>下面是一个计算从 1 到 100 万整数的总和的匿名函数：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	sum <span class="token operator">:=</span> <span class="token number">0</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">1e6</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		sum <span class="token operator">+=</span> i
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>表示参数列表的第一对括号必须紧挨着关键字 <code>func</code>，因为匿名函数没有名称。花括号 <code>{}</code> 涵盖着函数体，最后的一对括号表示对该匿名函数的调用。</p><p>下面的例子展示了如何将匿名函数赋值给变量并对其进行调用（<a href="examples/chapter_6/function_literal.go">function_literal.go</a>）：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		g <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d &quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token punctuation">}</span>
		<span class="token function">g</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot; - g is of type %T and has value %v\\n&quot;</span><span class="token punctuation">,</span> g<span class="token punctuation">,</span> g<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>0 - g is of type func(int) and has value 0x681a80
1 - g is of type func(int) and has value 0x681b00
2 - g is of type func(int) and has value 0x681ac0
3 - g is of type func(int) and has value 0x681400
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们可以看到变量 <code>g</code> 代表的是 <code>func(int)</code>，变量的值是一个内存地址。</p><p>所以我们实际上拥有的是一个函数值：匿名函数可以被赋值给变量并作为值使用。</p><p><strong>练习 6.8</strong> 在 <code>main()</code> 函数中写一个用于打印 <code>Hello World</code> 字符串的匿名函数并赋值给变量 <code>fv</code>，然后调用该函数并打印变量 <code>fv</code> 的类型。</p><p>匿名函数像所有函数一样可以接受或不接受参数。下面的例子展示了如何传递参数到匿名函数中：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>u <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span>
	…
<span class="token punctuation">}</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>请学习以下示例并思考（<a href="examples/chapter_6/return_defer.go">return_defer.go</a>）：函数 <code>f</code> 返回时，变量 <code>ret</code> 的值是什么？</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>ret <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		ret<span class="token operator">++</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>变量 <code>ret</code> 的值为 <code>2</code>，因为 <code>ret++</code> 是在执行 <code>return 1</code> 语句后发生的。</p><p>这可用于在返回语句之后修改返回的 <code>error</code> 时使用。</p><p><strong>defer 语句和匿名函数</strong></p><p>关键字 <code>defer</code> （详见<a href="">第 6.4 节</a>）经常配合匿名函数使用，它可以用于改变函数的命名返回值。</p><p>匿名函数还可以配合 <code>go</code> 关键字来作为 goroutine 使用（详见<a href="">第 14 章</a>和<a href="">第 16.9 节</a>）。</p><p>匿名函数同样被称之为闭包（函数式语言的术语）：它们被允许调用定义在其它环境下的变量。闭包可使得某个函数捕捉到一些外部状态，例如：函数被创建时的状态。另一种表示方式为：一个闭包继承了函数所声明时的作用域。这种状态（作用域内的变量）都被共享到闭包的环境中，因此这些变量可以在闭包中被操作，直到被销毁，详见<a href="">第 6.9 节</a> 中的示例。闭包经常被用作包装函数：它们会预先定义好 1 个或多个参数以用于包装，详见下一节中的示例。另一个不错的应用就是使用闭包来完成更加简洁的错误检查（详见<a href="">第 16.10.2 节</a>）。</p><h3 id="_6-9-应用闭包-将函数作为返回值" tabindex="-1"><a class="header-anchor" href="#_6-9-应用闭包-将函数作为返回值" aria-hidden="true">#</a> 6.9 应用闭包：将函数作为返回值</h3><p>在程序 <a href="examples/chapter_6/function_return.go">function_return.go</a> 中我们将会看到函数 <code>Add2()</code> 和 <code>Adder()</code> 均会返回签名为 <code>func(b int) int</code> 的函数：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Add2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>b <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">Adder</span><span class="token punctuation">(</span>a <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>b <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>函数 <code>Add2()</code> 不接受任何参数，但函数 <code>Adder()</code> 接受一个 <code>int</code> 类型的整数作为参数。</p><p>我们也可以将 <code>Adder()</code> 返回的函数存到变量中 (<a href="examples/chapter_6/function_return.go">function_return.go</a>)。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// make an Add2 function, give it a name p2, and call it:</span>
	p2 <span class="token operator">:=</span> <span class="token function">Add2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Call Add2 for 3 gives: %v\\n&quot;</span><span class="token punctuation">,</span> <span class="token function">p2</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">// make a special Adder function, a gets value 2:</span>
	TwoAdder <span class="token operator">:=</span> <span class="token function">Adder</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The result is: %v\\n&quot;</span><span class="token punctuation">,</span> <span class="token function">TwoAdder</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Add2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span>b <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>b <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> b <span class="token operator">+</span> <span class="token number">2</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Adder</span><span class="token punctuation">(</span>a <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span>b <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>b <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> a <span class="token operator">+</span> b
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Call Add2 for 3 gives: 5
The result is: 5
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>下例为一个略微不同的实现 (<a href="examples/chapter_6/function_closure.go">function_closure.go</a>)：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> f <span class="token operator">=</span> <span class="token function">Adder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot; - &quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot; - &quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Adder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> x <span class="token builtin">int</span>
	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>delta <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
		x <span class="token operator">+=</span> delta
		<span class="token keyword">return</span> x
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>函数 <code>Adder()</code> 现在被赋值到变量 <code>f</code> 中（类型为 <code>func(int) int</code>）。</p><p>输出：</p><pre><code>1 - 21 - 321
</code></pre><p>三次调用函数 <code>f</code> 的过程中函数 <code>Adder()</code> 中变量 <code>delta</code> 的值分别为：1、20 和 300。</p><p>我们可以看到，在多次调用中，变量 <code>x</code> 的值是被保留的，即 <code>0 + 1 = 1</code>，然后 <code>1 + 20 = 21</code>，最后 <code>21 + 300 = 321</code>：闭包函数保存并积累其中的变量的值，不管外部函数退出与否，它都能够继续操作外部函数中的局部变量。</p><p>这些局部变量同样可以是参数，例如之前例子中的 <code>Adder(as int)</code>。</p><p>这些例子清楚地展示了如何在 Go 语言中使用闭包。</p><p>在闭包中使用到的变量可以是在闭包函数体内声明的，也可以是在外部函数声明的：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> g <span class="token builtin">int</span>
<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	s <span class="token operator">:=</span> <span class="token number">0</span>
	<span class="token keyword">for</span> j <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> i<span class="token punctuation">;</span> j<span class="token operator">++</span> <span class="token punctuation">{</span> s <span class="token operator">+=</span> j <span class="token punctuation">}</span>
	g <span class="token operator">=</span> s
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token comment">// Passes argument 1000 to the function literal.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样闭包函数就能够被应用到整个集合的元素上，并修改它们的值。然后这些变量就可以用于表示或计算全局或平均值。</p><p><strong>练习 6.9</strong> <a href="exercises/chapter_6/fibonacci_closure.go">fibonacci_closure</a></p><p>不使用递归但使用闭包改写第 6.6 节中的斐波那契数列程序。</p><p><strong>练习 6.10</strong></p><p>学习并理解以下程序的工作原理：</p><p>一个返回值为另一个函数的函数可以被称之为工厂函数，这在您需要创建一系列相似的函数的时候非常有用：书写一个工厂函数而不是针对每种情况都书写一个函数。下面的函数演示了如何动态返回追加后缀的函数：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">MakeAddSuffix</span><span class="token punctuation">(</span>suffix <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>strings<span class="token punctuation">.</span><span class="token function">HasSuffix</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> suffix<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> name <span class="token operator">+</span> suffix
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> name
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>现在，我们可以生成如下函数：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>addBmp <span class="token operator">:=</span> <span class="token function">MakeAddSuffix</span><span class="token punctuation">(</span><span class="token string">&quot;.bmp&quot;</span><span class="token punctuation">)</span>
addJpeg <span class="token operator">:=</span> <span class="token function">MakeAddSuffix</span><span class="token punctuation">(</span><span class="token string">&quot;.jpeg&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>然后调用它们：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token function">addBmp</span><span class="token punctuation">(</span><span class="token string">&quot;file&quot;</span><span class="token punctuation">)</span> <span class="token comment">// returns: file.bmp</span>
<span class="token function">addJpeg</span><span class="token punctuation">(</span><span class="token string">&quot;file&quot;</span><span class="token punctuation">)</span> <span class="token comment">// returns: file.jpeg</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>可以返回其它函数的函数和接受其它函数作为参数的函数均被称之为高阶函数，是函数式语言的特点。我们已经在<a href="">第 6.7 节</a>中得知函数也是一种值，因此很显然 Go 语言具有一些函数式语言的特性。闭包在 Go 语言中非常常见，常用于 goroutine 和管道操作（详见第 <a href="">14.8</a>-<a href="">14.9</a> 节）。在<a href="">第 11.14 节</a>的程序中，我们将会看到 Go 语言中的函数在处理混合对象时的强大能力。</p><h3 id="_6-10-使用闭包调试" tabindex="-1"><a class="header-anchor" href="#_6-10-使用闭包调试" aria-hidden="true">#</a> 6.10 使用闭包调试</h3><p>当您在分析和调试复杂的程序时，无数个函数在不同的代码文件中相互调用，如果这时候能够准确地知道哪个文件中的具体哪个函数正在执行，对于调试是十分有帮助的。您可以使用 <code>runtime</code> 或 <code>log</code> 包中的特殊函数来实现这样的功能。包 <code>runtime</code> 中的函数 <code>Caller()</code> 提供了相应的信息，因此可以在需要的时候实现一个 <code>where()</code> 闭包函数来打印函数执行的位置：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>where <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> file<span class="token punctuation">,</span> line<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> runtime<span class="token punctuation">.</span><span class="token function">Caller</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s:%d&quot;</span><span class="token punctuation">,</span> file<span class="token punctuation">,</span> line<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// some code</span>
<span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// some more code</span>
<span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>您也可以设置 <code>log</code> 包中的 <code>flag</code> 参数来实现：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>log<span class="token punctuation">.</span><span class="token function">SetFlags</span><span class="token punctuation">(</span>log<span class="token punctuation">.</span>Llongfile<span class="token punctuation">)</span>
log<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>或使用一个更加简短版本的 <code>where()</code> 函数：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> where <span class="token operator">=</span> log<span class="token punctuation">.</span>Print
<span class="token keyword">func</span> <span class="token function">func1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">...</span> some code
<span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">...</span> some code
<span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-11-计算函数执行时间" tabindex="-1"><a class="header-anchor" href="#_6-11-计算函数执行时间" aria-hidden="true">#</a> 6.11 计算函数执行时间</h3><p>有时候，能够知道一个计算执行消耗的时间是非常有意义的，尤其是在对比和基准测试中。最简单的一个办法就是在计算开始之前设置一个起始时间，再记录计算结束时的结束时间，最后计算它们的差值，就是这个计算所消耗的时间。想要实现这样的做法，可以使用 <code>time</code> 包中的 <code>Now()</code> 和 <code>Sub()</code> 函数：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>start <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">longCalculation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
end <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
delta <span class="token operator">:=</span> end<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span>
fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;longCalculation took this amount of time: %s\\n&quot;</span><span class="token punctuation">,</span> delta<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>您可以查看示例 6.20 <a href="examples/chapter_6/fibonacci.go">fibonacci.go</a> 作为实例学习。</p><p>如果您对一段代码进行了所谓的优化，请务必对它们之间的效率进行对比再做出最后的判断。在接下来的章节中，我们会学习如何进行有价值的优化操作。</p><h3 id="_6-12-通过内存缓存来提升性能" tabindex="-1"><a class="header-anchor" href="#_6-12-通过内存缓存来提升性能" aria-hidden="true">#</a> 6.12 通过内存缓存来提升性能</h3><p>当在进行大量的计算时，提升性能最直接有效的一种方式就是避免重复计算。通过在内存中缓存和重复利用相同计算的结果，称之为内存缓存。最明显的例子就是生成斐波那契数列的程序（详见第 <a href="">6.6</a> 和 <a href="">6.11</a> 节）：</p><p>要计算数列中第 n 个数字，需要先得到之前两个数的值，但很明显绝大多数情况下前两个数的值都是已经计算过的。即每个更后面的数都是基于之前计算结果的重复计算，正如示例 6.11 <a href="examples/chapter_6/fibonacci.go">fibonnaci.go</a> 所展示的那样。</p><p>而我们要做就是将第 n 个数的值存在数组中索引为 n 的位置（详见<a href="">第 7 章</a>），然后在数组中查找是否已经计算过，如果没有找到，则再进行计算。</p><p>程序 Listing 6.17 - <a href="examples/chapter_6/fibonacci_memoization.go">fibonacci_memoization.go</a> 就是依照这个原则实现的，下面是计算到第 40 位数字的性能对比：</p><ul><li>普通写法：4.730270 秒</li><li>内存缓存：0.001000 秒</li></ul><p>内存缓存的优势显而易见，而且您还可以将它应用到其它类型的计算中，例如使用 <code>map</code>（详见<a href="">第 7 章</a>）而不是数组或切片（Listing 6.21 - <a href="examples/chapter_6/fibonacci_memoization.go">fibonacci_memoization.go</a>）：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> LIM <span class="token operator">=</span> <span class="token number">41</span>

<span class="token keyword">var</span> fibs <span class="token punctuation">[</span>LIM<span class="token punctuation">]</span><span class="token builtin">uint64</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> result <span class="token builtin">uint64</span> <span class="token operator">=</span> <span class="token number">0</span>
	start <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> LIM<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		result <span class="token operator">=</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;fibonacci(%d) is: %d\\n&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> result<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	end <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	delta <span class="token operator">:=</span> end<span class="token punctuation">.</span><span class="token function">Sub</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;longCalculation took this amount of time: %s\\n&quot;</span><span class="token punctuation">,</span> delta<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>res <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// memoization: check if fibonacci(n) is already known in array:</span>
	<span class="token keyword">if</span> fibs<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		res <span class="token operator">=</span> fibs<span class="token punctuation">[</span>n<span class="token punctuation">]</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> n <span class="token operator">&lt;=</span> <span class="token number">1</span> <span class="token punctuation">{</span>
		res <span class="token operator">=</span> <span class="token number">1</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		res <span class="token operator">=</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">fibonacci</span><span class="token punctuation">(</span>n<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fibs<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">=</span> res
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>内存缓存的技术在使用计算成本相对昂贵的函数时非常有用（不仅限于例子中的递归），譬如大量进行相同参数的运算。这种技术还可以应用于纯函数中，即相同输入必定获得相同输出的函数。</p><h2 id="第-7-章-数组-array-与切片-slice" tabindex="-1"><a class="header-anchor" href="#第-7-章-数组-array-与切片-slice" aria-hidden="true">#</a> 第 7 章：数组(array)与切片(slice)</h2><p>这章我们开始剖析 <strong>集合</strong>，它是可以包含大量条目 (item) 的数据结构，例如数组、切片和 <code>map</code>。从这看到 Go 明显受到 Python 的影响。</p><p>以 <code>[]</code> 符号标识的数组类型几乎在所有的编程语言中都是一个基本主力。Go 语言中的数组也是类似的，只是有一些特点。Go 没有 C 那么灵活，但是拥有切片 (slice) 类型。这是一种建立在 Go 语言数组类型之上的抽象，要想理解切片我们必须先理解数组。数组有特定的用处，但是却有一些呆板，所以在 Go 语言的代码里并不是特别常见。相对的，切片确实随处可见的。它们构建在数组之上并且提供更强大的能力和便捷。</p><h3 id="_7-1-声明和初始化" tabindex="-1"><a class="header-anchor" href="#_7-1-声明和初始化" aria-hidden="true">#</a> 7.1 声明和初始化</h3><h4 id="_7-1-1-概念" tabindex="-1"><a class="header-anchor" href="#_7-1-1-概念" aria-hidden="true">#</a> 7.1.1 概念</h4><p>数组是具有相同 <strong>唯一类型</strong> 的一组已编号且长度固定的数据项序列（这是一种同构的数据结构）；这种类型可以是任意的原始类型例如整型、字符串或者自定义类型。数组长度必须是一个常量表达式，并且必须是一个非负整数。数组长度也是数组类型的一部分，所以 <code>[5]int</code> 和 <code>[10]int</code> 是属于不同类型的。数组的编译时值初始化是按照数组顺序完成的（如下）。</p><p><strong>注意事项</strong> 如果我们想让数组元素类型为任意类型的话可以使用空接口作为类型（参考 <a href="">第 11 章</a>）。当使用值时我们必须先做一个类型判断（参考 <a href="">第 11 章</a>）。</p><p>数组元素可以通过 <strong>索引</strong>（位置）来读取（或者修改），索引从 <code>0</code> 开始，第一个元素索引为 <code>0</code>，第二个索引为 <code>1</code>，以此类推（数组以 0 开始在所有类 C 语言中是相似的）。元素的数目（也称为长度或者数组大小）必须是固定的并且在声明该数组时就给出（编译时需要知道数组长度以便分配内存）；数组长度最大为 2GB。</p><p>声明的格式是：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> identifier <span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">]</span><span class="token keyword">type</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> arr1 <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token builtin">int</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>在内存中的结构是： <img src="`+x+`" alt="" loading="lazy"></p><p>每个元素是一个整型值，当声明数组时所有的元素都会被自动初始化为默认值 0。</p><p><code>arr1</code> 的长度是 5，索引范围从 <code>0</code> 到 <code>len(arr1)-1</code>。</p><p>第一个元素是 <code>arr1[0]</code>，第三个元素是 <code>arr1[2]</code>；总体来说索引 <code>i</code> 代表的元素是 <code>arr1[i]</code>，最后一个元素是 <code>arr1[len(arr1)-1]</code>。</p><p>对索引项为 <code>i</code> 的数组元素赋值可以这么操作：<code>arr[i] = value</code>，所以数组是 <strong>可变的</strong>。</p><p>只有有效的索引可以被使用，当使用等于或者大于 <code>len(arr1)</code> 的索引时：如果编译器可以检测到，会给出索引超限的提示信息；如果检测不到的话编译会通过而运行时会 <code>panic()</code>:（参考<a href="">第 13 章</a>）</p><pre><code>runtime error: index out of range
</code></pre><p>由于索引的存在，遍历数组的方法自然就是使用 <code>for</code> 结构：</p><ul><li>通过 <code>for</code> 初始化数组项</li><li>通过 <code>for</code> 打印数组元素</li><li>通过 <code>for</code> 依次处理元素</li></ul><p>示例 7.1 <a href="examples/chapter_7/for_arrays.go">for_arrays.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> arr1 <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token builtin">int</span>

	<span class="token keyword">for</span> i<span class="token operator">:=</span><span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>arr1<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		arr1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i <span class="token operator">*</span> <span class="token number">2</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">for</span> i<span class="token operator">:=</span><span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>arr1<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Array at index %d is %d\\n&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> arr1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出结果：</p><pre><code>Array at index 0 is 0
Array at index 1 is 2
Array at index 2 is 4
Array at index 3 is 6
Array at index 4 is 8
</code></pre><p><code>for</code> 循环中的条件非常重要：<code>i &lt; len(arr1)</code>，如果写成 <code>i &lt;= len(arr1)</code> 的话会产生越界错误。</p><p>IDIOM:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">for</span> i<span class="token operator">:=</span><span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>arr1<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span>｛
	arr1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>也可以使用 for-range 的生成方式：</p><p>IDIOM:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">for</span> i<span class="token punctuation">,</span><span class="token boolean">_</span><span class="token operator">:=</span> <span class="token keyword">range</span> arr1 <span class="token punctuation">{</span>
<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在这里 <code>i</code> 也是数组的索引。当然这两种 <code>for</code> 结构对于切片（<code>slices</code>）（参考 <a href="">第 7 章</a>）来说也同样适用。</p><p><strong>问题 7.1</strong> 下面代码段的输出是什么？</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>a <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;c&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d&quot;</span><span class="token punctuation">}</span>
<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> a <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Array item&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token string">&quot;is&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Go 语言中的数组是一种 <strong>值类型</strong>（不像 C/C++ 中是指向首元素的指针），所以可以通过 <code>new()</code> 来创建： <code>var arr1 = new([5]int)</code>。</p><p>那么这种方式和 <code>var arr2 [5]int</code> 的区别是什么呢？<code>arr1</code> 的类型是 <code>*[5]int</code>，而 <code>arr2</code> 的类型是 <code>[5]int</code>。</p><p>这样的结果就是当把一个数组赋值给另一个时，需要再做一次数组内存的拷贝操作。例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>arr2 <span class="token operator">:=</span> <span class="token operator">*</span>arr1
arr2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">100</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>这样两个数组就有了不同的值，在赋值后修改 <code>arr2</code> 不会对 <code>arr1</code> 生效。</p><p>所以在函数中数组作为参数传入时，如 <code>func1(arr2)</code>，会产生一次数组拷贝，<code>func1()</code> 方法不会修改原始的数组 <code>arr2</code>。</p><p>如果你想修改原数组，那么 <code>arr2</code> 必须通过 <code>&amp;</code> 操作符以引用方式传过来，例如 <code>func1(&amp;arr2)</code>，下面是一个例子：</p><p>示例 7.2 <a href="examples/chapter_7/pointer_array.go">pointer_array.go</a>:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>
<span class="token keyword">func</span> <span class="token function">f</span><span class="token punctuation">(</span>a <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">fp</span><span class="token punctuation">(</span>a <span class="token operator">*</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> ar <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token builtin">int</span>
	<span class="token function">f</span><span class="token punctuation">(</span>ar<span class="token punctuation">)</span> 	<span class="token comment">// passes a copy of ar</span>
	<span class="token function">fp</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ar<span class="token punctuation">)</span> <span class="token comment">// passes a pointer to ar</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出结果：</p><pre><code>[0 0 0]
&amp;[0 0 0]
</code></pre><p>另一种方法就是生成数组切片并将其传递给函数（详见<a href="">第 7.1.4 节</a>）。</p><p><strong>练习</strong></p><p>练习7.1：<a href="examples/chapter_7/array_value.go">array_value.go</a>:</p><p>证明当数组赋值时，发生了数组内存拷贝。</p><p>练习7.2：<a href="examples/chapter_7/for_array.go">for_array.go</a>:</p><p>写一个循环并用下标给数组赋值（从 0 到 15）并且将数组打印在屏幕上。</p><p>练习7.3：<a href="examples/chapter_7/fibonacci_array.go">fibonacci_array.go</a>:</p><p>在<a href="">第 6.6 节</a> 我们看到了一个递归计算 Fibonacci 数值的方法。但是通过数组我们可以更快的计算出 Fibonacci 数。完成该方法并打印出前 50 个 Fibonacci 数字。</p><h4 id="_7-1-2-数组常量" tabindex="-1"><a class="header-anchor" href="#_7-1-2-数组常量" aria-hidden="true">#</a> 7.1.2 数组常量</h4><p>如果数组值已经提前知道了，那么可以通过 <strong>数组常量</strong> 的方法来初始化数组，而不用依次使用 <code>[]=</code> 方法（所有的组成元素都有相同的常量语法）。</p><p>示例 7.3 <a href="examples/chapter_7/array_literals.go">array_literals.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// var arrAge = [5]int{18, 20, 15, 22, 16}</span>
	<span class="token comment">// var arrLazy = [...]int{5, 6, 7, 8, 22}</span>
	<span class="token comment">// var arrLazy = []int{5, 6, 7, 8, 22}	//注：初始化得到的实际上是切片slice</span>
	<span class="token keyword">var</span> arrKeyValue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">:</span> <span class="token string">&quot;Chris&quot;</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span> <span class="token string">&quot;Ron&quot;</span><span class="token punctuation">}</span>
	<span class="token comment">// var arrKeyValue = []string{3: &quot;Chris&quot;, 4: &quot;Ron&quot;}	//注：初始化得到的实际上是切片slice</span>

	<span class="token keyword">for</span> i<span class="token operator">:=</span><span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>arrKeyValue<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Person at %d is %s\\n&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> arrKeyValue<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第一种变化：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> arrAge <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>注意 <code>[5]int</code> 可以从左边起开始忽略：<code>[10]int {1, 2, 3}</code> :这是一个有 10 个元素的数组，除了前三个元素外其他元素都为 <code>0</code>。</p><p>第二种变化：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> arrLazy <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>...</code> 同样可以忽略，从技术上说它们其实变成了切片。</p><p>第三种变化：<code>key: value 语法</code></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> arrKeyValue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">:</span> <span class="token string">&quot;Chris&quot;</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span> <span class="token string">&quot;Ron&quot;</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>只有索引 3 和 4 被赋予实际的值，其他元素都被设置为空的字符串，所以输出结果为：</p><pre><code>Person at 0 is
Person at 1 is
Person at 2 is
Person at 3 is Chris
Person at 4 is Ron
</code></pre><p>在这里数组长度同样可以写成 <code>...</code>。</p><p>你可以取任意数组常量的地址来作为指向新实例的指针。</p><p>示例 7.4 <a href="examples/chapter_7/pointer_array2.go">pointer_array2.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">fp</span><span class="token punctuation">(</span>a <span class="token operator">*</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token function">fp</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span>i<span class="token punctuation">,</span> i <span class="token operator">*</span> i<span class="token punctuation">,</span> i <span class="token operator">*</span> i <span class="token operator">*</span> i<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出结果：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>&amp;[0 0 0]
&amp;[1 1 1]
&amp;[2 4 8]
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>几何点（或者数学向量）是一个使用数组的经典例子。为了简化代码通常使用一个别名：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Vector3D <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token builtin">float32</span>
<span class="token keyword">var</span> vec Vector3D
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_7-1-3-多维数组" tabindex="-1"><a class="header-anchor" href="#_7-1-3-多维数组" aria-hidden="true">#</a> 7.1.3 多维数组</h4><p>数组通常是一维的，但是可以用来组装成多维数组，例如：<code>[3][5]int</code>，<code>[2][2][2]float64</code>。</p><p>内部数组总是长度相同的。Go 语言的多维数组是矩形式的（唯一的例外是切片的数组，参见<a href="">第 7.2.5 节</a>。</p><p>示例 7.5 <a href="examples/chapter_7/multidim_array.go">multidim_array.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">const</span> <span class="token punctuation">(</span>
	WIDTH  <span class="token operator">=</span> <span class="token number">1920</span>
	HEIGHT <span class="token operator">=</span> <span class="token number">1080</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> pixel <span class="token builtin">int</span>
<span class="token keyword">var</span> screen <span class="token punctuation">[</span>WIDTH<span class="token punctuation">]</span><span class="token punctuation">[</span>HEIGHT<span class="token punctuation">]</span>pixel

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> y <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> HEIGHT<span class="token punctuation">;</span> y<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> x <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> WIDTH<span class="token punctuation">;</span> x<span class="token operator">++</span> <span class="token punctuation">{</span>
			screen<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_7-1-4-将数组传递给函数" tabindex="-1"><a class="header-anchor" href="#_7-1-4-将数组传递给函数" aria-hidden="true">#</a> 7.1.4 将数组传递给函数</h4><p>把一个大数组传递给函数会消耗很多内存。有两种方法可以避免这种情况：</p><ul><li>传递数组的指针</li><li>使用数组的切片</li></ul><p>接下来的例子阐明了第一种方法：</p><p>示例 7.6 <a href="examples/chapter_7/array_sum.go">array_sum.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	array <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token builtin">float64</span><span class="token punctuation">{</span><span class="token number">7.0</span><span class="token punctuation">,</span> <span class="token number">8.5</span><span class="token punctuation">,</span> <span class="token number">9.1</span><span class="token punctuation">}</span>
	x <span class="token operator">:=</span> <span class="token function">Sum</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>array<span class="token punctuation">)</span> <span class="token comment">// Note the explicit address-of operator</span>
	<span class="token comment">// to pass a pointer to the array</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The sum of the array is: %f&quot;</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Sum</span><span class="token punctuation">(</span>a <span class="token operator">*</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token builtin">float64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>sum <span class="token builtin">float64</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> a <span class="token punctuation">{</span> <span class="token comment">// derefencing *a to get back to the array is not necessary!</span>
		sum <span class="token operator">+=</span> v
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出结果：</p><pre><code>The sum of the array is: 24.600000
</code></pre><p>但这在 Go 中并不常用，通常使用切片（参考 <a href="">第 7.2 节</a>）。</p><h3 id="_7-2-切片" tabindex="-1"><a class="header-anchor" href="#_7-2-切片" aria-hidden="true">#</a> 7.2 切片</h3><h4 id="_7-2-1-概念" tabindex="-1"><a class="header-anchor" href="#_7-2-1-概念" aria-hidden="true">#</a> 7.2.1 概念</h4><p>切片 (slice) 是对数组一个连续片段的引用（该数组我们称之为相关数组，通常是匿名的），所以切片是一个引用类型（因此更类似于 C/C++ 中的数组类型，或者 Python 中的 list 类型）。这个片段可以是整个数组，或者是由起始和终止索引标识的一些项的子集。需要注意的是，终止索引标识的项不包括在切片内。切片提供了一个相关数组的动态窗口。</p><p>切片是可索引的，并且可以由 <code>len()</code> 函数获取长度。</p><p>给定项的切片索引可能比相关数组的相同元素的索引小。和数组不同的是，切片的长度可以在运行时修改，最小为 0， 最大为相关数组的长度：切片是一个 <strong>长度可变的数组</strong>。</p><p>切片提供了计算容量的函数 <code>cap()</code> 可以测量切片最长可以达到多少：它等于切片的长度 + 数组除切片之外的长度。如果 <code>s</code> 是一个切片，<code>cap(s)</code> 就是从 <code>s[0]</code> 到数组末尾的数组长度。切片的长度永远不会超过它的容量，所以对于切片 <code>s</code> 来说该不等式永远成立：<code>0 &lt;= len(s) &lt;= cap(s)</code>。</p><p>多个切片如果表示同一个数组的片段，它们可以共享数据；因此一个切片和相关数组的其他切片是共享存储的，相反，不同的数组总是代表不同的存储。数组实际上是切片的构建块。</p><p><strong>优点</strong> 因为切片是引用，所以它们不需要使用额外的内存并且比使用数组更有效率，所以在 Go 代码中切片比数组更常用。</p><p>声明切片的格式是： <code>var identifier []type</code>（不需要说明长度）。</p><p>一个切片在未初始化之前默认为 <code>nil</code>，长度为 0。</p><p>切片的初始化格式是：<code>var slice1 []type = arr1[start:end]</code>。</p><p>这表示 <code>slice1</code> 是由数组 <code>arr1</code> 从 <code>start</code> 索引到 <code>end-1</code> 索引之间的元素构成的子集（切分数组，<code>start:end</code> 被称为切片表达式）。所以 <code>slice1[0]</code> 就等于 <code>arr1[start]</code>。这可以在 <code>arr1</code> 被填充前就定义好。</p><p>如果某个人写：<code>var slice1 []type = arr1[:]</code> 那么 <code>slice1</code> 就等于完整的 <code>arr1</code> 数组（所以这种表示方式是 <code>arr1[0:len(arr1)]</code> 的一种缩写）。另外一种表述方式是：<code>slice1 = &amp;arr1</code>。</p><p><code>arr1[2:]</code> 和 <code>arr1[2:len(arr1)]</code> 相同，都包含了数组从第三个到最后的所有元素。</p><p><code>arr1[:3]</code> 和 <code>arr1[0:3]</code> 相同，包含了从第一个到第三个元素（不包括第四个）。</p><p>如果你想去掉 <code>slice1</code> 的最后一个元素，只要 <code>slice1 = slice1[:len(slice1)-1]</code>。</p><p>一个由数字 1、2、3 组成的切片可以这么生成：<code>s := [3]int{1,2,3}[:]</code>（注：应先用 <code>s := [3]int{1, 2, 3}</code> 生成数组, 再使用 <code>s[:]</code> 转成切片）甚至更简单的 <code>s := []int{1,2,3}</code>。</p><p><code>s2 := s[:]</code> 是用切片组成的切片，拥有相同的元素，但是仍然指向相同的相关数组。</p><p>一个切片 <code>s</code> 可以这样扩展到它的大小上限：<code>s = s[:cap(s)]</code>，如果再扩大的话就会导致运行时错误（参见第 7.7 节）。</p><p>对于每一个切片（包括 <code>string</code>），以下状态总是成立的：</p><pre><code>s == s[:i] + s[i:] // i是一个整数且: 0 &lt;= i &lt;= len(s)
len(s) &lt;= cap(s)
</code></pre><p>切片也可以用类似数组的方式初始化：<code>var x = []int{2, 3, 5, 7, 11}</code>。这样就创建了一个长度为 5 的数组并且创建了一个相关切片。</p><p>切片在内存中的组织方式实际上是一个有 3 个域的结构体：指向相关数组的指针，切片长度以及切片容量。下图给出了一个长度为 2，容量为 4 的切片 <code>y</code>。</p><ul><li><code>y[0] = 3</code> 且 <code>y[1] = 5</code>。</li><li>切片 <code>y[0:4]</code> 由 元素 <code>3</code>，<code>5</code>，<code>7</code> 和 <code>11</code> 组成。</li></ul><figure><img src="`+G+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>示例 7.7 <a href="examples/chapter_7/array_slices.go">array_slices.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> arr1 <span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token builtin">int</span>
	<span class="token keyword">var</span> slice1 <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span> <span class="token operator">=</span> arr1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token comment">// item at index 5 not included!</span>

	<span class="token comment">// load the array with integers: 0,1,2,3,4,5</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>arr1<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		arr1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i
	<span class="token punctuation">}</span>

	<span class="token comment">// print the slice</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>slice1<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Slice at %d is %d\\n&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> slice1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The length of arr1 is %d\\n&quot;</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>arr1<span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The length of slice1 is %d\\n&quot;</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>slice1<span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The capacity of slice1 is %d\\n&quot;</span><span class="token punctuation">,</span> <span class="token function">cap</span><span class="token punctuation">(</span>slice1<span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token comment">// grow the slice</span>
	slice1 <span class="token operator">=</span> slice1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>slice1<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Slice at %d is %d\\n&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> slice1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The length of slice1 is %d\\n&quot;</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>slice1<span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The capacity of slice1 is %d\\n&quot;</span><span class="token punctuation">,</span> <span class="token function">cap</span><span class="token punctuation">(</span>slice1<span class="token punctuation">)</span><span class="token punctuation">)</span>

	<span class="token comment">// grow the slice beyond capacity</span>
	<span class="token comment">//slice1 = slice1[0:7 ] // panic: runtime error: slice bound out of range</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>Slice at 0 is 2  
Slice at 1 is 3  
Slice at 2 is 4  
The length of arr1 is 6  
The length of slice1 is 3  
The capacity of slice1 is 4  
Slice at 0 is 2  
Slice at 1 is 3  
Slice at 2 is 4  
Slice at 3 is 5  
The length of slice1 is 4  
The capacity of slice1 is 4  
</code></pre><p>如果 <code>s2</code> 是一个切片，你可以将 <code>s2</code> 向后移动一位 <code>s2 = s2[1:]</code>，但是末尾没有移动。切片只能向后移动，<code>s2 = s2[-1:]</code> 会导致编译错误。切片不能被重新分片以获取数组的前一个元素。</p><p><strong>注意</strong> 绝对不要用指针指向切片。切片本身已经是一个引用类型，所以它本身就是一个指针！！</p><p>问题 7.2： 给定切片 <code>b:= []byte{&#39;g&#39;, &#39;o&#39;, &#39;l&#39;, &#39;a&#39;, &#39;n&#39;, &#39;g&#39;}</code>，那么 <code>b[1:4]</code>、<code>b[:2]</code>、<code>b[2:]</code> 和 <code>b[:]</code> 分别是什么？</p><h4 id="_7-2-2-将切片传递给函数" tabindex="-1"><a class="header-anchor" href="#_7-2-2-将切片传递给函数" aria-hidden="true">#</a> 7.2.2 将切片传递给函数</h4><p>如果你有一个函数需要对数组做操作，你可能总是需要把参数声明为切片。当你调用该函数时，把数组分片，创建为一个切片引用并传递给该函数。这里有一个计算数组元素和的方法:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">sum</span><span class="token punctuation">(</span>a <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	s <span class="token operator">:=</span> <span class="token number">0</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		s <span class="token operator">+=</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> s
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">}</span>
	<span class="token function">sum</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_7-2-3-用-make-创建一个切片" tabindex="-1"><a class="header-anchor" href="#_7-2-3-用-make-创建一个切片" aria-hidden="true">#</a> 7.2.3 用 make() 创建一个切片</h4><p>当相关数组还没有定义时，我们可以使用 <code>make()</code> 函数来创建一个切片，同时创建好相关数组：<code>var slice1 []type = make([]type, len)</code>。</p><p>也可以简写为 <code>slice1 := make([]type, len)</code>，这里 <code>len</code> 是数组的长度并且也是 <code>slice</code> 的初始长度。</p><p>所以定义 <code>s2 := make([]int, 10)</code>，那么 <code>cap(s2) == len(s2) == 10</code>。</p><p><code>make()</code> 接受 2 个参数：元素的类型以及切片的元素个数。</p><p>如果你想创建一个 <code>slice1</code>，它不占用整个数组，而只是占用以 <code>len</code> 为个数个项，那么只要：<code>slice1 := make([]type, len, cap)</code>。</p><p><code>make()</code> 的使用方式是：<code>func make([]T, len, cap)</code>，其中 <code>cap</code> 是可选参数。</p><p>所以下面两种方法可以生成相同的切片:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
<span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>下图描述了使用 <code>make()</code> 方法生成的切片的内存结构：</p><figure><img src="`+P+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>示例 7.8 <a href="examples/chapter_7/make_slice.go">make_slice.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> slice1 <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span> <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
	<span class="token comment">// load the array/slice:</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>slice1<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		slice1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">5</span> <span class="token operator">*</span> i
	<span class="token punctuation">}</span>

	<span class="token comment">// print the slice:</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>slice1<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Slice at %d is %d\\n&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> slice1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;\\nThe length of slice1 is %d\\n&quot;</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>slice1<span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The capacity of slice1 is %d\\n&quot;</span><span class="token punctuation">,</span> <span class="token function">cap</span><span class="token punctuation">(</span>slice1<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>Slice at 0 is 0  
Slice at 1 is 5  
Slice at 2 is 10  
Slice at 3 is 15  
Slice at 4 is 20  
Slice at 5 is 25  
Slice at 6 is 30  
Slice at 7 is 35  
Slice at 8 is 40  
Slice at 9 is 45  

The length of slice1 is 10  
The capacity of slice1 is 10  
</code></pre><p>因为字符串是纯粹不可变的字节数组，它们也可以被切分成切片。</p><p>练习 7.4： <a href="examples/chapter_7/fibonacci_funcarray.go">fibonacci_funcarray.go</a>: 为练习 7.3 写一个新的版本，主函数调用一个使用序列个数作为参数的函数，该函数返回一个大小为序列个数的 Fibonacci 切片。</p><h4 id="_7-2-4-new-和-make-的区别" tabindex="-1"><a class="header-anchor" href="#_7-2-4-new-和-make-的区别" aria-hidden="true">#</a> 7.2.4 new() 和 make() 的区别</h4><p>看起来二者没有什么区别，都在堆上分配内存，但是它们的行为不同，适用于不同的类型。</p><ul><li><code>new(T)</code> 为每个新的类型 <code>T</code> 分配一片内存，初始化为 <code>0</code> 并且返回类型为 <code>*T</code> 的内存地址：这种方法 <strong>返回一个指向类型为 <code>T</code>，值为 <code>0</code> 的地址的指针</strong>，它适用于值类型如数组和结构体（参见<a href="">第 10 章</a>）；它相当于 <code>&amp;T{}</code>。</li><li><code>make(T)</code> <strong>返回一个类型为 T 的初始值</strong>，它只适用于 3 种内建的引用类型：切片、<code>map</code> 和 <code>channel</code>（参见<a href="">第 8 章</a>和<a href="">第 13 章</a>）。</li></ul><p>换言之，<code>new()</code> 函数分配内存，<code>make()</code> 函数初始化；下图给出了区别：</p><figure><img src="`+S+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>在图 7.3 的第一幅图中：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> p <span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span> <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token comment">// *p == nil; with len and cap 0</span>
p <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>在第二幅图中， <code>p := make([]int, 0)</code> ，切片 已经被初始化，但是指向一个空的数组。</p><p>以上两种方式实用性都不高。下面的方法：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> v <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span> <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>或者</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>v <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>这样分配一个有 50 个 <code>int</code> 值的数组，并且创建了一个长度为 10，容量为 50 的切片 <code>v</code>，该切片指向数组的前 10 个元素。</p><p><strong>问题 7.3</strong> 给定 <code>s := make([]byte, 5)</code>，<code>len(s)</code> 和 <code>cap(s)</code> 分别是多少？<code>s = s[2:4]</code>，<code>len(s)</code> 和 <code>cap(s)</code> 又分别是多少？</p><p><strong>问题 7.4</strong> 假设 <code>s1 := []byte{&#39;p&#39;, &#39;o&#39;, &#39;e&#39;, &#39;m&#39;}</code> 且 <code>s2 := s1[2:]</code>，<code>s2</code> 的值是多少？如果我们执行 <code>s2[1] = &#39;t&#39;</code>，<code>s1</code> 和 <code>s2</code> 现在的值又分别是多少？</p><p><em>译者注：如何理解 new、make、slice、map、channel 的关系</em></p><p><em>1.slice、map 以及 channel 都是 golang 内建的一种引用类型，三者在内存中存在多个组成部分， 需要对内存组成部分初始化后才能使用，而 make 就是对三者进行初始化的一种操作方式</em></p><p><em>2. new 获取的是存储指定变量内存地址的一个变量，对于变量内部结构并不会执行相应的初始化操作， 所以 slice、map、channel 需要 make 进行初始化并获取对应的内存地址，而非 new 简单的获取内存地址</em></p><h4 id="_7-2-5-多维切片" tabindex="-1"><a class="header-anchor" href="#_7-2-5-多维切片" aria-hidden="true">#</a> 7.2.5 多维切片</h4><p>和数组一样，切片通常也是一维的，但是也可以由一维组合成高维。通过分片的分片（或者切片的数组），长度可以任意动态变化，所以 Go 语言的多维切片可以任意切分。而且，内层的切片必须单独分配（通过 <code>make()</code> 函数）。</p><h4 id="_7-2-6-bytes-包" tabindex="-1"><a class="header-anchor" href="#_7-2-6-bytes-包" aria-hidden="true">#</a> 7.2.6 bytes 包</h4><p>类型 <code>[]byte</code> 的切片十分常见，Go 语言有一个 <code>bytes</code> 包专门用来提供这种类型的操作方法。</p><p><code>bytes</code> 包和字符串包十分类似（参见<a href="">第 4.7 节</a>）。而且它还包含一个十分有用的类型 <code>Buffer</code>:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token string">&quot;bytes&quot;</span>

<span class="token keyword">type</span> Buffer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这是一个长度可变的 <code>bytes</code> 的 buffer，提供 <code>Read()</code> 和 <code>Write()</code> 方法，因为读写长度未知的 <code>bytes</code> 最好使用 <code>buffer</code>。</p><p><code>Buffer</code> 可以这样定义：<code>var buffer bytes.Buffer</code>。</p><p>或者使用 <code>new()</code> 获得一个指针：<code>var r *bytes.Buffer = new(bytes.Buffer)</code>。</p><p>或者通过函数：<code>func NewBuffer(buf []byte) *Buffer</code>，创建一个 <code>Buffer</code> 对象并且用 <code>buf</code> 初始化好；<code>NewBuffer</code> 最好用在从 <code>buf</code> 读取的时候使用。</p><p><strong>通过 buffer 串联字符串</strong></p><p>类似于 Java 的 StringBuilder 类。</p><p>在下面的代码段中，我们创建一个 <code>buffer</code>，通过 <code>buffer.WriteString(s)</code> 方法将字符串 <code>s</code> 追加到后面，最后再通过 <code>buffer.String()</code> 方法转换为 <code>string</code>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> buffer bytes<span class="token punctuation">.</span>Buffer
<span class="token keyword">for</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> s<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token function">getNextString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span> <span class="token comment">//method getNextString() not shown here</span>
		buffer<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">break</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;\\n&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这种实现方式比使用 <code>+=</code> 要更节省内存和 CPU，尤其是要串联的字符串数目特别多的时候。</p><p><strong>练习 7.5</strong></p><p>给定切片 <code>sl</code>，将一个 <code>[]byte</code> 数组追加到 <code>sl</code> 后面。写一个函数 <code>Append(slice, data []byte) []byte</code>，该函数在 <code>sl</code> 不能存储更多数据的时候自动扩容。</p><p><strong>练习 7.6</strong></p><p>把一个缓存 <code>buf</code> 分片成两个切片：第一个是前 <code>n</code> 个 bytes，后一个是剩余的，用一行代码实现。</p><h3 id="_7-3-for-range-结构" tabindex="-1"><a class="header-anchor" href="#_7-3-for-range-结构" aria-hidden="true">#</a> 7.3 For-range 结构</h3><p>这种构建方法可以应用于数组和切片:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">for</span> ix<span class="token punctuation">,</span> value <span class="token operator">:=</span> <span class="token keyword">range</span> slice1 <span class="token punctuation">{</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第一个返回值 <code>ix</code> 是数组或者切片的索引，第二个是在该索引位置的值；他们都是仅在 <code>for</code> 循环内部可见的局部变量。<code>value</code> 只是 <code>slice1</code> 某个索引位置的值的一个拷贝，不能用来修改 <code>slice1</code> 该索引位置的值。</p><p>示例 7.9 <a href="examples/chapter_7/slices_forrange.go">slices_forrange.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> slice1 <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span> <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>

	slice1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
	slice1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span>
	slice1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">3</span>
	slice1<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">4</span>

	<span class="token keyword">for</span> ix<span class="token punctuation">,</span> value <span class="token operator">:=</span> <span class="token keyword">range</span> slice1 <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Slice at %d is: %d\\n&quot;</span><span class="token punctuation">,</span> ix<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>示例 7.10 <a href="examples/chapter_7/slices_forrange2.go">slices_forrange2.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	seasons <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;Spring&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Summer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Autumn&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Winter&quot;</span><span class="token punctuation">}</span>
	<span class="token keyword">for</span> ix<span class="token punctuation">,</span> season <span class="token operator">:=</span> <span class="token keyword">range</span> seasons <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Season %d is: %s\\n&quot;</span><span class="token punctuation">,</span> ix<span class="token punctuation">,</span> season<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">var</span> season <span class="token builtin">string</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> season <span class="token operator">=</span> <span class="token keyword">range</span> seasons <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s\\n&quot;</span><span class="token punctuation">,</span> season<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>slices_forrange2.go 给出了一个关于字符串的例子， <code>_</code> 可以用于忽略索引。</p><p>如果你只需要索引，你可以忽略第二个变量，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">for</span> ix <span class="token operator">:=</span> <span class="token keyword">range</span> seasons <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d&quot;</span><span class="token punctuation">,</span> ix<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// Output: 0 1 2 3</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果你需要修改 <code>seasons[ix]</code> 的值可以使用这个版本。</p><p><strong>多维切片下的 for-range：</strong></p><p>通过计算行数和矩阵值可以很方便的写出如（参考<a href="">第 7.1.3 节</a>）的 <code>for</code> 循环来，例如（参考<a href="">第 7.5 节</a>的例子 <a href="exercises/chapter_7/multidim_array.go">multidim_array.go</a>）：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">for</span> row <span class="token operator">:=</span> <span class="token keyword">range</span> screen <span class="token punctuation">{</span>
	<span class="token keyword">for</span> column <span class="token operator">:=</span> <span class="token keyword">range</span> screen<span class="token punctuation">[</span>row<span class="token punctuation">]</span> <span class="token punctuation">{</span>
		screen<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>column<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>问题 7.5</strong> 假设我们有如下数组：<code>items := [...]int{10, 20, 30, 40, 50}</code></p><p>a) 如果我们写了如下的 <code>for</code> 循环，那么执行完 <code>for</code> 循环后的 <code>items</code> 的值是多少？如果你不确定的话可以测试一下:)</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> item <span class="token operator">:=</span> <span class="token keyword">range</span> items <span class="token punctuation">{</span>
	item <span class="token operator">*=</span> <span class="token number">2</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>b) 如果 a) 无法正常工作，写一个 <code>for</code> 循环让值可以变成自身的两倍。</p><p><strong>问题 7.6</strong> 通过使用省略号操作符 <code>...</code> 来实现累加方法。</p><p><strong>练习 7.7</strong> <a href="exercises/chapter_7/sum_array.go">sum_array.go</a></p><p>a) 写一个 <code>Sum()</code> 函数，传入参数为一个 <code>float32</code> 数组成的数组 <code>arrF</code>，返回该数组的所有数字和。</p><p>如果把数组修改为切片的话代码要做怎样的修改？如果用切片形式方法实现不同长度数组的的和呢？</p><p>b) 写一个 <code>SumAndAverage()</code> 方法，返回两个 int 和 <code>float32</code> 类型的未命名变量的和与平均值。</p><p><strong>练习 7.8</strong> <a href="exercises/chapter_7/min_max.go">min_max.go</a></p><p>写一个 <code>minSlice()</code> 方法，传入一个 <code>int</code> 的切片并且返回最小值，再写一个 <code>maxSlice()</code> 方法返回最大值。</p><h3 id="_7-4-切片重组-reslice" tabindex="-1"><a class="header-anchor" href="#_7-4-切片重组-reslice" aria-hidden="true">#</a> 7.4 切片重组 (reslice)</h3><p>我们已经知道切片创建的时候通常比相关数组小，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>slice1 <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">type</span><span class="token punctuation">,</span> start_length<span class="token punctuation">,</span> capacity<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>其中 <code>start_length</code> 作为切片初始长度而 <code>capacity</code> 作为相关数组的长度。</p><p>这么做的好处是我们的切片在达到容量上限后可以扩容。改变切片长度的过程称之为切片重组 <strong>reslicing</strong>，做法如下：<code>slice1 = slice1[0:end]</code>，其中 <code>end</code> 是新的末尾索引（即长度）。</p><p>将切片扩展 1 位可以这么做：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>sl <span class="token operator">=</span> sl<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token function">len</span><span class="token punctuation">(</span>sl<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>切片可以反复扩展直到占据整个相关数组。</p><p>示例 7.11 <a href="examples/chapter_7/reslicing.go">reslicing.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	slice1 <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
	<span class="token comment">// load the slice, cap(slice1) is 10:</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">cap</span><span class="token punctuation">(</span>slice1<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		slice1 <span class="token operator">=</span> slice1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span>
		slice1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The length of slice is %d\\n&quot;</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>slice1<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// print the slice:</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>slice1<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Slice at %d is %d\\n&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> slice1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出结果：</p><pre><code>The length of slice is 1
The length of slice is 2
The length of slice is 3
The length of slice is 4
The length of slice is 5
The length of slice is 6
The length of slice is 7
The length of slice is 8
The length of slice is 9
The length of slice is 10
Slice at 0 is 0
Slice at 1 is 1
Slice at 2 is 2
Slice at 3 is 3
Slice at 4 is 4
Slice at 5 is 5
Slice at 6 is 6
Slice at 7 is 7
Slice at 8 is 8
Slice at 9 is 9
</code></pre><p>另一个例子：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> ar <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> a <span class="token operator">=</span> ar<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token comment">// reference to subarray {5,6} - len(a) is 2 and cap(a) is 5</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>将 <code>a</code> 重新分片：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>a <span class="token operator">=</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token comment">// ref of subarray {5,6,7,8} - len(a) is now 4 but cap(a) is still 5</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>问题 7.7</strong></p><ol><li><p>如果 <code>a</code> 是一个切片，那么 <code>a[n:n]</code> 的长度是多少？</p></li><li><p><code>a[n:n+1]</code> 的长度又是多少？</p></li></ol><h3 id="_7-5-切片的复制与追加" tabindex="-1"><a class="header-anchor" href="#_7-5-切片的复制与追加" aria-hidden="true">#</a> 7.5 切片的复制与追加</h3><p>如果想增加切片的容量，我们必须创建一个新的更大的切片并把原分片的内容都拷贝过来。下面的代码描述了从拷贝切片的 <code>copy</code> 函数和向切片追加新元素的 <code>append()</code> 函数。</p><p>示例 7.12 <a href="examples/chapter_7/copy_append_slice.go">copy_append_slice.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	slFrom <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span>
	slTo <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>

	n <span class="token operator">:=</span> <span class="token function">copy</span><span class="token punctuation">(</span>slTo<span class="token punctuation">,</span> slFrom<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>slTo<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Copied %d elements\\n&quot;</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token comment">// n == 3</span>

	sl3 <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span>
	sl3 <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>sl3<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>sl3<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>func append(s[]T, x ...T) []T</code> 其中 <code>append()</code> 方法将 0 个或多个具有相同类型 <code>s</code> 的元素追加到切片后面并且返回新的切片；追加的元素必须和原切片的元素是同类型。如果 <code>s</code> 的容量不足以存储新增元素，<code>append()</code> 会分配新的切片来保证已有切片元素和新增元素的存储。因此，返回的切片可能已经指向一个不同的相关数组了。<code>append()</code> 方法总是返回成功，除非系统内存耗尽了。</p><p>如果你想将切片 <code>y</code> 追加到切片 <code>x</code> 后面，只要将第二个参数扩展成一个列表即可：<code>x = append(x, y...)</code>。</p><p><strong>注意</strong>： <code>append()</code> 在大多数情况下很好用，但是如果你想完全掌控整个追加过程，你可以实现一个这样的 <code>AppendByte()</code> 方法：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">AppendByte</span><span class="token punctuation">(</span>slice <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> data <span class="token operator">...</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token punctuation">{</span>
	m <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>slice<span class="token punctuation">)</span>
	n <span class="token operator">:=</span> m <span class="token operator">+</span> <span class="token function">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
	<span class="token keyword">if</span> n <span class="token operator">&gt;</span> <span class="token function">cap</span><span class="token punctuation">(</span>slice<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// if necessary, reallocate</span>
		<span class="token comment">// allocate double what&#39;s needed, for future growth.</span>
		newSlice <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>n<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span>
		<span class="token function">copy</span><span class="token punctuation">(</span>newSlice<span class="token punctuation">,</span> slice<span class="token punctuation">)</span>
		slice <span class="token operator">=</span> newSlice
	<span class="token punctuation">}</span>
	slice <span class="token operator">=</span> slice<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span>
	<span class="token function">copy</span><span class="token punctuation">(</span>slice<span class="token punctuation">[</span>m<span class="token punctuation">:</span>n<span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
	<span class="token keyword">return</span> slice
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>func copy(dst, src []T) int</code> 方法将类型为 <code>T</code> 的切片从源地址 <code>src</code> 拷贝到目标地址 <code>dst</code>，覆盖 <code>dst</code> 的相关元素，并且返回拷贝的元素个数。源地址和目标地址可能会有重叠。拷贝个数是 <code>src</code> 和 <code>dst</code> 的长度最小值。如果 <code>src</code> 是字符串那么元素类型就是 <code>byte</code>。如果你还想继续使用 <code>src</code>，在拷贝结束后执行 <code>src = dst</code>。</p><p><strong>练习 7.9</strong> <a href="exercises/chapter_7/magnify_slice.go">magnify_slice.go</a></p><p>给定一个切片 <code>s []int</code> 和一个 <code>int</code> 类型的因子 <code>factor</code>，扩展 <code>s</code> 使其长度为 <code>len(s) * factor</code>。</p><p>**练习 7.10 ** <a href="exercises/chapter_7/filter_slice.go">filter_slice.go</a></p><p>用顺序函数过滤容器：<code>s</code> 是前 10 个整型的切片。构造一个函数 <code>Filter</code>，第一个参数是 <code>s</code>，第二个参数是一个 <code>fn func(int) bool</code>，返回满足函数 <code>fn</code> 的元素切片。通过 <code>fn</code> 测试方法测试当整型值是偶数时的情况。</p><p><strong>练习 7.11</strong> <a href="exercises/chapter_7/insert_slice.go">insert_slice.go</a></p><p>写一个函数 <code>InsertStringSlice()</code> 将切片插入到另一个切片的指定位置。</p><p><strong>练习 7.12</strong> <a href="exercises/chapter_7/remove_slice.go">remove_slice.go</a></p><p>写一个函数 <code>RemoveStringSlice()</code> 将从 <code>start</code> 到 <code>end</code> 索引的元素从切片中移除。</p><h3 id="_7-6-字符串、数组和切片的应用" tabindex="-1"><a class="header-anchor" href="#_7-6-字符串、数组和切片的应用" aria-hidden="true">#</a> 7.6 字符串、数组和切片的应用</h3><h4 id="_7-6-1-从字符串生成字节切片" tabindex="-1"><a class="header-anchor" href="#_7-6-1-从字符串生成字节切片" aria-hidden="true">#</a> 7.6.1 从字符串生成字节切片</h4><p>假设 <code>s</code> 是一个字符串（本质上是一个字节数组），那么就可以直接通过 <code>c := []byte(s)</code> 来获取一个字节的切片 <code>c</code> 。另外，您还可以通过 <code>copy()</code> 函数来达到相同的目的：<code>copy(dst []byte, src string)</code>。</p><p>同样的，还可以使用 for-range 来获得每个元素（Listing 7.13 — <a href="examples/chapter_7/for_string.go">for_string.go</a>）：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    s <span class="token operator">:=</span> <span class="token string">&quot;\\u00ff\\u754c&quot;</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> c <span class="token operator">:=</span> <span class="token keyword">range</span> s <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d:%c &quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>0:ÿ 2:界
</code></pre><p>我们知道，Unicode 字符会占用 2 个字节，有些甚至需要 3 个或者 4 个字节来进行表示。如果发现错误的 UTF8 字符，则该字符会被设置为 <code>U+FFFD</code> 并且索引向前移动一个字节。和字符串转换一样，您同样可以使用 <code>c := []int32(s)</code> 语法，这样切片中的每个 <code>int</code> 都会包含对应的 Unicode 代码，因为字符串中的每次字符都会对应一个整数。类似的，您也可以将字符串转换为元素类型为 <code>rune</code> 的切片：<code>r := []rune(s)</code>。</p><p>可以通过代码 <code>len([]int32(s))</code> 来获得字符串中字符的数量，但使用 <code>utf8.RuneCountInString(s)</code> 效率会更高一点。(参考 <a href="exercises/chapter_4/count_characters.go">count_characters.go</a>)</p><p>您还可以将一个字符串追加到某一个字节切片的尾部：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> b <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
<span class="token keyword">var</span> s <span class="token builtin">string</span>
b <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> s<span class="token operator">...</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_7-6-2-获取字符串的某一部分" tabindex="-1"><a class="header-anchor" href="#_7-6-2-获取字符串的某一部分" aria-hidden="true">#</a> 7.6.2 获取字符串的某一部分</h4><p>使用 <code>substr := str[start:end]</code> 可以从字符串 str 获取到从索引 <code>start</code> 开始到 <code>end-1</code> 位置的子字符串。同样的，<code>str[start:]</code> 则表示获取从 <code>start</code> 开始到 <code>len(str)-1</code> 位置的子字符串。而 <code>str[:end]</code> 表示获取从 0 开始到 <code>end-1</code> 的子字符串。</p><h4 id="_7-6-3-字符串和切片的内存结构" tabindex="-1"><a class="header-anchor" href="#_7-6-3-字符串和切片的内存结构" aria-hidden="true">#</a> 7.6.3 字符串和切片的内存结构</h4><p>在内存中，一个字符串实际上是一个双字结构，即一个指向实际数据的指针和记录字符串长度的整数（见图 7.4）。因为指针对用户来说是完全不可见，因此我们可以依旧把字符串看做是一个值类型，也就是一个字符数组。</p><p>字符串 <code>string s = &quot;hello&quot;</code> 和子字符串 <code>t = s[2:3]</code> 在内存中的结构可以用下图表示：</p><figure><img src="`+T+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h4 id="_7-6-4-修改字符串中的某个字符" tabindex="-1"><a class="header-anchor" href="#_7-6-4-修改字符串中的某个字符" aria-hidden="true">#</a> 7.6.4 修改字符串中的某个字符</h4><p>Go 语言中的字符串是不可变的，也就是说 <code>str[index]</code> 这样的表达式是不可以被放在等号左侧的。如果尝试运行 <code>str[i] = &#39;D&#39;</code> 会得到错误：<code>cannot assign to str[i]</code>。</p><p>因此，您必须先将字符串转换成字节数组，然后再通过修改数组中的元素值来达到修改字符串的目的，最后将字节数组转换回字符串格式。</p><p>例如，将字符串 <code>&quot;hello&quot;</code> 转换为 <code>&quot;cello&quot;</code>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>s <span class="token operator">:=</span> <span class="token string">&quot;hello&quot;</span>
c <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
c<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">&#39;c&#39;</span>
s2 <span class="token operator">:=</span> <span class="token function">string</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token comment">// s2 == &quot;cello&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>所以，您可以通过操作切片来完成对字符串的操作。</p><h4 id="_7-6-5-字节数组对比函数" tabindex="-1"><a class="header-anchor" href="#_7-6-5-字节数组对比函数" aria-hidden="true">#</a> 7.6.5 字节数组对比函数</h4><p>下面的 <code>Compare()</code> 函数会返回两个字节数组字典顺序的整数对比结果，即 <code>0 if a == b, -1 if a &lt; b, 1 if a &gt; b</code>。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Compare</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> i<span class="token operator">:=</span><span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&gt;</span> b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token number">1</span>
        <span class="token keyword">case</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;</span> b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 数组的长度可能不同</span>
    <span class="token keyword">switch</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token function">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span>
    <span class="token keyword">case</span> <span class="token function">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span> <span class="token comment">// 数组相等</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_7-6-6-搜索及排序切片和数组" tabindex="-1"><a class="header-anchor" href="#_7-6-6-搜索及排序切片和数组" aria-hidden="true">#</a> 7.6.6 搜索及排序切片和数组</h4><p>标准库提供了 <code>sort</code> 包来实现常见的搜索和排序操作。您可以使用 <code>sort</code> 包中的函数 <code>func Ints(a []int)</code> 来实现对 <code>int</code> 类型的切片排序。例如 <code>sort.Ints(arri)</code>，其中变量 <code>arri</code> 就是需要被升序排序的数组或切片。为了检查某个数组是否已经被排序，可以通过函数 <code>IntsAreSorted(a []int) bool</code> 来检查，如果返回 <code>true</code> 则表示已经被排序。</p><p>类似的，可以使用函数 <code>func Float64s(a []float64)</code> 来排序 <code>float64</code> 的元素，或使用函数 <code>func Strings(a []string)</code> 排序字符串元素。</p><p>想要在数组或切片中搜索一个元素，该数组或切片必须先被排序（因为标准库的搜索算法使用的是二分法）。然后，您就可以使用函数 <code>func SearchInts(a []int, n int) int</code> 进行搜索，并返回对应结果的索引值。</p><p>当然，还可以搜索 <code>float64</code> 和字符串：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">SearchFloat64s</span><span class="token punctuation">(</span>a <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">float64</span><span class="token punctuation">,</span> x <span class="token builtin">float64</span><span class="token punctuation">)</span> <span class="token builtin">int</span>
<span class="token keyword">func</span> <span class="token function">SearchStrings</span><span class="token punctuation">(</span>a <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> x <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">int</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div>`,373),le={href:"http://golang.org/pkg/sort/",target:"_blank",rel:"noopener noreferrer"},ue=t(`<p>这就是如何使用 <code>sort</code> 包的方法，我们会在<a href="">第 11.7 节</a> 对它的细节进行深入，并实现一个属于我们自己的版本。</p><h4 id="_7-6-7-append-函数常见操作" tabindex="-1"><a class="header-anchor" href="#_7-6-7-append-函数常见操作" aria-hidden="true">#</a> 7.6.7 append() 函数常见操作</h4><p>我们在<a href="">第 7.5 节</a>提到的 <code>append()</code> 非常有用，它能够用于各种方面的操作：</p><ol><li><p>将切片 <code>b</code> 的元素追加到切片 <code>a</code> 之后：<code>a = append(a, b...)</code></p></li><li><p>复制切片 <code>a</code> 的元素到新的切片 <code>b</code> 上：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>b <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>T<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">copy</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> a<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>删除位于索引 <code>i</code> 的元素：<code>a = append(a[:i], a[i+1:]...)</code></p></li><li><p>切除切片 <code>a</code> 中从索引 <code>i</code> 至 <code>j</code> 位置的元素：<code>a = append(a[:i], a[j:]...)</code></p></li><li><p>为切片 <code>a</code> 扩展 <code>j</code> 个元素长度：<code>a = append(a, make([]T, j)...)</code></p></li><li><p>在索引 <code>i</code> 的位置插入元素 <code>x</code>：<code>a = append(a[:i], append([]T{x}, a[i:]...)...)</code></p></li><li><p>在索引 <code>i</code> 的位置插入长度为 <code>j</code> 的新切片：<code>a = append(a[:i], append(make([]T, j), a[i:]...)...)</code></p></li><li><p>在索引 <code>i</code> 的位置插入切片 <code>b</code> 的所有元素：<code>a = append(a[:i], append(b, a[i:]...)...)</code></p></li><li><p>取出位于切片 <code>a</code> 最末尾的元素 <code>x</code>：<code>x, a = a[len(a)-1], a[:len(a)-1]</code></p></li><li><p>将元素 <code>x</code> 追加到切片 <code>a</code>：<code>a = append(a, x)</code></p></li></ol><p>因此，您可以使用切片和 <code>append()</code> 操作来表示任意可变长度的序列。</p><p>从数学的角度来看，切片相当于向量，如果需要的话可以定义一个向量作为切片的别名来进行操作。</p>`,6),de={href:"http://github.com/feyeleanor/slices",target:"_blank",rel:"noopener noreferrer"},re=n("code",null,"slices",-1),ke={href:"http://github.com/feyeleanor/chain",target:"_blank",rel:"noopener noreferrer"},ve=n("code",null,"chain",-1),me={href:"http://github.com/feyeleanor/lists",target:"_blank",rel:"noopener noreferrer"},be=n("code",null,"lists",-1),ge=t(`<h4 id="_7-6-8-切片和垃圾回收" tabindex="-1"><a class="header-anchor" href="#_7-6-8-切片和垃圾回收" aria-hidden="true">#</a> 7.6.8 切片和垃圾回收</h4><p>切片的底层指向一个数组，该数组的实际容量可能要大于切片所定义的容量。只有在没有任何切片指向的时候，底层的数组内存才会被释放，这种特性有时会导致程序占用多余的内存。</p><p><strong>示例</strong> 函数 <code>FindDigits()</code> 将一个文件加载到内存，然后搜索其中所有的数字并返回一个切片。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> digitRegexp <span class="token operator">=</span> regexp<span class="token punctuation">.</span><span class="token function">MustCompile</span><span class="token punctuation">(</span><span class="token string">&quot;[0-9]+&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">FindDigits</span><span class="token punctuation">(</span>filename <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token punctuation">{</span>
    b<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
    <span class="token keyword">return</span> digitRegexp<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这段代码可以顺利运行，但返回的 <code>[]byte</code> 指向的底层是整个文件的数据。只要该返回的切片不被释放，垃圾回收器就不能释放整个文件所占用的内存。换句话说，一点点有用的数据却占用了整个文件的内存。</p><p>想要避免这个问题，可以通过拷贝我们需要的部分到一个新的切片中：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">FindDigits</span><span class="token punctuation">(</span>filename <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token punctuation">{</span>
   b<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
   b <span class="token operator">=</span> digitRegexp<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
   c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token function">copy</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
   <span class="token keyword">return</span> c
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>事实上，上面这段代码只能找到第一个匹配正则表达式的数字串。要想找到所有的数字，可以尝试下面这段代码：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">FindFileDigits</span><span class="token punctuation">(</span>filename <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token punctuation">{</span>
   fileBytes<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
   b <span class="token operator">:=</span> digitRegexp<span class="token punctuation">.</span><span class="token function">FindAll</span><span class="token punctuation">(</span>fileBytes<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>fileBytes<span class="token punctuation">)</span><span class="token punctuation">)</span>
   c <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
   <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> bytes <span class="token operator">:=</span> <span class="token keyword">range</span> b <span class="token punctuation">{</span>
      c <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> bytes<span class="token operator">...</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> c
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>练习 7.12</strong> <a href="exercises/chapter_7/split_string.go">split_string.go</a></p><p>编写一个函数，要求其接受两个参数，原始字符串 <code>str</code> 和分割索引 <code>i</code>，然后返回两个分割后的字符串。</p><p><strong>练习 7.13</strong> <a href="exercises/chapter_7/string_split2.go">string_split2.go</a></p><p>假设有字符串 <code>str</code>，那么 <code>str[len(str)/2:] + str[:len(str)/2]</code> 的结果是什么？</p><p><strong>练习 7.14</strong> <a href="exercises/chapter_7/string_reverse.go">string_reverse.go</a></p><p>编写一个程序，要求能够反转字符串，即将 <code>&quot;Google&quot;</code> 转换成 <code>&quot;elgooG&quot;</code>（提示：使用 <code>[]byte</code> 类型的切片）。</p><p>如果您使用两个切片来实现反转，请再尝试使用一个切片（提示：使用交换法）。</p><p>如果您想要反转 Unicode 编码的字符串，请使用 <code>[]int32</code> 类型的切片。</p><p><strong>练习 7.15</strong> <a href="exercises/chapter_7/uniq.go">Q29_uniq.go</a></p><p>编写一个程序，要求能够遍历一个字符数组，并将当前字符和前一个字符不相同的字符拷贝至另一个数组。</p><p><strong>练习 7.16</strong> <a href="exercises/chapter_7/bubblesort.go">bubblesort.go</a></p>`,20),fe={href:"http://en.wikipedia.org/wiki/Bubble_sort",target:"_blank",rel:"noopener noreferrer"},he=t(`<p><strong>练习 7.17</strong> <a href="exercises/chapter_7/map_function.go">map_function.go</a></p><p>在函数式编程语言中，一个 map-function 是指能够接受一个函数原型和一个列表，并使用列表中的值依次执行函数原型，公式为：<code>map ( F(), (e1,e2, . . . ,en) ) = ( F(e1), F(e2), ... F(en) )</code>。</p><p>编写一个函数 <code>mapFunc</code> 要求接受以下 2 个参数：</p><ul><li>一个将整数乘以 10 的函数</li><li>一个整数列表</li></ul><p>最后返回保存运行结果的整数列表。</p><h2 id="第-8-章-map" tabindex="-1"><a class="header-anchor" href="#第-8-章-map" aria-hidden="true">#</a> 第 8 章：Map</h2><p><code>map</code> 是一种特殊的数据结构：一种元素对 (pair) 的无序集合，pair 的一个元素是 key，对应的另一个元素是 value，所以这个结构也称为关联数组或字典。这是一种快速寻找值的理想结构：给定 key，对应的 value 可以迅速定位。</p><p><code>map</code> 这种数据结构在其他编程语言中也称为字典 (Python) 、hash 和 HashTable 等。</p><h3 id="_8-1-声明、初始化和-make" tabindex="-1"><a class="header-anchor" href="#_8-1-声明、初始化和-make" aria-hidden="true">#</a> 8.1 声明、初始化和 make</h3><h4 id="_8-1-1-概念" tabindex="-1"><a class="header-anchor" href="#_8-1-1-概念" aria-hidden="true">#</a> 8.1.1 概念</h4><p><code>map</code> 是引用类型，可以使用如下声明：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> map1 <span class="token keyword">map</span><span class="token punctuation">[</span>keytype<span class="token punctuation">]</span>valuetype
<span class="token keyword">var</span> map1 <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>（<code>[keytype]</code> 和 <code>valuetype</code> 之间允许有空格，但是 gofmt 移除了空格）</p><p>在声明的时候不需要知道 <code>map</code> 的长度，<code>map</code> 是可以动态增长的。</p><p>未初始化的 <code>map</code> 的值是 <code>nil</code>。</p><p>key 可以是任意可以用 <code>==</code> 或者 <code>!=</code> 操作符比较的类型，比如 <code>string</code>、<code>int</code>、<code>float32(64)</code>。所以数组、切片和结构体不能作为 key (译者注：含有数组切片的结构体不能作为 key，只包含内建类型的 <code>struct</code> 是可以作为 key 的），但是指针和接口类型可以。如果要用结构体作为 key 可以提供 <code>Key()</code> 和 <code>Hash()</code> 方法，这样可以通过结构体的域计算出唯一的数字或者字符串的 key。</p><p>value 可以是任意类型的；通过使用空接口类型（详见<a href="">第 11.9 节</a>），我们可以存储任意值，但是使用这种类型作为值时需要先做一次类型断言（详见<a href="">第 11.3 节</a>）。</p><p><code>map</code> 传递给函数的代价很小：在 32 位机器上占 4 个字节，64 位机器上占 8 个字节，无论实际上存储了多少数据。通过 key 在 <code>map</code> 中寻找值是很快的，比线性查找快得多，但是仍然比从数组和切片的索引中直接读取要慢 100 倍；所以如果你很在乎性能的话还是建议用切片来解决问题。</p><p><code>map</code> 也可以用函数作为自己的值，这样就可以用来做分支结构（详见<a href="">第 5 章</a>）：key 用来选择要执行的函数。</p><p>如果 <code>key1</code> 是 <code>map1</code> 的 key，那么 <code>map1[key1]</code> 就是对应 <code>key1</code> 的值，就如同数组索引符号一样（数组可以视为一种简单形式的 <code>map</code>，key 是从 0 开始的整数）。</p><p><code>key1</code> 对应的值可以通过赋值符号来设置为 val1：<code>map1[key1] = val1</code>。</p><p>令 <code>v := map1[key1]</code> 可以将 <code>key1</code> 对应的值赋值给 <code>v</code>；如果 <code>map</code> 中没有 <code>key1</code> 存在，那么 <code>v</code> 将被赋值为 <code>map1</code> 的值类型的空值。</p><p>常用的 <code>len(map1)</code> 方法可以获得 <code>map</code> 中的 pair 数目，这个数目是可以伸缩的，因为 map-pairs 在运行时可以动态添加和删除。</p><p>示例 8.1 <a href="examples/chapter_8/make_maps.go">make_maps.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> mapLit <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span>
	<span class="token comment">//var mapCreated map[string]float32</span>
	<span class="token keyword">var</span> mapAssigned <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span>

	mapLit <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token string">&quot;one&quot;</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;two&quot;</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span>
	mapCreated <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">float32</span><span class="token punctuation">)</span>
	mapAssigned <span class="token operator">=</span> mapLit

	mapCreated<span class="token punctuation">[</span><span class="token string">&quot;key1&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">4.5</span>
	mapCreated<span class="token punctuation">[</span><span class="token string">&quot;key2&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">3.14159</span>
	mapAssigned<span class="token punctuation">[</span><span class="token string">&quot;two&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">3</span>

	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Map literal at \\&quot;one\\&quot; is: %d\\n&quot;</span><span class="token punctuation">,</span> mapLit<span class="token punctuation">[</span><span class="token string">&quot;one&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Map created at \\&quot;key2\\&quot; is: %f\\n&quot;</span><span class="token punctuation">,</span> mapCreated<span class="token punctuation">[</span><span class="token string">&quot;key2&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Map assigned at \\&quot;two\\&quot; is: %d\\n&quot;</span><span class="token punctuation">,</span> mapLit<span class="token punctuation">[</span><span class="token string">&quot;two&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Map literal at \\&quot;ten\\&quot; is: %d\\n&quot;</span><span class="token punctuation">,</span> mapLit<span class="token punctuation">[</span><span class="token string">&quot;ten&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出结果：</p><pre><code>Map literal at &quot;one&quot; is: 1
Map created at &quot;key2&quot; is: 3.141590
Map assigned at &quot;two&quot; is: 3
Mpa literal at &quot;ten&quot; is: 0
</code></pre><p><code>mapLit</code> 说明了 <code>map literals</code> 的使用方法： <code>map</code> 可以用 <code>{key1: val1, key2: val2}</code> 的描述方法来初始化，就像数组和结构体一样。</p><p><code>map</code> 是 <strong>引用类型</strong> 的： 内存用 <code>make()</code> 方法来分配。</p><p><code>map</code> 的初始化：<code>var map1 = make(map[keytype]valuetype)</code>。</p><p>或者简写为：<code>map1 := make(map[keytype]valuetype)</code>。</p><p>上面例子中的 <code>mapCreated</code> 就是用这种方式创建的：<code>mapCreated := make(map[string]float32)</code>。</p><p>相当于：<code>mapCreated := map[string]float32{}</code>。</p><p><code>mapAssigned</code> 也是 <code>mapLit</code> 的引用，对 <code>mapAssigned</code> 的修改也会影响到 <code>mapLit</code> 的值。</p><p><strong>不要使用 <code>new()</code>，永远用 <code>make()</code> 来构造 <code>map</code></strong></p><p><strong>注意</strong> 如果你错误地使用 <code>new()</code> 分配了一个引用对象，你会获得一个空引用的指针，相当于声明了一个未初始化的变量并且取了它的地址：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>mapCreated <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">float32</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>接下来当我们调用：<code>mapCreated[&quot;key1&quot;] = 4.5</code> 的时候，编译器会报错：</p><pre><code>invalid operation: mapCreated[&quot;key1&quot;] (index of type *map[string]float32).
</code></pre><p>为了说明值可以是任意类型的，这里给出了一个使用 <code>func() int</code> 作为值的 <code>map</code>：</p><p>示例 8.2 <a href="examples/chapter_8/map_func.go">map_func.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	mf <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span><span class="token punctuation">{</span>
		<span class="token number">1</span><span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token number">2</span><span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token number">20</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token number">5</span><span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token number">50</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>mf<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出结果为：<code>map[1:0x10903be0 5:0x10903ba0 2:0x10903bc0]</code>: 整型都被映射到函数地址。</p><h4 id="_8-1-2-map-容量" tabindex="-1"><a class="header-anchor" href="#_8-1-2-map-容量" aria-hidden="true">#</a> 8.1.2 map 容量</h4><p>和数组不同，<code>map</code> 可以根据新增的 key-value 对动态的伸缩，因此它不存在固定长度或者最大限制。但是你也可以选择标明 <code>map</code> 的初始容量 <code>capacity</code>，就像这样：<code>make(map[keytype]valuetype, cap)</code>。例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>map2 <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">float32</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>当 <code>map</code> 增长到容量上限的时候，如果再增加新的 key-value 对，<code>map</code> 的大小会自动加 1。所以出于性能的考虑，对于大的 <code>map</code> 或者会快速扩张的 <code>map</code>，即使只是大概知道容量，也最好先标明。</p><p>这里有一个 <code>map</code> 的具体例子，即将音阶和对应的音频映射起来：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>noteFrequency <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">float32</span> <span class="token punctuation">{</span>
	<span class="token string">&quot;C0&quot;</span><span class="token punctuation">:</span> <span class="token number">16.35</span><span class="token punctuation">,</span> <span class="token string">&quot;D0&quot;</span><span class="token punctuation">:</span> <span class="token number">18.35</span><span class="token punctuation">,</span> <span class="token string">&quot;E0&quot;</span><span class="token punctuation">:</span> <span class="token number">20.60</span><span class="token punctuation">,</span> <span class="token string">&quot;F0&quot;</span><span class="token punctuation">:</span> <span class="token number">21.83</span><span class="token punctuation">,</span>
	<span class="token string">&quot;G0&quot;</span><span class="token punctuation">:</span> <span class="token number">24.50</span><span class="token punctuation">,</span> <span class="token string">&quot;A0&quot;</span><span class="token punctuation">:</span> <span class="token number">27.50</span><span class="token punctuation">,</span> <span class="token string">&quot;B0&quot;</span><span class="token punctuation">:</span> <span class="token number">30.87</span><span class="token punctuation">,</span> <span class="token string">&quot;A4&quot;</span><span class="token punctuation">:</span> <span class="token number">440</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_8-1-3-用切片作为-map-的值" tabindex="-1"><a class="header-anchor" href="#_8-1-3-用切片作为-map-的值" aria-hidden="true">#</a> 8.1.3 用切片作为 map 的值</h4><p>既然一个 key 只能对应一个 value，而 value 又是一个原始类型，那么如果一个 key 要对应多个值怎么办？例如，当我们要处理 Unix 机器上的所有进程，以父进程（pid 为整型）作为 key，所有的子进程（以所有子进程的 pid 组成的切片）作为 value。通过将 value 定义为 <code>[]int</code> 类型或者其他类型的切片，就可以优雅地解决这个问题。</p><p>这里有一些定义这种 <code>map</code> 的例子：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>mp1 <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span>
mp2 <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-2-测试键值对是否存在及删除元素" tabindex="-1"><a class="header-anchor" href="#_8-2-测试键值对是否存在及删除元素" aria-hidden="true">#</a> 8.2 测试键值对是否存在及删除元素</h3><p>测试 <code>map1</code> 中是否存在 <code>key1</code>：</p><p>在例子 8.1 中，我们已经见过可以使用 <code>val1 = map1[key1]</code> 的方法获取 <code>key1</code> 对应的值 <code>val1</code>。如果 <code>map</code> 中不存在 <code>key1</code>，<code>val1</code> 就是一个值类型的空值。</p><p>这就会给我们带来困惑了：现在我们没法区分到底是 <code>key1</code> 不存在还是它对应的 <code>value</code> 就是空值。</p><p>为了解决这个问题，我们可以这么用：<code>val1, isPresent = map1[key1]</code></p><p><code>isPresent</code> 返回一个 <code>bool</code> 值：如果 <code>key1</code> 存在于 <code>map1</code>，<code>val1</code> 就是 <code>key1</code> 对应的 <code>value</code> 值，并且 <code>isPresent</code> 为 <code>true</code>；如果 <code>key1</code> 不存在，<code>val1</code> 就是一个空值，并且 <code>isPresent</code> 会返回 <code>false</code>。</p><p>如果你只是想判断某个 <code>key</code> 是否存在而不关心它对应的值到底是多少，你可以这么做：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> map1<span class="token punctuation">[</span>key1<span class="token punctuation">]</span> <span class="token comment">// 如果key1存在则ok == true，否则ok为false</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>或者和 <code>if</code> 混合使用：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> map1<span class="token punctuation">[</span>key1<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从 <code>map1</code> 中删除 <code>key1</code>：</p><p>直接 <code>delete(map1, key1)</code> 就可以。</p><p>如果 <code>key1</code> 不存在，该操作不会产生错误。</p><p>示例 8.4 <a href="examples/chapter_8/map_testelement.go">map_testelement.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> value <span class="token builtin">int</span>
	<span class="token keyword">var</span> isPresent <span class="token builtin">bool</span>

	map1 <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span>
	map1<span class="token punctuation">[</span><span class="token string">&quot;New Delhi&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">55</span>
	map1<span class="token punctuation">[</span><span class="token string">&quot;Beijing&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">20</span>
	map1<span class="token punctuation">[</span><span class="token string">&quot;Washington&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">25</span>
	value<span class="token punctuation">,</span> isPresent <span class="token operator">=</span> map1<span class="token punctuation">[</span><span class="token string">&quot;Beijing&quot;</span><span class="token punctuation">]</span>
	<span class="token keyword">if</span> isPresent <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The value of \\&quot;Beijing\\&quot; in map1 is: %d\\n&quot;</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;map1 does not contain Beijing&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	value<span class="token punctuation">,</span> isPresent <span class="token operator">=</span> map1<span class="token punctuation">[</span><span class="token string">&quot;Paris&quot;</span><span class="token punctuation">]</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Is \\&quot;Paris\\&quot; in map1 ?: %t\\n&quot;</span><span class="token punctuation">,</span> isPresent<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Value is: %d\\n&quot;</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>

	<span class="token comment">// delete an item:</span>
	<span class="token function">delete</span><span class="token punctuation">(</span>map1<span class="token punctuation">,</span> <span class="token string">&quot;Washington&quot;</span><span class="token punctuation">)</span>
	value<span class="token punctuation">,</span> isPresent <span class="token operator">=</span> map1<span class="token punctuation">[</span><span class="token string">&quot;Washington&quot;</span><span class="token punctuation">]</span>
	<span class="token keyword">if</span> isPresent <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The value of \\&quot;Washington\\&quot; in map1 is: %d\\n&quot;</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;map1 does not contain Washington&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出结果：</p><pre><code>The value of &quot;Beijing&quot; in map1 is: 20
Is &quot;Paris&quot; in map1 ?: false
Value is: 0
map1 does not contain Washington
</code></pre><h3 id="_8-3-for-range-的配套用法" tabindex="-1"><a class="header-anchor" href="#_8-3-for-range-的配套用法" aria-hidden="true">#</a> 8.3 for-range 的配套用法</h3><p>可以使用 <code>for</code> 循环读取 <code>map</code>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token operator">:=</span> <span class="token keyword">range</span> map1 <span class="token punctuation">{</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第一个返回值 <code>key</code> 是 <code>map</code> 中的 key 值，第二个返回值则是该 key 对应的 value 值；这两个都是仅 <code>for</code> 循环内部可见的局部变量。其中第一个返回值 <code>key</code> 值是一个可选元素。如果你只关心值，可以这么使用：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> value <span class="token operator">:=</span> <span class="token keyword">range</span> map1 <span class="token punctuation">{</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果只想获取 <code>key</code>，你可以这么使用：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">for</span> key <span class="token operator">:=</span> <span class="token keyword">range</span> map1 <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;key is: %d\\n&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>示例 8.5 <a href="examples/chapter_8/maps_forrange.go">maps_forrange.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	map1 <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token builtin">float32</span><span class="token punctuation">)</span>
	map1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1.0</span>
	map1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2.0</span>
	map1<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">3.0</span>
	map1<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">4.0</span>
	<span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token operator">:=</span> <span class="token keyword">range</span> map1 <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;key is: %d - value is: %f\\n&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出结果：</p><pre><code>key is: 3 - value is: 3.000000
key is: 1 - value is: 1.000000
key is: 4 - value is: 4.000000
key is: 2 - value is: 2.000000
</code></pre><p>注意 <code>map</code> 不是按照 key 的顺序排列的，也不是按照 value 的序排列的。</p><blockquote><p>译者注：map 的本质是散列表，而 map 的增长扩容会导致重新进行散列，这就可能使 map 的遍历结果在扩容前后变得不可靠，Go 设计者为了让大家不依赖遍历的顺序，每次遍历的起点--即起始 bucket 的位置不一样，即不让遍历都从某个固定的 bucket0 开始，所以即使未扩容时我们遍历出来的 map 也总是无序的。</p></blockquote><p>问题 8.1： 下面这段代码的输出是什么？</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>capitals <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span> <span class="token builtin">string</span> <span class="token punctuation">{</span><span class="token string">&quot;France&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;Paris&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Italy&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;Rome&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Japan&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;Tokyo&quot;</span> <span class="token punctuation">}</span>
<span class="token keyword">for</span> key <span class="token operator">:=</span> <span class="token keyword">range</span> capitals <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Map item: Capital of&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token string">&quot;is&quot;</span><span class="token punctuation">,</span> capitals<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>练习 8.1</strong> <a href="exercises/chapter_8/map_days.go">map_days.go</a></p><p>创建一个 <code>map</code> 来保存每周 7 天的名字，将它们打印出来并且测试是否存在 <code>&quot;Tuesday&quot;</code> 和 <code>&quot;Hollyday&quot;</code>。</p><h3 id="_8-4-map-类型的切片" tabindex="-1"><a class="header-anchor" href="#_8-4-map-类型的切片" aria-hidden="true">#</a> 8.4 map 类型的切片</h3><p>假设我们想获取一个 <code>map</code> 类型的切片，我们必须使用两次 <code>make()</code> 函数，第一次分配切片，第二次分配切片中每个 <code>map</code> 元素（参见下面的例子 8.4）。</p><p>示例 8.4 <a href="examples/chapter_8/maps_forrange2.go">maps_forrange2.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Version A:</span>
	items <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i<span class="token operator">:=</span> <span class="token keyword">range</span> items <span class="token punctuation">{</span>
		items<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
		items<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Version A: Value of items: %v\\n&quot;</span><span class="token punctuation">,</span> items<span class="token punctuation">)</span>

	<span class="token comment">// Version B: NOT GOOD!</span>
	items2 <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> item <span class="token operator">:=</span> <span class="token keyword">range</span> items2 <span class="token punctuation">{</span>
		item <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// item is only a copy of the slice element.</span>
		item<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span> <span class="token comment">// This &#39;item&#39; will be lost on the next iteration.</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Version B: Value of items: %v\\n&quot;</span><span class="token punctuation">,</span> items2<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出结果：</p><pre><code>Version A: Value of items: [map[1:2] map[1:2] map[1:2] map[1:2] map[1:2]]
Version B: Value of items: [map[] map[] map[] map[] map[]]
</code></pre><p>需要注意的是，应当像 A 版本那样通过索引使用切片的 <code>map</code> 元素。在 B 版本中获得的项只是 <code>map</code> 值的一个拷贝而已，所以真正的 <code>map</code> 元素没有得到初始化。</p><h3 id="_8-5-map-的排序" tabindex="-1"><a class="header-anchor" href="#_8-5-map-的排序" aria-hidden="true">#</a> 8.5 map 的排序</h3><p><code>map</code> 默认是无序的，不管是按照 key 还是按照 value 默认都不排序（详见第 8.3 节）。</p><p>如果你想为 <code>map</code> 排序，需要将 key（或者 value）拷贝到一个切片，再对切片排序（使用 <code>sort</code> 包，详见<a href="">第 7.6.6 节</a>），然后可以使用切片的 for-range 方法打印出所有的 key 和 value。</p><p>下面有一个示例：</p><p>示例 8.6 <a href="examples/chapter_8/sort_map.go">sort_map.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// the telephone alphabet:</span>
<span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;sort&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	barVal <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token string">&quot;alpha&quot;</span><span class="token punctuation">:</span> <span class="token number">34</span><span class="token punctuation">,</span> <span class="token string">&quot;bravo&quot;</span><span class="token punctuation">:</span> <span class="token number">56</span><span class="token punctuation">,</span> <span class="token string">&quot;charlie&quot;</span><span class="token punctuation">:</span> <span class="token number">23</span><span class="token punctuation">,</span>
							<span class="token string">&quot;delta&quot;</span><span class="token punctuation">:</span> <span class="token number">87</span><span class="token punctuation">,</span> <span class="token string">&quot;echo&quot;</span><span class="token punctuation">:</span> <span class="token number">56</span><span class="token punctuation">,</span> <span class="token string">&quot;foxtrot&quot;</span><span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span>
							<span class="token string">&quot;golf&quot;</span><span class="token punctuation">:</span> <span class="token number">34</span><span class="token punctuation">,</span> <span class="token string">&quot;hotel&quot;</span><span class="token punctuation">:</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">&quot;indio&quot;</span><span class="token punctuation">:</span> <span class="token number">87</span><span class="token punctuation">,</span>
							<span class="token string">&quot;juliet&quot;</span><span class="token punctuation">:</span> <span class="token number">65</span><span class="token punctuation">,</span> <span class="token string">&quot;kili&quot;</span><span class="token punctuation">:</span> <span class="token number">43</span><span class="token punctuation">,</span> <span class="token string">&quot;lima&quot;</span><span class="token punctuation">:</span> <span class="token number">98</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;unsorted:&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> barVal <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Key: %v, Value: %v / &quot;</span><span class="token punctuation">,</span> k<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	keys <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>barVal<span class="token punctuation">)</span><span class="token punctuation">)</span>
	i <span class="token operator">:=</span> <span class="token number">0</span>
	<span class="token keyword">for</span> k<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token keyword">range</span> barVal <span class="token punctuation">{</span>
		keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> k
		i<span class="token operator">++</span>
	<span class="token punctuation">}</span>
	sort<span class="token punctuation">.</span><span class="token function">Strings</span><span class="token punctuation">(</span>keys<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;sorted:&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> k <span class="token operator">:=</span> <span class="token keyword">range</span> keys <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Key: %v, Value: %v / &quot;</span><span class="token punctuation">,</span> k<span class="token punctuation">,</span> barVal<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出结果：</p><pre><code>unsorted:
Key: bravo, Value: 56 / Key: echo, Value: 56 / Key: indio, Value: 87 / Key: juliet, Value: 65 / Key: alpha, Value: 34 / Key: charlie, Value: 23 / Key: delta, Value: 87 / Key: foxtrot, Value: 12 / Key: golf, Value: 34 / Key: hotel, Value: 16 / Key: kili, Value: 43 / Key: lima, Value: 98 /
sorted:
Key: alpha, Value: 34 / Key: bravo, Value: 56 / Key: charlie, Value: 23 / Key: delta, Value: 87 / Key: echo, Value: 56 / Key: foxtrot, Value: 12 / Key: golf, Value: 34 / Key: hotel, Value: 16 / Key: indio, Value: 87 / Key: juliet, Value: 65 / Key: kili, Value: 43 / Key: lima, Value: 98 /
</code></pre><p>但是如果你想要一个排序的列表，那么最好使用结构体切片，这样会更有效：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> name <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	key <span class="token builtin">string</span>
	value <span class="token builtin">int</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_8-6-将-map-的键值对调" tabindex="-1"><a class="header-anchor" href="#_8-6-将-map-的键值对调" aria-hidden="true">#</a> 8.6 将 map 的键值对调</h3><p>这里对调是指调换 key 和 value。如果 <code>map</code> 的值类型可以作为 key 且所有的 value 是唯一的，那么通过下面的方法可以简单的做到键值对调。</p><p>示例 8.7 <a href="examples/chapter_8/invert_map.go">invert_map.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
	barVal <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token string">&quot;alpha&quot;</span><span class="token punctuation">:</span> <span class="token number">34</span><span class="token punctuation">,</span> <span class="token string">&quot;bravo&quot;</span><span class="token punctuation">:</span> <span class="token number">56</span><span class="token punctuation">,</span> <span class="token string">&quot;charlie&quot;</span><span class="token punctuation">:</span> <span class="token number">23</span><span class="token punctuation">,</span>
							<span class="token string">&quot;delta&quot;</span><span class="token punctuation">:</span> <span class="token number">87</span><span class="token punctuation">,</span> <span class="token string">&quot;echo&quot;</span><span class="token punctuation">:</span> <span class="token number">56</span><span class="token punctuation">,</span> <span class="token string">&quot;foxtrot&quot;</span><span class="token punctuation">:</span> <span class="token number">12</span><span class="token punctuation">,</span>
							<span class="token string">&quot;golf&quot;</span><span class="token punctuation">:</span> <span class="token number">34</span><span class="token punctuation">,</span> <span class="token string">&quot;hotel&quot;</span><span class="token punctuation">:</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token string">&quot;indio&quot;</span><span class="token punctuation">:</span> <span class="token number">87</span><span class="token punctuation">,</span>
							<span class="token string">&quot;juliet&quot;</span><span class="token punctuation">:</span> <span class="token number">65</span><span class="token punctuation">,</span> <span class="token string">&quot;kili&quot;</span><span class="token punctuation">:</span> <span class="token number">43</span><span class="token punctuation">,</span> <span class="token string">&quot;lima&quot;</span><span class="token punctuation">:</span> <span class="token number">98</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	invMap <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>barVal<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> barVal <span class="token punctuation">{</span>
		invMap<span class="token punctuation">[</span>v<span class="token punctuation">]</span> <span class="token operator">=</span> k
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;inverted:&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> invMap <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Key: %v, Value: %v / &quot;</span><span class="token punctuation">,</span> k<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出结果：</p><pre><code>inverted:
Key: 34, Value: golf / Key: 23, Value: charlie / Key: 16, Value: hotel / Key: 87, Value: delta / Key: 98, Value: lima / Key: 12, Value: foxtrot / Key: 43, Value: kili / Key: 56, Value: bravo / Key: 65, Value: juliet /
</code></pre><p>如果原始 value 值不唯一那这么做肯定会出问题；这种情况下不会报错，但是当遇到不唯一的 key 时应当直接停止对调，且此时对调后的 <code>map</code> 很可能没有包含原 <code>map</code> 的所有键值对！一种解决方法就是仔细检查唯一性并且使用多值 <code>map</code>，比如使用 <code>map[int][]string</code> 类型。</p><p><strong>练习 8.2</strong> <a href="exercises/chapter_8/map_drinks.go">map_drinks.go</a></p><p>构造一个将英文饮料名映射为法语（或者任意你的母语）的集合；先打印所有的饮料，然后打印原名和翻译后的名字。接下来按照英文名排序后再打印出来。</p><h2 id="第-9-章-包-package" tabindex="-1"><a class="header-anchor" href="#第-9-章-包-package" aria-hidden="true">#</a> 第 9 章：包 (package)</h2><p>本章主要针对 Go 语言的包展开讲解。</p><h3 id="_9-1-标准库" tabindex="-1"><a class="header-anchor" href="#_9-1-标准库" aria-hidden="true">#</a> 9.1 标准库</h3>`,116),ye=n("code",null,"fmt",-1),we=n("code",null,"os",-1),qe={href:"https://gowalker.org/search?q=gorepos",target:"_blank",rel:"noopener noreferrer"},_e=t(`<p>在贯穿本书的例子和练习中，我们都是用标准库的包。可以通过查阅第 350 页包中的内容快速找到相关的包的实例。这里我们只是按功能进行分组来介绍这些包的简单用途，我们不会深入讨论他们的内部结构。</p><ul><li><p><code>unsafe</code>: 包含了一些打破 Go 语言“类型安全”的命令，一般的程序中不会被使用，可用在 C/C++ 程序的调用中。</p></li><li><p><code>syscall</code>-<code>os</code>-<code>os/exec</code>:</p><ul><li><p><code>os</code>: 提供给我们一个平台无关性的操作系统功能接口，采用类 Unix 设计，隐藏了不同操作系统间的差异，让不同的文件系统和操作系统对象表现一致。</p></li><li><p><code>os/exec</code>: 提供我们运行外部操作系统命令和程序的方式。</p></li><li><p><code>syscall</code>: 底层的外部包，提供了操作系统底层调用的基本接口。</p><p>通过一个 Go 程序让Linux重启来体现它的能力。</p><p>示例 9.1 <a href="examples/chapter_9/reboot.go">reboot.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;syscall&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> LINUX_REBOOT_MAGIC1 <span class="token builtin">uintptr</span> <span class="token operator">=</span> <span class="token number">0xfee1dead</span>
<span class="token keyword">const</span> LINUX_REBOOT_MAGIC2 <span class="token builtin">uintptr</span> <span class="token operator">=</span> <span class="token number">672274793</span>
<span class="token keyword">const</span> LINUX_REBOOT_CMD_RESTART <span class="token builtin">uintptr</span> <span class="token operator">=</span> <span class="token number">0x1234567</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	syscall<span class="token punctuation">.</span><span class="token function">Syscall</span><span class="token punctuation">(</span>syscall<span class="token punctuation">.</span>SYS_REBOOT<span class="token punctuation">,</span>
		LINUX_REBOOT_MAGIC1<span class="token punctuation">,</span>
		LINUX_REBOOT_MAGIC2<span class="token punctuation">,</span>
		LINUX_REBOOT_CMD_RESTART<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li><li><p><code>archive/tar</code> 和 <code>/zip-compress</code>：压缩（解压缩）文件功能。</p></li><li><p><code>fmt</code>-<code>io</code>-<code>bufio</code>-<code>path/filepath</code>-<code>flag</code>:</p><ul><li><code>fmt</code>: 提供了格式化输入输出功能。</li><li><code>io</code>: 提供了基本输入输出功能，大多数是围绕系统功能的封装。</li><li><code>bufio</code>: 缓冲输入输出功能的封装。</li><li><code>path/filepath</code>: 用来操作在当前系统中的目标文件名路径。</li><li><code>flag</code>: 对命令行参数的操作。</li></ul></li><li><p><code>strings</code>-<code>strconv</code>-<code>unicode</code>-<code>regexp</code>-<code>bytes</code>:</p><ul><li><code>strings</code>: 提供对字符串的操作。</li><li><code>strconv</code>: 提供将字符串转换为基础类型的功能。</li><li><code>unicode</code>: 为 unicode 型的字符串提供特殊的功能。</li><li><code>regexp</code>: 正则表达式功能。</li><li><code>bytes</code>: 提供对字符型分片的操作。</li><li><code>index/suffixarray</code>: 子字符串快速查询。</li></ul></li><li><p><code>math</code>-<code>math/cmath</code>-<code>math/big</code>-<code>math/rand</code>-<code>sort</code>:</p><ul><li><code>math</code>: 基本的数学函数。</li><li><code>math/cmath</code>: 对复数的操作。</li><li><code>math/rand</code>: 伪随机数生成。</li><li><code>sort</code>: 为数组排序和自定义集合。</li><li><code>math/big</code>: 大数的实现和计算。</li></ul></li><li><p><code>container</code>-<code>/list-ring-heap</code>: 实现对集合的操作。</p><ul><li><p><code>list</code>: 双链表。</p></li><li><p><code>ring</code>: 环形链表。</p><p>下面代码演示了如何遍历一个链表(当 l 是 <code>*List</code>)：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">for</span> e <span class="token operator">:=</span> l<span class="token punctuation">.</span><span class="token function">Front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> e <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">;</span> e <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//do something with e.Value</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li><li><p><code>time</code>-<code>log</code>:</p><ul><li><code>time</code>: 日期和时间的基本操作。 <h2 id="日期函数-time" tabindex="-1"><a class="header-anchor" href="#日期函数-time" aria-hidden="true">#</a> 日期函数(Time)</h2><pre><code>  时间和日期是我们编程中经常会用到的，在golang中time包提供了时间的显示和测量用的函数。
</code></pre><h3 id="time-now获取当前时间" tabindex="-1"><a class="header-anchor" href="#time-now获取当前时间" aria-hidden="true">#</a> time.Now获取当前时间</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>timeObj <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
year <span class="token operator">:=</span> timeObj<span class="token punctuation">.</span><span class="token function">Year</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
month <span class="token operator">:=</span> timeObj<span class="token punctuation">.</span><span class="token function">Month</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
day <span class="token operator">:=</span> timeObj<span class="token punctuation">.</span><span class="token function">Day</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d-%02d-%02d \\n&quot;</span><span class="token punctuation">,</span> year<span class="token punctuation">,</span> month<span class="token punctuation">,</span> day<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="格式化日期" tabindex="-1"><a class="header-anchor" href="#格式化日期" aria-hidden="true">#</a> 格式化日期</h3><pre><code>  时间类型有一个自带的方法 Format进行格式化
  需要注意的是Go语言中格式化时间模板不是长久的 Y-m-d H:M:S
  而是使用Go的诞生时间 2006年1月2日 15点04分 （记忆口诀：2006 1 2 3 4 5）
</code></pre><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">/**
		时间类型有一个自带的方法 Format进行格式化
		需要注意的是Go语言中格式化时间模板不是长久的 Y-m-d H:M:S
		而是使用Go的诞生时间 2006年1月2日 15点04分 （记忆口诀：2006 1 2 3 4 5）
	*/</span>
timeObj2 <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 24小时值  （15表示二十四小时）</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>timeObj2<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">&quot;2006-01-02 15:04:05&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 12小时制</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>timeObj2<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">&quot;2006-01-02 03:04:05&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="获取当前时间戳" tabindex="-1"><a class="header-anchor" href="#获取当前时间戳" aria-hidden="true">#</a> 获取当前时间戳</h3><pre><code>  时间戳是自1070年1月1日（08:00:00GMT）至当前时间的总毫秒数。它也被称为Unix时间戳
</code></pre><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">/**
	获取当前时间戳
	*/</span>
timeObj3 <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 获取毫秒时间戳</span>
unixTime <span class="token operator">:=</span> timeObj3<span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 获取纳秒时间戳</span>
unixNaTime <span class="token operator">:=</span> timeObj3<span class="token punctuation">.</span><span class="token function">UnixNano</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="时间戳转日期字符串" tabindex="-1"><a class="header-anchor" href="#时间戳转日期字符串" aria-hidden="true">#</a> 时间戳转日期字符串</h3><pre><code>  通过将时间戳我们可以转换成日期字符串
</code></pre><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 时间戳转换年月日时分秒（一个参数是秒，另一个参数是毫秒）</span>
<span class="token keyword">var</span> timeObj4 <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token number">1595289901</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> timeStr <span class="token operator">=</span> timeObj4<span class="token punctuation">.</span><span class="token function">Format</span><span class="token punctuation">(</span><span class="token string">&quot;2006-01-02 15:04:05&quot;</span><span class="token punctuation">)</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>timeStr<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="日期字符串转换成时间戳" tabindex="-1"><a class="header-anchor" href="#日期字符串转换成时间戳" aria-hidden="true">#</a> 日期字符串转换成时间戳</h3><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 日期字符串转换成时间戳</span>
<span class="token keyword">var</span> timeStr2 <span class="token operator">=</span> <span class="token string">&quot;2020-07-21 08:10:05&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> tmp <span class="token operator">=</span> <span class="token string">&quot;2006-01-02 15:04:05&quot;</span>
timeObj5<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">ParseInLocation</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> timeStr2<span class="token punctuation">,</span> time<span class="token punctuation">.</span>Local<span class="token punctuation">)</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>timeObj5<span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="时间间隔" tabindex="-1"><a class="header-anchor" href="#时间间隔" aria-hidden="true">#</a> 时间间隔</h3><pre><code>  time.Duration是time包定义的一个类型，它代表两个时间点之间经过的时间，以纳秒为单位。time.Duration表示一段时间间隔，可表示的最大长度段大约290年。
  time包中定义的时间间隔类型的常量如下：
</code></pre><img src="`+C+`" alt="image-20200721081402315" tabindex="0" loading="lazy"><figcaption>image-20200721081402315</figcaption><h3 id="时间操作函数" tabindex="-1"><a class="header-anchor" href="#时间操作函数" aria-hidden="true">#</a> 时间操作函数</h3><pre><code>  我们在日常的编码过程中可能会遇到要求时间+时间间隔的需求，Go语言的时间对象有提供Add方法如下
</code></pre><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>t Time<span class="token punctuation">)</span> <span class="token function">Add</span><span class="token punctuation">(</span>d Duration<span class="token punctuation">)</span>Time
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div>例如<div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 时间相加</span>
now <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 当前时间加1个小时后</span>
later <span class="token operator">:=</span> now<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Hour<span class="token punctuation">)</span>
fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>later<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>  同理的方法还有：时间差、判断相等
</code></pre><h3 id="定时器" tabindex="-1"><a class="header-anchor" href="#定时器" aria-hidden="true">#</a> 定时器</h3><pre><code>  方式1：使用time.NewTicker（时间间隔）来设置定时器
</code></pre><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 定时器, 定义一个1秒间隔的定时器</span>
ticker <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">NewTicker</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
n <span class="token operator">:=</span> <span class="token number">0</span>
<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> ticker<span class="token punctuation">.</span>C <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
	n<span class="token operator">++</span>
	<span class="token keyword">if</span> n<span class="token operator">&gt;</span><span class="token number">5</span> <span class="token punctuation">{</span>
		<span class="token comment">// 终止定时器</span>
		ticker<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><pre><code>  方式2：time.Sleep(time.Second)来实现定时器
</code></pre><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">for</span>  <span class="token punctuation">{</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;一秒后&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><code>log</code>: 记录程序运行时产生的日志，我们将在后面的章节使用它。</li></ul></li><li><p><code>encoding/json</code>-<code>encoding/xml</code>-<code>text/template</code>:</p><ul><li><code>encoding/json</code>: 读取并解码和写入并编码 JSON 数据。</li><li><code>encoding/xml</code>: 简单的 XML1.0 解析器，有关 JSON 和 XML 的实例请查阅第 <a href="">12.9</a>/<a href="">10</a> 章节。</li><li><code>text/template</code>:生成像 HTML 一样的数据与文本混合的数据驱动模板（参见<a href="">第 15.7 节</a>）。</li></ul></li><li><p><code>net</code>-<code>net/http</code>-<code>html</code>:（参见<a href="">第 15 章</a>）</p><ul><li><code>net</code>: 网络数据的基本操作。</li><li><code>http</code>: 提供了一个可扩展的 HTTP 服务器和基础客户端，解析 HTTP 请求和回复。</li><li><code>html</code>: HTML5 解析器。</li></ul></li><li><p><code>runtime</code>: Go 程序运行时的交互操作，例如垃圾回收和协程创建。</p></li><li><p><code>reflect</code>: 实现通过程序运行时反射，让程序操作任意类型的变量。</p></li></ul><p><code>exp</code> 包中有许多将被编译为新包的实验性的包。在下次稳定版本发布的时候，它们将成为独立的包。如果前一个版本已经存在了，它们将被作为过时的包被回收。然而 Go1.0 发布的时候并没有包含过时或者实验性的包。</p><p><strong>练习 9.1</strong> <a href="exercises/chapter_9/dlinked_list.go">Q20_linked_list.go</a></p><p>使用 <code>container/list</code> 包实现一个双向链表，将 <code>101</code>、<code>102</code> 和 <code>103</code> 放入其中并打印出来。</p><p><strong>练习 9.2</strong> <a href="exercises/chapter_9/size_int.go">size_int.go</a></p><p>通过使用 <code>unsafe</code> 包中的方法来测试你电脑上一个整型变量占用多少个字节。</p><h3 id="_9-2-regexp-包" tabindex="-1"><a class="header-anchor" href="#_9-2-regexp-包" aria-hidden="true">#</a> 9.2 regexp 包</h3>`,8),xe={href:"http://en.wikipedia.org/wiki/Regular_expression",target:"_blank",rel:"noopener noreferrer"},Ge=t(`<p>在下面的程序里，我们将在字符串中对正则表达式模式 (pattern) 进行匹配。</p><p>如果是简单模式，使用 <code>Match()</code> 方法便可：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>ok<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> regexp<span class="token punctuation">.</span><span class="token function">Match</span><span class="token punctuation">(</span>pat<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>searchIn<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>变量 <code>ok</code> 将返回 <code>true</code> 或者 <code>false</code>，我们也可以使用 <code>MatchString()</code>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>ok<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> regexp<span class="token punctuation">.</span><span class="token function">MatchString</span><span class="token punctuation">(</span>pat<span class="token punctuation">,</span> searchIn<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>更多方法中，必须先将正则模式通过 <code>Compile()</code> 方法返回一个 <code>Regexp</code> 对象。然后我们将掌握一些匹配，查找，替换相关的功能。</p><p>示例 9.2 <a href="examples/chapter_9/pattern.go">pattern.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;regexp&quot;</span>
	<span class="token string">&quot;strconv&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">//目标字符串</span>
	searchIn <span class="token operator">:=</span> <span class="token string">&quot;John: 2578.34 William: 4567.23 Steve: 5632.18&quot;</span>
	pat <span class="token operator">:=</span> <span class="token string">&quot;[0-9]+.[0-9]+&quot;</span> <span class="token comment">//正则</span>

	f <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
		v<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseFloat</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> strconv<span class="token punctuation">.</span><span class="token function">FormatFloat</span><span class="token punctuation">(</span>v<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token char">&#39;f&#39;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> ok<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> regexp<span class="token punctuation">.</span><span class="token function">Match</span><span class="token punctuation">(</span>pat<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>searchIn<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Match Found!&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	re<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> regexp<span class="token punctuation">.</span><span class="token function">Compile</span><span class="token punctuation">(</span>pat<span class="token punctuation">)</span>
	<span class="token comment">//将匹配到的部分替换为&quot;##.#&quot;</span>
	str <span class="token operator">:=</span> re<span class="token punctuation">.</span><span class="token function">ReplaceAllString</span><span class="token punctuation">(</span>searchIn<span class="token punctuation">,</span> <span class="token string">&quot;##.#&quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
	<span class="token comment">//参数为函数时</span>
	str2 <span class="token operator">:=</span> re<span class="token punctuation">.</span><span class="token function">ReplaceAllStringFunc</span><span class="token punctuation">(</span>searchIn<span class="token punctuation">,</span> f<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>str2<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出结果：</p><pre><code>Match Found!
John: ##.# William: ##.# Steve: ##.#
John: 5156.68 William: 9134.46 Steve: 11264.36
</code></pre><p><code>Compile()</code> 函数也可能返回一个错误，我们在使用时忽略对错误的判断是因为我们确信自己正则表达式是有效的。当用户输入或从数据中获取正则表达式的时候，我们有必要去检验它的正确性。另外我们也可以使用 <code>MustCompile()</code> 方法，它可以像 <code>Compile()</code> 方法一样检验正则的有效性，但是当正则不合法时程序将 <code>panic()</code>（详情查看<a href="">第 13.2 节</a>）。</p><h3 id="_9-3-锁和-sync-包" tabindex="-1"><a class="header-anchor" href="#_9-3-锁和-sync-包" aria-hidden="true">#</a> 9.3 锁和 sync 包</h3><p>在一些复杂的程序中，通常通过不同线程执行不同应用来实现程序的并发。当不同线程要使用同一个变量时，经常会出现一个问题：无法预知变量被不同线程修改的顺序！（这通常被称为资源竞争，指不同线程对同一变量使用的竞争）显然这无法让人容忍，那我们该如何解决这个问题呢？</p><p>经典的做法是一次只能让一个线程对共享变量进行操作。当变量被一个线程改变时（临界区），我们为它上锁，直到这个线程执行完成并解锁后，其他线程才能访问它。</p><p>特别是我们之前章节学习的 <code>map</code> 类型是不存在锁的机制来实现这种效果（出于对性能的考虑），所以 map 类型是非线程安全的。当并行访问一个共享的 <code>map</code> 类型的数据，<code>map</code> 数据将会出错。</p><p>在 Go 语言中这种锁的机制是通过 <code>sync</code> 包中 <code>Mutex</code> 来实现的。sync 来源于 &quot;synchronized&quot; 一词，这意味着线程将有序的对同一变量进行访问。</p><p><code>sync.Mutex</code> 是一个互斥锁，它的作用是守护在临界区入口来确保同一时间只能有一个线程进入临界区。</p><p>假设 <code>info</code> 是一个需要上锁的放在共享内存中的变量。通过包含 <code>Mutex</code> 来实现的一个典型例子如下：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">import</span>  <span class="token string">&quot;sync&quot;</span>

<span class="token keyword">type</span> Info <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	mu sync<span class="token punctuation">.</span>Mutex
	<span class="token comment">// ... other fields, e.g.: Str string</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果一个函数想要改变这个变量可以这样写:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Update</span><span class="token punctuation">(</span>info <span class="token operator">*</span>Info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	info<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// critical section:</span>
    info<span class="token punctuation">.</span>Str <span class="token operator">=</span> <span class="token comment">// new value</span>
    <span class="token comment">// end critical section</span>
    info<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>还有一个很有用的例子是通过 <code>Mutex</code> 来实现一个可以上锁的共享缓冲器:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> SyncedBuffer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	lock 	sync<span class="token punctuation">.</span>Mutex
	buffer  bytes<span class="token punctuation">.</span>Buffer
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 <code>sync</code> 包中还有一个 <code>RWMutex</code> 锁：它能通过 <code>RLock()</code> 来允许同一时间多个线程对变量进行读操作，但是只能一个线程进行写操作。如果使用 <code>Lock()</code> 将和普通的 <code>Mutex</code> 作用相同。包中还有一个方便的 <code>Once</code> 类型变量的方法 <code>once.Do(call)</code>，这个方法确保被调用函数只能被调用一次。</p><p>相对简单的情况下，通过使用 <code>sync</code> 包可以解决同一时间只能一个线程访问变量或 <code>map</code> 类型数据的问题。如果这种方式导致程序明显变慢或者引起其他问题，我们要重新思考来通过 goroutines 和 channels 来解决问题，这是在 Go 语言中所提倡用来实现并发的技术。我们将在<a href="">第 14 章</a>对其深入了解，并在<a href="">第 14.7 节</a>中对这两种方式进行比较。</p><h3 id="_9-4-精密计算和-big-包" tabindex="-1"><a class="header-anchor" href="#_9-4-精密计算和-big-包" aria-hidden="true">#</a> 9.4 精密计算和 big 包</h3><p>我们知道有些时候通过编程的方式去进行计算是不精确的。如果你使用 Go 语言中的 <code>float64</code> 类型进行浮点运算，返回结果将精确到 15 位，足以满足大多数的任务。当对超出 <code>int64</code> 或者 <code>uint64</code> 类型这样的大数进行计算时，如果对精度没有要求，<code>float32</code> 或者 <code>float64</code> 可以胜任，但如果对精度有严格要求的时候，我们不能使用浮点数，在内存中它们只能被近似的表示。</p><p>对于整数的高精度计算 Go 语言中提供了 <code>big</code> 包，被包含在 <code>math</code> 包下：有用来表示大整数的 <code>big.Int</code> 和表示大有理数的 <code>big.Rat</code> 类型（可以表示为 2/5 或 3.1416 这样的分数，而不是无理数或 π）。这些类型可以实现任意位类型的数字，只要内存足够大。缺点是更大的内存和处理开销使它们使用起来要比内置的数字类型慢很多。</p><p>大的整型数字是通过 <code>big.NewInt(n)</code> 来构造的，其中 <code>n</code> 为 <code>int64</code> 类型整数。而大有理数是通过 <code>big.NewRat(n, d)</code> 方法构造。<code>n</code>（分子）和 <code>d</code>（分母）都是 <code>int64</code> 型整数。因为 Go 语言不支持运算符重载，所以所有大数字类型都有像是 <code>Add()</code> 和 <code>Mul()</code> 这样的方法。它们作用于作为 receiver 的整数和有理数，大多数情况下它们修改 receiver 并以 receiver 作为返回结果。因为没有必要创建 <code>big.Int</code> 类型的临时变量来存放中间结果，所以运算可以被链式地调用，并节省内存。</p><p>示例 9.2 <a href="examples/chapter_9/big.go">big.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// big.go</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;math&quot;</span>
	<span class="token string">&quot;math/big&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Here are some calculations with bigInts:</span>
	im <span class="token operator">:=</span> big<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span>MaxInt64<span class="token punctuation">)</span>
	in <span class="token operator">:=</span> im
	io <span class="token operator">:=</span> big<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span><span class="token number">1956</span><span class="token punctuation">)</span>
	ip <span class="token operator">:=</span> big<span class="token punctuation">.</span><span class="token function">NewInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	ip<span class="token punctuation">.</span><span class="token function">Mul</span><span class="token punctuation">(</span>im<span class="token punctuation">,</span> in<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> im<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Div</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> io<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Big Int: %v\\n&quot;</span><span class="token punctuation">,</span> ip<span class="token punctuation">)</span>
	<span class="token comment">// Here are some calculations with bigInts:</span>
	rm <span class="token operator">:=</span> big<span class="token punctuation">.</span><span class="token function">NewRat</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span>MaxInt64<span class="token punctuation">,</span> <span class="token number">1956</span><span class="token punctuation">)</span>
	rn <span class="token operator">:=</span> big<span class="token punctuation">.</span><span class="token function">NewRat</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1956</span><span class="token punctuation">,</span> math<span class="token punctuation">.</span>MaxInt64<span class="token punctuation">)</span>
	ro <span class="token operator">:=</span> big<span class="token punctuation">.</span><span class="token function">NewRat</span><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">56</span><span class="token punctuation">)</span>
	rp <span class="token operator">:=</span> big<span class="token punctuation">.</span><span class="token function">NewRat</span><span class="token punctuation">(</span><span class="token number">1111</span><span class="token punctuation">,</span> <span class="token number">2222</span><span class="token punctuation">)</span>
	rq <span class="token operator">:=</span> big<span class="token punctuation">.</span><span class="token function">NewRat</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	rq<span class="token punctuation">.</span><span class="token function">Mul</span><span class="token punctuation">(</span>rm<span class="token punctuation">,</span> rn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>rq<span class="token punctuation">,</span> ro<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Mul</span><span class="token punctuation">(</span>rq<span class="token punctuation">,</span> rp<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Big Rat: %v\\n&quot;</span><span class="token punctuation">,</span> rq<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/* Output:
Big Int: 43492122561469640008497075573153004
Big Rat: -37/112
*/</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出结果：</p><pre><code>Big Int: 43492122561469640008497075573153004
Big Rat: -37/112
</code></pre><h3 id="_9-5-自定义包和可见性" tabindex="-1"><a class="header-anchor" href="#_9-5-自定义包和可见性" aria-hidden="true">#</a> 9.5 自定义包和可见性</h3><p>包是 Go 语言中代码组织和代码编译的主要方式。关于它们的很多基本信息已经在 4.2 章节中给出，最引人注目的便是可见性。现在我们来看看具体如何来使用自己写的包。在下一节，我们将回顾一些标准库中的包，自定义的包和标准库以外的包。</p><p>当写自己包的时候，要使用短小的不含有 <code>_</code>（下划线）的小写单词来为文件命名。这里有个简单例子来说明包是如何相互调用以及可见性是如何实现的。</p><p>当前目录下（examples/chapter_9/book/）有一个名为 package_mytest.go 的程序, 它使用了自定义包 pack1 中 pack1.go 的代码。这段程序（连同编译链接生成的 pack1.a）存放在当前目录下一个名为 pack1 的文件夹下。所以链接器将包的对象和主程序对象链接在一起。</p><p>示例 9.4 <a href="examples/chapter_9/book/pack1/pack1.go">pack1.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> pack1
<span class="token keyword">var</span> Pack1Int <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">42</span>
<span class="token keyword">var</span> pack1Float <span class="token operator">=</span> <span class="token number">3.14</span>

<span class="token keyword">func</span> <span class="token function">ReturnStr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token string">&quot;Hello main!&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>它包含了一个整型变量 <code>Pack1Int</code> 和一个返回字符串的函数 <code>ReturnStr</code>。这段程序在运行时不做任何的事情，因为它没有一个 main 函数。</p><p>在主程序 package_mytest.go 中这个包通过声明的方式被导入, 只到包的目录一层。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token string">&quot;./pack1&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>import 的一般格式如下:</p><pre><code>import &quot;包的路径或 URL 地址&quot; 
</code></pre><p>例如：</p><pre><code>import &quot;github.com/org1/pack1”
</code></pre><p>路径是指当前目录的相对路径。</p><p>示例 9.5 <a href="examples/chapter_9/book/package_mytest.go">package_mytest.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;./pack1&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> test1 <span class="token builtin">string</span>
	test1 <span class="token operator">=</span> pack1<span class="token punctuation">.</span><span class="token function">ReturnStr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;ReturnStr from package1: %s\\n&quot;</span><span class="token punctuation">,</span> test1<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Integer from package1: %d\\n&quot;</span><span class="token punctuation">,</span> pack1<span class="token punctuation">.</span>Pack1Int<span class="token punctuation">)</span>
	<span class="token comment">// fmt.Printf(&quot;Float from package1: %f\\n&quot;, pack1.pack1Float)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出结果：</p><pre><code>ReturnStr from package1: Hello main!
Integer from package1: 42
</code></pre><p>如果包 pack1 和我们的程序在同一路径下，我们可以通过 <code>&quot;import ./pack1&quot;</code> 这样的方式来引入，但这不被视为一个好的方法。</p><p>下面的代码试图访问一个未引用的变量或者函数，甚至没有编译。将会返回一个错误：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Float from package1: %f\\n&quot;</span><span class="token punctuation">,</span> pack1<span class="token punctuation">.</span>pack1Float<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>错误：</p><pre><code>cannot refer to unexported name pack1.pack1Float
</code></pre><p>主程序利用的包必须在主程序编写之前被编译。主程序中每个 pack1 项目都要通过包名来使用：<code>pack1.Item</code>。具体使用方法请参见示例 4.6 和 4.7。</p><p>因此，按照惯例，子目录和包之间有着密切的联系：为了区分，不同包存放在不同的目录下，每个包（所有属于这个包中的 go 文件）都存放在和包名相同的子目录下：</p><p>Import with <code>.</code> :</p><pre><code>import . &quot;./pack1&quot;
</code></pre><p>当使用 <code>.</code> 作为包的别名时，你可以不通过包名来使用其中的项目。例如：<code>test := ReturnStr()</code>。</p><p>在当前的命名空间导入 pack1 包，一般是为了具有更好的测试效果。</p><p>Import with <code>_</code> :</p><pre><code>import _ &quot;./pack1/pack1&quot;
</code></pre><p><code>pack1</code> 包只导入其副作用，也就是说，只执行它的 <code>init()</code> 函数并初始化其中的全局变量。</p><p><strong>导入外部安装包:</strong></p><p>如果你要在你的应用中使用一个或多个外部包，首先你必须使用 <code>go install</code>（参见<a href="">第 9.7 节</a>）在你的本地机器上安装它们。</p><p>假设你想使用 <code>http://codesite.ext/author/goExample/goex</code> 这种托管在 Google Code、GitHub 和 Launchpad 等代码网站上的包。</p><p>你可以通过如下命令安装：</p><pre><code>go install codesite.ext/author/goExample/goex
</code></pre><p>将一个名为 <code>codesite.ext/author/goExample/goex</code> 的 map 安装在 <code>$GOROOT/src/</code> 目录下。</p><p>通过以下方式，一次性安装，并导入到你的代码中：</p><pre><code>import goex &quot;codesite.ext/author/goExample/goex&quot;
</code></pre><p>因此该包的 URL 将用作导入路径。</p><p>在 <code>http://golang.org/cmd/goinstall/</code> 的 <code>go install</code> 文档中列出了一些广泛被使用的托管在网络代码仓库的包的导入路径</p><p><strong>包的初始化:</strong></p><p>程序的执行开始于导入包，初始化 <code>main</code> 包然后调用 <code>main()</code> 函数。</p><p>一个没有导入的包将通过分配初始值给所有的包级变量和调用源码中定义的包级 <code>init()</code> 函数来初始化。一个包可能有多个 <code>init()</code> 函数甚至在一个源码文件中。它们的执行是无序的。这是最好的例子来测定包的值是否只依赖于相同包下的其他值或者函数。</p><p><code>init()</code> 函数是不能被调用的。</p><p>导入的包在包自身初始化前被初始化，而一个包在程序执行中只能初始化一次。</p><p><strong>编译并安装一个包（参见<a href="">第 9.7 节</a>）：</strong></p><p>在 Linux/OS X 下可以用类似<a href="">第 3.9 节</a>的 Makefile 脚本做到这一点：</p><pre><code>include $(GOROOT)/src/Make.inc
TARG=pack1
GOFILES=\\
 	pack1.go\\
 	pack1b.go\\
include $(GOROOT)/src/Make.pkg
</code></pre><p>通过 <code>chmod 777 ./Makefile</code> 确保它的可执行性。</p><p>上面脚本内的 <code>include</code> 语句引入了相应的功能，将自动检测机器的架构并调用正确的编译器和链接器。</p><p>然后终端执行 <code>make</code> 或 <code>gomake</code> 工具：他们都会生成一个包含静态库 <code>pack1.a</code> 的 <code>_obj</code> 目录。</p><p>go install（参见<a href="">第 9.7 节</a>，从 Go1 的首选方式）同样复制 <code>pack1.a</code> 到本地的 <code>$GOROOT/pkg</code> 的目录中一个以操作系统为名的子目录下。像 <code>import &quot;pack1&quot;</code> 代替 <code>import &quot;path to pack1&quot;</code>，这样只通过名字就可以将包在程序中导入。</p><p>当<a href="">第 13 章</a> 我们遇到使用测试工具进行测试的时候我们将重新回到自己的包的制作和编译这个话题。</p><p><strong>问题 9.1</strong></p><p>a）一个包能分成多个源文件么？</p><p>b）一个源文件是否能包含多个包？</p><p><strong>练习 9.3</strong> <a href="exercises/chapter_9/main_greetings.go">main_greetings.go</a></p><p>创建一个程序 main_greetings.go 能够和用户说 <code>&quot;Good Day&quot;</code> 或者 <code>&quot;Good Night&quot;</code>。不同的问候应该放到单独的 <code>greetings</code> 包中。</p><p>在同一个包中创建一个 <code>IsAM</code> 函数返回一个布尔值用来判断当前时间是 AM 还是 PM，同样创建 <code>IsAfternoon</code> 和 <code>IsEvening</code> 函数。</p><p>使用 main_greetings 作出合适的问候（提示：使用 <code>time</code> 包）。</p><p><strong>练习 9.4</strong> 创建一个程序 <a href="exercises/chapter_9/main_oddeven.go">main_oddven.go</a> 判断前 100 个整数是不是偶数，将判断所用的函数编写在 <code>even</code> 包里。</p><p><strong>练习 9.5</strong> 使用<a href="">第 6.6 节</a>的斐波那契程序：</p><p>1）将斐波那契功能放入自己的 <code>fibo</code> 包中并通过主程序调用它，存储最后输入的值在函数的全局变量。</p><p>2）扩展 <code>fibo</code> 包将通过调用斐波那契的时候，操作也作为一个参数。实验 <code>&quot;+&quot;</code> 和 <code>&quot;*&quot;</code></p><p><a href="exercises/chapter_9/main_fibo.go">main_fibo.go</a> / <a href="exercises/chapter_6/fibonacci.go">fibonacci.go</a></p><h3 id="_9-6-为自定义包使用-godoc" tabindex="-1"><a class="header-anchor" href="#_9-6-为自定义包使用-godoc" aria-hidden="true">#</a> 9.6 为自定义包使用 godoc</h3><p>godoc 工具（<a href="">第 3.6 节</a>）在显示自定义包中的注释也有很好的效果：注释必须以 <code>//</code> 开始并无空行放在声明（包，类型，函数）前。godoc 会为每个文件生成一系列的网页。</p><p>例如：</p><ul><li><p>在 <a href="examples/chapter_9/doc_example">doc_examples</a> 目录下我们有<a href="">第 11.7 节</a>中的用来排序的 go 文件，文件中有一些注释（文件需要未编译）</p></li><li><p>命令行下进入目录下并输入命令：</p><p><code>godoc -http=:6060 -goroot=&quot;.&quot;</code></p></li></ul><p>（<code>.</code> 是指当前目录，<code>-goroot</code> 参数可以是 <code>/path/to/my/package1</code> 这样的形式指出 <code>package1</code> 在你源码中的位置或接受用冒号形式分隔的路径，无根目录的路径为相对于当前目录的相对路径）</p>`,105),Pe={href:"http://localhost:6060",target:"_blank",rel:"noopener noreferrer"},Se=t(`<p>然后你会看到本地的 godoc 页面（详见<a href="">第 3.6 节</a>）从左到右一次显示出目录中的包：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>doc_example:

doc_example | Packages | Commands | Specification
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下面是链接到源码和所有对象时有序概述（所以是很好的浏览和查找源代码的方式），连同文件/注释：</p><p><code>sort</code> 包</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> Float64sAreSorted

<span class="token keyword">type</span> IntArray

<span class="token keyword">func</span> IntsAreSortedfunc IsSortedfunc Sort

<span class="token keyword">func</span> <span class="token punctuation">(</span>IntArray<span class="token punctuation">)</span> Len

<span class="token keyword">func</span> SortFloat64s

<span class="token keyword">func</span> <span class="token punctuation">(</span>IntArray<span class="token punctuation">)</span> Less

<span class="token keyword">func</span> SortInts

<span class="token keyword">func</span> <span class="token punctuation">(</span>IntArray<span class="token punctuation">)</span> Swap

<span class="token keyword">func</span> SortStrings <span class="token keyword">type</span> Interface

<span class="token keyword">func</span> StringsAreSorted <span class="token keyword">type</span> StringArray <span class="token keyword">type</span> Float64Array

<span class="token keyword">func</span> <span class="token punctuation">(</span>StringArray<span class="token punctuation">)</span> Len

<span class="token keyword">func</span> <span class="token punctuation">(</span>Float64Array<span class="token punctuation">)</span> Len

<span class="token keyword">func</span> <span class="token punctuation">(</span>StringArray<span class="token punctuation">)</span> Less

<span class="token keyword">func</span> <span class="token punctuation">(</span>Float64Array<span class="token punctuation">)</span> Less

<span class="token keyword">func</span> <span class="token punctuation">(</span>StringArray<span class="token punctuation">)</span> Swap

<span class="token keyword">func</span> <span class="token punctuation">(</span>Float64Array<span class="token punctuation">)</span> Swap

<span class="token comment">// Other packages</span>
<span class="token keyword">import</span> <span class="token string">&quot;doc_example&quot;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用通用的接口排序:</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>func Float64sAreSorted[Top]
func Float64sAreSorted(a []float64) bool

func IntsAreSorted[Top]
func IntsAreSorted(a []int) bool

func IsSorted[Top]
func IsSorted(data Interface) bool
Test if data is sorted

func Sort[Top]
func Sort(data Interface)
General sort function

func SortInts[Top]
func SortInts(a []int)

Convenience wrappers for common cases: type IntArray[Top]
Convenience types for common cases: IntArray type IntArray []int  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果你在一个团队中工作，并且源代码树被存储在网络硬盘上，就可以使用 godoc 给所有团队成员连续文档的支持。通过设置 <code>sync_minutes=n</code>，你甚至可以让它每 <code>n</code> 分钟自动更新您的文档！</p><h3 id="_9-7-使用-go-install-安装自定义包" tabindex="-1"><a class="header-anchor" href="#_9-7-使用-go-install-安装自定义包" aria-hidden="true">#</a> 9.7 使用 go install 安装自定义包</h3><p>go install 是 Go 中自动包安装工具：如需要将包安装到本地它会从远端仓库下载包：检出、编译和安装一气呵成。</p><p>在包安装前的先决条件是要自动处理包自身依赖关系的安装。被依赖的包也会安装到子目录下，但是没有文档和示例：可以到网上浏览。</p><p>go install 使用了 GOPATH 变量（详见<a href="">第 2.2 节</a>）。</p><p>远端包（详见<a href="">第 9.5 节</a>）：</p>`,13),Te=n("code",null,"tideland",-1),Ce={href:"http://code.google.com/p/tideland-cgl",target:"_blank",rel:"noopener noreferrer"},Ae=t(`<p>因为我们需要创建目录在 Go 安装目录下，所以我们需要使用 root 或者 su 的身份执行命令。</p><p>确保 Go 环境变量已经设置在 root 用户下的 <code>./bashrc</code> 文件中。</p><p>使用命令安装：<code>go install tideland-cgl.googlecode.com/hg</code>。</p><p>可执行文件 <code>hg.a</code> 将被放到 <code>$GOROOT/pkg/linux_amd64/tideland-cgl.googlecode.com</code> 目录下，源码文件被放置在 <code>$GOROOT/src/tideland-cgl.googlecode.com/hg</code> 目录下，同样有个 <code>hg.a</code> 放置在 <code>_obj</code> 的子目录下。</p><p>现在就可以在 go 代码中使用这个包中的功能了，例如使用包名 cgl 导入：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">import</span> cgl <span class="token string">&quot;tideland-cgl.googlecode.com/hg&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>从 Go1 起 go install 安装 Google Code 的导入路径形式是：<code>&quot;code.google.com/p/tideland-cgl&quot;</code></p><p>升级到新的版本：</p><p>更新到新版本的 Go 之后本地安装包的二进制文件将全被删除。如果你想更新，重编译、重安装所有的 go 安装包可以使用：<code>go install -a</code>。</p><p>go 的版本发布的很频繁，所以需要注意发布版本和包的兼容性。go1 之后都是自己编译自己了。</p><p>go install 同样可以使用 go install 编译链接并安装本地自己的包（详见<a href="">第 9.8.2 节</a>）。</p>`,11),Oe={href:"http://golang.org/cmd/go/",target:"_blank",rel:"noopener noreferrer"},Ie=t(`<h3 id="_9-8-自定义包的目录结构、go-install-和-go-test" tabindex="-1"><a class="header-anchor" href="#_9-8-自定义包的目录结构、go-install-和-go-test" aria-hidden="true">#</a> 9.8 自定义包的目录结构、go install 和 go test</h3><p>为了示范，我们创建了一个名为 <code>uc</code> 的简单包，它含有一个 <code>UpperCase</code> 函数将字符串的所有字母转换为大写。当然这并不值得创建一个自定义包，同样的功能已被包含在 <code>strings</code> 包里，但是同样的技巧也可以应用在更复杂的包中。</p><h4 id="_9-8-1-自定义包的目录结构" tabindex="-1"><a class="header-anchor" href="#_9-8-1-自定义包的目录结构" aria-hidden="true">#</a> 9.8.1 自定义包的目录结构</h4><p>下面的结构给了你一个好的示范（<code>uc</code> 代表通用包名, 名字为粗体的代表目录，斜体代表可执行文件）:</p><pre><code>/home/user/goprograms
	ucmain.go	(uc 包主程序)
	Makefile (ucmain 的 makefile)
	ucmain
	src/uc	 (包含 uc 包的 go 源码)
		uc.go
	 	uc_test.go
	 	Makefile (包的 makefile)
	 	uc.a
	 	_obj
			uc.a
		_test
			uc.a
	bin		(包含最终的执行文件)
		ucmain
	pkg/linux_amd64
		uc.a	(包的目标文件)
</code></pre><p>将你的项目放在 goprograms 目录下(你可以创建一个环境变量 <code>GOPATH</code>，详见第 <a href="">2.2</a>/<a href="">3</a> 章节：在 <code>.profile</code> 和 <code>.bashrc</code> 文件中添加 <code>export GOPATH=/home/user/goprograms</code>)，而你的项目将作为 <code>src</code> 的子目录。<code>uc</code> 包中的功能在 uc.go 中实现。</p><p>示例 9.6 <a href="examples/chapter_9/uc.go">uc.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> uc
<span class="token keyword">import</span> <span class="token string">&quot;strings&quot;</span>

<span class="token keyword">func</span> <span class="token function">UpperCase</span><span class="token punctuation">(</span>str <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> strings<span class="token punctuation">.</span><span class="token function">ToUpper</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>包通常附带一个或多个测试文件，在这我们创建了一个 uc_test.go 文件，如<a href="">第 9.8 节</a>所述。</p><p>示例 9.7 <a href="examples/chapter_9/test.go">test.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> uc
<span class="token keyword">import</span> <span class="token string">&quot;testing&quot;</span>

<span class="token keyword">type</span> ucTest <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	in<span class="token punctuation">,</span> out <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> ucTests <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>ucTest <span class="token punctuation">{</span>
	ucTest<span class="token punctuation">{</span><span class="token string">&quot;abc&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ABC&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	ucTest<span class="token punctuation">{</span><span class="token string">&quot;cvo-az&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;CVO-AZ&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	ucTest<span class="token punctuation">{</span><span class="token string">&quot;Antwerp&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ANTWERP&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestUC</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ut <span class="token operator">:=</span> <span class="token keyword">range</span> ucTests <span class="token punctuation">{</span>
		uc <span class="token operator">:=</span> <span class="token function">UpperCase</span><span class="token punctuation">(</span>ut<span class="token punctuation">.</span>in<span class="token punctuation">)</span>
		<span class="token keyword">if</span> uc <span class="token operator">!=</span> ut<span class="token punctuation">.</span>out <span class="token punctuation">{</span>
			t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;UpperCase(%s) = %s, must be %s&quot;</span><span class="token punctuation">,</span> ut<span class="token punctuation">.</span>in<span class="token punctuation">,</span> uc<span class="token punctuation">,</span>
			ut<span class="token punctuation">.</span>out<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过指令编译并安装包到本地：<code>go install uc</code>, 这会将 uc.a 复制到 pkg/linux_amd64 下面。</p><p>另外，使用 make ，通过以下内容创建一个包的 Makefile 在 src/uc 目录下:</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>include $(GOROOT)/src/Make.inc

TARG=uc
GOFILES=\\
		uc.go\\

include $(GOROOT)/src/Make.pkg
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在该目录下的命令行调用: gomake</p><p>这将创建一个 _obj 目录并将包编译生成的存档 uc.a 放在该目录下。</p><p>这个包可以通过 go test 测试。</p><p>创建一个 uc.a 的测试文件在目录下，输出为 <code>PASS</code> 时测试通过。</p><p>在<a href="">第 13.8 节</a>我们将给出另外一个测试例子并进行深入研究。</p><p>备注：有可能你当前的用户不具有足够的资格使用 go install（没有权限）。这种情况下，选择 root 用户 su。确保 Go 环境变量和 Go 源码路径也设置给 su，同样也适用你的普通用户（详见<a href="">第 2.3 节</a>）。</p><p>接下来我们创建主程序 ucmain.go:</p><p>示例 9.8 <a href="/examples/chapter_9/ucmain.go">ucmain.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;./src/uc&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	str1 <span class="token operator">:=</span> <span class="token string">&quot;USING package uc!&quot;</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>uc<span class="token punctuation">.</span><span class="token function">UpperCase</span><span class="token punctuation">(</span>str1<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后在这个目录下输入 <code>go install</code>。</p><p>另外复制 uc.a 到 /home/user/goprograms 目录并创建一个 Makefile 并写入文本：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>include $(GOROOT)/src/Make.inc
TARG=ucmain
GOFILES=\\
	ucmain.go\\

include $(GOROOT)/src/Make.cmd
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行 gomake 编译 <code>ucmain.go</code> 生成可执行文件 ucmain</p><p>运行 <code>./ucmain</code> 显示: <code>USING PACKAGE UC!</code>。</p><h4 id="_9-8-2-本地安装包" tabindex="-1"><a class="header-anchor" href="#_9-8-2-本地安装包" aria-hidden="true">#</a> 9.8.2 本地安装包</h4><p>本地包在用户目录下，使用给出的目录结构，以下命令用来从源码安装本地包：</p><pre><code>go install /home/user/goprograms/src/uc # 编译安装 uc
cd /home/user/goprograms/uc
go install ./uc 	# 编译安装 uc（和之前的指令一样）
cd ..
go install .	# 编译安装 ucmain
</code></pre><p>安装到 <code>$GOPATH</code> 下：</p><p>如果我们想安装的包在系统上的其他 Go 程序中被使用，它一定要安装到 <code>$GOPATH</code> 下。 这样做，在 .profile 和 .bashrc 中设置 <code>export GOPATH=/home/user/goprograms</code>。</p><p>然后执行 <code>go install uc</code> 将会复制包存档到 <code>$GOPATH/pkg/LINUX_AMD64/uc</code>。</p><p>现在，uc 包可以通过 <code>import &quot;uc&quot;</code> 在任何 Go 程序中被引用。</p><h4 id="_9-8-3-依赖系统的代码" tabindex="-1"><a class="header-anchor" href="#_9-8-3-依赖系统的代码" aria-hidden="true">#</a> 9.8.3 依赖系统的代码</h4><p>在不同的操作系统上运行的程序以不同的代码实现是非常少见的：绝大多数情况下语言和标准库解决了大部分的可移植性问题。</p><p>你有一个很好的理由去写平台特定的代码，例如汇编语言。这种情况下，按照下面的约定是合理的：</p><pre><code>prog1.go
prog1_linux.go
prog1_darwin.go
prog1_windows.go
</code></pre><p>prog1.go 定义了不同操作系统通用的接口，并将系统特定的代码写到 prog1_os.go 中。 对于 Go 工具你可以指定 <code>prog1_$GOOS.go</code> 或 <code>prog1_$GOARCH.go</code> 或在平台 Makefile 中：<code>prog1_$(GOOS).go\\</code> 或 <code>prog1_$(GOARCH).go\\</code>。</p><h3 id="_9-9-通过-git-打包和安装" tabindex="-1"><a class="header-anchor" href="#_9-9-通过-git-打包和安装" aria-hidden="true">#</a> 9.9 通过 Git 打包和安装</h3><h4 id="_9-9-1-安装到-github" tabindex="-1"><a class="header-anchor" href="#_9-9-1-安装到-github" aria-hidden="true">#</a> 9.9.1 安装到 GitHub</h4><p>以上的方式对于本地包来说是可以的，但是我们如何打包代码到开发者圈子呢？那么我们需要一个云端的源码的版本控制系统，比如著名的 Git。</p>`,43),Fe={href:"http://help.github.com/win-set-up-git/",target:"_blank",rel:"noopener noreferrer"},Ne=t('<p>这里将通过为<a href="">第 9.8 节</a>中的 <code>uc</code> 包创建一个 git 仓库作为演示</p><p>进入到 <code>uc</code> 包目录下并创建一个 Git 仓库在里面: <code>git init</code>。</p><p>信息提示: <code>Initialized empty git repository in $PWD/uc</code>。</p>',3),Ee={href:"http://README.md",target:"_blank",rel:"noopener noreferrer"},Re=n("ul",null,[n("li",null,[s("添加所有文件到仓库："),n("code",null,"git add README.md uc.go uc_test.go Makefile"),s("。")]),n("li",null,[s("标记为第一个版本："),n("code",null,'git commit -m "initial rivision"'),s("。")])],-1),Me={href:"https://github.com",target:"_blank",rel:"noopener noreferrer"},Le={href:"http://help.github.com/",target:"_blank",rel:"noopener noreferrer"},Be=t(`<p>在云端创建一个新的 uc 仓库;发布的指令为（<code>NNNN</code> 替代用户名）:</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>git remote add origin git@github.com:NNNN/uc.git  
git push -u origin master
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>操作完成后检查 GitHub 上的包页面: <code>http://github.com/NNNN/uc</code>。</p><h4 id="_9-9-2-从-github-安装" tabindex="-1"><a class="header-anchor" href="#_9-9-2-从-github-安装" aria-hidden="true">#</a> 9.9.2 从 GitHub 安装</h4><p>如果有人想安装您的远端项目到本地机器，打开终端并执行（<code>NNNN</code> 是你在 GitHub 上的用户名）：<code>go get github.com/NNNN/uc</code>。</p><p>这样现在这台机器上的其他 Go 应用程序也可以通过导入路径：<code>&quot;github.com/NNNN/uc&quot;</code> 代替 <code>&quot;./uc/uc&quot;</code> 来使用。</p><p>也可以将其缩写为：<code>import uc &quot;github.com/NNNN/uc&quot;</code>。</p><p>然后修改 Makefile: 将 <code>TARG=uc</code> 替换为 <code>TARG=github.com/NNNN/uc</code>。</p><p>Gomake（和 go install）将通过 <code>$GOPATH</code> 下的本地版本进行工作。</p><p>网站和版本控制系统的其他的选择(括号中为网站所使用的版本控制系统)：</p><ul><li>BitBucket(hg/Git)</li><li>GitHub(Git)</li><li>Google Code(hg/Git/svn)</li><li>Launchpad(bzr)</li></ul><p>版本控制系统可以选择你熟悉的或者本地使用的代码版本控制。Go 核心代码的仓库是使用 Mercurial(hg) 来控制的，所以它是一个最可能保证你可以得到开发者项目中最好的软件。Git 也很出名，同样也适用。如果你从未使用过版本控制，这些网站有一些很好的帮助并且你可以通过在谷歌搜索 &quot;{name} tutorial&quot;（name为你想要使用的版本控制系统）得到许多很好的教程。</p><h3 id="_9-10-go-的外部包和项目" tabindex="-1"><a class="header-anchor" href="#_9-10-go-的外部包和项目" aria-hidden="true">#</a> 9.10 Go 的外部包和项目</h3><p>现在我们知道如何使用 Go 以及它的标准库了，但是 Go 的生态要比这大的多。当着手自己的 Go 项目时，最好先查找下是否有些存在的第三方的包或者项目能不能使用。大多数可以通过 go install 来进行安装。</p>`,14),We={href:"https://gowalker.org",target:"_blank",rel:"noopener noreferrer"},De=t('<p>目前已经有许多非常好的外部库，如：</p><ul><li>MySQL(GoMySQL), PostgreSQL(go-pgsql), MongoDB (mgo, gomongo), CouchDB (couch-go), ODBC (godbcl), Redis (redis.go) and SQLite3 (gosqlite) database drivers</li><li>SDL bindings</li><li>Google&#39;s Protocal Buffers(goprotobuf)</li><li>XML-RPC(go-xmlrpc)</li><li>Twitter(twitterstream)</li><li>OAuth libraries(GoAuth)</li></ul><h3 id="_9-11-在-go-程序中使用外部库" tabindex="-1"><a class="header-anchor" href="#_9-11-在-go-程序中使用外部库" aria-hidden="true">#</a> 9.11 在 Go 程序中使用外部库</h3><p>（本节我们将创建一个 Web 应用和它的 Google App Engine 版本，在第 19 和 21 章分别说明，当你阅读到这些章节时可以再回到这个例子。)</p><p>当开始一个新项目或增加新的功能到现有的项目，你可以通过在应用程序中使用已经存在的库来节省开发时间。为了做到这一点，你必须理解库的 API（应用编程接口），那就是：库中有哪些方法可以调用，如何调用。你可能没有这个库的源代码，但作者肯定有记载的 API 以及详细介绍了如何使用它。</p>',5),Ue={href:"http://goo.gl/",target:"_blank",rel:"noopener noreferrer"},je={href:"http://www.destandaard.be",target:"_blank",rel:"noopener noreferrer"},Ve={href:"http://goo.gl/O9SUO",target:"_blank",rel:"noopener noreferrer"},He={href:"http://code.google.com/apis/urlshortener/",target:"_blank",rel:"noopener noreferrer"},ze=n("a",{href:""},"第 19 章",-1),Je=n("p",null,"谷歌将这项技术提供给其他开发者，我们可以在我们自己的应用程序中调用 API （释放到指定的限制）。他们也生成了一个 Go 语言客户端库使调用变得更容易。",-1),Xe={href:"http://code.google.com/p/google-api-go-client/",target:"_blank",rel:"noopener noreferrer"},Ke=t(`<p>下载并安装 Go 客户端库: 将通过 go install 实现。但是首先要验证环境变量中是否含有 <code>GOPATH</code> 变量，因为外部源码将被下载到 <code>$GOPATH/src</code> 目录下并被安装到 <code>$GOPATH/PKG/&quot;machine_arch&quot;/</code> 目录下。</p><p>我们将通过在终端调用以下命令来安装 API:</p><pre><code>go install google.golang.org/api/urlshortener/v1
</code></pre><p>go install 将下载源码，编译并安装包</p><p>使用 urlshortener 服务的 web 程序: 现在我们可以通过导入并赋予别名来使用已安装的包：</p><pre><code>import  &quot;google.golang.org/api/urlshortener/v1&quot;
</code></pre><p>现在我们写一个 Web 应用（参见<a href="">第 15 章 4-8 节</a>）通过表单实现短地址和长地址的相互转换。我们将使用 <code>template</code> 包并写三个处理函数：<code>root()</code> 函数通过执行表单模板来展示表单，<code>short()</code> 函数将长地址转换为短地址，<code>long()</code> 函数逆向转换。</p><p>要调用 <code>urlshortener</code> 接口必须先通过 <code>http</code> 包中的默认客户端创建一个服务实例 <code>urlshortenerSvc</code>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>urlshortenerSvc<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> urlshortener<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>DefaultClient<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>我们通过调用服务中的 <code>Url.Insert</code> 中的 <code>Do</code> 方法传入包含长地址的 <code>Url</code> 数据结构从而获取短地址：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>url<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> urlshortenerSvc<span class="token punctuation">.</span>Url<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>urlshortener<span class="token punctuation">.</span>Url<span class="token punctuation">{</span>LongUrl<span class="token punctuation">:</span> longUrl<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>返回 <code>url</code> 的 <code>Id</code> 便是我们需要的短地址。</p><p>我们通过调用服务中的 <code>Url.Get</code> 中的 <code>Do</code> 方法传入包含短地址的 Url 数据结构从而获取长地址：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>url<span class="token punctuation">,</span> <span class="token builtin">error</span> <span class="token operator">:=</span> urlshortenerSvc<span class="token punctuation">.</span>Url<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>shwortUrl<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>返回的长地址便是转换前的原始地址。</p><p>示例 9.9 <a href="examples/chapter_9/use_urlshortener.go">urlshortener.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	 <span class="token string">&quot;fmt&quot;</span>
	 <span class="token string">&quot;net/http&quot;</span>
	 <span class="token string">&quot;text/template&quot;</span>

	 <span class="token string">&quot;google.golang.org/api/urlshortener/v1&quot;</span>
<span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	 http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span>
	 http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/short&quot;</span><span class="token punctuation">,</span> short<span class="token punctuation">)</span>
	 http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/long&quot;</span><span class="token punctuation">,</span> long<span class="token punctuation">)</span>

	 http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">&quot;localhost:8080&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// the template used to show the forms and the results web page to the user</span>
<span class="token keyword">var</span> rootHtmlTmpl <span class="token operator">=</span> template<span class="token punctuation">.</span><span class="token function">Must</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;rootHtml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token string">\`
&lt;html&gt;&lt;body&gt;
&lt;h1&gt;URL SHORTENER&lt;/h1&gt;
{{if .}}{{.}}&lt;br /&gt;&lt;br /&gt;{{end}}
&lt;form action=&quot;/short&quot; type=&quot;POST&quot;&gt;
Shorten this: &lt;input type=&quot;text&quot; name=&quot;longUrl&quot; /&gt;
&lt;input type=&quot;submit&quot; value=&quot;Give me the short URL&quot; /&gt;
&lt;/form&gt;
&lt;br /&gt;
&lt;form action=&quot;/long&quot; type=&quot;POST&quot;&gt;
Expand this: http://goo.gl/&lt;input type=&quot;text&quot; name=&quot;shortUrl&quot; /&gt;
&lt;input type=&quot;submit&quot; value=&quot;Give me the long URL&quot; /&gt;
&lt;/form&gt;
&lt;/body&gt;&lt;/html&gt;
\`</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">func</span> <span class="token function">root</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	rootHtmlTmpl<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">short</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	 longUrl <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">FormValue</span><span class="token punctuation">(</span><span class="token string">&quot;longUrl&quot;</span><span class="token punctuation">)</span>
	 urlshortenerSvc<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> urlshortener<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>DefaultClient<span class="token punctuation">)</span>
	 url<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> urlshortenerSvc<span class="token punctuation">.</span>Url<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>urlshortener<span class="token punctuation">.</span>Url<span class="token punctuation">{</span>LongUrl<span class="token punctuation">:</span>
	 longUrl<span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	 rootHtmlTmpl<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;Shortened version of %s is : %s&quot;</span><span class="token punctuation">,</span>
	 longUrl<span class="token punctuation">,</span> url<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">long</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	 shortUrl <span class="token operator">:=</span> <span class="token string">&quot;http://goo.gl/&quot;</span> <span class="token operator">+</span> r<span class="token punctuation">.</span><span class="token function">FormValue</span><span class="token punctuation">(</span><span class="token string">&quot;shortUrl&quot;</span><span class="token punctuation">)</span>
	 urlshortenerSvc<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> urlshortener<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>DefaultClient<span class="token punctuation">)</span>
	 url<span class="token punctuation">,</span> err <span class="token operator">:=</span> urlshortenerSvc<span class="token punctuation">.</span>Url<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>shortUrl<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	 <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		 fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;error: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		 <span class="token keyword">return</span>

	 <span class="token punctuation">}</span>
	 rootHtmlTmpl<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;Longer version of %s is : %s&quot;</span><span class="token punctuation">,</span>
	 shortUrl<span class="token punctuation">,</span> url<span class="token punctuation">.</span>LongUrl<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行这段代码：</p><pre><code>go run urlshortener.go
</code></pre><p>通过浏览 <code>http://localhost:8080/</code> 的页面来测试。</p><p>为了代码的简洁我们并没有检测返回的错误状态，但是在真实的生产环境的应用中一定要做检测。</p><p>将应用放入 Google App Engine，我们只需要在之前的代码中作出如下改变：</p><pre><code>package main -&gt; package urlshort
func main() -&gt; func init()
</code></pre><p>创建一个和包同名的目录 <code>urlshort</code>，并将以下两个安装目录复制到这个目录：</p><pre><code>google.golang.org/api/urlshortener
google.golang.org/api/googleapi
</code></pre><p>此外还要配置下配置文件 <code>app.yaml</code>，内容如下：</p><div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">application</span><span class="token punctuation">:</span> urlshort
<span class="token key atrule">version</span><span class="token punctuation">:</span> 0<span class="token punctuation">-</span>1<span class="token punctuation">-</span>test
<span class="token key atrule">runtime</span><span class="token punctuation">:</span> go
<span class="token key atrule">api_version</span><span class="token punctuation">:</span> <span class="token number">3</span>
<span class="token key atrule">handlers</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">url</span><span class="token punctuation">:</span> /.*
<span class="token key atrule">script</span><span class="token punctuation">:</span> _go_app
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>现在你可以到你的项目目录并在终端运行：<code>dev_appserver.py urlshort</code></p>`,28),$e={href:"http://localhost:8080",target:"_blank",rel:"noopener noreferrer"},Ye=t(`<h2 id="第-10-章-结构体-struct-与方法-method" tabindex="-1"><a class="header-anchor" href="#第-10-章-结构体-struct-与方法-method" aria-hidden="true">#</a> 第 10 章：结构体 (struct) 与方法 (method)</h2><p>Go 通过类型别名 (alias types) 和结构体的形式支持用户自定义类型，或者叫定制类型。一个带属性的结构体试图表示一个现实世界中的实体。结构体是复合类型 (composite types)，当需要定义一个类型，它由一系列属性组成，每个属性都有自己的类型和值的时候，就应该使用结构体，它把数据聚集在一起。然后可以访问这些数据，就好像它是一个独立实体的一部分。结构体也是值类型，因此可以通过 <strong>new</strong> 函数来创建。</p><p>组成结构体类型的那些数据称为 <strong>字段 (fields)</strong>。每个字段都有一个类型和一个名字；在一个结构体中，字段名字必须是唯一的。</p><p>结构体的概念在软件工程上旧的术语叫 ADT（抽象数据类型：Abstract Data Type），在一些老的编程语言中叫 <strong>记录 (Record)</strong>，比如 Cobol，在 C 家族的编程语言中它也存在，并且名字也是 <strong>struct</strong>，在面向对象的编程语言中，跟一个无方法的轻量级类一样。不过因为 Go 语言中没有类的概念，因此在 Go 中结构体有着更为重要的地位。</p><h3 id="_10-1-结构体定义" tabindex="-1"><a class="header-anchor" href="#_10-1-结构体定义" aria-hidden="true">#</a> 10.1 结构体定义</h3><p>结构体定义的一般方式如下：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> identifier <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    field1 type1
    field2 type2
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>type T struct {a, b int}</code> 也是合法的语法，它更适用于简单的结构体。</p><p>结构体里的字段都有 <strong>名字</strong>，像 <code>field1</code>、<code>field2</code> 等，如果字段在代码中从来也不会被用到，那么可以命名它为 <code>_</code>。</p><p>结构体的字段可以是任何类型，甚至是结构体本身（参考第 <a href="">10.5</a> 节），也可以是函数或者接口（参考<a href="">第 11 章</a>）。可以声明结构体类型的一个变量，然后像下面这样给它的字段赋值：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> s T
s<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">5</span>
s<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token number">8</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>数组可以看作是一种结构体类型，不过它使用下标而不是具名的字段。</p><p><strong>使用 <code>new()</code></strong></p><p>使用 <code>new()</code> 函数给一个新的结构体变量分配内存，它返回指向已分配内存的指针：<code>var t *T = new(T)</code>，如果需要可以把这条语句放在不同的行（比如定义是包范围的，但是分配却没有必要在开始就做）。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> t <span class="token operator">*</span>T
t <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>写这条语句的惯用方法是：<code>t := new(T)</code>，变量 <code>t</code> 是一个指向 <code>T</code> 的指针，此时结构体字段的值是它们所属类型的零值。</p><p>声明 <code>var t T</code> 也会给 <code>t</code> 分配内存，并零值化内存，但是这个时候 <code>t</code> 是类型 <code>T</code> 。在这两种方式中，<code>t</code> 通常被称做类型 T 的一个实例 (instance) 或对象 (object)。</p><p>示例 10.1 <a href="examples/chapter_10/structs_fields.go">structs_fields.go</a> 给出了一个非常简单的例子：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">type</span> struct1 <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    i1  <span class="token builtin">int</span>
    f1  <span class="token builtin">float32</span>
    str <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ms <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>struct1<span class="token punctuation">)</span>
    ms<span class="token punctuation">.</span>i1 <span class="token operator">=</span> <span class="token number">10</span>
    ms<span class="token punctuation">.</span>f1 <span class="token operator">=</span> <span class="token number">15.5</span>
    ms<span class="token punctuation">.</span>str<span class="token operator">=</span> <span class="token string">&quot;Chris&quot;</span>

    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The int is: %d\\n&quot;</span><span class="token punctuation">,</span> ms<span class="token punctuation">.</span>i1<span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The float is: %f\\n&quot;</span><span class="token punctuation">,</span> ms<span class="token punctuation">.</span>f1<span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The string is: %s\\n&quot;</span><span class="token punctuation">,</span> ms<span class="token punctuation">.</span>str<span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>ms<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>The int is: 10
The float is: 15.500000
The string is: Chris
&amp;{10 15.5 Chris}
</code></pre><p>使用 <code>fmt.Println()</code> 打印一个结构体的默认输出可以很好的显示它的内容，类似使用 <code>%v</code> 选项。</p><p>就像在面向对象语言所作的那样，可以使用点号符给字段赋值：<code>structname.fieldname = value</code>。</p><p>同样的，使用点号符可以获取结构体字段的值：<code>structname.fieldname</code>。</p><p>在 Go 语言中这叫 <strong>选择器 (selector)</strong>。无论变量是一个结构体类型还是一个结构体类型指针，都使用同样的 <strong>选择器符 (selector-notation)</strong> 来引用结构体的字段：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> myStruct <span class="token keyword">struct</span> <span class="token punctuation">{</span> i <span class="token builtin">int</span> <span class="token punctuation">}</span>
<span class="token keyword">var</span> v myStruct    <span class="token comment">// v 是结构体类型变量</span>
<span class="token keyword">var</span> p <span class="token operator">*</span>myStruct   <span class="token comment">// p 是指向一个结构体类型变量的指针</span>
v<span class="token punctuation">.</span>i
p<span class="token punctuation">.</span>i
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>初始化一个结构体实例（一个结构体字面量：struct-literal）的更简短和惯用的方式如下：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>    ms <span class="token operator">:=</span> <span class="token operator">&amp;</span>struct1<span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">15.5</span><span class="token punctuation">,</span> <span class="token string">&quot;Chris&quot;</span><span class="token punctuation">}</span>
    <span class="token comment">// 此时 ms 的类型是 *struct1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>或者：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>    <span class="token keyword">var</span> ms struct1
    ms <span class="token operator">=</span> struct1<span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">15.5</span><span class="token punctuation">,</span> <span class="token string">&quot;Chris&quot;</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>混合字面量语法 (composite literal syntax) <code>&amp;struct1{a, b, c}</code> 是一种简写，底层仍然会调用 <code>new()</code>，这里值的顺序必须按照字段顺序来写。在下面的例子中能看到可以通过在值的前面放上字段名来初始化字段的方式。表达式 <code>new(Type)</code> 和 <code>&amp;Type{}</code> 是等价的。</p><p>时间间隔（开始和结束时间以秒为单位）是使用结构体的一个典型例子：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Interval <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    start <span class="token builtin">int</span>
    end   <span class="token builtin">int</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>初始化方式：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>intr <span class="token operator">:=</span> Interval<span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span>            <span class="token punctuation">(</span>A<span class="token punctuation">)</span>
intr <span class="token operator">:=</span> Interval<span class="token punctuation">{</span>end<span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">,</span> start<span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">}</span>  <span class="token punctuation">(</span>B<span class="token punctuation">)</span>
intr <span class="token operator">:=</span> Interval<span class="token punctuation">{</span>end<span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">}</span>           <span class="token punctuation">(</span>C<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 (A) 中，值必须以字段在结构体定义时的顺序给出，<code>&amp;</code> 不是必须的。(B) 显示了另一种方式，字段名加一个冒号放在值的前面，这种情况下值的顺序不必一致，并且某些字段还可以被忽略掉，就像 (C) 中那样。</p><p>结构体类型和字段的命名遵循可见性规则（第 <a href="">4.2</a> 节），一个导出的结构体类型中有些字段是导出的，另一些不是，这是可能的。</p><p>下图说明了结构体类型实例和一个指向它的指针的内存布局：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Point <span class="token keyword">struct</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token builtin">int</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>使用 <code>new()</code> 初始化：</p><figure><img src="`+A+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>作为结构体字面量初始化：</p><figure><img src="'+O+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>类型 <code>struct1</code> 在定义它的包 <code>pack1</code> 中必须是唯一的，它的完全类型名是：<code>pack1.struct1</code>。</p><p>下面的例子 <a href="examples/chapter_10/person.go">Listing 10.2—person.go</a> 显示了一个结构体 <code>Person</code>，一个方法 <code>upPerson()</code>，方法有一个类型为 <code>*Person</code> 的参数（因此对象本身是可以被改变的），以及三种调用这个方法的不同方式：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;fmt&quot;</span>
    <span class="token string">&quot;strings&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Person <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    firstName   <span class="token builtin">string</span>
    lastName    <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">upPerson</span><span class="token punctuation">(</span>p <span class="token operator">*</span>Person<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    p<span class="token punctuation">.</span>firstName <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">ToUpper</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>firstName<span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>lastName <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">ToUpper</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>lastName<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1-struct as a value type:</span>
    <span class="token keyword">var</span> pers1 Person
    pers1<span class="token punctuation">.</span>firstName <span class="token operator">=</span> <span class="token string">&quot;Chris&quot;</span>
    pers1<span class="token punctuation">.</span>lastName <span class="token operator">=</span> <span class="token string">&quot;Woodward&quot;</span>
    <span class="token function">upPerson</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pers1<span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The name of the person is %s %s\\n&quot;</span><span class="token punctuation">,</span> pers1<span class="token punctuation">.</span>firstName<span class="token punctuation">,</span> pers1<span class="token punctuation">.</span>lastName<span class="token punctuation">)</span>

    <span class="token comment">// 2—struct as a pointer:</span>
    pers2 <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>Person<span class="token punctuation">)</span>
    pers2<span class="token punctuation">.</span>firstName <span class="token operator">=</span> <span class="token string">&quot;Chris&quot;</span>
    pers2<span class="token punctuation">.</span>lastName <span class="token operator">=</span> <span class="token string">&quot;Woodward&quot;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>pers2<span class="token punctuation">)</span><span class="token punctuation">.</span>lastName <span class="token operator">=</span> <span class="token string">&quot;Woodward&quot;</span>  <span class="token comment">// 这是合法的</span>
    <span class="token function">upPerson</span><span class="token punctuation">(</span>pers2<span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The name of the person is %s %s\\n&quot;</span><span class="token punctuation">,</span> pers2<span class="token punctuation">.</span>firstName<span class="token punctuation">,</span> pers2<span class="token punctuation">.</span>lastName<span class="token punctuation">)</span>

    <span class="token comment">// 3—struct as a literal:</span>
    pers3 <span class="token operator">:=</span> <span class="token operator">&amp;</span>Person<span class="token punctuation">{</span><span class="token string">&quot;Chris&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Woodward&quot;</span><span class="token punctuation">}</span>
    <span class="token function">upPerson</span><span class="token punctuation">(</span>pers3<span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The name of the person is %s %s\\n&quot;</span><span class="token punctuation">,</span> pers3<span class="token punctuation">.</span>firstName<span class="token punctuation">,</span> pers3<span class="token punctuation">.</span>lastName<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>The name of the person is CHRIS WOODWARD
The name of the person is CHRIS WOODWARD
The name of the person is CHRIS WOODWARD
</code></pre><p>在上面例子的第二种情况中，可以直接通过指针，像 <code>pers2.lastName = &quot;Woodward&quot;</code> 这样给结构体字段赋值，没有像 C++ 中那样需要使用 <code>-&gt;</code> 操作符，Go 会自动做这样的转换。</p><p>注意也可以通过解指针的方式来设置值：<code>(*pers2).lastName = &quot;Woodward&quot;</code></p><p><strong>结构体的内存布局</strong></p><p>Go 语言中，结构体和它所包含的数据在内存中是以连续块的形式存在的，即使结构体中嵌套有其他的结构体，这在性能上带来了很大的优势。不像 Java 中的引用类型，一个对象和它里面包含的对象可能会在不同的内存空间中，这点和 Go 语言中的指针很像。下面的例子清晰地说明了这些情况：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Rect1 <span class="token keyword">struct</span> <span class="token punctuation">{</span>Min<span class="token punctuation">,</span> Max Point <span class="token punctuation">}</span>
<span class="token keyword">type</span> Rect2 <span class="token keyword">struct</span> <span class="token punctuation">{</span>Min<span class="token punctuation">,</span> Max <span class="token operator">*</span>Point <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="`+I+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p><strong>递归结构体</strong></p><p>结构体类型可以通过引用自身来定义。这在定义链表或二叉树的元素（通常叫节点）时特别有用，此时节点包含指向临近节点的链接（地址）。如下所示，链表中的 <code>su</code>，树中的 <code>ri</code> 和 <code>le</code> 分别是指向别的节点的指针。</p><p>链表：</p><figure><img src="'+F+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>这块的 <code>data</code> 字段用于存放有效数据（比如 <code>float64</code>），<code>su</code> 指针指向后继节点。</p><p>Go 代码：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Node <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    data    <span class="token builtin">float64</span>
    su      <span class="token operator">*</span>Node
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>链表中的第一个元素叫 <code>head</code>，它指向第二个元素；最后一个元素叫 <code>tail</code>，它没有后继元素，所以它的 <code>su</code> 为 <code>nil</code> 值。当然真实的链接会有很多数据节点，并且链表可以动态增长或收缩。</p><p>同样地可以定义一个双向链表，它有一个前趋节点 <code>pr</code> 和一个后继节点 <code>su</code>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Node <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    pr      <span class="token operator">*</span>Node
    data    <span class="token builtin">float64</span>
    su      <span class="token operator">*</span>Node
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>二叉树：</p><figure><img src="`+N+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>二叉树中每个节点最多能链接至两个节点：左节点 (<code>le</code>) 和右节点 (<code>ri</code>)，这两个节点本身又可以有左右节点，依次类推。树的顶层节点叫根节点 (<strong>root</strong>)，底层没有子节点的节点叫叶子节点 (<strong>leaves</strong>)，叶子节点的 <code>le</code> 和 <code>ri</code> 指针为 <code>nil</code> 值。在 Go 中可以如下定义二叉树：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Tree <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    le      <span class="token operator">*</span>Tree
    data    <span class="token builtin">float64</span>
    ri      <span class="token operator">*</span>Tree
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>结构体转换</strong></p><p>Go 中的类型转换遵循严格的规则。当为结构体定义了一个 <code>alias</code> 类型时，此结构体类型和它的 <code>alias</code> 类型都有相同的底层类型，它们可以如示例 10.3 那样互相转换，同时需要注意其中非法赋值或转换引起的编译错误。</p><p>示例 10.3：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">type</span> number <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    f <span class="token builtin">float32</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> nr number   <span class="token comment">// alias type</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    a <span class="token operator">:=</span> number<span class="token punctuation">{</span><span class="token number">5.0</span><span class="token punctuation">}</span>
    b <span class="token operator">:=</span> nr<span class="token punctuation">{</span><span class="token number">5.0</span><span class="token punctuation">}</span>
    <span class="token comment">// var i float32 = b   // compile-error: cannot use b (type nr) as type float32 in assignment</span>
    <span class="token comment">// var i = float32(b)  // compile-error: cannot convert b (type nr) to type float32</span>
    <span class="token comment">// var c number = b    // compile-error: cannot use b (type nr) as type number in assignment</span>
    <span class="token comment">// needs a conversion:</span>
    <span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token function">number</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>{5} {5} {5}
</code></pre><p><strong>练习 10.1</strong> <a href="exercises/chapter_10/vcard.go">vcard.go</a>：</p><p>定义结构体 <code>Address</code> 和 <code>VCard</code>，后者包含一个人的名字、地址编号、出生日期和图像，试着选择正确的数据类型。构建一个自己的 <code>vcard</code> 并打印它的内容。</p><pre><code>提示：
VCard 必须包含住址，它应该以值类型还是以指针类型放在 VCard 中呢？
第二种会好点，因为它占用内存少。包含一个名字和两个指向地址的指针的 Address 结构体可以使用 %v 打印：
{Kersschot 0x126d2b80 0x126d2be0}
</code></pre><p><strong>练习 10.2</strong> <a href="exercises/chapter_10/personex1.go">personex1.go</a>：</p><p>修改 personex1.go，使它的参数 <code>upPerson</code> 不是一个指针，解释下二者的区别。</p><p><strong>练习 10.3</strong> <a href="exercises/chapter_10/point.go">point.go</a>：</p><p>使用坐标 <code>X</code>、<code>Y</code> 定义一个二维 <code>Point</code> 结构体。同样地，对一个三维点使用它的极坐标定义一个 <code>Polar</code> 结构体。实现一个 <code>Abs()</code> 方法来计算一个 <code>Point</code> 表示的向量的长度，实现一个 <code>Scale()</code> 方法，它将点的坐标乘以一个尺度因子（提示：使用 <code>math</code> 包里的 <code>Sqrt()</code> 函数）(function Scale that multiplies the coordinates of a point with a scale factor)。</p><p><strong>练习 10.4</strong> <a href="exercises/chapter_10/rectangle.go">rectangle.go</a>：</p><p>定义一个 <code>Rectangle</code> 结构体，它的长和宽是 <code>int</code> 类型，并定义方法 <code>Area()</code> 和 <code>Perimeter()</code>，然后进行测试。</p><h3 id="_10-2-使用工厂方法创建结构体实例" tabindex="-1"><a class="header-anchor" href="#_10-2-使用工厂方法创建结构体实例" aria-hidden="true">#</a> 10.2 使用工厂方法创建结构体实例</h3><h4 id="_10-2-1-结构体工厂" tabindex="-1"><a class="header-anchor" href="#_10-2-1-结构体工厂" aria-hidden="true">#</a> 10.2.1 结构体工厂</h4><p>Go 语言不支持面向对象编程语言中那样的构造子方法，但是可以很容易的在 Go 中实现 “构造子工厂”方法。为了方便通常会为类型定义一个工厂，按惯例，工厂的名字以 <code>new...</code> 或 <code>New...</code> 开头。假设定义了如下的 <code>File</code> 结构体类型：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> File <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    fd      <span class="token builtin">int</span>     <span class="token comment">// 文件描述符</span>
    name    <span class="token builtin">string</span>  <span class="token comment">// 文件名</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下面是这个结构体类型对应的工厂方法，它返回一个指向结构体实例的指针：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">NewFile</span><span class="token punctuation">(</span>fd <span class="token builtin">int</span><span class="token punctuation">,</span> name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>File <span class="token punctuation">{</span>
    <span class="token keyword">if</span> fd <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token operator">&amp;</span>File<span class="token punctuation">{</span>fd<span class="token punctuation">,</span> name<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后这样调用它：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>f <span class="token operator">:=</span> <span class="token function">NewFile</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">&quot;./test.txt&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>在 Go 语言中常常像上面这样在工厂方法里使用初始化来简便的实现构造函数。</p><p>如果 <code>File</code> 是一个结构体类型，那么表达式 <code>new(File)</code> 和 <code>&amp;File{}</code> 是等价的。</p><p>这可以和大多数面向对象编程语言中笨拙的初始化方式做个比较：<code>File f = new File(...)</code>。</p><p>我们可以说是工厂实例化了类型的一个对象，就像在基于类的 OO 语言中那样。</p><p>如果想知道结构体类型 <code>T</code> 的一个实例占用了多少内存，可以使用：<code>size := unsafe.Sizeof(T{})</code>。</p><p><strong>如何强制使用工厂方法</strong></p><p>通过应用可见性规则参考 <a href="">4.2.1节</a>、<a href="">9.5 节</a> 就可以禁止使用 <code>new()</code> 函数，强制用户使用工厂方法，从而使类型变成私有的，就像在面向对象语言中那样。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> matrix <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewMatrix</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span> <span class="token operator">*</span>matrix <span class="token punctuation">{</span>
    m <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>matrix<span class="token punctuation">)</span> <span class="token comment">// 初始化 m</span>
    <span class="token keyword">return</span> m
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在其他包里使用工厂方法：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token string">&quot;matrix&quot;</span>
<span class="token operator">...</span>
wrong <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>matrix<span class="token punctuation">.</span>matrix<span class="token punctuation">)</span>     <span class="token comment">// 编译失败（matrix 是私有的）</span>
right <span class="token operator">:=</span> matrix<span class="token punctuation">.</span><span class="token function">NewMatrix</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>  <span class="token comment">// 实例化 matrix 的唯一方式</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-2-2-map-和-struct-vs-new-和-make" tabindex="-1"><a class="header-anchor" href="#_10-2-2-map-和-struct-vs-new-和-make" aria-hidden="true">#</a> 10.2.2 map 和 struct vs new() 和 make()</h4><p><code>new()</code> 和 <code>make()</code> 这两个内置函数已经在第 <a href="">7.2.4</a> 节通过切片的例子说明过一次。</p><p>现在为止我们已经见到了可以使用 <code>make()</code> 的三种类型中的其中两个：</p><pre><code>slices  /  maps / channels（见第 14 章）
</code></pre><p>下面的例子说明了在映射上使用 <code>new()</code> 和 <code>make()</code> 的区别以及可能发生的错误：</p><p>示例 10.4 <a href="examples/chapter_10/new_make.go">new_make.go</a>（不能编译）</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">type</span> Foo <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span>
<span class="token keyword">type</span> Bar <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    thingOne <span class="token builtin">string</span>
    thingTwo <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// OK</span>
    y <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>Bar<span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>y<span class="token punctuation">)</span><span class="token punctuation">.</span>thingOne <span class="token operator">=</span> <span class="token string">&quot;hello&quot;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>y<span class="token punctuation">)</span><span class="token punctuation">.</span>thingTwo <span class="token operator">=</span> <span class="token number">1</span>

    <span class="token comment">// NOT OK</span>
    z <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span>Bar<span class="token punctuation">)</span> <span class="token comment">// 编译错误：cannot make type Bar</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>z<span class="token punctuation">)</span><span class="token punctuation">.</span>thingOne <span class="token operator">=</span> <span class="token string">&quot;hello&quot;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>z<span class="token punctuation">)</span><span class="token punctuation">.</span>thingTwo <span class="token operator">=</span> <span class="token number">1</span>

    <span class="token comment">// OK</span>
    x <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span>Foo<span class="token punctuation">)</span>
    x<span class="token punctuation">[</span><span class="token string">&quot;x&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;goodbye&quot;</span>
    x<span class="token punctuation">[</span><span class="token string">&quot;y&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;world&quot;</span>

    <span class="token comment">// NOT OK</span>
    u <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>Foo<span class="token punctuation">)</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>u<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">&quot;x&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;goodbye&quot;</span> <span class="token comment">// 运行时错误!! panic: assignment to entry in nil map</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>u<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">&quot;y&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;world&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>试图 <code>make()</code> 一个结构体变量，会引发一个编译错误，这还不是太糟糕，但是 <code>new()</code> 一个 <code>map</code> 并试图向其填充数据，将会引发运行时错误！ 因为 <code>new(Foo)</code> 返回的是一个指向 <code>nil</code> 的指针，它尚未被分配内存。所以在使用 <code>map</code> 时要特别谨慎。</p><h3 id="_10-3-使用自定义包中的结构体" tabindex="-1"><a class="header-anchor" href="#_10-3-使用自定义包中的结构体" aria-hidden="true">#</a> 10.3 使用自定义包中的结构体</h3><p>下面的例子中，main.go 使用了一个结构体，它来自 struct_pack 下的包 <code>structPack</code>。</p><p>示例 10.5 <a href="examples/chapter_10/struct_pack/structPack.go">structPack.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> structPack

<span class="token keyword">type</span> ExpStruct <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Mi1 <span class="token builtin">int</span>
    Mf1 <span class="token builtin">float32</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>示例 10.6 <a href="examples/chapter_10/main.go">main.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;fmt&quot;</span>
    <span class="token string">&quot;./struct_pack/structPack&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    struct1 <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>structPack<span class="token punctuation">.</span>ExpStruct<span class="token punctuation">)</span>
    struct1<span class="token punctuation">.</span>Mi1 <span class="token operator">=</span> <span class="token number">10</span>
    struct1<span class="token punctuation">.</span>Mf1 <span class="token operator">=</span> <span class="token number">16.</span>

    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Mi1 = %d\\n&quot;</span><span class="token punctuation">,</span> struct1<span class="token punctuation">.</span>Mi1<span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Mf1 = %f\\n&quot;</span><span class="token punctuation">,</span> struct1<span class="token punctuation">.</span>Mf1<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>Mi1 = 10
Mf1 = 16.000000
</code></pre><h3 id="_10-4-带标签的结构体" tabindex="-1"><a class="header-anchor" href="#_10-4-带标签的结构体" aria-hidden="true">#</a> 10.4 带标签的结构体</h3><p>结构体中的字段除了有名字和类型外，还可以有一个可选的标签 (tag)：它是一个附属于字段的字符串，可以是文档或其他的重要标记。标签的内容不可以在一般的编程中使用，只有包 <code>reflect</code> 能获取它。我们将在下一章（<a href="">第 11.10 节</a>中深入的探讨 <code>reflect</code> 包，它可以在运行时自省类型、属性和方法，比如：在一个变量上调用 <code>reflect.TypeOf()</code> 可以获取变量的正确类型，如果变量是一个结构体类型，就可以通过 Field 来索引结构体的字段，然后就可以使用 Tag 属性。</p><p>示例 10.7 <a href="examples/chapter_10/struct_tag.go">struct_tag.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;reflect&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> TagType <span class="token keyword">struct</span> <span class="token punctuation">{</span> <span class="token comment">// tags</span>
	field1 <span class="token builtin">bool</span>   <span class="token string">&quot;An important answer&quot;</span>
	field2 <span class="token builtin">string</span> <span class="token string">&quot;The name of the thing&quot;</span>
	field3 <span class="token builtin">int</span>    <span class="token string">&quot;How much there are&quot;</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	tt <span class="token operator">:=</span> TagType<span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">&quot;Barak Obama&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token function">refTag</span><span class="token punctuation">(</span>tt<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">refTag</span><span class="token punctuation">(</span>tt TagType<span class="token punctuation">,</span> ix <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ttType <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>tt<span class="token punctuation">)</span>
	ixField <span class="token operator">:=</span> ttType<span class="token punctuation">.</span><span class="token function">Field</span><span class="token punctuation">(</span>ix<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%v\\n&quot;</span><span class="token punctuation">,</span> ixField<span class="token punctuation">.</span>Tag<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>An important answer
The name of the thing
How much there are
</code></pre><h3 id="_10-5-匿名字段和内嵌结构体" tabindex="-1"><a class="header-anchor" href="#_10-5-匿名字段和内嵌结构体" aria-hidden="true">#</a> 10.5 匿名字段和内嵌结构体</h3><h4 id="_10-5-1-定义" tabindex="-1"><a class="header-anchor" href="#_10-5-1-定义" aria-hidden="true">#</a> 10.5.1 定义</h4><p>结构体可以包含一个或多个 <strong>匿名（或内嵌）字段</strong>，即这些字段没有显式的名字，只有字段的类型是必须的，此时类型就是字段的名字。匿名字段本身可以是一个结构体类型，即 <strong>结构体可以包含内嵌结构体</strong>。</p><p>可以粗略地将这个和面向对象语言中的继承概念相比较，随后将会看到它被用来模拟类似继承的行为。Go 语言中的继承是通过内嵌或组合来实现的，所以可以说，在 Go 语言中，相比较于继承，组合更受青睐。</p><p>考虑如下的程序：</p><p>示例 10.8 <a href="examples/chapter_10/structs_anonymous_fields.go">structs_anonymous_fields.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">type</span> innerS <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	in1 <span class="token builtin">int</span>
	in2 <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> outerS <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	b    <span class="token builtin">int</span>
	c    <span class="token builtin">float32</span>
	<span class="token builtin">int</span>  <span class="token comment">// anonymous field</span>
	innerS <span class="token comment">//anonymous field</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	outer <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>outerS<span class="token punctuation">)</span>
	outer<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token number">6</span>
	outer<span class="token punctuation">.</span>c <span class="token operator">=</span> <span class="token number">7.5</span>
	outer<span class="token punctuation">.</span><span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">60</span>
	outer<span class="token punctuation">.</span>in1 <span class="token operator">=</span> <span class="token number">5</span>
	outer<span class="token punctuation">.</span>in2 <span class="token operator">=</span> <span class="token number">10</span>

	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;outer.b is: %d\\n&quot;</span><span class="token punctuation">,</span> outer<span class="token punctuation">.</span>b<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;outer.c is: %f\\n&quot;</span><span class="token punctuation">,</span> outer<span class="token punctuation">.</span>c<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;outer.int is: %d\\n&quot;</span><span class="token punctuation">,</span> outer<span class="token punctuation">.</span><span class="token builtin">int</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;outer.in1 is: %d\\n&quot;</span><span class="token punctuation">,</span> outer<span class="token punctuation">.</span>in1<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;outer.in2 is: %d\\n&quot;</span><span class="token punctuation">,</span> outer<span class="token punctuation">.</span>in2<span class="token punctuation">)</span>

	<span class="token comment">// 使用结构体字面量</span>
	outer2 <span class="token operator">:=</span> outerS<span class="token punctuation">{</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7.5</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> innerS<span class="token punctuation">{</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;outer2 is:&quot;</span><span class="token punctuation">,</span> outer2<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>outer.b is: 6
outer.c is: 7.500000
outer.int is: 60
outer.in1 is: 5
outer.in2 is: 10
outer2 is:{6 7.5 60 {5 10}}
</code></pre><p>通过类型 <code>outer.int</code> 的名字来获取存储在匿名字段中的数据，于是可以得出一个结论：在一个结构体中对于每一种数据类型只能有一个匿名字段。</p><h4 id="_10-5-2-内嵌结构体" tabindex="-1"><a class="header-anchor" href="#_10-5-2-内嵌结构体" aria-hidden="true">#</a> 10.5.2 内嵌结构体</h4><p>同样地结构体也是一种数据类型，所以它也可以作为一个匿名字段来使用，如同上面例子中那样。外层结构体通过 <code>outer.in1</code> 直接进入内层结构体的字段，内嵌结构体甚至可以来自其他包。内层结构体被简单的插入或者内嵌进外层结构体。这个简单的“继承”机制提供了一种方式，使得可以从另外一个或一些类型继承部分或全部实现。</p><p>另外一个例子：</p><p>示例 10.9 <a href="examples/chapter_10/embedd_struct.go">embedd_struct.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">type</span> A <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	ax<span class="token punctuation">,</span> ay <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> B <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	A
	bx<span class="token punctuation">,</span> by <span class="token builtin">float32</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	b <span class="token operator">:=</span> B<span class="token punctuation">{</span>A<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3.0</span><span class="token punctuation">,</span> <span class="token number">4.0</span><span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>ax<span class="token punctuation">,</span> b<span class="token punctuation">.</span>ay<span class="token punctuation">,</span> b<span class="token punctuation">.</span>bx<span class="token punctuation">,</span> b<span class="token punctuation">.</span>by<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>A<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>1 2 3 4
{1 2}
</code></pre><p><strong>练习 10.5</strong> <a href="exercises/chapter_10/anonymous_struct.go">anonymous_struct.go</a>：</p><p>创建一个结构体，它有一个具名的 <code>float32</code> 字段，2 个匿名字段，类型分别是 <code>int</code> 和 <code>string</code>。通过结构体字面量新建一个结构体实例并打印它的内容。</p><h4 id="_10-5-3-命名冲突" tabindex="-1"><a class="header-anchor" href="#_10-5-3-命名冲突" aria-hidden="true">#</a> 10.5.3 命名冲突</h4><p>当两个字段拥有相同的名字（可能是继承来的名字）时该怎么办呢？</p><ol><li>外层名字会覆盖内层名字（但是两者的内存空间都保留），这提供了一种重载字段或方法的方式；</li><li>如果相同的名字在同一级别出现了两次，如果这个名字被程序使用了，将会引发一个错误（不使用没关系）。没有办法来解决这种问题引起的二义性，必须由程序员自己修正。</li></ol><p>例子：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> A <span class="token keyword">struct</span> <span class="token punctuation">{</span>a <span class="token builtin">int</span><span class="token punctuation">}</span>
<span class="token keyword">type</span> B <span class="token keyword">struct</span> <span class="token punctuation">{</span>a<span class="token punctuation">,</span> b <span class="token builtin">int</span><span class="token punctuation">}</span>

<span class="token keyword">type</span> C <span class="token keyword">struct</span> <span class="token punctuation">{</span>A<span class="token punctuation">;</span> B<span class="token punctuation">}</span>
<span class="token keyword">var</span> c C
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>规则 2：使用 <code>c.a</code> 是错误的，到底是 <code>c.A.a</code> 还是 <code>c.B.a</code> 呢？会导致编译器错误：<strong><code>ambiguous DOT reference c.a disambiguate with either c.A.a or c.B.a</code></strong>。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> D <span class="token keyword">struct</span> <span class="token punctuation">{</span>B<span class="token punctuation">;</span> b <span class="token builtin">float32</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> d D
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>规则1：使用 <code>d.b</code> 是没问题的：它是 <code>float32</code>，而不是 <code>B</code> 的 <code>b</code>。如果想要内层的 <code>b</code> 可以通过 <code>d.B.b</code> 得到。</p><h3 id="_10-6-方法" tabindex="-1"><a class="header-anchor" href="#_10-6-方法" aria-hidden="true">#</a> 10.6 方法</h3><h4 id="_10-6-1-方法是什么" tabindex="-1"><a class="header-anchor" href="#_10-6-1-方法是什么" aria-hidden="true">#</a> 10.6.1 方法是什么</h4><p>在 Go 语言中，结构体就像是类的一种简化形式，那么面向对象程序员可能会问：类的方法在哪里呢？在 Go 中有一个概念，它和方法有着同样的名字，并且大体上意思相同：Go 方法是作用在接收者 (receiver) 上的一个函数，接收者是某种类型的变量。因此方法是一种特殊类型的函数。</p><p>接收者类型可以是（几乎）任何类型，不仅仅是结构体类型：任何类型都可以有方法，甚至可以是函数类型，可以是 <code>int</code>、<code>bool</code>、<code>string</code> 或数组的别名类型。但是接收者不能是一个接口类型（参考<a href="">第 11 章</a>），因为接口是一个抽象定义，但是方法却是具体实现；如果这样做会引发一个编译错误：<code>invalid receiver type...</code>。</p><p>最后接收者不能是一个指针类型，但是它可以是任何其他允许类型的指针。</p><p>一个类型加上它的方法等价于面向对象中的一个类。一个重要的区别是：在 Go 中，类型的代码和绑定在它上面的方法的代码可以不放置在一起，它们可以存在在不同的源文件，唯一的要求是：它们必须是同一个包的。</p><p>类型 <code>T</code>（或 <code>*T</code>）上的所有方法的集合叫做类型 <code>T</code>（或 <code>*T</code>）的方法集 (method set)。</p><p>因为方法是函数，所以同样的，不允许方法重载，即对于一个类型只能有一个给定名称的方法。但是如果基于接收者类型，是有重载的：具有同样名字的方法可以在 2 个或多个不同的接收者类型上存在，比如在同一个包里这么做是允许的：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>denseMatrix<span class="token punctuation">)</span> <span class="token function">Add</span><span class="token punctuation">(</span>b Matrix<span class="token punctuation">)</span> Matrix
<span class="token keyword">func</span> <span class="token punctuation">(</span>a <span class="token operator">*</span>sparseMatrix<span class="token punctuation">)</span> <span class="token function">Add</span><span class="token punctuation">(</span>b Matrix<span class="token punctuation">)</span> Matrix
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>别名类型没有原始类型上已经定义过的方法。</p><p>定义方法的一般格式如下：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>recv receiver_type<span class="token punctuation">)</span> <span class="token function">methodName</span><span class="token punctuation">(</span>parameter_list<span class="token punctuation">)</span> <span class="token punctuation">(</span>return_value_list<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>在方法名之前，<code>func</code> 关键字之后的括号中指定 receiver。</p><p>如果 <code>recv</code> 是 receiver 的实例，<code>Method1</code> 是它的方法名，那么方法调用遵循传统的 <code>object.name</code> 选择器符号：<code>recv.Method1()</code>。</p><p>如果 <code>recv</code> 是一个指针，Go 会自动解引用。</p><p>如果方法不需要使用 <code>recv</code> 的值，可以用 <strong>_</strong> 替换它，比如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token boolean">_</span> receiver_type<span class="token punctuation">)</span> <span class="token function">methodName</span><span class="token punctuation">(</span>parameter_list<span class="token punctuation">)</span> <span class="token punctuation">(</span>return_value_list<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>recv</code> 就像是面向对象语言中的 <code>this</code> 或 <code>self</code>，但是 Go 中并没有这两个关键字。随个人喜好，你可以使用 <code>this</code> 或 <code>self</code> 作为 receiver 的名字。下面是一个结构体上的简单方法的例子：</p><p>示例 10.10 <a href="examples/chapter_10/method1.go">method1 .go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">type</span> TwoInts <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	a <span class="token builtin">int</span>
	b <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	two1 <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>TwoInts<span class="token punctuation">)</span>
	two1<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">12</span>
	two1<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token number">10</span>

	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The sum is: %d\\n&quot;</span><span class="token punctuation">,</span> two1<span class="token punctuation">.</span><span class="token function">AddThem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Add them to the param: %d\\n&quot;</span><span class="token punctuation">,</span> two1<span class="token punctuation">.</span><span class="token function">AddToParam</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	two2 <span class="token operator">:=</span> TwoInts<span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The sum is: %d\\n&quot;</span><span class="token punctuation">,</span> two2<span class="token punctuation">.</span><span class="token function">AddThem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>tn <span class="token operator">*</span>TwoInts<span class="token punctuation">)</span> <span class="token function">AddThem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> tn<span class="token punctuation">.</span>a <span class="token operator">+</span> tn<span class="token punctuation">.</span>b
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>tn <span class="token operator">*</span>TwoInts<span class="token punctuation">)</span> <span class="token function">AddToParam</span><span class="token punctuation">(</span>param <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> tn<span class="token punctuation">.</span>a <span class="token operator">+</span> tn<span class="token punctuation">.</span>b <span class="token operator">+</span> param
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>The sum is: 22
Add them to the param: 42
The sum is: 7
</code></pre><p>下面是非结构体类型上方法的例子：</p><p>示例 10.11 <a href="examples/chapter_10/method2.go">method2.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">type</span> IntVector <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>v IntVector<span class="token punctuation">)</span> <span class="token function">Sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>s <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> x <span class="token operator">:=</span> <span class="token keyword">range</span> v <span class="token punctuation">{</span>
		s <span class="token operator">+=</span> x
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>IntVector<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">Sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 输出是6</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>练习 10.6</strong> <a href="exercises/chapter_10/employee_salary.go">employee_salary.go</a></p><p>定义结构体 <code>employee</code>，它有一个 <code>salary</code> 字段，给这个结构体定义一个方法 <code>giveRaise</code> 来按照指定的百分比增加薪水。</p><p><strong>练习 10.7</strong> <a href="exercises/chapter_10/iteration_list.go">iteration_list.go</a></p><p>下面这段代码有什么错？</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;container/list&quot;</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>list<span class="token punctuation">.</span>List<span class="token punctuation">)</span> <span class="token function">Iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	lst <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span>List<span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token operator">=</span> <span class="token keyword">range</span> lst<span class="token punctuation">.</span><span class="token function">Iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>类型和作用在它上面定义的方法必须在同一个包里定义，这就是为什么不能在 <code>int</code>、<code>float32(64)</code> 或类似这些的类型上定义方法。试图在 <code>int</code> 类型上定义方法会得到一个编译错误：</p><pre><code>cannot define new methods on non-local type int
</code></pre><p>比如想在 <code>time.Time</code> 上定义如下方法：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>t time<span class="token punctuation">.</span>Time<span class="token punctuation">)</span> <span class="token function">first3Chars</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> time<span class="token punctuation">.</span><span class="token function">LocalTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>类型在其他的，或是非本地的包里定义，在它上面定义方法都会得到和上面同样的错误。</p><p>但是有一个间接的方式：可以先定义该类型（比如：<code>int</code> 或 <code>float32(64)</code>）的别名类型，然后再为别名类型定义方法。或者像下面这样将它作为匿名类型嵌入在一个新的结构体中。当然方法只在这个别名类型上有效。</p><p>示例 10.12 <a href="examples/chapter_10/method_on_time.go">method_on_time.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> myTime <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	time<span class="token punctuation">.</span>Time <span class="token comment">//anonymous field</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>t myTime<span class="token punctuation">)</span> <span class="token function">first3Chars</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> t<span class="token punctuation">.</span>Time<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	m <span class="token operator">:=</span> myTime<span class="token punctuation">{</span>time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
	<span class="token comment">// 调用匿名 Time 上的 String 方法</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Full time now:&quot;</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">// 调用 myTime.first3Chars</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;First 3 chars:&quot;</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span><span class="token function">first3Chars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/* Output:
Full time now: Mon Oct 24 15:34:54 Romance Daylight Time 2011
First 3 chars: Mon
*/</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-6-2-函数和方法的区别" tabindex="-1"><a class="header-anchor" href="#_10-6-2-函数和方法的区别" aria-hidden="true">#</a> 10.6.2 函数和方法的区别</h4><p>函数将变量作为参数：<code>Function1(recv)</code></p><p>方法在变量上被调用：<code>recv.Method1()</code></p><p>在接收者是指针时，方法可以改变接收者的值（或状态），这点函数也可以做到（当参数作为指针传递，即通过引用调用时，函数也可以改变参数的状态）。</p><p><strong>不要忘记 <code>Method1()</code> 后边的括号 <code>()</code>，否则会引发编译器错误：<code>method recv.Method1 is not an expression, must be called</code></strong></p><p>接收者必须有一个显式的名字，这个名字必须在方法中被使用。</p><p><code>receiver_type</code> 叫做 <strong>（接收者）基本类型</strong>，这个类型必须在和方法同样的包中被声明。</p><p>在 Go 中，（接收者）类型关联的方法不写在类型结构里面，就像类那样；耦合更加宽松；类型和方法之间的关联由接收者来建立。</p><p><strong>方法没有和数据定义（结构体）混在一起：它们是正交的类型；表示（数据）和行为（方法）是独立的。</strong></p><h4 id="_10-6-3-指针或值作为接收者" tabindex="-1"><a class="header-anchor" href="#_10-6-3-指针或值作为接收者" aria-hidden="true">#</a> 10.6.3 指针或值作为接收者</h4><p>鉴于性能的原因，<code>recv</code> 最常见的是一个指向 <code>receiver_type</code> 的指针（因为我们不想要一个实例的拷贝，如果按值调用的话就会是这样），特别是在 receiver 类型是结构体时，就更是如此了。</p><p>如果想要方法改变接收者的数据，就在接收者的指针类型上定义该方法。否则，就在普通的值类型上定义方法。</p><p>下面的例子 <code>pointer_value.go</code> 作了说明：<code>change()</code>接受一个指向 <code>B</code> 的指针，并改变它内部的成员；<code>write()</code> 通过拷贝接受 <code>B</code> 的值并只输出 <code>B</code> 的内容。注意 Go 为我们做了探测工作，我们自己并没有指出是否在指针上调用方法，Go 替我们做了这些事情。<code>b1</code> 是值而 <code>b2</code> 是指针，方法都支持运行了。</p><p>示例 10.13 <a href="examples/chapter_10/pointer_value.go">pointer_value.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> B <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	thing <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>B<span class="token punctuation">)</span> <span class="token function">change</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> b<span class="token punctuation">.</span>thing <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>b B<span class="token punctuation">)</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprint</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> b1 B <span class="token comment">// b1 是值</span>
	b1<span class="token punctuation">.</span><span class="token function">change</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>b1<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	b2 <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>B<span class="token punctuation">)</span> <span class="token comment">// b2 是指针</span>
	b2<span class="token punctuation">.</span><span class="token function">change</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>b2<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 输出：
{1}
{1}
*/</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>试着在 <code>write()</code> 中改变接收者 <code>b</code> 的值：将会看到它可以正常编译，但是开始的 <code>b</code> 没有被改变。</p><p>我们知道方法将指针作为接收者不是必须的，如下面的例子，我们只是需要 <code>Point3</code> 的值来做计算：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Point3 <span class="token keyword">struct</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z <span class="token builtin">float64</span> <span class="token punctuation">}</span>
<span class="token comment">// A method on Point3</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p Point3<span class="token punctuation">)</span> <span class="token function">Abs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">float64</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> math<span class="token punctuation">.</span><span class="token function">Sqrt</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token operator">*</span>p<span class="token punctuation">.</span>x <span class="token operator">+</span> p<span class="token punctuation">.</span>y<span class="token operator">*</span>p<span class="token punctuation">.</span>y <span class="token operator">+</span> p<span class="token punctuation">.</span>z<span class="token operator">*</span>p<span class="token punctuation">.</span>z<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样做稍微有点昂贵，因为 <code>Point3</code> 是作为值传递给方法的，因此传递的是它的拷贝，这在 Go 中是合法的。也可以在指向这个类型的指针上调用此方法（会自动解引用）。</p><p>假设 <code>p3</code> 定义为一个指针：<code>p3 := &amp;Point{ 3, 4, 5}</code>。</p><p>可以使用 <code>p3.Abs()</code> 来替代 <code>(*p3).Abs()</code>。</p><p>像例子 10.10 (<a href="examples/chapter_10/method1.go">method1.go</a>) 中接收者类型是 <code>*TwoInts</code> 的方法 <code>AddThem()</code>，它能在类型 <code>TwoInts</code> 的值上被调用，这是自动间接发生的。</p><p>因此 <code>two2.AddThem</code> 可以替代 <code>(&amp;two2).AddThem()</code>。</p><p>在值和指针上调用方法：</p><p>可以有连接到类型的方法，也可以有连接到类型指针的方法。</p><p>但是这没关系：对于类型 <code>T</code>，如果在 <code>\\*T</code> 上存在方法 <code>Meth()</code>，并且 <code>t</code> 是这个类型的变量，那么 <code>t.Meth()</code> 会被自动转换为 <code>(&amp;t).Meth()</code>。</p><p><strong>指针方法和值方法都可以在指针或非指针上被调用</strong>，如下面程序所示，类型 <code>List</code> 在值上有一个方法 <code>Len()</code>，在指针上有一个方法 <code>Append()</code>，但是可以看到两个方法都可以在两种类型的变量上被调用。</p><p>示例 10.14 <a href="examples/chapter_10/methodset1.go">methodset1.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> List <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>l List<span class="token punctuation">)</span> <span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span>        <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">len</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>List<span class="token punctuation">)</span> <span class="token function">Append</span><span class="token punctuation">(</span>val <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">*</span>l <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token operator">*</span>l<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 值</span>
	<span class="token keyword">var</span> lst List
	lst<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%v (len: %d)&quot;</span><span class="token punctuation">,</span> lst<span class="token punctuation">,</span> lst<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// [1] (len: 1)</span>

	<span class="token comment">// 指针</span>
	plst <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>List<span class="token punctuation">)</span>
	plst<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%v (len: %d)&quot;</span><span class="token punctuation">,</span> plst<span class="token punctuation">,</span> plst<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// &amp;[2] (len: 1)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-6-4-方法和未导出字段" tabindex="-1"><a class="header-anchor" href="#_10-6-4-方法和未导出字段" aria-hidden="true">#</a> 10.6.4 方法和未导出字段</h4><p>考虑 <code>person2.go</code> 中的 <code>person</code> 包：类型 <code>Person</code> 被明确的导出了，但是它的字段没有被导出。例如在 <code>use_person2.go</code> 中 <code>p.firstName</code> 就是错误的。该如何在另一个程序中修改或者只是读取一个 <code>Person</code> 的名字呢？</p><p>这可以通过面向对象语言一个众所周知的技术来完成：提供 <code>getter()</code> 和 <code>setter()</code> 方法。对于 <code>setter()</code> 方法使用 <code>Set...</code> 前缀，对于 <code>getter()</code> 方法只使用成员名。</p><p>示例 10.15 <a href="examples/chapter_10/person2.go">person2.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> person

<span class="token keyword">type</span> Person <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	firstName <span class="token builtin">string</span>
	lastName  <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Person<span class="token punctuation">)</span> <span class="token function">FirstName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> p<span class="token punctuation">.</span>firstName
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Person<span class="token punctuation">)</span> <span class="token function">SetFirstName</span><span class="token punctuation">(</span>newName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	p<span class="token punctuation">.</span>firstName <span class="token operator">=</span> newName
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>示例 10.16 <a href="examples/chapter_10/use_person2.go">use_person2.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;./person&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	p <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>Person<span class="token punctuation">)</span>
	<span class="token comment">// p.firstName undefined</span>
	<span class="token comment">// (cannot refer to unexported field or method firstName)</span>
	<span class="token comment">// p.firstName = &quot;Eric&quot;</span>
	p<span class="token punctuation">.</span><span class="token function">SetFirstName</span><span class="token punctuation">(</span><span class="token string">&quot;Eric&quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">FirstName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// Output: Eric</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>并发访问对象</strong></p><p>对象的字段（属性）不应该由 2 个或 2 个以上的不同线程在同一时间去改变。如果在程序发生这种情况，为了安全并发访问，可以使用包 <code>sync</code>（参考<a href="">第 9.3 节</a>中的方法。在<a href="14.17">第 14.17 节</a>中我们会通过 goroutines 和 channels 探索另一种方式。</p><h4 id="_10-6-5-内嵌类型的方法和继承" tabindex="-1"><a class="header-anchor" href="#_10-6-5-内嵌类型的方法和继承" aria-hidden="true">#</a> 10.6.5 内嵌类型的方法和继承</h4><p>当一个匿名类型被内嵌在结构体中时，匿名类型的可见方法也同样被内嵌，这在效果上等同于外层类型 <strong>继承</strong> 了这些方法：<strong>将父类型放在子类型中来实现亚型</strong>。这个机制提供了一种简单的方式来模拟经典面向对象语言中的子类和继承相关的效果，也类似 Ruby 中的混入 (mixin)。</p><p>下面是一个示例（可以在练习 10.8 中进一步学习）：假定有一个 <code>Engine</code> 接口类型，一个 <code>Car</code> 结构体类型，它包含一个 <code>Engine</code> 类型的匿名字段：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Engine <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Car <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Engine
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们可以构建如下的代码：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Car<span class="token punctuation">)</span> <span class="token function">GoToWorkIn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// get in car</span>
	c<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// drive to work</span>
	c<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// get out of car</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下面是 <a href="examples/chapter_10/method3.go">method3.go</a> 的完整例子，它展示了内嵌结构体上的方法可以直接在外层类型的实例上调用：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;math&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Point <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	x<span class="token punctuation">,</span> y <span class="token builtin">float64</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Point<span class="token punctuation">)</span> <span class="token function">Abs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">float64</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> math<span class="token punctuation">.</span><span class="token function">Sqrt</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token operator">*</span>p<span class="token punctuation">.</span>x <span class="token operator">+</span> p<span class="token punctuation">.</span>y<span class="token operator">*</span>p<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> NamedPoint <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Point
	name <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	n <span class="token operator">:=</span> <span class="token operator">&amp;</span>NamedPoint<span class="token punctuation">{</span>Point<span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Pythagoras&quot;</span><span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span><span class="token function">Abs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 打印 5</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>内嵌将一个已存在类型的字段和方法注入到了另一个类型里：匿名字段上的方法“晋升”成为了外层类型的方法。当然类型可以有只作用于本身实例而不作用于内嵌“父”类型上的方法。</p><p>可以覆写方法（像字段一样）：和内嵌类型方法具有同样名字的外层类型的方法会覆写内嵌类型对应的方法。</p><p>在示例 10.18 <a href="examples/chapter_10/method4.go">method4.go</a> 中添加：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>n <span class="token operator">*</span>NamedPoint<span class="token punctuation">)</span> <span class="token function">Abs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">float64</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> n<span class="token punctuation">.</span>Point<span class="token punctuation">.</span><span class="token function">Abs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>现在 <code>fmt.Println(n.Abs())</code> 会打印 <code>500</code>。</p><p>因为一个结构体可以嵌入多个匿名类型，所以实际上我们可以有一个简单版本的多重继承，就像：<code>type Child struct { Father; Mother}</code>。在<a href="">第 10.6.7 节</a>中会进一步讨论这个问题。</p><p>结构体内嵌和自己在同一个包中的结构体时，可以彼此访问对方所有的字段和方法。</p><p><strong>练习 10.8</strong> <a href="exercises/chapter_10/inheritance_car.go">inheritance_car.go</a></p><p>创建一个上面 <code>Car</code> 和 <code>Engine</code> 可运行的例子，并且给 <code>Car</code> 类型一个 <code>wheelCount</code> 字段和一个 <code>numberOfWheels()</code> 方法。</p><p>创建一个 <code>Mercedes</code> 类型，它内嵌 <code>Car</code>，并新建 <code>Mercedes</code> 的一个实例，然后调用它的方法。</p><p>然后仅在 <code>Mercedes</code> 类型上创建方法 <code>sayHiToMerkel()</code> 并调用它。</p><h4 id="_10-6-6-如何在类型中嵌入功能" tabindex="-1"><a class="header-anchor" href="#_10-6-6-如何在类型中嵌入功能" aria-hidden="true">#</a> 10.6.6 如何在类型中嵌入功能</h4><p>主要有两种方法来实现在类型中嵌入功能：</p><p>A：聚合（或组合）：包含一个所需功能类型的具名字段。</p><p>B：内嵌：内嵌（匿名地）所需功能类型，像前一节 10.6.5 所演示的那样。</p><p>为了使这些概念具体化，假设有一个 <code>Customer</code> 类型，我们想让它通过 <code>Log</code> 类型来包含日志功能，<code>Log</code> 类型只是简单地包含一个累积的消息（当然它可以是复杂的）。如果想让特定类型都具备日志功能，你可以实现一个这样的 <code>Log</code> 类型，然后将它作为特定类型的一个字段，并提供 <code>Log()</code>，它返回这个日志的引用。</p><p>方式 A 可以通过如下方法实现（使用了<a href="">第 10.7 节</a>中的 <code>String()</code> 功能）：</p><p>示例 10.19 <a href="examples/chapter_10/embed_func1.go">embed_func1.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Log <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	msg <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Customer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Name <span class="token builtin">string</span>
	log  <span class="token operator">*</span>Log
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>Customer<span class="token punctuation">)</span>
	c<span class="token punctuation">.</span>Name <span class="token operator">=</span> <span class="token string">&quot;Barak Obama&quot;</span>
	c<span class="token punctuation">.</span>log <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>Log<span class="token punctuation">)</span>
	c<span class="token punctuation">.</span>log<span class="token punctuation">.</span>msg <span class="token operator">=</span> <span class="token string">&quot;1 - Yes we can!&quot;</span>
	<span class="token comment">// shorter</span>
	c <span class="token operator">=</span> <span class="token operator">&amp;</span>Customer<span class="token punctuation">{</span><span class="token string">&quot;Barak Obama&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>Log<span class="token punctuation">{</span><span class="token string">&quot;1 - Yes we can!&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
	<span class="token comment">// fmt.Println(c) &amp;{Barak Obama 1 - Yes we can!}</span>
	c<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;2 - After me the world will be a better place!&quot;</span><span class="token punctuation">)</span>
	<span class="token comment">//fmt.Println(c.log)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>Log<span class="token punctuation">)</span> <span class="token function">Add</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	l<span class="token punctuation">.</span>msg <span class="token operator">+=</span> <span class="token string">&quot;\\n&quot;</span> <span class="token operator">+</span> s
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>Log<span class="token punctuation">)</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> l<span class="token punctuation">.</span>msg
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Customer<span class="token punctuation">)</span> <span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>Log <span class="token punctuation">{</span>
	<span class="token keyword">return</span> c<span class="token punctuation">.</span>log
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>1 - Yes we can!
2 - After me the world will be a better place!
</code></pre><p>相对的方式 B 可能会像这样 (<a href="examples/chapter_10/embed_func2.go">embed_func2.go</a>)：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Log <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	msg <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Customer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Name <span class="token builtin">string</span>
	Log
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c <span class="token operator">:=</span> <span class="token operator">&amp;</span>Customer<span class="token punctuation">{</span><span class="token string">&quot;Barak Obama&quot;</span><span class="token punctuation">,</span> Log<span class="token punctuation">{</span><span class="token string">&quot;1 - Yes we can!&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
	c<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;2 - After me the world will be a better place!&quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>

<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>Log<span class="token punctuation">)</span> <span class="token function">Add</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	l<span class="token punctuation">.</span>msg <span class="token operator">+=</span> <span class="token string">&quot;\\n&quot;</span> <span class="token operator">+</span> s
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>Log<span class="token punctuation">)</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> l<span class="token punctuation">.</span>msg
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Customer<span class="token punctuation">)</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> c<span class="token punctuation">.</span>Name <span class="token operator">+</span> <span class="token string">&quot;\\nLog:&quot;</span> <span class="token operator">+</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintln</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Log<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>Barak Obama
Log:1 - Yes we can!
2 - After me the world will be a better place!
</code></pre><p>内嵌的类型不需要指针，<code>Customer</code> 也不需要 <code>Add</code> 方法，它使用 <code>Log</code> 的 <code>Add</code> 方法，<code>Customer</code> 有自己的 <code>String</code> 方法，并且在它里面调用了 <code>Log</code> 的 <code>String</code> 方法。</p><p>如果内嵌类型嵌入了其他类型，也是可以的，那些类型的方法可以直接在外层类型中使用。</p><p>因此一个好的策略是创建一些小的、可复用的类型作为一个工具箱，用于组成域类型。</p><h4 id="_10-6-7-多重继承" tabindex="-1"><a class="header-anchor" href="#_10-6-7-多重继承" aria-hidden="true">#</a> 10.6.7 多重继承</h4><p>多重继承指的是类型获得多个父类型行为的能力，它在传统的面向对象语言中通常是不被实现的（C++ 和 Python 例外）。因为在类继承层次中，多重继承会给编译器引入额外的复杂度。但是在 Go 语言中，通过在类型中嵌入所有必要的父类型，可以很简单的实现多重继承。</p><p>作为一个例子，假设有一个类型 <code>CameraPhone</code>，通过它可以 <code>Call()</code>，也可以 <code>TakeAPicture()</code>，但是第一个方法属于类型 <code>Phone</code>，第二个方法属于类型 <code>Camera</code>。</p><p>只要嵌入这两个类型就可以解决这个问题，如下所示 (<a href="examples/chapter_10/mult_inheritance.go">mult_inheritance.go</a>)：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Camera <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Camera<span class="token punctuation">)</span> <span class="token function">TakeAPicture</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token string">&quot;Click&quot;</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Phone <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Phone<span class="token punctuation">)</span> <span class="token function">Call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token string">&quot;Ring Ring&quot;</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> CameraPhone <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Camera
	Phone
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	cp <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>CameraPhone<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Our new CameraPhone exhibits multiple behaviors...&quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;It exhibits behavior of a Camera: &quot;</span><span class="token punctuation">,</span> cp<span class="token punctuation">.</span><span class="token function">TakeAPicture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;It works like a Phone too: &quot;</span><span class="token punctuation">,</span> cp<span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>Our new CameraPhone exhibits multiple behaviors...
It exhibits behavior of a Camera: Click
It works like a Phone too: Ring Ring
</code></pre><p><strong>练习 10.9</strong> <a href="exercises/chapter_10/point_methods.go">point_methods.go</a>：</p><p>从 <code>point.go</code> 开始（<a href="10.1">第 10.1 节</a>的练习）：使用方法来实现 <code>Abs()</code> 和 <code>Scale()</code>函数，<code>Point</code> 作为方法的接收者类型。也为 <code>Point3</code> 和 <code>Polar</code> 实现 <code>Abs()</code> 方法。完成了 <code>point.go</code> 中同样的事情，只是这次通过方法。</p><p><strong>练习 10.10</strong> <a href="exercises/chapter_10/inherit_methods.go">inherit_methods.go</a>：</p><p>定义一个结构体类型 <code>Base</code>，它包含一个字段 <code>id</code>，方法 <code>Id()</code> 返回 <code>id</code>，方法 <code>SetId()</code> 修改 <code>id</code>。结构体类型 <code>Person</code> 包含 <code>Base</code>，及 <code>FirstName</code> 和 <code>LastName</code> 字段。结构体类型 <code>Employee</code> 包含一个 <code>Person</code> 和 <code>salary</code> 字段。</p><p>创建一个 <code>employee</code> 实例，然后显示它的 <code>id</code>。</p><p><strong>练习 10.11</strong> <a href="exercises/chapter_10/magic.go">magic.go</a>：</p><p>首先预测一下下面程序的结果，然后动手实验下：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Base <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>Base<span class="token punctuation">)</span> <span class="token function">Magic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;base magic&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>self Base<span class="token punctuation">)</span> <span class="token function">MoreMagic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	self<span class="token punctuation">.</span><span class="token function">Magic</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	self<span class="token punctuation">.</span><span class="token function">Magic</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Voodoo <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Base
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>Voodoo<span class="token punctuation">)</span> <span class="token function">Magic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;voodoo magic&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	v <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>Voodoo<span class="token punctuation">)</span>
	v<span class="token punctuation">.</span><span class="token function">Magic</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	v<span class="token punctuation">.</span><span class="token function">MoreMagic</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_10-6-8-通用方法和方法命名" tabindex="-1"><a class="header-anchor" href="#_10-6-8-通用方法和方法命名" aria-hidden="true">#</a> 10.6.8 通用方法和方法命名</h4><p>在编程中一些基本操作会一遍又一遍的出现，比如打开 (Open)、关闭 (Close)、读 (Read)、写 (Write)、排序(Sort) 等等，并且它们都有一个大致的意思：打开 (Open)可以作用于一个文件、一个网络连接、一个数据库连接等等。具体的实现可能千差万别，但是基本的概念是一致的。在 Go 语言中，通过使用接口（参考<a href="">第 11 章</a>），标准库广泛的应用了这些规则，在标准库中这些通用方法都有一致的名字，比如 <code>Open()</code>、<code>Read()</code>、<code>Write()</code>等。想写规范的 Go 程序，就应该遵守这些约定，给方法合适的名字和签名，就像那些通用方法那样。这样做会使 Go 开发的软件更加具有一致性和可读性。比如：如果需要一个 <code>convert-to-string()</code> 方法，应该命名为 <code>String()</code>，而不是 <code>ToString()</code>（参考<a href="">第 10.7 节</a>）。</p><h4 id="_10-6-9-和其他面向对象语言比较-go-的类型和方法" tabindex="-1"><a class="header-anchor" href="#_10-6-9-和其他面向对象语言比较-go-的类型和方法" aria-hidden="true">#</a> 10.6.9 和其他面向对象语言比较 Go 的类型和方法</h4><p>在如 C++、Java、C# 和 Ruby 这样的面向对象语言中，方法在类的上下文中被定义和继承：在一个对象上调用方法时，运行时会检测类以及它的超类中是否有此方法的定义，如果没有会导致异常发生。</p><p>在 Go 语言中，这样的继承层次是完全没必要的：如果方法在此类型定义了，就可以调用它，和其他类型上是否存在这个方法没有关系。在这个意义上，Go 具有更大的灵活性。</p><p>下面的模式就很好的说明了这个问题：</p><figure><img src="`+E+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>Go 不需要一个显式的类定义，如同 Java、C++、C# 等那样，相反地，“类”是通过提供一组作用于一个共同类型的方法集来隐式定义的。类型可以是结构体或者任何用户自定义类型。</p><p>比如：我们想定义自己的 <code>Integer</code> 类型，并添加一些类似转换成字符串的方法，在 Go 中可以如下定义：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Integer <span class="token builtin">int</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token operator">*</span>Integer<span class="token punctuation">)</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span><span class="token operator">*</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 Java 或 C# 中，这个方法需要和类 <code>Integer</code> 的定义放在一起，在 Ruby 中可以直接在基本类型 <code>int</code> 上定义这个方法。</p><p><strong>总结</strong></p><p>在 Go 中，类型就是类（数据和关联的方法）。Go 不知道类似面向对象语言的类继承的概念。继承有两个好处：代码复用和多态。</p><p>在 Go 中，代码复用通过组合和委托实现，多态通过接口的使用来实现：有时这也叫 <strong>组件编程 (Component Programming)</strong>。</p><p>许多开发者说相比于类继承，Go 的接口提供了更强大、却更简单的多态行为。</p><p><strong>备注</strong></p>`,293),Ze={href:"https://github.com/losalamos/goop",target:"_blank",rel:"noopener noreferrer"},Qe=n("code",null,"goop",-1),nt=t(`<p><strong>问题 10.1</strong></p><p>我们在某个类型的变量上使用点号调用一个方法：<code>variable.method()</code>，在使用 Go 以前，在哪儿碰到过面向对象的点号？</p><p><strong>问题 10.2</strong></p><p>a）假设定义： <code>type Integer int</code>，完成 <code>get()</code> 方法的方法体: <code>func (p Integer) get() int { ... }</code>。</p><p>b）定义： <code>func f(i int) {}; var v Integer</code> ，如何就 <code>v</code> 作为参数调用f？</p><p>c）假设 <code>Integer</code> 定义为 <code>type Integer struct {n int}</code>，完成 <code>get()</code> 方法的方法体：<code>func (p Integer) get() int { ... }</code>。</p><p>d）对于新定义的 <code>Integer</code>，和 b）中同样的问题。</p><h3 id="_10-7-类型的-string-方法和格式化描述符" tabindex="-1"><a class="header-anchor" href="#_10-7-类型的-string-方法和格式化描述符" aria-hidden="true">#</a> 10.7 类型的 String() 方法和格式化描述符</h3><p>当定义了一个有很多方法的类型时，十之八九你会使用 <code>String()</code> 方法来定制类型的字符串形式的输出，换句话说：一种可阅读性和打印性的输出。如果类型定义了 <code>String()</code> 方法，它会被用在 <code>fmt.Printf()</code> 中生成默认的输出：等同于使用格式化描述符 <code>%v</code> 产生的输出。还有 <code>fmt.Print()</code> 和 <code>fmt.Println()</code> 也会自动使用 <code>String()</code> 方法。</p><p>我们使用<a href="">第 10.4 节</a>中程序的类型来进行测试：</p><p>示例 10.22 <a href="examples/chapter_10/method_string.go">method_string.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;strconv&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> TwoInts <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	a <span class="token builtin">int</span>
	b <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	two1 <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>TwoInts<span class="token punctuation">)</span>
	two1<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">12</span>
	two1<span class="token punctuation">.</span>b <span class="token operator">=</span> <span class="token number">10</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;two1 is: %v\\n&quot;</span><span class="token punctuation">,</span> two1<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;two1 is:&quot;</span><span class="token punctuation">,</span> two1<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;two1 is: %T\\n&quot;</span><span class="token punctuation">,</span> two1<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;two1 is: %#v\\n&quot;</span><span class="token punctuation">,</span> two1<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>tn <span class="token operator">*</span>TwoInts<span class="token punctuation">)</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token string">&quot;(&quot;</span> <span class="token operator">+</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>tn<span class="token punctuation">.</span>a<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>tn<span class="token punctuation">.</span>b<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>two1 is: (12/10)
two1 is: (12/10)
two1 is: *main.TwoInts
two1 is: &amp;main.TwoInts{a:12, b:10}
</code></pre><p>当你广泛使用一个自定义类型时，最好为它定义 <code>String()</code>方法。从上面的例子也可以看到，格式化描述符 <code>%T</code> 会给出类型的完全规格，<code>%#v</code> 会给出实例的完整输出，包括它的字段（在程序自动生成 <code>Go</code> 代码时也很有用）。</p><p><strong>备注</strong></p><p>不要在 <code>String()</code> 方法里面调用涉及 <code>String()</code> 方法的方法，它会导致意料之外的错误，比如下面的例子，它导致了一个无限递归调用（<code>TT.String()</code> 调用 <code>fmt.Sprintf</code>，而 <code>fmt.Sprintf</code> 又会反过来调用 <code>TT.String()</code>），很快就会导致内存溢出：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> TT <span class="token builtin">float64</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>t TT<span class="token punctuation">)</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%v&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
t<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>练习 10.12</strong> <a href="exercises/chapter_10/type_string.go">type_string.go</a></p><p>给定结构体类型 <code>T</code>:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> T <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    a <span class="token builtin">int</span>
    b <span class="token builtin">float32</span>
    c <span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>值 <code>t</code>: <code>t := &amp;T{7, -2.35, &quot;abc\\tdef&quot;}</code>。给 T 定义 <code>String()</code>，使得 <code>fmt.Printf(&quot;%v\\n&quot;, t)</code> 输出：<code>7 / -2.350000 / &quot;abc\\tdef&quot;</code>。</p><p><strong>练习 10.13</strong> <a href="exercises/chapter_10/celsius.go">celsius.go</a></p><p>为 <code>float64</code> 定义一个别名类型 <code>Celsius</code>，并给它定义 <code>String()</code>，它输出一个十进制数和 °C 表示的温度值。</p><p><strong>练习 10.14</strong> <a href="exercises/chapter_10/days.go">days.go</a></p><p>为 <code>int</code> 定义一个别名类型 <code>Day</code>，定义一个字符串数组它包含一周七天的名字，为类型 <code>Day</code> 定义 <code>String()</code> 方法，它输出星期几的名字。使用 <code>iota</code> 定义一个枚举常量用于表示一周的中每天（MO、TU...）。</p><p><strong>练习 10.15</strong> <a href="exercises/chapter_10/timezones.go">timezones.go</a></p><p>为 <code>int</code> 定义别名类型 <code>TZ</code>，定义一些常量表示时区，比如 UTC，定义一个 <code>map</code>，它将时区的缩写映射为它的全称，比如：<code>UTC -&gt; &quot;Universal Greenwich time&quot;</code>。为类型 <code>TZ</code> 定义 <code>String()</code> 方法，它输出时区的全称。</p><p><strong>练习 10.16</strong> <a href="exercises/chapter_10/stack_arr.go">stack_arr.go</a> / <a href="exercises/chapter_10/stack_struct.go">stack_struct.go</a></p><p>实现栈 (stack) 数据结构：</p><figure><img src="`+R+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>它的格子包含数据，比如整数 <code>i</code>、<code>j</code>、<code>k</code> 和 <code>l</code> 等等，格子从底部（索引 0）至顶部（索引 n）来索引。这个例子中假定 <code>n = 3</code>，那么一共有 4 个格子。</p><p>一个新栈中所有格子的值都是 <code>0</code>。</p><p>将一个新值放到栈的最顶部一个空（包括零）的格子中，这叫做 push。</p><p>获取栈的最顶部一个非空（非零）的格子的值，这叫做 pop。 现在可以理解为什么栈是一个后进先出 (LIFO) 的结构了吧。</p><p>为栈定义一个 <code>Stack</code> 类型，并为它定义 <code>Push</code> 和 <code>Pop</code> 方法，再为它定义 <code>String()</code> 方法（用于调试）输出栈的内容，比如：<code>[0:i] [1:j] [2:k] [3:l]</code>。</p><p>1）<a href="exercises/chapter_10/stack_arr.go">stack_arr.go</a>：使用长度为 4 的 int 数组作为底层数据结构。</p><p>2） <a href="exercises/chapter_10/stack_struct.go">stack_struct.go</a>：使用包含一个索引和一个 <code>int</code> 数组的结构体作为底层数据结构，索引表示第一个空闲的位置。</p><p>3）使用常量 <code>LIMIT</code> 代替上面表示元素个数的 4 重新实现上面的 1）和 2），使它们更具有一般性。</p><h3 id="_10-8-垃圾回收和-setfinalizer" tabindex="-1"><a class="header-anchor" href="#_10-8-垃圾回收和-setfinalizer" aria-hidden="true">#</a> 10.8 垃圾回收和 SetFinalizer</h3><p>Go 开发者不需要写代码来释放程序中不再使用的变量和结构占用的内存，在 Go 运行时中有一个独立的进程，即垃圾收集器 (GC)，会处理这些事情，它搜索不再使用的变量然后释放它们的内存。可以通过 <code>runtime</code> 包访问 GC 进程。</p><p>通过调用 <code>runtime.GC()</code> 函数可以显式的触发 GC，但这只在某些罕见的场景下才有用，比如当内存资源不足时调用 <code>runtime.GC()</code>，它会在此函数执行的点上立即释放一大片内存，此时程序可能会有短时的性能下降（因为 <code>GC</code> 进程在执行）。</p><p>如果想知道当前的内存状态，可以使用：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// fmt.Printf(&quot;%d\\n&quot;, runtime.MemStats.Alloc/1024)</span>
<span class="token comment">// 此处代码在 Go 1.5.1下不再有效，更正为</span>
<span class="token keyword">var</span> m runtime<span class="token punctuation">.</span>MemStats
runtime<span class="token punctuation">.</span><span class="token function">ReadMemStats</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m<span class="token punctuation">)</span>
fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d Kb\\n&quot;</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>Alloc <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,44),st={href:"http://golang.org/pkg/runtime/#MemStatsType",target:"_blank",rel:"noopener noreferrer"},at=t(`<p>如果需要在一个对象 <code>obj</code> 被从内存移除前执行一些特殊操作，比如写到日志文件中，可以通过如下方式调用函数来实现：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>runtime<span class="token punctuation">.</span><span class="token function">SetFinalizer</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>obj <span class="token operator">*</span>typeObj<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>func(obj *typeObj)</code> 需要一个 <code>typeObj</code> 类型的指针参数 <code>obj</code>，特殊操作会在它上面执行。<code>func</code> 也可以是一个匿名函数。</p><p>在对象被 GC 进程选中并从内存中移除以前，<code>SetFinalizer</code> 都不会执行，即使程序正常结束或者发生错误。</p><p><strong>练习 10.17</strong> <a href="exercises/chapter_10/main_stack.go">main_stack.go</a></p><p>从练习 10.16 开始（它基于结构体实现了一个栈结构），为栈的实现 (<a href="exercises/chapter_10/stack_struct.go">stack_struct.go</a>) 创建一个单独的包 <code>stack</code>，并从 <code>main</code> 包 <code>main.stack.go</code> 中调用它。</p><h2 id="第-11-章-接口-interface-与反射-reflection" tabindex="-1"><a class="header-anchor" href="#第-11-章-接口-interface-与反射-reflection" aria-hidden="true">#</a> 第 11 章：接口 (interface) 与反射 (reflection)</h2><p>本章介绍 Go 语言中接口和反射的相关内容。</p><h1 id="_11-1-接口是什么" tabindex="-1"><a class="header-anchor" href="#_11-1-接口是什么" aria-hidden="true">#</a> 11.1 接口是什么</h1><p>Go 语言不是一种 <em>“传统”</em> 的面向对象编程语言：它里面没有类和继承的概念。</p><p>但是 Go 语言里有非常灵活的 <strong>接口</strong> 概念，通过它可以实现很多面向对象的特性。接口提供了一种方式来 <strong>说明</strong> 对象的行为：如果谁能搞定这件事，它就可以用在这儿。</p><p>接口定义了一组方法（方法集），但是这些方法不包含（实现）代码：它们没有被实现（它们是抽象的）。接口里也不能包含变量。</p><p>通过如下格式定义接口：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Namer <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">Method1</span><span class="token punctuation">(</span>param_list<span class="token punctuation">)</span> return_type
    <span class="token function">Method2</span><span class="token punctuation">(</span>param_list<span class="token punctuation">)</span> return_type
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面的 <code>Namer</code> 是一个 <strong>接口类型</strong>。</p><p>（按照约定，只包含一个方法的）接口的名字由方法名加 <code>er</code> 后缀组成，例如 <code>Printer</code>、<code>Reader</code>、<code>Writer</code>、<code>Logger</code>、<code>Converter</code> 等等。还有一些不常用的方式（当后缀 <code>er</code> 不合适时），比如 <code>Recoverable</code>，此时接口名以 <code>able</code> 结尾，或者以 <code>I</code> 开头（像 <code>.NET</code> 或 <code>Java</code> 中那样）。</p><p>Go 语言中的接口都很简短，通常它们会包含 0 个、最多 3 个方法。</p><p>不像大多数面向对象编程语言，在 Go 语言中接口可以有值，一个接口类型的变量或一个 <strong>接口值</strong> ：<code>var ai Namer</code>，<code>ai</code> 是一个多字（multiword）数据结构，它的值是 <code>nil</code>。它本质上是一个指针，虽然不完全是一回事。指向接口值的指针是非法的，它们不仅一点用也没有，还会导致代码错误。</p><figure><img src="`+M+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>此处的方法指针表是通过运行时反射能力构建的。</p><p>类型（比如结构体）可以实现某个接口的方法集；这个实现可以描述为，该类型的变量上的每一个具体方法所组成的集合，包含了该接口的方法集。实现了 <code>Namer</code> 接口的类型的变量可以赋值给 <code>ai</code>（即 <code>receiver</code> 的值），方法表指针（method table ptr）就指向了当前的方法实现。当另一个实现了 <code>Namer</code> 接口的类型的变量被赋给 <code>ai</code>，<code>receiver</code> 的值和方法表指针也会相应改变。</p><p><strong>类型不需要显式声明它实现了某个接口：接口被隐式地实现。多个类型可以实现同一个接口</strong>。</p><p><strong>实现某个接口的类型（除了实现接口方法外）可以有其他的方法</strong>。</p><p><strong>一个类型可以实现多个接口</strong>。</p><p><strong>接口类型可以包含一个实例的引用， 该实例的类型实现了此接口（接口是动态类型）</strong>。</p><p>即使接口在类型之后才定义，二者处于不同的包中，被单独编译：只要类型实现了接口中的方法，它就实现了此接口。</p><p>所有这些特性使得接口具有很大的灵活性。</p><p>第一个例子：</p><p>示例 11.1 <a href="examples/chapter_11/interfaces.go">interfaces.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">type</span> Shaper <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Area</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">float32</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Square <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	side <span class="token builtin">float32</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>sq <span class="token operator">*</span>Square<span class="token punctuation">)</span> <span class="token function">Area</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">float32</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> sq<span class="token punctuation">.</span>side <span class="token operator">*</span> sq<span class="token punctuation">.</span>side
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	sq1 <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>Square<span class="token punctuation">)</span>
	sq1<span class="token punctuation">.</span>side <span class="token operator">=</span> <span class="token number">5</span>

	<span class="token keyword">var</span> areaIntf Shaper
	areaIntf <span class="token operator">=</span> sq1
	<span class="token comment">// shorter,without separate declaration:</span>
	<span class="token comment">// areaIntf := Shaper(sq1)</span>
	<span class="token comment">// or even:</span>
	<span class="token comment">// areaIntf := sq1</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The square has area: %f\\n&quot;</span><span class="token punctuation">,</span> areaIntf<span class="token punctuation">.</span><span class="token function">Area</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>The square has area: 25.000000
</code></pre><p>上面的程序定义了一个结构体 <code>Square</code> 和一个接口 <code>Shaper</code>，接口有一个方法 <code>Area()</code>。</p><p>在 <code>main()</code> 方法中创建了一个 <code>Square</code> 的实例。在主程序外边定义了一个接收者类型是 <code>Square</code> 方法的 <code>Area()</code>，用来计算正方形的面积：结构体 <code>Square</code> 实现了接口 <code>Shaper</code> 。</p><p>所以可以将一个 <code>Square</code> 类型的变量赋值给一个接口类型的变量：<code>areaIntf = sq1</code> 。</p><p>现在接口变量包含一个指向 <code>Square</code> 变量的引用，通过它可以调用 <code>Square</code> 上的方法 <code>Area()</code>。当然也可以直接在 <code>Square</code> 的实例上调用此方法，但是在接口实例上调用此方法更令人兴奋，它使此方法更具有一般性。接口变量里包含了接收者实例的值和指向对应方法表的指针。</p><p>这是 <strong>多态</strong> 的 Go 版本，多态是面向对象编程中一个广为人知的概念：根据当前的类型选择正确的方法，或者说：同一种类型在不同的实例上似乎表现出不同的行为。</p><p>如果 <code>Square</code> 没有实现 <code>Area()</code> 方法，编译器将会给出清晰的错误信息：</p><pre><code>cannot use sq1 (type *Square) as type Shaper in assignment:
*Square does not implement Shaper (missing Area method)
</code></pre><p>如果 <code>Shaper</code> 有另外一个方法 <code>Perimeter()</code>，但是 <code>Square</code> 没有实现它，即使没有人在 <code>Square</code> 实例上调用这个方法，编译器也会给出上面同样的错误。</p><p>扩展一下上面的例子，类型 <code>Rectangle</code> 也实现了 <code>Shaper</code> 接口。接着创建一个 <code>Shaper</code> 类型的数组，迭代它的每一个元素并在上面调用 <code>Area()</code> 方法，以此来展示多态行为：</p><p>示例 11.2 <a href="examples/chapter_11/interfaces_poly.go">interfaces_poly.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">type</span> Shaper <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Area</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">float32</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Square <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	side <span class="token builtin">float32</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>sq <span class="token operator">*</span>Square<span class="token punctuation">)</span> <span class="token function">Area</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">float32</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> sq<span class="token punctuation">.</span>side <span class="token operator">*</span> sq<span class="token punctuation">.</span>side
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Rectangle <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	length<span class="token punctuation">,</span> width <span class="token builtin">float32</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r Rectangle<span class="token punctuation">)</span> <span class="token function">Area</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">float32</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> r<span class="token punctuation">.</span>length <span class="token operator">*</span> r<span class="token punctuation">.</span>width
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

	r <span class="token operator">:=</span> Rectangle<span class="token punctuation">{</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span> <span class="token comment">// Area() of Rectangle needs a value</span>
	q <span class="token operator">:=</span> <span class="token operator">&amp;</span>Square<span class="token punctuation">{</span><span class="token number">5</span><span class="token punctuation">}</span>      <span class="token comment">// Area() of Square needs a pointer</span>
	<span class="token comment">// shapes := []Shaper{Shaper(r), Shaper(q)}</span>
	<span class="token comment">// or shorter</span>
	shapes <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Shaper<span class="token punctuation">{</span>r<span class="token punctuation">,</span> q<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Looping through shapes for area ...&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> n<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token keyword">range</span> shapes <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Shape details: &quot;</span><span class="token punctuation">,</span> shapes<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Area of this shape is: &quot;</span><span class="token punctuation">,</span> shapes<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Area</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>Looping through shapes for area ...
Shape details:  {5 3}
Area of this shape is:  15
Shape details:  &amp;{5}
Area of this shape is:  25
</code></pre><p>在调用 <code>shapes[n].Area()</code> 这个时，只知道 <code>shapes[n]</code> 是一个 <code>Shaper</code> 对象，最后它摇身一变成为了一个 <code>Square</code> 或 <code>Rectangle</code> 对象，并且表现出了相对应的行为。</p><p>也许从现在开始你将看到通过接口如何产生 <strong>更干净</strong>、<strong>更简单</strong> 及 <strong>更具有扩展性</strong> 的代码。在 11.12.3 中将看到在开发中为类型添加新的接口是多么的容易。</p><p>下面是一个更具体的例子：有两个类型 <code>stockPosition</code> 和 <code>car</code>，它们都有一个 <code>getValue()</code> 方法，我们可以定义一个具有此方法的接口 <code>valuable</code>。接着定义一个使用 <code>valuable</code> 类型作为参数的函数 <code>showValue()</code>，所有实现了 <code>valuable</code> 接口的类型都可以用这个函数。</p><p>示例 11.3 <a href="examples/chapter_11/valuable.go">valuable.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">type</span> stockPosition <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	ticker     <span class="token builtin">string</span>
	sharePrice <span class="token builtin">float32</span>
	count      <span class="token builtin">float32</span>
<span class="token punctuation">}</span>

<span class="token comment">/* method to determine the value of a stock position */</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s stockPosition<span class="token punctuation">)</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">float32</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> s<span class="token punctuation">.</span>sharePrice <span class="token operator">*</span> s<span class="token punctuation">.</span>count
<span class="token punctuation">}</span>

<span class="token keyword">type</span> car <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token builtin">make</span>  <span class="token builtin">string</span>
	model <span class="token builtin">string</span>
	price <span class="token builtin">float32</span>
<span class="token punctuation">}</span>

<span class="token comment">/* method to determine the value of a car */</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c car<span class="token punctuation">)</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">float32</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> c<span class="token punctuation">.</span>price
<span class="token punctuation">}</span>

<span class="token comment">/* contract that defines different things that have value */</span>
<span class="token keyword">type</span> valuable <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">float32</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">showValue</span><span class="token punctuation">(</span>asset valuable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Value of the asset is %f\\n&quot;</span><span class="token punctuation">,</span> asset<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> o valuable <span class="token operator">=</span> stockPosition<span class="token punctuation">{</span><span class="token string">&quot;GOOG&quot;</span><span class="token punctuation">,</span> <span class="token number">577.20</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">}</span>
	<span class="token function">showValue</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span>
	o <span class="token operator">=</span> car<span class="token punctuation">{</span><span class="token string">&quot;BMW&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;M3&quot;</span><span class="token punctuation">,</span> <span class="token number">66500</span><span class="token punctuation">}</span>
	<span class="token function">showValue</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>Value of the asset is 2308.800049
Value of the asset is 66500.000000
</code></pre><p><strong>一个标准库的例子</strong></p><p><code>io</code> 包里有一个接口类型 <code>Reader</code>:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Reader <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">Read</span><span class="token punctuation">(</span>p <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>定义变量 <code>r</code>：<code> var r io.Reader</code></p><p>那么就可以写如下的代码：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>	<span class="token keyword">var</span> r io<span class="token punctuation">.</span>Reader
	r <span class="token operator">=</span> os<span class="token punctuation">.</span>Stdin    <span class="token comment">// see 12.1</span>
	r <span class="token operator">=</span> bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
	r <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span>Buffer<span class="token punctuation">)</span>
	f<span class="token punctuation">,</span><span class="token boolean">_</span> <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;test.txt&quot;</span><span class="token punctuation">)</span>
	r <span class="token operator">=</span> bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面 <code>r</code> 右边的类型都实现了 <code>Read()</code> 方法，并且有相同的方法签名，<code>r</code> 的静态类型是 <code>io.Reader</code>。</p><p><strong>备注</strong></p><p>有的时候，也会以一种稍微不同的方式来使用接口这个词：从某个类型的角度来看，它的接口指的是：它的所有导出方法，只不过没有显式地为这些导出方法额外定一个接口而已。</p><p><strong>练习 11.1</strong> <a href="exercises/chapter_11/simple_interface.go">simple_interface.go</a>：</p><p>定义一个接口 <code>Simpler</code>，它有一个 <code>Get()</code> 方法和一个 <code>Set()</code>，<code>Get()</code> 返回一个整型值，<code>Set()</code> 有一个整型参数。创建一个结构体类型 <code>Simple</code> 实现这个接口。</p><p>接着定一个函数，它有一个 <code>Simpler</code> 类型的参数，调用参数的 <code>Get()</code> 和 <code>Set()</code> 方法。在 <code>main</code> 函数里调用这个函数，看看它是否可以正确运行。</p><p><strong>练习 11.2</strong> <a href="exercises/chapter_11/interfaces_poly2.go">interfaces_poly2.go</a>：</p><p>a) 扩展 <a href="exercises/chapter_11/interfaces_poly.go">interfaces_poly.go</a> 中的例子，添加一个 <code>Circle</code> 类型</p><p>b) 使用一个抽象类型 <code>Shape</code>（没有字段） 实现同样的功能，它实现接口 <code>Shaper</code>，然后在其他类型里内嵌此类型。扩展 <a href="">10.6.5</a> 中的例子来说明覆写。</p><h1 id="_11-2-接口嵌套接口" tabindex="-1"><a class="header-anchor" href="#_11-2-接口嵌套接口" aria-hidden="true">#</a> 11.2 接口嵌套接口</h1><p>一个接口可以包含一个或多个其他的接口，这相当于直接将这些内嵌接口的方法列举在外层接口中一样。</p><p>比如接口 <code>File</code> 包含了 <code>ReadWrite</code> 和 <code>Lock</code> 的所有方法，它还额外有一个 <code>Close()</code> 方法。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> ReadWrite <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">Read</span><span class="token punctuation">(</span>b Buffer<span class="token punctuation">)</span> <span class="token builtin">bool</span>
    <span class="token function">Write</span><span class="token punctuation">(</span>b Buffer<span class="token punctuation">)</span> <span class="token builtin">bool</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Lock <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> File <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    ReadWrite
    Lock
    <span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="_11-3-类型断言-如何检测和转换接口变量的类型" tabindex="-1"><a class="header-anchor" href="#_11-3-类型断言-如何检测和转换接口变量的类型" aria-hidden="true">#</a> 11.3 类型断言：如何检测和转换接口变量的类型</h1><p>一个接口类型的变量 <code>varI</code> 中可以包含任何类型的值，必须有一种方式来检测它的 <strong>动态</strong> 类型，即运行时在变量中存储的值的实际类型。在执行过程中动态类型可能会有所不同，但是它总是可以分配给接口变量本身的类型。通常我们可以使用 <strong>类型断言</strong> 来测试在某个时刻 <code>varI</code> 是否包含类型 <code>T</code> 的值：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>v <span class="token operator">:=</span> varI<span class="token punctuation">.</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span>       <span class="token comment">// unchecked type assertion</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong><code>varI</code> 必须是一个接口变量</strong>，否则编译器会报错：<code>invalid type assertion: varI.(T) (non-interface type (type of varI) on left)</code> 。</p><p>类型断言可能是无效的，虽然编译器会尽力检查转换是否有效，但是它不可能预见所有的可能性。如果转换在程序运行时失败会导致错误发生。更安全的方式是使用以下形式来进行类型断言：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> v<span class="token punctuation">,</span> ok <span class="token operator">:=</span> varI<span class="token punctuation">.</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>  <span class="token comment">// checked type assertion</span>
    <span class="token function">Process</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
    <span class="token keyword">return</span>
<span class="token punctuation">}</span>
<span class="token comment">// varI is not of type T</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果转换合法，<code>v</code> 是 <code>varI</code> 转换到类型 <code>T</code> 的值，<code>ok</code> 会是 <code>true</code>；否则 <code>v</code> 是类型 <code>T</code> 的零值，<code>ok</code> 是 <code>false</code>，也没有运行时错误发生。</p><p><strong>应该总是使用上面的方式来进行类型断言</strong>。</p><p>多数情况下，我们可能只是想在 <code>if</code> 中测试一下 <code>ok</code> 的值，此时使用以下的方法会是最方便的：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> varI<span class="token punctuation">.</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>示例 11.4 <a href="examples/chapter_11/type_interfaces.go">type_interfaces.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;math&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Square <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	side <span class="token builtin">float32</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Circle <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	radius <span class="token builtin">float32</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Shaper <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Area</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">float32</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> areaIntf Shaper
	sq1 <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>Square<span class="token punctuation">)</span>
	sq1<span class="token punctuation">.</span>side <span class="token operator">=</span> <span class="token number">5</span>

	areaIntf <span class="token operator">=</span> sq1
	<span class="token comment">// Is Square the type of areaIntf?</span>
	<span class="token keyword">if</span> t<span class="token punctuation">,</span> ok <span class="token operator">:=</span> areaIntf<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>Square<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The type of areaIntf is: %T\\n&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> u<span class="token punctuation">,</span> ok <span class="token operator">:=</span> areaIntf<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>Circle<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The type of areaIntf is: %T\\n&quot;</span><span class="token punctuation">,</span> u<span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;areaIntf does not contain a variable of type Circle&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>sq <span class="token operator">*</span>Square<span class="token punctuation">)</span> <span class="token function">Area</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">float32</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> sq<span class="token punctuation">.</span>side <span class="token operator">*</span> sq<span class="token punctuation">.</span>side
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>ci <span class="token operator">*</span>Circle<span class="token punctuation">)</span> <span class="token function">Area</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">float32</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> ci<span class="token punctuation">.</span>radius <span class="token operator">*</span> ci<span class="token punctuation">.</span>radius <span class="token operator">*</span> math<span class="token punctuation">.</span>Pi
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>The type of areaIntf is: *main.Square
areaIntf does not contain a variable of type Circle
</code></pre><p>程序中定义了一个新类型 <code>Circle</code>，它也实现了 <code>Shaper</code> 接口。 <code>if t, ok := areaIntf.(*Square); ok</code> 测试 <code>areaIntf</code> 里是否有一个包含 <code>*Square</code> 类型的变量，结果是确定的；然后我们测试它是否包含一个 <code>*Circle</code> 类型的变量，结果是否定的。</p><p><strong>备注</strong></p><p>如果忽略 <code>areaIntf.(*Square)</code> 中的 <code>*</code> 号，会导致编译错误：<code>impossible type assertion: Square does not implement Shaper (Area method has pointer receiver)</code>。</p><h1 id="_11-4-类型判断-type-switch" tabindex="-1"><a class="header-anchor" href="#_11-4-类型判断-type-switch" aria-hidden="true">#</a> 11.4 类型判断：type-switch</h1><p>接口变量的类型也可以使用一种特殊形式的 <code>switch</code> 来检测：<strong>type-switch</strong> （下面是示例 11.4 的第二部分）：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">switch</span> t <span class="token operator">:=</span> areaIntf<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">case</span> <span class="token operator">*</span>Square<span class="token punctuation">:</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Type Square %T with value %v\\n&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">,</span> t<span class="token punctuation">)</span>
<span class="token keyword">case</span> <span class="token operator">*</span>Circle<span class="token punctuation">:</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Type Circle %T with value %v\\n&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">,</span> t<span class="token punctuation">)</span>
<span class="token keyword">case</span> <span class="token boolean">nil</span><span class="token punctuation">:</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;nil value: nothing to check?\\n&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">default</span><span class="token punctuation">:</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Unexpected type %T\\n&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>Type Square *main.Square with value &amp;{5}
</code></pre><p>变量 <code>t</code> 得到了 <code>areaIntf</code> 的值和类型，所有 <code>case</code> 语句中列举的类型（<code>nil</code> 除外）都必须实现对应的接口（在上例中即 <code>Shaper</code>），如果被检测类型没有在 <code>case</code> 语句列举的类型中，就会执行 <code>default</code> 语句。</p><p>可以用 <code>type-switch</code> 进行运行时类型分析，但是在 <code>type-switch</code> 不允许有 <code>fallthrough</code> 。</p><p>如果仅仅是测试变量的类型，不用它的值，那么就可以不需要赋值语句，比如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">switch</span> areaIntf<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">case</span> <span class="token operator">*</span>Square<span class="token punctuation">:</span>
	<span class="token comment">// TODO</span>
<span class="token keyword">case</span> <span class="token operator">*</span>Circle<span class="token punctuation">:</span>
	<span class="token comment">// TODO</span>
<span class="token operator">...</span>
<span class="token keyword">default</span><span class="token punctuation">:</span>
	<span class="token comment">// TODO</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下面的代码片段展示了一个类型分类函数，它有一个可变长度参数，可以是任意类型的数组，它会根据数组元素的实际类型执行不同的动作：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">classifier</span><span class="token punctuation">(</span>items <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i<span class="token punctuation">,</span> x <span class="token operator">:=</span> <span class="token keyword">range</span> items <span class="token punctuation">{</span>
		<span class="token keyword">switch</span> x<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Param #%d is a bool\\n&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token builtin">float64</span><span class="token punctuation">:</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Param #%d is a float64\\n&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">int64</span><span class="token punctuation">:</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Param #%d is a int\\n&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token boolean">nil</span><span class="token punctuation">:</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Param #%d is a nil\\n&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token builtin">string</span><span class="token punctuation">:</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Param #%d is a string\\n&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Param #%d is unknown\\n&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以这样调用此方法：<code>classifier(13, -14.3, &quot;BELGIUM&quot;, complex(1, 2), nil, false)</code> 。</p><p>在处理来自于外部的、类型未知的数据时，比如解析诸如 JSON 或 XML 编码的数据，类型测试和转换会非常有用。</p><p>在示例 12.17 (<a href="examples/chapter_12/xml.go">xml.go</a>) 中解析 XML 文档时，我们就会用到 <code>type-switch</code>。</p><p><strong>练习 11.4</strong> <a href="exercises/chapter_11/simple_interface2.go">simple_interface2.go</a>：</p><p>接着练习 11.1 中的内容，创建第二个类型 <code>RSimple</code>，它也实现了接口 <code>Simpler</code>，写一个函数 <code>fi()</code>，使它可以区分 <code>Simple</code> 和 <code>RSimple</code> 类型的变量。</p><h1 id="_11-5-测试一个值是否实现了某个接口" tabindex="-1"><a class="header-anchor" href="#_11-5-测试一个值是否实现了某个接口" aria-hidden="true">#</a> 11.5 测试一个值是否实现了某个接口</h1><p>这是 11.3 类型断言中的一个特例：假定 <code>v</code> 是一个值，然后我们想测试它是否实现了 <code>Stringer</code> 接口，可以这样做：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Stringer <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> sv<span class="token punctuation">,</span> ok <span class="token operator">:=</span> v<span class="token punctuation">.</span><span class="token punctuation">(</span>Stringer<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;v implements String(): %s\\n&quot;</span><span class="token punctuation">,</span> sv<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// note: sv, not v</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>Print()</code> 函数就是如此检测类型是否可以打印自身的。</p><p>接口是一种契约，实现类型必须满足它，它描述了类型的行为，规定类型可以做什么。接口彻底将类型能做什么，以及如何做分离开来，使得相同接口的变量在不同的时刻表现出不同的行为，这就是多态的本质。</p><p>编写参数是接口变量的函数，这使得它们更具有一般性。</p><p><strong>使用接口使代码更具有普适性。</strong></p><p>标准库里到处都使用了这个原则，如果对接口概念没有良好的把握，是不可能理解它是如何构建的。</p><p>在接下来的章节中，我们会讨论两个重要的例子，试着去深入理解它们，这样你就可以更好的应用上面的原则。</p><h1 id="_11-6-使用方法集与接口" tabindex="-1"><a class="header-anchor" href="#_11-6-使用方法集与接口" aria-hidden="true">#</a> 11.6 使用方法集与接口</h1><p>在<a href="">第 10.6.3 节</a>及例子 <a href="examples%5Cchapter_10%5Cmethodset1.go">methodset1.go</a> 中我们看到，作用于变量上的方法实际上是不区分变量到底是指针还是值的。当碰到接口类型值时，这会变得有点复杂，原因是接口变量中存储的具体值是不可寻址的，幸运的是，如果使用不当编译器会给出错误。考虑下面的程序：</p><p>示例 11.5 <a href="examples/chapter_11/methodset2.go">methodset2.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> List <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>l List<span class="token punctuation">)</span> <span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">len</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>List<span class="token punctuation">)</span> <span class="token function">Append</span><span class="token punctuation">(</span>val <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">*</span>l <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token operator">*</span>l<span class="token punctuation">,</span> val<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Appender <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Append</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">CountInto</span><span class="token punctuation">(</span>a Appender<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> start<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> end<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		a<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Lener <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">LongEnough</span><span class="token punctuation">(</span>l Lener<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> l<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">10</span> <span class="token operator">&gt;</span> <span class="token number">42</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// A bare value</span>
	<span class="token keyword">var</span> lst List
	<span class="token comment">// compiler error:</span>
	<span class="token comment">// cannot use lst (type List) as type Appender in argument to CountInto:</span>
	<span class="token comment">//       List does not implement Appender (Append method has pointer receiver)</span>
	<span class="token comment">// CountInto(lst, 1, 10)</span>
	<span class="token keyword">if</span> <span class="token function">LongEnough</span><span class="token punctuation">(</span>lst<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// VALID: Identical receiver type</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;- lst is long enough\\n&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// A pointer value</span>
	plst <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>List<span class="token punctuation">)</span>
	<span class="token function">CountInto</span><span class="token punctuation">(</span>plst<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment">// VALID: Identical receiver type</span>
	<span class="token keyword">if</span> <span class="token function">LongEnough</span><span class="token punctuation">(</span>plst<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// VALID: a *List can be dereferenced for the receiver</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;- plst is long enough\\n&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>讨论</strong></p><p>在 <code>lst</code> 上调用 <code>CountInto</code> 时会导致一个编译器错误，因为 <code>CountInto</code> 需要一个 <code>Appender</code>，而它的方法 <code>Append</code> 只定义在指针上。 在 <code>lst</code> 上调用 <code>LongEnough</code> 是可以的，因为 <code>Len</code> 定义在值上。</p><p>在 <code>plst</code> 上调用 <code>CountInto</code> 是可以的，因为 <code>CountInto</code> 需要一个 <code>Appender</code>，并且它的方法 <code>Append</code> 定义在指针上。 在 <code>plst</code> 上调用 <code>LongEnough</code> 也是可以的，因为指针会被自动解引用。</p><p><strong>总结</strong></p><p>在接口上调用方法时，必须有和方法定义时相同的接收者类型或者是可以根据具体类型 <code>P</code> 直接辨识的：</p><ul><li>指针方法可以通过指针调用</li><li>值方法可以通过值调用</li><li>接收者是值的方法可以通过指针调用，因为指针会首先被解引用</li><li>接收者是指针的方法不可以通过值调用，因为存储在接口中的值没有地址</li></ul><p>将一个值赋值给一个接口时，编译器会确保所有可能的接口方法都可以在此值上被调用，因此不正确的赋值在编译期就会失败。</p><p><strong>译注</strong></p><p>Go 语言规范定义了接口方法集的调用规则：</p><ul><li>类型 <code>*T</code> 的可调用方法集包含接受者为 <code>*T</code> 或 <code>T</code> 的所有方法集</li><li>类型 <code>T</code> 的可调用方法集包含接受者为 <code>T</code> 的所有方法</li><li>类型 <code>T</code> 的可调用方法集<strong>不</strong>包含接受者为 <code>*T</code> 的方法</li></ul><h1 id="_11-7-第一个例子-使用-sorter-接口排序" tabindex="-1"><a class="header-anchor" href="#_11-7-第一个例子-使用-sorter-接口排序" aria-hidden="true">#</a> 11.7 第一个例子：使用 Sorter 接口排序</h1><p>一个很好的例子是来自标准库的 <code>sort</code> 包，要对一组数字或字符串排序，只需要实现三个方法：反映元素个数的 <code>Len()</code> 方法、比较第 <code>i</code> 和 <code>j</code> 个元素的 <code>Less(i, j)</code> 方法以及交换第 <code>i</code> 和 <code>j</code> 个元素的 <code>Swap(i, j)</code> 方法。</p><p>排序函数的算法只会使用到这三个方法（可以使用任何排序算法来实现，此处我们使用冒泡排序）：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Sort</span><span class="token punctuation">(</span>data Sorter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> pass <span class="token operator">:=</span> <span class="token number">1</span><span class="token punctuation">;</span> pass <span class="token operator">&lt;</span> data<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> pass<span class="token operator">++</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> data<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> pass<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> data<span class="token punctuation">.</span><span class="token function">Less</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                data<span class="token punctuation">.</span><span class="token function">Swap</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>Sort</code> 函数接收一个接口类型的参数：<code>Sorter</code> ，它声明了这些方法：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Sorter <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span>
    <span class="token function">Less</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
    <span class="token function">Swap</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token builtin">int</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>参数中的 <code>int</code> 是待排序序列长度的类型，而不是说要排序的对象一定要是一组 <code>int</code>。<code>i</code> 和 <code>j</code> 表示元素的整型索引，长度也是整型的。</p><p>现在如果我们想对一个 <code>int</code> 数组进行排序，所有必须做的事情就是：为数组定一个类型并在它上面实现 <code>Sorter</code> 接口的方法：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> IntArray <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p IntArray<span class="token punctuation">)</span> <span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span>           <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">len</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p IntArray<span class="token punctuation">)</span> <span class="token function">Less</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> p<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;</span> p<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p IntArray<span class="token punctuation">)</span> <span class="token function">Swap</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token builtin">int</span><span class="token punctuation">)</span>      <span class="token punctuation">{</span> p<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下面是调用排序函数的一个具体例子：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>data <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">74</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">,</span> <span class="token number">238</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">784</span><span class="token punctuation">,</span> <span class="token number">9845</span><span class="token punctuation">,</span> <span class="token number">959</span><span class="token punctuation">,</span> <span class="token number">905</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">,</span> <span class="token number">7586</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">5467984</span><span class="token punctuation">,</span> <span class="token number">7586</span><span class="token punctuation">}</span>
a <span class="token operator">:=</span> sort<span class="token punctuation">.</span><span class="token function">IntArray</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token comment">//conversion to type IntArray from package sort</span>
sort<span class="token punctuation">.</span><span class="token function">Sort</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>完整的、可运行的代码可以在 <a href="examples/chapter_11/sort/sort.go">sort.go</a> 和 <a href="examples/chapter_11/sortmain.go">sortmain.go</a> 里找到。</p><p>同样的原理，排序函数可以用于一个浮点型数组，一个字符串数组，或者一个表示每周各天的结构体 <code>dayArray</code>。</p><p>示例 11.6 <a href="examples/chapter_11/sort/sort.go">sort.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> sort

<span class="token keyword">type</span> Sorter <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span>
	<span class="token function">Less</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
	<span class="token function">Swap</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token builtin">int</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Sort</span><span class="token punctuation">(</span>data Sorter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> pass <span class="token operator">:=</span> <span class="token number">1</span><span class="token punctuation">;</span> pass <span class="token operator">&lt;</span> data<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> pass<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> data<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>pass<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> data<span class="token punctuation">.</span><span class="token function">Less</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				data<span class="token punctuation">.</span><span class="token function">Swap</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">IsSorted</span><span class="token punctuation">(</span>data Sorter<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	n <span class="token operator">:=</span> data<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> data<span class="token punctuation">.</span><span class="token function">Less</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>

<span class="token comment">// Convenience types for common cases</span>
<span class="token keyword">type</span> IntArray <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p IntArray<span class="token punctuation">)</span> <span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span>           <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">len</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p IntArray<span class="token punctuation">)</span> <span class="token function">Less</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> p<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;</span> p<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p IntArray<span class="token punctuation">)</span> <span class="token function">Swap</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token builtin">int</span><span class="token punctuation">)</span>      <span class="token punctuation">{</span> p<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token punctuation">}</span>

<span class="token keyword">type</span> StringArray <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p StringArray<span class="token punctuation">)</span> <span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span>           <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">len</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p StringArray<span class="token punctuation">)</span> <span class="token function">Less</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> p<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;</span> p<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p StringArray<span class="token punctuation">)</span> <span class="token function">Swap</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token builtin">int</span><span class="token punctuation">)</span>      <span class="token punctuation">{</span> p<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token punctuation">}</span>

<span class="token comment">// Convenience wrappers for common cases</span>
<span class="token keyword">func</span> <span class="token function">SortInts</span><span class="token punctuation">(</span>a <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span>       <span class="token punctuation">{</span> <span class="token function">Sort</span><span class="token punctuation">(</span><span class="token function">IntArray</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">SortStrings</span><span class="token punctuation">(</span>a <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">Sort</span><span class="token punctuation">(</span><span class="token function">StringArray</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">IntsAreSorted</span><span class="token punctuation">(</span>a <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>       <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">IsSorted</span><span class="token punctuation">(</span><span class="token function">IntArray</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">StringsAreSorted</span><span class="token punctuation">(</span>a <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">IsSorted</span><span class="token punctuation">(</span><span class="token function">StringArray</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>示例 11.7 <a href="examples/chapter_11/sortmain.go">sortmain.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;./sort&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">ints</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	data <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">74</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">,</span> <span class="token number">238</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">784</span><span class="token punctuation">,</span> <span class="token number">9845</span><span class="token punctuation">,</span> <span class="token number">959</span><span class="token punctuation">,</span> <span class="token number">905</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">,</span> <span class="token number">7586</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">5467984</span><span class="token punctuation">,</span> <span class="token number">7586</span><span class="token punctuation">}</span>
	a <span class="token operator">:=</span> sort<span class="token punctuation">.</span><span class="token function">IntArray</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token comment">//conversion to type IntArray</span>
	sort<span class="token punctuation">.</span><span class="token function">Sort</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>sort<span class="token punctuation">.</span><span class="token function">IsSorted</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;fails&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The sorted array is: %v\\n&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">strings</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	data <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;monday&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;friday&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;tuesday&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;wednesday&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sunday&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;thursday&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;saturday&quot;</span><span class="token punctuation">}</span>
	a <span class="token operator">:=</span> sort<span class="token punctuation">.</span><span class="token function">StringArray</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
	sort<span class="token punctuation">.</span><span class="token function">Sort</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>sort<span class="token punctuation">.</span><span class="token function">IsSorted</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;fail&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The sorted array is: %v\\n&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> day <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	num       <span class="token builtin">int</span>
	shortName <span class="token builtin">string</span>
	longName  <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> dayArray <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>day
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>dayArray<span class="token punctuation">)</span> <span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span>           <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">len</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>dayArray<span class="token punctuation">)</span> <span class="token function">Less</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> p<span class="token punctuation">.</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>num <span class="token operator">&lt;</span> p<span class="token punctuation">.</span>data<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>num <span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>dayArray<span class="token punctuation">)</span> <span class="token function">Swap</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token builtin">int</span><span class="token punctuation">)</span>      <span class="token punctuation">{</span> p<span class="token punctuation">.</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>data<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token punctuation">.</span>data<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">days</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	Sunday    <span class="token operator">:=</span> day<span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;SUN&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Sunday&quot;</span><span class="token punctuation">}</span>
	Monday    <span class="token operator">:=</span> day<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;MON&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Monday&quot;</span><span class="token punctuation">}</span>
	Tuesday   <span class="token operator">:=</span> day<span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;TUE&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Tuesday&quot;</span><span class="token punctuation">}</span>
	Wednesday <span class="token operator">:=</span> day<span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;WED&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Wednesday&quot;</span><span class="token punctuation">}</span>
	Thursday  <span class="token operator">:=</span> day<span class="token punctuation">{</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">&quot;THU&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Thursday&quot;</span><span class="token punctuation">}</span>
	Friday    <span class="token operator">:=</span> day<span class="token punctuation">{</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">&quot;FRI&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Friday&quot;</span><span class="token punctuation">}</span>
	Saturday  <span class="token operator">:=</span> day<span class="token punctuation">{</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">&quot;SAT&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Saturday&quot;</span><span class="token punctuation">}</span>
	data <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>day<span class="token punctuation">{</span><span class="token operator">&amp;</span>Tuesday<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Thursday<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Wednesday<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Sunday<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Monday<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Friday<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Saturday<span class="token punctuation">}</span>
	a <span class="token operator">:=</span> dayArray<span class="token punctuation">{</span>data<span class="token punctuation">}</span>
	sort<span class="token punctuation">.</span><span class="token function">Sort</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>sort<span class="token punctuation">.</span><span class="token function">IsSorted</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;fail&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> d <span class="token operator">:=</span> <span class="token keyword">range</span> data <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s &quot;</span><span class="token punctuation">,</span> d<span class="token punctuation">.</span>longName<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;\\n&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">ints</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">strings</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">days</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>The sorted array is: [-5467984 -784 0 0 42 59 74 238 905 959 7586 7586 9845]
The sorted array is: [ friday monday saturday sunday thursday tuesday wednesday]
Sunday Monday Tuesday Wednesday Thursday Friday Saturday 
</code></pre><p><strong>备注</strong>：</p><p><code>panic(&quot;fail&quot;)</code> 用于停止处于在非正常情况下的程序（详细请参考<a href="">第 13 章</a>），当然也可以先打印一条信息，然后调用 <code>os.Exit(1)</code> 来停止程序。</p><p>上面的例子帮助我们进一步了解了接口的意义和使用方式。对于基本类型的排序，标准库已经提供了相关的排序函数，所以不需要我们再重复造轮子了。对于一般性的排序，<code>sort</code> 包定义了一个接口：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Interface <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span>
	<span class="token function">Less</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
	<span class="token function">Swap</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j <span class="token builtin">int</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个接口总结了需要用于排序的抽象方法，函数 <code>Sort(data Interface)</code> 用来对此类对象进行排序，可以用它们来实现对其他类型的数据（非基本类型）进行排序。在上面的例子中，我们也是这么做的，不仅可以对 <code>int</code> 和 <code>string</code> 序列进行排序，也可以对用户自定义类型 <code>dayArray</code> 进行排序。</p><p><strong>练习 11.5</strong> <a href="exercises/chapter_11/interfaces_ext.go">interfaces_ext.go</a>：</p><p>a). 继续扩展程序，定义类型 <code>Triangle</code>，让它实现 <code>AreaInterface</code> 接口。通过计算一个特定三角形的面积来进行测试（三角形面积=0.5 * (底 * 高)）</p><p>b). 定义一个新接口 <code>PeriInterface</code>，它有一个 <code>Perimeter</code> 方法。让 <code>Square</code> 实现这个接口，并通过一个 <code>Square</code> 示例来测试它。</p><p><strong>练习 11.6</strong> <a href="exercises/chapter_11/point_interfaces.go">point_interfaces.go</a>：</p><p>继续 <a href="">10.3</a> 中的练习 <a href="exercises/chapter_10/point_methods.go">point_methods.go</a>，定义接口 <code>Magnitude</code>，它有一个方法 <code>Abs()</code>。让 <code>Point</code>、<code>Point3</code> 及 <code>Polar</code> 实现此接口。通过接口类型变量使用方法做 point.go 中同样的事情。</p><p><strong>练习 11.7</strong> <a href="exercises/chapter_11/float_sort.go">float_sort.go</a> / <a href="exercises/chapter_11/float_sortmain.go">float_sortmain.go</a>：</p><p>类似 11.7 和示例 11.3/4，定义一个包 <code>float64</code>，并在包里定义类型 <code>Float64Array</code>，然后让它实现 <code>Sorter</code> 接口用来对 <code>float64</code> 数组进行排序。</p><p>另外提供如下方法：</p><ul><li><code>NewFloat64Array()</code>：创建一个包含 25 个元素的数组变量（参考 <a href="">10.2</a> ）</li><li><code>List()</code>：返回数组格式化后的字符串，并在 <code>String()</code> 方法中调用它，这样就不用显式地调用 <code>List()</code> 来打印数组（参考 <a href="">10.7</a>）</li><li><code>Fill()</code>：创建一个包含 10 个随机浮点数的数组（参考 <a href="">4.5.2.6</a>）</li></ul><p>在主程序中新建一个此类型的变量，然后对它排序并进行测试。</p><p><strong>练习 11.8</strong> <a href="exercises/chapter_11/sort/sort.go">sort.go</a> / <a href="exercises/chapter_11/sort_persons.go">sort_persons.go</a>：</p><p>定义一个结构体 <code>Person</code>，它有两个字段：<code>firstName</code> 和 <code>lastName</code>，为 <code>[]Person</code> 定义类型 <code>Persons</code> 。让 <code>Persons</code> 实现 <code>Sorter</code> 接口并进行测试。</p><h1 id="_11-8-第二个例子-读和写" tabindex="-1"><a class="header-anchor" href="#_11-8-第二个例子-读和写" aria-hidden="true">#</a> 11.8 第二个例子：读和写</h1><p>读和写是软件中很普遍的行为，提起它们会立即想到读写文件、缓存（比如字节或字符串切片）、标准输入输出、标准错误以及网络连接、管道等等，或者读写我们的自定义类型。为了让代码尽可能通用，Go 采取了一致的方式来读写数据。</p><p><code>io</code> 包提供了用于读和写的接口 <code>io.Reader</code> 和 <code>io.Writer</code>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Reader <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">Read</span><span class="token punctuation">(</span>p <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Writer <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">Write</span><span class="token punctuation">(</span>p <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>只要类型实现了读写接口，提供 <code>Read</code> 和 <code>Write</code> 方法，就可以从它读取数据，或向它写入数据。一个对象要是可读的，它必须实现 <code>io.Reader</code> 接口，这个接口只有一个签名是 <code>Read(p []byte) (n int, err error)</code> 的方法，它从调用它的对象上读取数据，并把读到的数据放入参数中的字节切片中，然后返回读取的字节数和一个 <code>error</code> 对象，如果没有错误发生返回 <code>nil</code>，如果已经到达输入的尾端，会返回 <code>io.EOF(&quot;EOF&quot;)</code>，如果读取的过程中发生了错误，就会返回具体的错误信息。类似地，一个对象要是可写的，它必须实现 <code>io.Writer</code> 接口，这个接口也只有一个签名是 <code>Write(p []byte) (n int, err error)</code> 的方法，它将指定字节切片中的数据写入调用它的对象里，然后返回实际写入的字节数和一个 <code>error</code> 对象（如果没有错误发生就是 <code>nil</code>）。</p><p><code>io</code> 包里的 <code>Readers</code> 和 <code>Writers</code> 都是不带缓冲的，<code>bufio</code> 包里提供了对应的带缓冲的操作，在读写 <code>UTF-8</code> 编码的文本文件时它们尤其有用。在<a href="">第 12 章</a>我们会看到很多在实战中使用它们的例子。</p><p>在实际编程中尽可能的使用这些接口，会使程序变得更通用，可以在任何实现了这些接口的类型上使用读写方法。</p><p>例如一个 <code>JPEG</code> 图形解码器，通过一个 <code>Reader</code> 参数，它可以解码来自磁盘、网络连接或以 <code>gzip</code> 压缩的 <code>HTTP</code> 流中的 <code>JPEG</code> 图形数据，或者其他任何实现了 <code>Reader</code> 接口的对象。</p><h1 id="_11-9-空接口" tabindex="-1"><a class="header-anchor" href="#_11-9-空接口" aria-hidden="true">#</a> 11.9 空接口</h1><h2 id="_11-9-1-概念" tabindex="-1"><a class="header-anchor" href="#_11-9-1-概念" aria-hidden="true">#</a> 11.9.1 概念</h2><p><strong>空接口或者最小接口</strong> 不包含任何方法，它对实现不做任何要求：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Any <span class="token keyword">interface</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>任何其他类型都实现了空接口（它不仅仅像 <code>Java/C#</code> 中 <code>Object</code> 引用类型），<code>any</code> 或 <code>Any</code> 是空接口一个很好的别名或缩写。</p><p>空接口类似 <code>Java/C#</code> 中所有类的基类： <code>Object</code> 类，二者的目标也很相近。</p><p>可以给一个空接口类型的变量 <code>var val interface {}</code> 赋任何类型的值。</p><p>示例 11.8 <a href="examples/chapter_11/empty_interface.go">empty_interface.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">5</span>
<span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">&quot;ABC&quot;</span>

<span class="token keyword">type</span> Person <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	name <span class="token builtin">string</span>
	age  <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Any <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> val Any
	val <span class="token operator">=</span> <span class="token number">5</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;val has the value: %v\\n&quot;</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span>
	val <span class="token operator">=</span> str
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;val has the value: %v\\n&quot;</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span>
	pers1 <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>Person<span class="token punctuation">)</span>
	pers1<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;Rob Pike&quot;</span>
	pers1<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">55</span>
	val <span class="token operator">=</span> pers1
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;val has the value: %v\\n&quot;</span><span class="token punctuation">,</span> val<span class="token punctuation">)</span>
	<span class="token keyword">switch</span> t <span class="token operator">:=</span> val<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> <span class="token builtin">int</span><span class="token punctuation">:</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Type int %T\\n&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token builtin">string</span><span class="token punctuation">:</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Type string %T\\n&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Type boolean %T\\n&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>Person<span class="token punctuation">:</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Type pointer to Person %T\\n&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Unexpected type %T&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>val has the value: 5
val has the value: ABC
val has the value: &amp;{Rob Pike 55}
Type pointer to Person *main.Person
</code></pre><p>在上面的例子中，接口变量 <code>val</code> 被依次赋予一个 <code>int</code>，<code>string</code> 和 <code>Person</code> 实例的值，然后使用 <code>type-switch</code> 来测试它的实际类型。每个 <code>interface {}</code> 变量在内存中占据两个字长：一个用来存储它包含的类型，另一个用来存储它包含的数据或者指向数据的指针。</p><p>示例 <a href="examples/chapter_11/emptyint_switch.go">emptyint_switch.go</a> 说明了空接口在 <code>type-switch</code> 中联合 <code>lambda</code> 函数的用法：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">type</span> specialString <span class="token builtin">string</span>

<span class="token keyword">var</span> whatIsThis specialString <span class="token operator">=</span> <span class="token string">&quot;hello&quot;</span>

<span class="token keyword">func</span> <span class="token function">TypeSwitch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	testFunc <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>any <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">switch</span> v <span class="token operator">:=</span> any<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;any %v is a bool type&quot;</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token builtin">int</span><span class="token punctuation">:</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;any %v is an int type&quot;</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token builtin">float32</span><span class="token punctuation">:</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;any %v is a float32 type&quot;</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token builtin">string</span><span class="token punctuation">:</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;any %v is a string type&quot;</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span>
		<span class="token keyword">case</span> specialString<span class="token punctuation">:</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;any %v is a special String!&quot;</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;unknown type!&quot;</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token function">testFunc</span><span class="token punctuation">(</span>whatIsThis<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">TypeSwitch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><pre><code>any hello is a special String!
</code></pre><p><strong>练习 11.9</strong> <a href="exercises/chapter_11/simple_interface3.go">simple_interface3.go</a>：</p><p>继续练习 11.2，在它中添加一个 <code>gI()</code> 函数，它不再接受 <code>Simpler</code> 类型的参数，而是接受一个空接口参数。然后通过类型断言判断参数是否是 <code>Simpler</code> 类型。最后在 <code>main</code> 使用 <code>gI()</code> 取代 <code>fI()</code> 函数并调用它。确保你的代码足够安全。</p><h2 id="_11-9-2-构建通用类型或包含不同类型变量的数组" tabindex="-1"><a class="header-anchor" href="#_11-9-2-构建通用类型或包含不同类型变量的数组" aria-hidden="true">#</a> 11.9.2 构建通用类型或包含不同类型变量的数组</h2><p>在 <a href="">7.6.6</a> 中我们看到了能被搜索和排序的 <code>int</code> 数组、<code>float</code> 数组以及 <code>string</code> 数组，那么对于其他类型的数组呢，是不是我们必须得自己编程实现它们？</p><p>现在我们知道该怎么做了，就是通过使用空接口。让我们给空接口定一个别名类型 <code>Element</code>：<code>type Element interface{}</code></p><p>然后定义一个容器类型的结构体 <code>Vector</code>，它包含一个 <code>Element</code> 类型元素的切片：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Vector <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	a <span class="token punctuation">[</span><span class="token punctuation">]</span>Element
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>Vector</code> 里能放任何类型的变量，因为任何类型都实现了空接口，实际上 <code>Vector</code> 里放的每个元素可以是不同类型的变量。我们为它定义一个 <code>At()</code> 方法用于返回第 <code>i</code> 个元素：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Vector<span class="token punctuation">)</span> <span class="token function">At</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> Element <span class="token punctuation">{</span>
	<span class="token keyword">return</span> p<span class="token punctuation">.</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>再定一个 <code>Set()</code> 方法用于设置第 <code>i</code> 个元素的值：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Vector<span class="token punctuation">)</span> <span class="token function">Set</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">,</span> e Element<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	p<span class="token punctuation">.</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> e
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>Vector</code> 中存储的所有元素都是 <code>Element</code> 类型，要得到它们的原始类型（unboxing：拆箱）需要用到类型断言。TODO：The compiler rejects assertions guaranteed to fail，类型断言总是在运行时才执行，因此它会产生运行时错误。</p><p><strong>练习 11.10</strong> <a href="exercises/chapter_11/min_interface.go">min_interface.go</a> / <a href="exercises/chapter_11/minmain.go">minmain.go</a>：</p><p>仿照 11.7 中开发的 <code>Sorter</code> 接口，创建一个 <code>Miner</code> 接口并实现一些必要的操作。函数 <code>Min()</code> 接受一个 <code>Miner</code> 类型变量的集合，然后计算并返回集合中最小的元素。</p><h2 id="_11-9-3-复制数据切片至空接口切片" tabindex="-1"><a class="header-anchor" href="#_11-9-3-复制数据切片至空接口切片" aria-hidden="true">#</a> 11.9.3 复制数据切片至空接口切片</h2><p>假设你有一个 <code>myType</code> 类型的数据切片，你想将切片中的数据复制到一个空接口切片中，类似：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> dataSlice <span class="token punctuation">[</span><span class="token punctuation">]</span>myType <span class="token operator">=</span> <span class="token function">FuncReturnSlice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> interfaceSlice <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token operator">=</span> dataSlice
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>可惜不能这么做，编译时会出错：<code>cannot use dataSlice (type []myType) as type []interface { } in assignment</code>。</p>`,205),et={href:"https://github.com/golang/go/wiki/InterfaceSlice",target:"_blank",rel:"noopener noreferrer"},tt=t(`<p>必须使用 <code>for-range</code> 语句来一个一个显式地赋值：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> dataSlice <span class="token punctuation">[</span><span class="token punctuation">]</span>myType <span class="token operator">=</span> <span class="token function">FuncReturnSlice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> interfaceSlice <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>dataSlice<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> d <span class="token operator">:=</span> <span class="token keyword">range</span> dataSlice <span class="token punctuation">{</span>
    interfaceSlice<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> d
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_11-9-4-通用类型的节点数据结构" tabindex="-1"><a class="header-anchor" href="#_11-9-4-通用类型的节点数据结构" aria-hidden="true">#</a> 11.9.4 通用类型的节点数据结构</h2><p>在 <a href="">10.1</a> 中我们遇到了诸如列表和树这样的数据结构，在它们的定义中使用了一种叫节点的递归结构体类型，节点包含一个某种类型的数据字段。现在可以使用空接口作为数据字段的类型，这样我们就能写出通用的代码。下面是实现一个二叉树的部分代码：通用定义、用于创建空节点的 <code>NewNode</code> 方法，及设置数据的 <code>SetData</code> 方法。</p><p>示例 11.10 <a href="examples/chapter_11/node_structures.go">node_structures.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">type</span> Node <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	le   <span class="token operator">*</span>Node
	data <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	ri   <span class="token operator">*</span>Node
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">NewNode</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> right <span class="token operator">*</span>Node<span class="token punctuation">)</span> <span class="token operator">*</span>Node <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>Node<span class="token punctuation">{</span>left<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> right<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>n <span class="token operator">*</span>Node<span class="token punctuation">)</span> <span class="token function">SetData</span><span class="token punctuation">(</span>data <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	n<span class="token punctuation">.</span>data <span class="token operator">=</span> data
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	root <span class="token operator">:=</span> <span class="token function">NewNode</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
	root<span class="token punctuation">.</span><span class="token function">SetData</span><span class="token punctuation">(</span><span class="token string">&quot;root node&quot;</span><span class="token punctuation">)</span>
	<span class="token comment">// make child (leaf) nodes:</span>
	a <span class="token operator">:=</span> <span class="token function">NewNode</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
	a<span class="token punctuation">.</span><span class="token function">SetData</span><span class="token punctuation">(</span><span class="token string">&quot;left node&quot;</span><span class="token punctuation">)</span>
	b <span class="token operator">:=</span> <span class="token function">NewNode</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
	b<span class="token punctuation">.</span><span class="token function">SetData</span><span class="token punctuation">(</span><span class="token string">&quot;right node&quot;</span><span class="token punctuation">)</span>
	root<span class="token punctuation">.</span>le <span class="token operator">=</span> a
	root<span class="token punctuation">.</span>ri <span class="token operator">=</span> b
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%v\\n&quot;</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span> <span class="token comment">// Output: &amp;{0x125275f0 root node 0x125275e0}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_11-9-5-接口到接口" tabindex="-1"><a class="header-anchor" href="#_11-9-5-接口到接口" aria-hidden="true">#</a> 11.9.5 接口到接口</h2><p>一个接口的值可以赋值给另一个接口变量，只要底层类型实现了必要的方法。这个转换是在运行时进行检查的，转换失败会导致一个运行时错误：这是 <code>Go</code> 语言动态的一面，可以拿它和 <code>Ruby</code> 和 <code>Python</code> 这些动态语言相比较。</p><p>假定：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> ai AbsInterface <span class="token comment">// declares method Abs()</span>
<span class="token keyword">type</span> SqrInterface <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">Sqr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> float
<span class="token punctuation">}</span>
<span class="token keyword">var</span> si SqrInterface
pp <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>Point<span class="token punctuation">)</span> <span class="token comment">// say *Point implements Abs, Sqr</span>
<span class="token keyword">var</span> empty <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>那么下面的语句和类型断言是合法的：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>empty <span class="token operator">=</span> pp                <span class="token comment">// everything satisfies empty</span>
ai <span class="token operator">=</span> empty<span class="token punctuation">.</span><span class="token punctuation">(</span>AbsInterface<span class="token punctuation">)</span> <span class="token comment">// underlying value pp implements Abs()</span>
<span class="token comment">// (runtime failure otherwise)</span>
si <span class="token operator">=</span> ai<span class="token punctuation">.</span><span class="token punctuation">(</span>SqrInterface<span class="token punctuation">)</span> <span class="token comment">// *Point has Sqr() even though AbsInterface doesn’t</span>
empty <span class="token operator">=</span> si             <span class="token comment">// *Point implements empty set</span>
<span class="token comment">// Note: statically checkable so type assertion not necessary.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下面是函数调用的一个例子：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> myPrintInterface <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">f3</span><span class="token punctuation">(</span>x myInterface<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	x<span class="token punctuation">.</span><span class="token punctuation">(</span>myPrintInterface<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// type assertion to myPrintInterface</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>x</code> 转换为 <code>myPrintInterface</code> 类型是完全动态的：只要 <code>x</code> 的底层类型（动态类型）定义了 <code>print</code> 方法这个调用就可以正常运行（译注：若 <code>x</code> 的底层类型未定义 <code>print</code> 方法，此处类型断言会导致 <code>panic</code>，最佳实践应该为 <code>if mpi, ok := x.(myPrintInterface); ok { mpi.print() }</code>，参考 <a href="">11.3</a> 章节）。</p><h1 id="_11-10-反射包" tabindex="-1"><a class="header-anchor" href="#_11-10-反射包" aria-hidden="true">#</a> 11.10 反射包</h1><h2 id="_11-10-1-方法和类型的反射" tabindex="-1"><a class="header-anchor" href="#_11-10-1-方法和类型的反射" aria-hidden="true">#</a> 11.10.1 方法和类型的反射</h2><p>在 <a href="">10.4</a> 节我们看到可以通过反射来分析一个结构体。本节我们进一步探讨强大的反射功能。反射是用程序检查其所拥有的结构，尤其是类型的一种能力；这是元编程的一种形式。反射可以在运行时检查类型和变量，例如：它的大小、它的方法以及它能“动态地”调用这些方法。这对于没有源代码的包尤其有用。这是一个强大的工具，除非真得有必要，否则应当避免使用或小心使用。</p><p>变量的最基本信息就是类型和值：反射包的 <code>Type</code> 用来表示一个 Go 类型，反射包的 <code>Value</code> 为 Go 值提供了反射接口。</p><p>两个简单的函数，<code>reflect.TypeOf</code> 和 <code>reflect.ValueOf</code>，返回被检查对象的类型和值。例如，x 被定义为：<code>var x float64 = 3.4</code>，那么 <code>reflect.TypeOf(x)</code> 返回 <code>float64</code>，<code>reflect.ValueOf(x)</code> 返回 <code>&lt;float64 Value&gt;</code></p><p>实际上，反射是通过检查一个接口的值，变量首先被转换成空接口。这从下面两个函数签名能够很明显的看出来：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">TypeOf</span><span class="token punctuation">(</span>i <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> Type
<span class="token keyword">func</span> <span class="token function">ValueOf</span><span class="token punctuation">(</span>i <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> Value
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>接口的值包含一个 type 和 value。</p><p>反射可以从接口值反射到对象，也可以从对象反射回接口值。</p><p><code>reflect.Type</code> 和 <code>reflect.Value</code> 都有许多方法用于检查和操作它们。一个重要的例子是 <code>Value</code> 有一个 <code>Type()</code> 方法返回 <code>reflect.Value</code> 的 <code>Type</code> 类型。另一个是 <code>Type</code> 和 <code>Value</code> 都有 <code>Kind()</code> 方法返回一个常量来表示类型：<code>Uint</code>、<code>Float64</code>、<code>Slice</code> 等等。同样 <code>Value</code> 有叫做 <code>Int()</code> 和 <code>Float()</code> 的方法可以获取存储在内部的值（跟 <code>int64</code> 和 <code>float64</code> 一样）</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">const</span> <span class="token punctuation">(</span>
	Invalid Kind <span class="token operator">=</span> <span class="token boolean">iota</span>
	Bool
	Int
	Int8
	Int16
	Int32
	Int64
	Uint
	Uint8
	Uint16
	Uint32
	Uint64
	Uintptr
	Float32
	Float64
	Complex64
	Complex128
	Array
	Chan
	Func
	Interface
	Map
	Ptr
	Slice
	String
	Struct
	UnsafePointer
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对于 <code>float64</code> 类型的变量 <code>x</code>，如果 <code>v:=reflect.ValueOf(x)</code>，那么 <code>v.Kind()</code> 返回 <code>reflect.Float64</code> ，所以下面的表达式是 <code>true</code>：<code>v.Kind() == reflect.Float64</code></p><p><code>Kind()</code> 总是返回底层类型：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> MyInt <span class="token builtin">int</span>
<span class="token keyword">var</span> m MyInt <span class="token operator">=</span> <span class="token number">5</span>
v <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>方法 <code>v.Kind()</code> 返回 <code>reflect.Int</code>。</p><p>变量 <code>v</code> 的 <code>Interface()</code> 方法可以得到还原（接口）值，所以可以这样打印 <code>v</code> 的值：<code>fmt.Println(v.Interface())</code></p><p>尝试运行下面的代码：</p><p>示例 11.11 <a href="examples/chapter_11/reflect1.go">reflect1.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// blog: Laws of Reflection</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;reflect&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> x <span class="token builtin">float64</span> <span class="token operator">=</span> <span class="token number">3.4</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;type:&quot;</span><span class="token punctuation">,</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
	v <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;value:&quot;</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;type:&quot;</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span><span class="token function">Type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;kind:&quot;</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span><span class="token function">Kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;value:&quot;</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span><span class="token function">Float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">Interface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;value is %5.2e\\n&quot;</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span><span class="token function">Interface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	y <span class="token operator">:=</span> v<span class="token punctuation">.</span><span class="token function">Interface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">float64</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>type: float64
value: 3.4
type: float64
kind: float64
value: 3.4
3.4
value is 3.40e+00
3.4
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>x</code> 是一个 <code>float64</code> 类型的值，<code>reflect.ValueOf(x).Float()</code> 返回这个 <code>float64</code> 类型的实际值；同样的适用于 <code>Int(), Bool(), Complex(), String()</code></p><h2 id="_11-10-2-通过反射修改-设置-值" tabindex="-1"><a class="header-anchor" href="#_11-10-2-通过反射修改-设置-值" aria-hidden="true">#</a> 11.10.2 通过反射修改（设置）值</h2><p>继续前面的例子（参阅 11.9 <a href="examples/chapter_11/reflect2.go">reflect2.go</a>），假设我们要把 <code>x</code> 的值改为 <code>3.1415</code>。<code>Value</code> 有一些方法可以完成这个任务，但是必须小心使用：<code>v.SetFloat(3.1415)</code>。</p><p>这将产生一个错误：<code>reflect.Value.SetFloat using unaddressable value</code>。</p><p>为什么会这样呢？问题的原因是 <code>v</code> 不是可设置的（这里并不是说值不可寻址）。是否可设置是 <code>Value</code> 的一个属性，并且不是所有的反射值都有这个属性：可以使用 <code>CanSet()</code> 方法测试是否可设置。</p><p>在例子中我们看到 <code>v.CanSet()</code> 返回 <code>false</code>： <code>settability of v: false</code></p><p>当 <code>v := reflect.ValueOf(x)</code> 函数通过传递一个 <code>x</code> 拷贝创建了 <code>v</code>，那么 <code>v</code> 的改变并不能更改原始的 <code>x</code>。要想 <code>v</code> 的更改能作用到 <code>x</code>，那就必须传递 x 的地址 <code>v = reflect.ValueOf(&amp;x)</code>。</p><p>通过 <code>Type()</code> 我们看到 <code>v</code> 现在的类型是 <code>*float64</code> 并且仍然是不可设置的。</p><p>要想让其可设置我们需要使用 <code>Elem()</code> 函数，这间接地使用指针：<code>v = v.Elem()</code></p><p>现在 <code>v.CanSet()</code> 返回 <code>true</code> 并且 <code>v.SetFloat(3.1415)</code> 设置成功了！</p><p>示例 11.12 <a href="examples/chapter_11/reflect2.go">reflect2.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;reflect&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> x <span class="token builtin">float64</span> <span class="token operator">=</span> <span class="token number">3.4</span>
	v <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
	<span class="token comment">// setting a value:</span>
	<span class="token comment">// v.SetFloat(3.1415) // Error: will panic: reflect.Value.SetFloat using unaddressable value</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;settability of v:&quot;</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span><span class="token function">CanSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	v <span class="token operator">=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>x<span class="token punctuation">)</span> <span class="token comment">// Note: take the address of x.</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;type of v:&quot;</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span><span class="token function">Type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;settability of v:&quot;</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span><span class="token function">CanSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	v <span class="token operator">=</span> v<span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;The Elem of v is: &quot;</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;settability of v:&quot;</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span><span class="token function">CanSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	v<span class="token punctuation">.</span><span class="token function">SetFloat</span><span class="token punctuation">(</span><span class="token number">3.1415</span><span class="token punctuation">)</span> <span class="token comment">// this works!</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">Interface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>settability of v: false
type of v: *float64
settability of v: false
The Elem of v is:  &lt;float64 Value&gt;
settability of v: true
3.1415
&lt;float64 Value&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>反射中有些内容是需要用地址去改变它的状态的。</p><h2 id="_11-10-3-反射结构" tabindex="-1"><a class="header-anchor" href="#_11-10-3-反射结构" aria-hidden="true">#</a> 11.10.3 反射结构</h2><p>有些时候需要反射一个结构类型。<code>NumField()</code> 方法返回结构内的字段数量；通过一个 <code>for</code> 循环用索引取得每个字段的值 <code>Field(i)</code>。</p><p>我们同样能够调用签名在结构上的方法，例如，使用索引 <code>n</code> 来调用：<code>Method(n).Call(nil)</code>。</p><p>示例 11.13 <a href="examples/chapter_11/reflect_struct.go">reflect_struct.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;reflect&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> NotknownType <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	s1<span class="token punctuation">,</span> s2<span class="token punctuation">,</span> s3 <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>n NotknownType<span class="token punctuation">)</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> n<span class="token punctuation">.</span>s1 <span class="token operator">+</span> <span class="token string">&quot; - &quot;</span> <span class="token operator">+</span> n<span class="token punctuation">.</span>s2 <span class="token operator">+</span> <span class="token string">&quot; - &quot;</span> <span class="token operator">+</span> n<span class="token punctuation">.</span>s3
<span class="token punctuation">}</span>

<span class="token comment">// variable to investigate:</span>
<span class="token keyword">var</span> secret <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token operator">=</span> NotknownType<span class="token punctuation">{</span><span class="token string">&quot;Ada&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Go&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Oberon&quot;</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	value <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>secret<span class="token punctuation">)</span> <span class="token comment">// &lt;main.NotknownType Value&gt;</span>
	typ <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>secret<span class="token punctuation">)</span>    <span class="token comment">// main.NotknownType</span>
	<span class="token comment">// alternative:</span>
	<span class="token comment">// typ := value.Type()  // main.NotknownType</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>typ<span class="token punctuation">)</span>
	knd <span class="token operator">:=</span> value<span class="token punctuation">.</span><span class="token function">Kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// struct</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>knd<span class="token punctuation">)</span>

	<span class="token comment">// iterate through the fields of the struct:</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> value<span class="token punctuation">.</span><span class="token function">NumField</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Field %d: %v\\n&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token function">Field</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token comment">// error: panic: reflect.Value.SetString using value obtained using unexported field</span>
		<span class="token comment">// value.Field(i).SetString(&quot;C#&quot;)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// call the first method, which is String():</span>
	results <span class="token operator">:=</span> value<span class="token punctuation">.</span><span class="token function">Method</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span> <span class="token comment">// [Ada - Go - Oberon]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>main.NotknownType
struct
Field 0: Ada
Field 1: Go
Field 2: Oberon
[Ada - Go - Oberon]
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>但是如果尝试更改一个值，会得到一个错误：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>panic: reflect.Value.SetString using value obtained using unexported field
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>这是因为结构中只有被导出字段（首字母大写）才是可设置的；来看下面的例子：</p><p>示例 11.14 <a href="examples/chapter_11/reflect_struct2.go">reflect_struct2.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;reflect&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> T <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	A <span class="token builtin">int</span>
	B <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	t <span class="token operator">:=</span> T<span class="token punctuation">{</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token string">&quot;skidoo&quot;</span><span class="token punctuation">}</span>
	s <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	typeOfT <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">Type</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> s<span class="token punctuation">.</span><span class="token function">NumField</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		f <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">Field</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d: %s %s = %v\\n&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span>
			typeOfT<span class="token punctuation">.</span><span class="token function">Field</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>Name<span class="token punctuation">,</span> f<span class="token punctuation">.</span><span class="token function">Type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> f<span class="token punctuation">.</span><span class="token function">Interface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	s<span class="token punctuation">.</span><span class="token function">Field</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SetInt</span><span class="token punctuation">(</span><span class="token number">77</span><span class="token punctuation">)</span>
	s<span class="token punctuation">.</span><span class="token function">Field</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">SetString</span><span class="token punctuation">(</span><span class="token string">&quot;Sunset Strip&quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;t is now&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>0: A int = 23
1: B string = skidoo
t is now {77 Sunset Strip}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>附录 37 深入阐述了反射概念。</p><h1 id="_11-11-printf-和反射" tabindex="-1"><a class="header-anchor" href="#_11-11-printf-和反射" aria-hidden="true">#</a> 11.11 Printf() 和反射</h1><p>在 Go 语言的标准库中，前几节所述的反射的功能被大量地使用。举个例子，<code>fmt</code> 包中的 <code>Printf()</code>（以及其他格式化输出函数）都会使用反射来分析它的 <code>...</code> 参数。</p><p><code>Printf()</code> 的函数声明为：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Printf</span><span class="token punctuation">(</span>format <span class="token builtin">string</span><span class="token punctuation">,</span> args <span class="token operator">...</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>Printf()</code> 中的 <code>...</code> 参数为空接口类型。<code>Printf()</code> 使用反射包来解析这个参数列表。所以，<code>Printf()</code> 能够知道它每个参数的类型。因此格式化字符串中只有 <code>%d</code> 而没有 <code>%u</code> 和 <code>%ld</code>，因为它知道这个参数是 unsigned 还是 long。这也是为什么 <code>Print()</code> 和 <code>Println()</code> 在没有格式字符串的情况下还能如此漂亮地输出。</p><p>为了让大家更加具体地了解 <code>Printf()</code> 中的反射，我们实现了一个简单的通用输出函数。其中使用了 type-switch 来推导参数类型，并根据类型来输出每个参数的值（这里用了 <a href="">10.7</a> 节中练习 10.13 的部分代码）</p><p>示例 11.15 <a href="examples/chapter_11/print.go">print.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;os&quot;</span>
	<span class="token string">&quot;strconv&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Stringer <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Celsius <span class="token builtin">float64</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c Celsius<span class="token punctuation">)</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> strconv<span class="token punctuation">.</span><span class="token function">FormatFloat</span><span class="token punctuation">(</span><span class="token function">float64</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token char">&#39;f&#39;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; °C&quot;</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Day <span class="token builtin">int</span>

<span class="token keyword">var</span> dayName <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;Monday&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Tuesday&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Wednesday&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Thursday&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Friday&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Saturday&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Sunday&quot;</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>day Day<span class="token punctuation">)</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> dayName<span class="token punctuation">[</span>day<span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">print</span><span class="token punctuation">(</span>args <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i<span class="token punctuation">,</span> arg <span class="token operator">:=</span> <span class="token keyword">range</span> args <span class="token punctuation">{</span>
		<span class="token keyword">if</span> i <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>os<span class="token punctuation">.</span>Stdout<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
		<span class="token keyword">switch</span> a <span class="token operator">:=</span> arg<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// type switch</span>
			<span class="token keyword">case</span> Stringer<span class="token punctuation">:</span>	os<span class="token punctuation">.</span>Stdout<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">case</span> <span class="token builtin">int</span><span class="token punctuation">:</span>		os<span class="token punctuation">.</span>Stdout<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">case</span> <span class="token builtin">string</span><span class="token punctuation">:</span>	os<span class="token punctuation">.</span>Stdout<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
			<span class="token comment">// more types</span>
			<span class="token keyword">default</span><span class="token punctuation">:</span>		os<span class="token punctuation">.</span>Stdout<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">&quot;???&quot;</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">print</span><span class="token punctuation">(</span><span class="token function">Day</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;was&quot;</span><span class="token punctuation">,</span> <span class="token function">Celsius</span><span class="token punctuation">(</span><span class="token number">18.36</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// Tuesday was 18.4 °C</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 <a href="">12.8</a> 节中我们将阐释 <code>fmt.Fprintf()</code> 是怎么运用同样的反射原则的。</p><h1 id="_11-12-接口与动态类型" tabindex="-1"><a class="header-anchor" href="#_11-12-接口与动态类型" aria-hidden="true">#</a> 11.12 接口与动态类型</h1><h2 id="_11-12-1-go-的动态类型" tabindex="-1"><a class="header-anchor" href="#_11-12-1-go-的动态类型" aria-hidden="true">#</a> 11.12.1 Go 的动态类型</h2><p>在经典的面向对象语言（像 C++，Java 和 C#）中数据和方法被封装为<em>类</em>的概念：类包含它们两者，并且不能剥离。</p><p>Go 没有类：数据（结构体或更一般的类型）和方法是一种松耦合的正交关系。</p><p>Go 中的接口跟 Java/C# 类似：都是必须提供一个指定方法集的实现。但是更加灵活通用：任何提供了接口方法实现代码的类型都隐式地实现了该接口，而不用显式地声明。</p><p>和其它语言相比，Go 是唯一结合了接口值，静态类型检查（是否该类型实现了某个接口），运行时动态转换的语言，并且不需要显式地声明类型是否满足某个接口。该特性允许我们在不改变已有的代码的情况下定义和使用新接口。</p><p>接收一个（或多个）接口类型作为参数的函数，其<strong>实参</strong>可以是任何实现了该接口的类型的变量。 <em>实现了某个接口的类型可以被传给任何以此接口为参数的函数</em>。</p><p>类似于 Python 和 Ruby 这类动态语言中的动态类型 (duck typing)；这意味着对象可以根据提供的方法被处理（例如，作为参数传递给函数），而忽略它们的实际类型：它们能做什么比它们是什么更重要。</p><p>这在程序 <a href="examples/chapter_11/duck_dance.go">duck_dance.go</a> 中得以阐明，函数 <code>DuckDance()</code> 接受一个 <code>IDuck</code> 接口类型变量。仅当 <code>DuckDance()</code> 被实现了 <code>IDuck</code> 接口的类型调用时程序才能编译通过。</p><p>示例 11.16 <a href="examples/chapter_11/duck_dance.go">duck_dance.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">type</span> IDuck <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Quack</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">Walk</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">DuckDance</span><span class="token punctuation">(</span>duck IDuck<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		duck<span class="token punctuation">.</span><span class="token function">Quack</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		duck<span class="token punctuation">.</span><span class="token function">Walk</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Bird <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Bird<span class="token punctuation">)</span> <span class="token function">Quack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;I am quacking!&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Bird<span class="token punctuation">)</span> <span class="token function">Walk</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;I am walking!&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	b <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>Bird<span class="token punctuation">)</span>
	<span class="token function">DuckDance</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>I am quacking!
I am walking!
I am quacking!
I am walking!
I am quacking!
I am walking!
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果 <code>Bird</code> 没有实现 <code>Walk()</code>（把它注释掉），会得到一个编译错误：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>cannot use b (type *Bird) as type IDuck in function argument:
*Bird does not implement IDuck (missing Walk method)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>如果对 <code>cat</code> 调用函数 <code>DuckDance()</code>，Go 会提示编译错误，但是 Python 和 Ruby 会以运行时错误结束。</p><h2 id="_11-12-2-动态方法调用" tabindex="-1"><a class="header-anchor" href="#_11-12-2-动态方法调用" aria-hidden="true">#</a> 11.12.2 动态方法调用</h2><p>像 Python，Ruby 这类语言，动态类型是延迟绑定的（在运行时进行）：方法只是用参数和变量简单地调用，然后在运行时才解析（它们很可能有像 <code>responds_to</code> 这样的方法来检查对象是否可以响应某个方法，但是这也意味着更大的编码量和更多的测试工作）</p><p>Go 的实现与此相反，通常需要编译器静态检查的支持：当变量被赋值给一个接口类型的变量时，编译器会检查其是否实现了该接口的所有函数。如果方法调用作用于像 <code>interface{}</code> 这样的“泛型”上，你可以通过类型断言（参见 <a href="">11.3</a> 节）来检查变量是否实现了相应接口。</p><p>例如，你用不同的类型表示 XML 输出流中的不同实体。然后我们为 XML 定义一个如下的“写”接口（甚至可以把它定义为私有接口）：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> xmlWriter <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">WriteXML</span><span class="token punctuation">(</span>w io<span class="token punctuation">.</span>Writer<span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>现在我们可以实现适用于该流类型的任何变量的 <code>StreamXML()</code> 函数，并用类型断言检查传入的变量是否实现了该接口；如果没有，我们就调用内建的 <code>encodeToXML()</code> 来完成相应工作：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// Exported XML streaming function.</span>
<span class="token keyword">func</span> <span class="token function">StreamXML</span><span class="token punctuation">(</span>v <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> w io<span class="token punctuation">.</span>Writer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> xw<span class="token punctuation">,</span> ok <span class="token operator">:=</span> v<span class="token punctuation">.</span><span class="token punctuation">(</span>xmlWriter<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		<span class="token comment">// It’s an  xmlWriter, use method of asserted type.</span>
		<span class="token keyword">return</span> xw<span class="token punctuation">.</span><span class="token function">WriteXML</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// No implementation, so we have to use our own function (with perhaps reflection):</span>
	<span class="token keyword">return</span> <span class="token function">encodeToXML</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> w<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Internal XML encoding function.</span>
<span class="token keyword">func</span> <span class="token function">encodeToXML</span><span class="token punctuation">(</span>v <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> w io<span class="token punctuation">.</span>Writer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Go 在这里用了和 <code>gob</code> 相同的机制：定义了两个接口 <code>GobEncoder</code> 和 <code>GobDecoder</code>。这样就允许类型自己实现从流编解码的具体方式；如果没有实现就使用标准的反射方式。</p><p>因此 Go 提供了动态语言的优点，却没有其他动态语言在运行时可能发生错误的缺点。</p><p>对于动态语言非常重要的单元测试来说，这样即可以减少单元测试的部分需求，又可以发挥相当大的作用。</p><p>Go 的接口提高了代码的分离度，改善了代码的复用性，使得代码开发过程中的设计模式更容易实现。用 Go 接口还能实现“依赖注入模式”。</p><h2 id="_11-12-3-接口的提取" tabindex="-1"><a class="header-anchor" href="#_11-12-3-接口的提取" aria-hidden="true">#</a> 11.12.3 接口的提取</h2><p><em>提取接口</em>是非常有用的设计模式，可以减少需要的类型和方法数量，而且不需要像传统的基于类的面向对象语言那样维护整个的类层次结构。</p><p>Go 接口可以让开发者找出自己写的程序中的类型。假设有一些拥有共同行为的对象，并且开发者想要抽象出这些行为，这时就可以创建一个接口来使用。</p><p>我们来扩展 11.1 节的示例 11.2 <a href="examples/chapter_11/interfaces_poly.go">interfaces_poly.go</a>，假设我们需要一个新的接口 <code>TopologicalGenus</code>，用来给 <code>shape</code> 排序（这里简单地实现为返回 <code>int</code>）。我们需要做的是给想要满足接口的类型实现 <code>Rank()</code> 方法：</p><p>示例 11.17 <a href="examples/chapter_11/multi_interfaces_poly.go">multi_interfaces_poly.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">//multi_interfaces_poly.go</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">type</span> Shaper <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Area</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">float32</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> TopologicalGenus <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Rank</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Square <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	side <span class="token builtin">float32</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>sq <span class="token operator">*</span>Square<span class="token punctuation">)</span> <span class="token function">Area</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">float32</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> sq<span class="token punctuation">.</span>side <span class="token operator">*</span> sq<span class="token punctuation">.</span>side
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>sq <span class="token operator">*</span>Square<span class="token punctuation">)</span> <span class="token function">Rank</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token number">1</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Rectangle <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	length<span class="token punctuation">,</span> width <span class="token builtin">float32</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r Rectangle<span class="token punctuation">)</span> <span class="token function">Area</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">float32</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> r<span class="token punctuation">.</span>length <span class="token operator">*</span> r<span class="token punctuation">.</span>width
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r Rectangle<span class="token punctuation">)</span> <span class="token function">Rank</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token number">2</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r <span class="token operator">:=</span> Rectangle<span class="token punctuation">{</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span> <span class="token comment">// Area() of Rectangle needs a value</span>
	q <span class="token operator">:=</span> <span class="token operator">&amp;</span>Square<span class="token punctuation">{</span><span class="token number">5</span><span class="token punctuation">}</span>      <span class="token comment">// Area() of Square needs a pointer</span>
	shapes <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Shaper<span class="token punctuation">{</span>r<span class="token punctuation">,</span> q<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Looping through shapes for area ...&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> n<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token keyword">range</span> shapes <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Shape details: &quot;</span><span class="token punctuation">,</span> shapes<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Area of this shape is: &quot;</span><span class="token punctuation">,</span> shapes<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Area</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	topgen <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>TopologicalGenus<span class="token punctuation">{</span>r<span class="token punctuation">,</span> q<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Looping through topgen for rank ...&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> n<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token keyword">range</span> topgen <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Shape details: &quot;</span><span class="token punctuation">,</span> topgen<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Topological Genus of this shape is: &quot;</span><span class="token punctuation">,</span> topgen<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Rank</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Looping through shapes for area ...
Shape details:  {5 3}
Area of this shape is:  15
Shape details:  &amp;{5}
Area of this shape is:  25
Looping through topgen for rank ...
Shape details:  {5 3}
Topological Genus of this shape is:  2
Shape details:  &amp;{5}
Topological Genus of this shape is:  1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>所以你不用提前设计出所有的接口；<em>整个设计可以持续演进，而不用废弃之前的决定</em>。类型要实现某个接口，它本身不用改变，你只需要在这个类型上实现新的方法。</p><h2 id="_11-12-4-显式地指明类型实现了某个接口" tabindex="-1"><a class="header-anchor" href="#_11-12-4-显式地指明类型实现了某个接口" aria-hidden="true">#</a> 11.12.4 显式地指明类型实现了某个接口</h2><p>如果你希望满足某个接口的类型显式地声明它们实现了这个接口，你可以向接口的方法集中添加一个具有描述性名字的方法。例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Fooer <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">ImplementsFooer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>类型 Bar 必须实现 <code>ImplementsFooer</code> 方法来满足 <code>Fooer</code> 接口，以清楚地记录这个事实。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Bar <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>b Bar<span class="token punctuation">)</span> <span class="token function">ImplementsFooer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>b Bar<span class="token punctuation">)</span> <span class="token function">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>大部分代码并不使用这样的约束，因为它限制了接口的实用性。</p><p>但是有些时候，这样的约束在大量相似的接口中被用来解决歧义。</p><h2 id="_11-12-5-空接口和函数重载" tabindex="-1"><a class="header-anchor" href="#_11-12-5-空接口和函数重载" aria-hidden="true">#</a> 11.12.5 空接口和函数重载</h2><p>在 <a href="">6.1</a> 节中, 我们看到函数重载是不被允许的。在 Go 语言中函数重载可以用可变参数 <code>...T</code> 作为函数最后一个参数来实现（参见 <a href="">6.3</a> 节）。如果我们把 <code>T</code> 换为空接口，那么可以知道任何类型的变量都是满足 <code>T</code> (空接口）类型的，这样就允许我们传递任何数量任何类型的参数给函数，即重载的实际含义。</p><p>函数 <code>fmt.Printf</code> 就是这样做的：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span>format <span class="token builtin">string</span><span class="token punctuation">,</span> a <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">,</span> errno <span class="token builtin">error</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>这个函数通过枚举 slice 类型的实参动态确定所有参数的类型，并查看每个类型是否实现了 <code>String()</code> 方法，如果是就用于产生输出信息。我们可以回到 <a href="">11.10</a> 节查看这些细节。</p><h2 id="_11-12-6-接口的继承" tabindex="-1"><a class="header-anchor" href="#_11-12-6-接口的继承" aria-hidden="true">#</a> 11.12.6 接口的继承</h2><p>当一个类型包含（内嵌）另一个类型（实现了一个或多个接口）的指针时，这个类型就可以使用（另一个类型）所有的接口方法。</p><p>例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Task <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Command <span class="token builtin">string</span>
	<span class="token operator">*</span>log<span class="token punctuation">.</span>Logger
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个类型的工厂方法像这样：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">NewTask</span><span class="token punctuation">(</span>command <span class="token builtin">string</span><span class="token punctuation">,</span> logger <span class="token operator">*</span>log<span class="token punctuation">.</span>Logger<span class="token punctuation">)</span> <span class="token operator">*</span>Task <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>Task<span class="token punctuation">{</span>command<span class="token punctuation">,</span> logger<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当 <code>log.Logger</code> 实现了 <code>Log()</code> 方法后，<code>Task</code> 的实例 <code>task</code> 就可以调用该方法：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>task<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>类型可以通过继承多个接口来提供像<em>多重继承</em>一样的特性：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> ReaderWriter <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token operator">*</span>io<span class="token punctuation">.</span>Reader
	<span class="token operator">*</span>io<span class="token punctuation">.</span>Writer
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面概述的原理被应用于整个 Go 包，多态用得越多，代码就相对越少（参见 <a href="">12.8 节</a>）。这被认为是 Go 编程中的重要的最佳实践。</p><p>有用的接口可以在开发的过程中被归纳出来。添加新接口非常容易，因为已有的类型不用变动（仅仅需要实现新接口的方法）。已有的函数可以扩展为使用接口类型的约束性参数：通常只有函数签名需要改变。对比基于类的 OO 类型的语言在这种情况下则需要适应整个类层次结构的变化。</p><p><strong>练习 11.11</strong>：<a href="exercises/chapter_11/map_function_interface.go">map_function_interface.go</a>：</p><p>在练习 7.13 中我们定义了一个 <code>map()</code> 函数来使用 <code>int</code> 切片 (<a href="exercises/chapter_7/map_function.go">map_function.go</a>)。</p><p>通过空接口和类型断言，现在我们可以写一个可以应用于许多类型的<em>泛型</em>的 <code>map()</code> 函数，为 <code>int</code> 和 <code>string</code> 构建一个把 <code>int</code> 值加倍和将字符串值与其自身连接（译者注：即 <code>&quot;abc&quot;</code> 变成 <code>&quot;abcabc&quot;</code> ）的 <code>map()</code> 函数 <code>mapFunc()</code>。</p><p>提示：为了可读性可以定义一个 <code>interface{}</code> 的别名，比如：<code>type obj interface{}</code>。</p><p><strong>练习 11.12</strong>：<a href="exercises/chapter_11/map_function_interface_var.go">map_function_interface_var.go</a>：</p><p>稍微改变练习 11.11，允许 <code>mapFunc()</code> 接收不定数量的 <code>items</code>。</p><p><strong>练习 11.13</strong>：<a href="exercises/chapter_11/main_stack.go">main_stack.go</a>—<a href="exercises/chapter_11/stack/stack_general.go">stack/stack_general.go</a>：</p><p>在练习 10.16 和 10.17 中我们开发了一些栈结构类型。但是它们被限制为某种固定的内建类型。现在用一个元素类型是 <code>interface{}</code>（空接口）的切片开发一个通用的栈类型。</p><p>实现下面的栈方法：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span>
<span class="token function">IsEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>
<span class="token function">Push</span><span class="token punctuation">(</span>x <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">Pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>Pop()</code> 改变栈并返回最顶部的元素；<code>Top()</code> 只返回最顶部元素。</p><p>在主程序中构建一个充满不同类型元素的栈，然后弹出并打印所有元素的值。</p><h1 id="_11-13-总结-go-中的面向对象" tabindex="-1"><a class="header-anchor" href="#_11-13-总结-go-中的面向对象" aria-hidden="true">#</a> 11.13 总结：Go 中的面向对象</h1><p>我们总结一下前面看到的：Go 没有类，而是松耦合的类型、方法对接口的实现。</p><p>OO 语言最重要的三个方面分别是：封装、继承和多态，在 Go 中它们是怎样表现的呢？</p><ul><li><p>封装（数据隐藏）：和别的 OO 语言有 4 个或更多的访问层次相比，Go 把它简化为了 2 层（参见 <a href="">4.2 节</a>的可见性规则）:</p><p>1）包范围内的：通过标识符首字母小写，<em>对象</em>只在它所在的包内可见</p><p>2）可导出的：通过标识符首字母大写，<em>对象</em>对所在包以外也可见</p></li></ul><p>类型只拥有自己所在包中定义的方法。</p><ul><li>继承：用组合实现：内嵌一个（或多个）包含想要的行为（字段和方法）的类型；多重继承可以通过内嵌多个类型实现</li><li>多态：用接口实现：某个类型的实例可以赋给它所实现的任意接口类型的变量。类型和接口是松耦合的，并且多重继承可以通过实现多个接口实现。Go 接口不是 Java 和 C# 接口的变体，而且接口间是不相关的，并且是大规模编程和可适应的演进型设计的关键。</li></ul><h1 id="_11-14-结构体、集合和高阶函数" tabindex="-1"><a class="header-anchor" href="#_11-14-结构体、集合和高阶函数" aria-hidden="true">#</a> 11.14 结构体、集合和高阶函数</h1><p>通常你在应用中定义了一个结构体，那么你也可能需要这个结构体的（指针）对象集合，比如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Any <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">type</span> Car <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Model        <span class="token builtin">string</span>
	Manufacturer <span class="token builtin">string</span>
	BuildYear    <span class="token builtin">int</span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Cars <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Car
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后我们就可以使用高阶函数，实际上也就是把函数作为定义所需方法（其他函数）的参数，例如：</p><p>1）定义一个通用的 <code>Process()</code> 函数，它接收一个作用于每一辆 car 的 f 函数作参数：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// Process all cars with the given function f:</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>cs Cars<span class="token punctuation">)</span> <span class="token function">Process</span><span class="token punctuation">(</span>f <span class="token keyword">func</span><span class="token punctuation">(</span>car <span class="token operator">*</span>Car<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> c <span class="token operator">:=</span> <span class="token keyword">range</span> cs <span class="token punctuation">{</span>
		<span class="token function">f</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>2）在上面的基础上，实现一个查找函数来获取子集合，并在 <code>Process()</code> 中传入一个闭包执行（这样就可以访问局部切片 <code>cars</code>）：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// Find all cars matching a given criteria.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>cs Cars<span class="token punctuation">)</span> <span class="token function">FindAll</span><span class="token punctuation">(</span>f <span class="token keyword">func</span><span class="token punctuation">(</span>car <span class="token operator">*</span>Car<span class="token punctuation">)</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> Cars <span class="token punctuation">{</span>

	cars <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Car<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	cs<span class="token punctuation">.</span><span class="token function">Process</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>Car<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token function">f</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			cars <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>cars<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> cars
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>3）实现对应作用的功效 (Map-functionality)，从每个 <code>car</code> 对象当中产出某些东西：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// Process cars and create new data.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>cs Cars<span class="token punctuation">)</span> <span class="token function">Map</span><span class="token punctuation">(</span>f <span class="token keyword">func</span><span class="token punctuation">(</span>car <span class="token operator">*</span>Car<span class="token punctuation">)</span> Any<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Any <span class="token punctuation">{</span>
	result <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Any<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	ix <span class="token operator">:=</span> <span class="token number">0</span>
	cs<span class="token punctuation">.</span><span class="token function">Process</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>Car<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		result<span class="token punctuation">[</span>ix<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
		ix<span class="token operator">++</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> result
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>现在我们可以定义下面这样的具体查询：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>allNewBMWs <span class="token operator">:=</span> allCars<span class="token punctuation">.</span><span class="token function">FindAll</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>car <span class="token operator">*</span>Car<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span>car<span class="token punctuation">.</span>Manufacturer <span class="token operator">==</span> <span class="token string">&quot;BMW&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>car<span class="token punctuation">.</span>BuildYear <span class="token operator">&gt;</span> <span class="token number">2010</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>4）我们也可以根据参数返回不同的函数。也许我们想根据不同的厂商添加汽车到不同的集合，但是这（这种映射关系）可能会是会改变的。所以我们可以定义一个函数来产生特定的添加函数和 <code>map</code> 集：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">MakeSortedAppender</span><span class="token punctuation">(</span>manufacturers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>car <span class="token operator">*</span>Car<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>Cars<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Prepare maps of sorted cars.</span>
	sortedCars <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>Cars<span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> m <span class="token operator">:=</span> <span class="token keyword">range</span> manufacturers <span class="token punctuation">{</span>
		sortedCars<span class="token punctuation">[</span>m<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Car<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	sortedCars<span class="token punctuation">[</span><span class="token string">&quot;Default&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Car<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token comment">// Prepare appender function:</span>
	appender <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>Car<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> sortedCars<span class="token punctuation">[</span>c<span class="token punctuation">.</span>Manufacturer<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
			sortedCars<span class="token punctuation">[</span>c<span class="token punctuation">.</span>Manufacturer<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>sortedCars<span class="token punctuation">[</span>c<span class="token punctuation">.</span>Manufacturer<span class="token punctuation">]</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			sortedCars<span class="token punctuation">[</span><span class="token string">&quot;Default&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>sortedCars<span class="token punctuation">[</span><span class="token string">&quot;Default&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> appender<span class="token punctuation">,</span> sortedCars
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>现在我们可以用它把汽车分类为独立的集合，像这样：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>manufacturers <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;Ford&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Aston Martin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Land Rover&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;BMW&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Jaguar&quot;</span><span class="token punctuation">}</span>
sortedAppender<span class="token punctuation">,</span> sortedCars <span class="token operator">:=</span> <span class="token function">MakeSortedAppender</span><span class="token punctuation">(</span>manufacturers<span class="token punctuation">)</span>
allUnsortedCars<span class="token punctuation">.</span><span class="token function">Process</span><span class="token punctuation">(</span>sortedAppender<span class="token punctuation">)</span>
BMWCount <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>sortedCars<span class="token punctuation">[</span><span class="token string">&quot;BMW&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们让这些代码在下面的程序 cars.go 中执行：</p><p>示例 11.18 <a href="examples/chapter_11/cars.go">cars.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// cars.go</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Any <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">type</span> Car <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Model        <span class="token builtin">string</span>
	Manufacturer <span class="token builtin">string</span>
	BuildYear    <span class="token builtin">int</span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span>
<span class="token keyword">type</span> Cars <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Car

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// make some cars:</span>
	ford <span class="token operator">:=</span> <span class="token operator">&amp;</span>Car<span class="token punctuation">{</span><span class="token string">&quot;Fiesta&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Ford&quot;</span><span class="token punctuation">,</span> <span class="token number">2008</span><span class="token punctuation">}</span>
	bmw <span class="token operator">:=</span> <span class="token operator">&amp;</span>Car<span class="token punctuation">{</span><span class="token string">&quot;XL 450&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;BMW&quot;</span><span class="token punctuation">,</span> <span class="token number">2011</span><span class="token punctuation">}</span>
	merc <span class="token operator">:=</span> <span class="token operator">&amp;</span>Car<span class="token punctuation">{</span><span class="token string">&quot;D600&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Mercedes&quot;</span><span class="token punctuation">,</span> <span class="token number">2009</span><span class="token punctuation">}</span>
	bmw2 <span class="token operator">:=</span> <span class="token operator">&amp;</span>Car<span class="token punctuation">{</span><span class="token string">&quot;X 800&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;BMW&quot;</span><span class="token punctuation">,</span> <span class="token number">2008</span><span class="token punctuation">}</span>
	<span class="token comment">// query:</span>
	allCars <span class="token operator">:=</span> <span class="token function">Cars</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Car<span class="token punctuation">{</span>ford<span class="token punctuation">,</span> bmw<span class="token punctuation">,</span> merc<span class="token punctuation">,</span> bmw2<span class="token punctuation">}</span><span class="token punctuation">)</span>
	allNewBMWs <span class="token operator">:=</span> allCars<span class="token punctuation">.</span><span class="token function">FindAll</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>car <span class="token operator">*</span>Car<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token punctuation">(</span>car<span class="token punctuation">.</span>Manufacturer <span class="token operator">==</span> <span class="token string">&quot;BMW&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>car<span class="token punctuation">.</span>BuildYear <span class="token operator">&gt;</span> <span class="token number">2010</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;AllCars: &quot;</span><span class="token punctuation">,</span> allCars<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;New BMWs: &quot;</span><span class="token punctuation">,</span> allNewBMWs<span class="token punctuation">)</span>
	<span class="token comment">//</span>
	manufacturers <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;Ford&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Aston Martin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Land Rover&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;BMW&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Jaguar&quot;</span><span class="token punctuation">}</span>
	sortedAppender<span class="token punctuation">,</span> sortedCars <span class="token operator">:=</span> <span class="token function">MakeSortedAppender</span><span class="token punctuation">(</span>manufacturers<span class="token punctuation">)</span>
	allCars<span class="token punctuation">.</span><span class="token function">Process</span><span class="token punctuation">(</span>sortedAppender<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Map sortedCars: &quot;</span><span class="token punctuation">,</span> sortedCars<span class="token punctuation">)</span>
	BMWCount <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>sortedCars<span class="token punctuation">[</span><span class="token string">&quot;BMW&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;We have &quot;</span><span class="token punctuation">,</span> BMWCount<span class="token punctuation">,</span> <span class="token string">&quot; BMWs&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Process all cars with the given function f:</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>cs Cars<span class="token punctuation">)</span> <span class="token function">Process</span><span class="token punctuation">(</span>f <span class="token keyword">func</span><span class="token punctuation">(</span>car <span class="token operator">*</span>Car<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> c <span class="token operator">:=</span> <span class="token keyword">range</span> cs <span class="token punctuation">{</span>
		<span class="token function">f</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Find all cars matching a given criteria.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>cs Cars<span class="token punctuation">)</span> <span class="token function">FindAll</span><span class="token punctuation">(</span>f <span class="token keyword">func</span><span class="token punctuation">(</span>car <span class="token operator">*</span>Car<span class="token punctuation">)</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> Cars <span class="token punctuation">{</span>
	cars <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Car<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

	cs<span class="token punctuation">.</span><span class="token function">Process</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>Car<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token function">f</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			cars <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>cars<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> cars
<span class="token punctuation">}</span>

<span class="token comment">// Process cars and create new data.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>cs Cars<span class="token punctuation">)</span> <span class="token function">Map</span><span class="token punctuation">(</span>f <span class="token keyword">func</span><span class="token punctuation">(</span>car <span class="token operator">*</span>Car<span class="token punctuation">)</span> Any<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Any <span class="token punctuation">{</span>
	result <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Any<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>cs<span class="token punctuation">)</span><span class="token punctuation">)</span>
	ix <span class="token operator">:=</span> <span class="token number">0</span>
	cs<span class="token punctuation">.</span><span class="token function">Process</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>Car<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		result<span class="token punctuation">[</span>ix<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
		ix<span class="token operator">++</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> result
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">MakeSortedAppender</span><span class="token punctuation">(</span>manufacturers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>car <span class="token operator">*</span>Car<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>Cars<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Prepare maps of sorted cars.</span>
	sortedCars <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>Cars<span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> m <span class="token operator">:=</span> <span class="token keyword">range</span> manufacturers <span class="token punctuation">{</span>
		sortedCars<span class="token punctuation">[</span>m<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Car<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	sortedCars<span class="token punctuation">[</span><span class="token string">&quot;Default&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Car<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

	<span class="token comment">// Prepare appender function:</span>
	appender <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>c <span class="token operator">*</span>Car<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> sortedCars<span class="token punctuation">[</span>c<span class="token punctuation">.</span>Manufacturer<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
			sortedCars<span class="token punctuation">[</span>c<span class="token punctuation">.</span>Manufacturer<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>sortedCars<span class="token punctuation">[</span>c<span class="token punctuation">.</span>Manufacturer<span class="token punctuation">]</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			sortedCars<span class="token punctuation">[</span><span class="token string">&quot;Default&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>sortedCars<span class="token punctuation">[</span><span class="token string">&quot;Default&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> appender<span class="token punctuation">,</span> sortedCars
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>AllCars:  [0xf8400038a0 0xf840003bd0 0xf840003ba0 0xf840003b70]
New BMWs:  [0xf840003bd0]
Map sortedCars:  map[Default:[0xf840003ba0] Jaguar:[] Land Rover:[] BMW:[0xf840003bd0 0xf840003b70] Aston Martin:[] Ford:[0xf8400038a0]]
We have  2  BMWs
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="第-12-章-读写数据" tabindex="-1"><a class="header-anchor" href="#第-12-章-读写数据" aria-hidden="true">#</a> 第 12 章：读写数据</h2><p>除了 <code>fmt</code> 和 <code>os</code> 包，我们还需要用到 <code>bufio</code> 包来处理缓冲的输入和输出。</p><h1 id="_12-1-读取用户的输入" tabindex="-1"><a class="header-anchor" href="#_12-1-读取用户的输入" aria-hidden="true">#</a> 12.1 读取用户的输入</h1><p>我们如何读取用户的键盘（控制台）输入呢？从键盘和标准输入 <code>os.Stdin</code> 读取输入，最简单的办法是使用 <code>fmt</code> 包提供的 <code>Scan...</code> 和 <code>Sscan...</code> 开头的函数。请看以下程序：</p><p>示例 12.1 <a href="examples/chapter_12/readinput1.go">readinput1.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 从控制台读取输入:</span>
<span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
   firstName<span class="token punctuation">,</span> lastName<span class="token punctuation">,</span> s <span class="token builtin">string</span>
   i <span class="token builtin">int</span>
   f <span class="token builtin">float32</span>
   input <span class="token operator">=</span> <span class="token string">&quot;56.12 / 5212 / Go&quot;</span>
   format <span class="token operator">=</span> <span class="token string">&quot;%f / %d / %s&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Please enter your full name: &quot;</span><span class="token punctuation">)</span>
   fmt<span class="token punctuation">.</span><span class="token function">Scanln</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>firstName<span class="token punctuation">,</span> <span class="token operator">&amp;</span>lastName<span class="token punctuation">)</span>
   <span class="token comment">// fmt.Scanf(&quot;%s %s&quot;, &amp;firstName, &amp;lastName)</span>
   fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Hi %s %s!\\n&quot;</span><span class="token punctuation">,</span> firstName<span class="token punctuation">,</span> lastName<span class="token punctuation">)</span> <span class="token comment">// Hi Chris Naegels</span>
   fmt<span class="token punctuation">.</span><span class="token function">Sscanf</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> format<span class="token punctuation">,</span> <span class="token operator">&amp;</span>f<span class="token punctuation">,</span> <span class="token operator">&amp;</span>i<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token punctuation">)</span>
   fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;From the string we read: &quot;</span><span class="token punctuation">,</span> f<span class="token punctuation">,</span> i<span class="token punctuation">,</span> s<span class="token punctuation">)</span>
    <span class="token comment">// 输出结果: From the string we read: 56.12 5212 Go</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>Scanln()</code> 扫描来自标准输入的文本，将空格分隔的值依次存放到后续的参数内，直到碰到换行。<code>Scanf()</code> 与其类似，除了 <code>Scanf()</code> 的第一个参数用作格式字符串，用来决定如何读取。<code>Sscan...</code> 和以 <code>Sscan...</code> 开头的函数则是从字符串读取，除此之外，与 <code>Scanf()</code> 相同。如果这些函数读取到的结果与您预想的不同，您可以检查成功读入数据的个数和返回的错误。</p><p>您也可以使用 <code>bufio</code> 包提供的缓冲读取器 (buffered reader) 来读取数据，正如以下例子所示：</p><p>示例 12.2 <a href="examples/chapter_12/readinput2.go">readinput2.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;fmt&quot;</span>
    <span class="token string">&quot;bufio&quot;</span>
    <span class="token string">&quot;os&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> inputReader <span class="token operator">*</span>bufio<span class="token punctuation">.</span>Reader
<span class="token keyword">var</span> input <span class="token builtin">string</span>
<span class="token keyword">var</span> err <span class="token builtin">error</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    inputReader <span class="token operator">=</span> bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdin<span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Please enter some input: &quot;</span><span class="token punctuation">)</span>
    input<span class="token punctuation">,</span> err <span class="token operator">=</span> inputReader<span class="token punctuation">.</span><span class="token function">ReadString</span><span class="token punctuation">(</span><span class="token char">&#39;\\n&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The input was: %s\\n&quot;</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>inputReader</code> 是一个指向 <code>bufio.Reader</code> 的指针。<code>inputReader := bufio.NewReader(os.Stdin)</code> 这行代码，将会创建一个读取器，并将其与标准输入绑定。</p><p><code>bufio.NewReader()</code> 构造函数的签名为：<code>func NewReader(rd io.Reader) *Reader</code></p><p>该函数的实参可以是满足 <code>io.Reader</code> 接口的任意对象（任意包含有适当的 <code>Read()</code> 方法的对象，请参考<a href="">章节 11.8</a>），函数返回一个新的带缓冲的 <code>io.Reader</code> 对象，它将从指定读取器（例如 <code>os.Stdin</code>）读取内容。</p><p>返回的读取器对象提供一个方法 <code>ReadString(delim byte)</code>，该方法从输入中读取内容，直到碰到 <code>delim</code> 指定的字符，然后将读取到的内容连同 <code>delim</code> 字符一起放到缓冲区。</p><p><code>ReadString</code> 返回读取到的字符串，如果碰到错误则返回 <code>nil</code>。如果它一直读到文件结束，则返回读取到的字符串和 <code>io.EOF</code>。如果读取过程中没有碰到 <code>delim</code> 字符，将返回错误 <code>err != nil</code>。</p><p>在上面的例子中，我们会读取键盘输入，直到回车键 (<code>\\n</code>) 被按下。</p><p>屏幕是标准输出 <code>os.Stdout</code>；<code>os.Stderr</code> 用于显示错误信息，大多数情况下等同于 <code>os.Stdout</code>。</p><p>一般情况下，我们会省略变量声明，而使用 <code>:=</code>，例如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>inputReader <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdin<span class="token punctuation">)</span>
input<span class="token punctuation">,</span> err <span class="token operator">:=</span> inputReader<span class="token punctuation">.</span><span class="token function">ReadString</span><span class="token punctuation">(</span><span class="token char">&#39;\\n&#39;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>我们将从现在开始使用这种写法。</p><p>第二个例子从键盘读取输入，使用了 <code>switch</code> 语句：</p><p>示例 12.3 <a href="examples/chapter_12/switch_input.go">switch_input.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;fmt&quot;</span>
    <span class="token string">&quot;os&quot;</span>
    <span class="token string">&quot;bufio&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    inputReader <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdin<span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Please enter your name:&quot;</span><span class="token punctuation">)</span>
    input<span class="token punctuation">,</span> err <span class="token operator">:=</span> inputReader<span class="token punctuation">.</span><span class="token function">ReadString</span><span class="token punctuation">(</span><span class="token char">&#39;\\n&#39;</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;There were errors reading, exiting program.&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Your name is %s&quot;</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span>
    <span class="token comment">// For Unix: test with delimiter &quot;\\n&quot;, for Windows: test with &quot;\\r\\n&quot;</span>
    <span class="token keyword">switch</span> input <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">&quot;Philip\\r\\n&quot;</span><span class="token punctuation">:</span>  fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Welcome Philip!&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">case</span> <span class="token string">&quot;Chris\\r\\n&quot;</span><span class="token punctuation">:</span>   fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Welcome Chris!&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">case</span> <span class="token string">&quot;Ivo\\r\\n&quot;</span><span class="token punctuation">:</span>     fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Welcome Ivo!&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;You are not welcome here! Goodbye!&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// version 2:   </span>
    <span class="token keyword">switch</span> input <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">&quot;Philip\\r\\n&quot;</span><span class="token punctuation">:</span>  <span class="token keyword">fallthrough</span>
    <span class="token keyword">case</span> <span class="token string">&quot;Ivo\\r\\n&quot;</span><span class="token punctuation">:</span>     <span class="token keyword">fallthrough</span>
    <span class="token keyword">case</span> <span class="token string">&quot;Chris\\r\\n&quot;</span><span class="token punctuation">:</span>   fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Welcome %s\\n&quot;</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;You are not welcome here! Goodbye!\\n&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// version 3:</span>
    <span class="token keyword">switch</span> input <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">&quot;Philip\\r\\n&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Ivo\\r\\n&quot;</span><span class="token punctuation">:</span>   fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Welcome %s\\n&quot;</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span> fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;You are not welcome here! Goodbye!\\n&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意：Unix 和 Windows 的行结束符是不同的！</p><p><strong>练习</strong></p><p><strong>练习 12.1:</strong> <a href="exercises/chapter_12/word_letter_count.go">word_letter_count.go</a></p><p>编写一个程序，从键盘读取输入。当用户输入 &#39;S&#39; 的时候表示输入结束，这时程序输出 3 个数字：<br> i) 输入的字符的个数，包括空格，但不包括 <code>&#39;\\r&#39;</code> 和 <code>&#39;\\n&#39;</code><br> ii) 输入的单词的个数<br> iii) 输入的行数</p><p><strong>练习 12.2:</strong> <a href="exercises/chapter_12/calculator.go">calculator.go</a></p><p>编写一个简单的逆波兰式计算器，它接受用户输入的整型数（最大值 999999）和运算符 +、-、*、/。<br> 输入的格式为：<code>number1 ENTER number2 ENTER operator ENTER --&gt; 显示结果</code><br> 当用户输入字符 <code>&#39;q&#39;</code> 时，程序结束。请使用您在<a href="">练习 11.13</a> 中开发的 <code>stack</code> 包。</p><h1 id="_12-2-文件读写" tabindex="-1"><a class="header-anchor" href="#_12-2-文件读写" aria-hidden="true">#</a> 12.2 文件读写</h1><h2 id="_12-2-1-读文件" tabindex="-1"><a class="header-anchor" href="#_12-2-1-读文件" aria-hidden="true">#</a> 12.2.1 读文件</h2><p>在 Go 语言中，文件使用指向 <code>os.File</code> 类型的指针来表示的，也叫做文件句柄。我们在前面章节使用到过标准输入 <code>os.Stdin</code> 和标准输出 <code>os.Stdout</code>，他们的类型都是 <code>*os.File</code>。让我们来看看下面这个程序：</p><p>示例 12.4 <a href="examples/chapter_12/fileinput.go">fileinput.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;bufio&quot;</span>
    <span class="token string">&quot;fmt&quot;</span>
    <span class="token string">&quot;io&quot;</span>
    <span class="token string">&quot;os&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    inputFile<span class="token punctuation">,</span> inputError <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;input.dat&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> inputError <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;An error occurred on opening the inputfile\\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;Does the file exist?\\n&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;Have you got access to it?\\n&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token comment">// exit the function on error</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">defer</span> inputFile<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    inputReader <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>inputFile<span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        inputString<span class="token punctuation">,</span> readerError <span class="token operator">:=</span> inputReader<span class="token punctuation">.</span><span class="token function">ReadString</span><span class="token punctuation">(</span><span class="token char">&#39;\\n&#39;</span><span class="token punctuation">)</span>
        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The input was: %s&quot;</span><span class="token punctuation">,</span> inputString<span class="token punctuation">)</span>
        <span class="token keyword">if</span> readerError <span class="token operator">==</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">{</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>      
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>变量 <code>inputFile</code> 是 <code>*os.File</code> 类型的。该类型是一个结构，表示一个打开文件的描述符（文件句柄）。然后，使用 <code>os</code> 包里的 <code>Open()</code> 函数来打开一个文件。该函数的参数是文件名，类型为 <code>string</code>。在上面的程序中，我们以只读模式打开 <code>input.dat</code> 文件。</p><p>如果文件不存在或者程序没有足够的权限打开这个文件，Open函数会返回一个错误：<code>inputFile, inputError = os.Open(&quot;input.dat&quot;)</code>。如果文件打开正常，我们就使用 <code>defer inputFile.Close()</code> 语句确保在程序退出前关闭该文件。然后，我们使用 <code>bufio.NewReader()</code> 来获得一个读取器变量。</p><p>通过使用 <code>bufio</code> 包提供的读取器（写入器也类似），如上面程序所示，我们可以很方便的操作相对高层的 <code>string</code> 对象，而避免了去操作比较底层的字节。</p><p>接着，我们在一个无限循环中使用 <code>ReadString(&#39;\\n&#39;)</code> 或 <code>ReadBytes(&#39;\\n&#39;)</code> 将文件的内容逐行（行结束符 <code>&#39;\\n&#39;</code>）读取出来。</p><p><strong>注意：</strong> 在之前的例子中，我们看到，Unix 和 Linux 的行结束符是 <code>\\n</code>，而 Windows 的行结束符是 <code>\\r\\n</code>。在使用 <code>ReadString</code> 和 <code>ReadBytes</code> 方法的时候，我们不需要关心操作系统的类型，直接使用 <code>\\n</code> 就可以了。另外，我们也可以使用 <code>ReadLine()</code> 方法来实现相同的功能。</p><p>一旦读取到文件末尾，变量 <code>readerError</code> 的值将变成非空（事实上，其值为常量 <code>io.EOF</code>），我们就会执行 <code>return</code> 语句从而退出循环。</p><p><strong>其他类似函数：</strong></p><p><strong>1) 将整个文件的内容读到一个字符串里：</strong></p><p>如果您想这么做，可以使用 <code>io/ioutil</code> 包里的 <code>ioutil.ReadFile()</code> 方法，该方法第一个返回值的类型是 <code>[]byte</code>，里面存放读取到的内容，第二个返回值是错误，如果没有错误发生，第二个返回值为 <code>nil</code>。请看示例 12.5。类似的，函数 <code>WriteFile()</code> 可以将 <code>[]byte</code> 的值写入文件。</p><p>示例 12.5 <a href="examples/chapter_12/read_write_file1.go">read_write_file1.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;fmt&quot;</span>
    <span class="token string">&quot;io/ioutil&quot;</span>
    <span class="token string">&quot;os&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    inputFile <span class="token operator">:=</span> <span class="token string">&quot;products.txt&quot;</span>
    outputFile <span class="token operator">:=</span> <span class="token string">&quot;products_copy.txt&quot;</span>
    buf<span class="token punctuation">,</span> err <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>inputFile<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">&quot;File Error: %s\\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token comment">// panic(err.Error())</span>
    <span class="token punctuation">}</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s\\n&quot;</span><span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span>
    err <span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>outputFile<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span> <span class="token comment">// oct, not hex</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2) 带缓冲的读取</strong></p><p>在很多情况下，文件的内容是不按行划分的，或者干脆就是一个二进制文件。在这种情况下，<code>ReadString()</code> 就无法使用了，我们可以使用 <code>bufio.Reader</code> 的 <code>Read()</code>，它只接收一个参数：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>buf <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span>
<span class="token operator">...</span>
n<span class="token punctuation">,</span> err <span class="token operator">:=</span> inputReader<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">break</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>变量 <code>n</code> 的值表示读取到的字节数.</p><p><strong>3) 按列读取文件中的数据</strong></p><p>如果数据是按列排列并用空格分隔的，你可以使用 <code>fmt</code> 包提供的以 <code>FScan...</code> 开头的一系列函数来读取他们。请看以下程序，我们将 3 列的数据分别读入变量 <code>v1</code>、<code>v2</code> 和 <code>v3</code> 内，然后分别把他们添加到切片的尾部。</p><p>示例 12.6 <a href="examples/chapter_12/read_file2.go">read_file2.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">&quot;fmt&quot;</span>
    <span class="token string">&quot;os&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    file<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;products2.txt&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">defer</span> file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">var</span> col1<span class="token punctuation">,</span> col2<span class="token punctuation">,</span> col3 <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> v1<span class="token punctuation">,</span> v2<span class="token punctuation">,</span> v3 <span class="token builtin">string</span>
        <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Fscanln</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v2<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v3<span class="token punctuation">)</span>
        <span class="token comment">// scans until newline</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">break</span>
        <span class="token punctuation">}</span>
        col1 <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>col1<span class="token punctuation">,</span> v1<span class="token punctuation">)</span>
        col2 <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>col2<span class="token punctuation">,</span> v2<span class="token punctuation">)</span>
        col3 <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>col3<span class="token punctuation">,</span> v3<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>col1<span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>col2<span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>col3<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出结果：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>[ABC FUNC GO]
[40 56 45]
[150 280 356]
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>注意：</strong> <code>path</code> 包里包含一个子包叫 <code>filepath</code>，这个子包提供了跨平台的函数，用于处理文件名和路径。例如 <code>Base()</code> 函数用于获得路径中的最后一个元素（不包含后面的分隔符）：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token string">&quot;path/filepath&quot;</span>
filename <span class="token operator">:=</span> filepath<span class="token punctuation">.</span><span class="token function">Base</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>练习 12.3</strong>：<a href="exercises/chapter_12/read_csv.go">read_csv.go</a></p><p>文件 products.txt 的内容如下：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>&quot;The ABC of Go&quot;;25.5;1500
&quot;Functional Programming with Go&quot;;56;280
&quot;Go for It&quot;;45.9;356
&quot;The Go Way&quot;;55;500
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>每行的第一个字段为标题，第二个字段为价格，第三个字段为数量。内容的格式基本与 示例 12.3c 的相同，除了分隔符改成了分号。请读取出文件的内容，创建一个结构用于存取一行的数据，然后使用结构的切片，并把数据打印出来。</p>`,235),pt=n("code",null,"encoding/csv",-1),ot={href:"http://golang.org/pkg/encoding/csv/",target:"_blank",rel:"noopener noreferrer"},ct=t(`<h2 id="_12-2-2-compress-包-读取压缩文件" tabindex="-1"><a class="header-anchor" href="#_12-2-2-compress-包-读取压缩文件" aria-hidden="true">#</a> 12.2.2 compress 包：读取压缩文件</h2><p><code>compress</code> 包提供了读取压缩文件的功能，支持的压缩文件格式为：bzip2、flate、gzip、lzw 和 zlib。</p><p>下面的程序展示了如何读取一个 gzip 文件。</p><p>示例 12.7 <a href="examples/chapter_12/gzipped.go">gzipped.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;bufio&quot;</span>
	<span class="token string">&quot;os&quot;</span>
	<span class="token string">&quot;compress/gzip&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fName <span class="token operator">:=</span> <span class="token string">&quot;MyFile.gz&quot;</span>
	<span class="token keyword">var</span> r <span class="token operator">*</span>bufio<span class="token punctuation">.</span>Reader
	fi<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>fName<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">&quot;%v, Can&#39;t open %s: error: %s\\n&quot;</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> fName<span class="token punctuation">,</span>
			err<span class="token punctuation">)</span>
		os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> fi<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fz<span class="token punctuation">,</span> err <span class="token operator">:=</span> gzip<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>fi<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		r <span class="token operator">=</span> bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>fi<span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		r <span class="token operator">=</span> bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>fz<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		line<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">ReadString</span><span class="token punctuation">(</span><span class="token char">&#39;\\n&#39;</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Done reading file&quot;</span><span class="token punctuation">)</span>
			os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_12-2-3-写文件" tabindex="-1"><a class="header-anchor" href="#_12-2-3-写文件" aria-hidden="true">#</a> 12.2.3 写文件</h2><p>请看以下程序：</p><p>示例 12.8 <a href="examples/chapter_12/fileoutput.go">fileoutput.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;os&quot;</span>
	<span class="token string">&quot;bufio&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> main <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// var outputWriter *bufio.Writer</span>
	<span class="token comment">// var outputFile *os.File</span>
	<span class="token comment">// var outputError os.Error</span>
	<span class="token comment">// var outputString string</span>
	outputFile<span class="token punctuation">,</span> outputError <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">OpenFile</span><span class="token punctuation">(</span><span class="token string">&quot;output.dat&quot;</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>O_WRONLY<span class="token operator">|</span>os<span class="token punctuation">.</span>O_CREATE<span class="token punctuation">,</span> <span class="token number">0666</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> outputError <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;An error occurred with file opening or creation\\n&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>  
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> outputFile<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	outputWriter <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewWriter</span><span class="token punctuation">(</span>outputFile<span class="token punctuation">)</span>
	outputString <span class="token operator">:=</span> <span class="token string">&quot;hello world!\\n&quot;</span>

	<span class="token keyword">for</span> i<span class="token operator">:=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		outputWriter<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>outputString<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	outputWriter<span class="token punctuation">.</span><span class="token function">Flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>除了文件句柄，我们还需要 <code>bufio</code> 的 <code>Writer</code>。我们以只写模式打开文件 <code>output.dat</code>，如果文件不存在则自动创建：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>outputFile<span class="token punctuation">,</span> outputError <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">OpenFile</span><span class="token punctuation">(</span><span class="token string">&quot;output.dat&quot;</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>O_WRONLY<span class="token operator">|</span>os<span class="token punctuation">.</span>O_CREATE<span class="token punctuation">,</span> <span class="token number">0666</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>可以看到，<code>OpenFile</code> 函数有三个参数：文件名、一个或多个标志（使用逻辑运算符 <code>|</code> 连接），使用的文件权限。</p><p>我们通常会用到以下标志：</p><ul><li><code>os.O_RDONLY</code>：只读</li><li><code>os.O_WRONLY</code>：只写</li><li><code>os.O_CREATE</code>：创建：如果指定文件不存在，就创建该文件。</li><li><code>os.O_TRUNC</code>：截断：如果指定文件已存在，就将该文件的长度截为 0 。</li></ul><p>在读文件的时候，文件的权限是被忽略的，所以在使用 <code>OpenFile()</code> 时传入的第三个参数可以用 0 。而在写文件时，不管是 Unix 还是 Windows，都需要使用 <code>0666</code>。</p><p>然后，我们创建一个写入器（缓冲区）对象：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>outputWriter <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewWriter</span><span class="token punctuation">(</span>outputFile<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>接着，使用一个 <code>for</code> 循环，将字符串写入缓冲区，写 10 次：<code>outputWriter.WriteString(outputString)</code></p><p>缓冲区的内容紧接着被完全写入文件：<code>outputWriter.Flush()</code></p><p>如果写入的东西很简单，我们可以使用 <code>fmt.Fprintf(outputFile, &quot;Some test data.\\n&quot;)</code> 直接将内容写入文件。<code>fmt</code> 包里的 <code>F...</code> 开头的 <code>Print()</code> 函数可以直接写入任何 <code>io.Writer</code>，包括文件（请参考<a href="">章节 12.8</a>)。</p><p>程序 <code>filewrite.go</code> 展示了不使用 <code>fmt.FPrintf()</code> 函数，使用其他函数如何写文件：</p><p>示例 12.8 <a href="examples/chapter_12/filewrite.go">filewrite.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;os&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	os<span class="token punctuation">.</span>Stdout<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">&quot;hello, world\\n&quot;</span><span class="token punctuation">)</span>
	f<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">OpenFile</span><span class="token punctuation">(</span><span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>O_CREATE<span class="token operator">|</span>os<span class="token punctuation">.</span>O_WRONLY<span class="token punctuation">,</span> <span class="token number">0666</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> f<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	f<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">&quot;hello, world in a file\\n&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用 <code>os.Stdout.WriteString(&quot;hello, world\\n&quot;)</code>，我们可以输出到屏幕。</p><p>我们以只写模式创建或打开文件 <code>&quot;test&quot;</code> ，并且忽略了可能发生的错误：<code>f, _ := os.OpenFile(&quot;test&quot;, os.O_CREATE|os.O_WRONLY, 0666)</code></p><p>我们不使用缓冲区，直接将内容写入文件：<code>f.WriteString()</code></p><p><strong>练习 12.4</strong>：<a href="exercises/chapter_12/wiki_part1.go">wiki_part1.go</a></p><p>（这是一个独立的练习，但是同时也是为<a href="">章节 15.4</a> 做准备）</p><p>程序中的数据结构如下，是一个包含以下字段的结构:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Page <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Title <span class="token builtin">string</span>
    Body  <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>请给这个结构编写一个 <code>save()</code> 方法，将 Title 作为文件名、Body 作为文件内容，写入到文本文件中。</p><p>再编写一个 <code>load()</code> 函数，接收的参数是字符串 <code>title</code>，该函数读取出与 <code>title</code> 对应的文本文件。请使用 <code>*Page</code> 做为参数，因为这个结构可能相当巨大，我们不想在内存中拷贝它。请使用 <code>ioutil</code> 包里的函数（参考<a href="">章节 12.2.1</a>）。</p><h1 id="_12-3-文件拷贝" tabindex="-1"><a class="header-anchor" href="#_12-3-文件拷贝" aria-hidden="true">#</a> 12.3 文件拷贝</h1><p>如何拷贝一个文件到另一个文件？最简单的方式就是使用 <code>io</code> 包：</p><p>示例 12.10 <a href="examples/chapter_12/filecopy.go">filecopy.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// filecopy.go</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;io&quot;</span>
	<span class="token string">&quot;os&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">CopyFile</span><span class="token punctuation">(</span><span class="token string">&quot;target.txt&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;source.txt&quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Copy done!&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">CopyFile</span><span class="token punctuation">(</span>dstName<span class="token punctuation">,</span> srcName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>written <span class="token builtin">int64</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	src<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>srcName<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> src<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	dst<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>dstName<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> dst<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">return</span> io<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> src<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意 <code>defer</code> 的使用：当打开 <code>dst</code> 文件时发生了错误，那么 <code>defer</code> 仍然能够确保 <code>src.Close()</code> 执行。如果不这么做，<code>src</code> 文件会一直保持打开状态并占用资源。</p><h1 id="_12-4-从命令行读取参数" tabindex="-1"><a class="header-anchor" href="#_12-4-从命令行读取参数" aria-hidden="true">#</a> 12.4 从命令行读取参数</h1><h2 id="_12-4-1-os-包" tabindex="-1"><a class="header-anchor" href="#_12-4-1-os-包" aria-hidden="true">#</a> 12.4.1 os 包</h2><p><code>os</code> 包中有一个 <code>string</code> 类型的切片变量 <code>os.Args</code>，用来处理一些基本的命令行参数，它在程序启动后读取命令行输入的参数。来看下面的打招呼程序：</p><p>示例 12.11 <a href="examples/chapter_12/os_args.go">os_args.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// os_args.go</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;os&quot;</span>
	<span class="token string">&quot;strings&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	who <span class="token operator">:=</span> <span class="token string">&quot;Alice &quot;</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Args<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token punctuation">{</span>
		who <span class="token operator">+=</span> strings<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Good Morning&quot;</span><span class="token punctuation">,</span> who<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们在 IDE 或编辑器中直接运行这个程序输出：<code>Good Morning Alice</code></p><p>我们在命令行运行 <code>os_args</code> 或 <code>./os_args</code> 会得到同样的结果。</p><p>但是我们在命令行加入参数，像这样：<code>os_args John Bill Marc Luke</code>，将得到这样的输出：<code>Good Morning Alice John Bill Marc Luke</code></p><p>这个命令行参数会放置在切片 <code>os.Args[]</code> 中（以空格分隔），从索引 1 开始（<code>os.Args[0]</code> 放的是程序本身的名字，在本例中是 <code>os_args</code>）。函数 <code>strings.Join</code> 以空格为间隔连接这些参数。</p><p><strong>练习 12.5</strong>：<a href="exercises/chapter_12/hello_who.go">hello_who.go</a></p><p>写一个“Hello World”的变种程序：把人的名字作为程序命令行执行的一个参数，比如： <code>hello_who Evan Michael Laura</code> 那么会输出 <code>Hello Evan Michael Laura!</code></p><h2 id="_12-4-2-flag-包" tabindex="-1"><a class="header-anchor" href="#_12-4-2-flag-包" aria-hidden="true">#</a> 12.4.2 flag 包</h2><p><code>flag</code> 包有一个扩展功能用来解析命令行选项。但是通常被用来替换基本常量，例如，在某些情况下我们希望在命令行给常量一些不一样的值。（参看 <a href="">19 章</a>的项目）</p><p>在 <code>flag</code> 包中有一个 <code>Flag</code> 是被定义成一个含有如下字段的结构体：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Flag <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Name     <span class="token builtin">string</span> <span class="token comment">// name as it appears on command line</span>
	Usage    <span class="token builtin">string</span> <span class="token comment">// help message</span>
	Value    Value  <span class="token comment">// value as set</span>
	DefValue <span class="token builtin">string</span> <span class="token comment">// default value (as text); for usage message</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下面的程序 <a href="examples/chapter_12/echo.go">echo.go</a> 模拟了 Unix 的 echo 功能：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;flag&quot;</span> <span class="token comment">// command line option parser</span>
	<span class="token string">&quot;os&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> NewLine <span class="token operator">=</span> flag<span class="token punctuation">.</span><span class="token function">Bool</span><span class="token punctuation">(</span><span class="token string">&quot;n&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">&quot;print newline&quot;</span><span class="token punctuation">)</span> <span class="token comment">// echo -n flag, of type *bool</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
	Space   <span class="token operator">=</span> <span class="token string">&quot; &quot;</span>
	Newline <span class="token operator">=</span> <span class="token string">&quot;\\n&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	flag<span class="token punctuation">.</span><span class="token function">PrintDefaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Scans the arg list and sets up flags</span>
	<span class="token keyword">var</span> s <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">&quot;&quot;</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> flag<span class="token punctuation">.</span><span class="token function">NArg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> i <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			s <span class="token operator">+=</span> <span class="token string">&quot; &quot;</span>
			<span class="token keyword">if</span> <span class="token operator">*</span>NewLine <span class="token punctuation">{</span> <span class="token comment">// -n is parsed, flag becomes true</span>
				s <span class="token operator">+=</span> Newline
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		s <span class="token operator">+=</span> flag<span class="token punctuation">.</span><span class="token function">Arg</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	os<span class="token punctuation">.</span>Stdout<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>flag.Parse()</code> 扫描参数列表（或者常量列表）并设置 flag, <code>flag.Arg(i)</code> 表示第 i 个参数。<code>Parse()</code> 之后 <code>flag.Arg(i)</code> 全部可用，<code>flag.Arg(0)</code> 就是第一个真实的 flag，而不是像 <code>os.Args(0)</code> 放置程序的名字。</p><p><code>flag.Narg()</code> 返回参数的数量。解析后 flag 或常量就可用了。 <code>flag.Bool()</code> 定义了一个默认值是 <code>false</code> 的 flag：当在命令行出现了第一个参数（这里是 <code>&#39;n&#39;</code>），flag 被设置成 <code>true</code>（<code>NewLine</code> 是 <code>*bool</code> 类型）。flag 被解引用到 <code>*NewLine</code>，所以当值是 <code>true</code> 时将添加一个 <code>Newline(&quot;\\n&quot;)</code>。</p><p><code>flag.PrintDefaults()</code> 打印 flag 的使用帮助信息，本例中打印的是：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token operator">-</span>n<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">:</span> <span class="token builtin">print</span> newline
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>flag.VisitAll(fn func(*Flag))</code> 是另一个有用的功能：按照字典顺序遍历 flag，并且对每个标签调用 fn （参考 <a href="">15.8 章</a>的例子）</p><p>当在命令行 (Windows) 中执行：<code>echo.exe A B C</code>，将输出：<code>A B C</code>；执行 <code>echo.exe -n A B C</code>，将输出：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>A
B
C
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>每个字符的输出都新起一行，每次都在输出的数据前面打印使用帮助信息：<code>-n=false: print newline</code>。</p><p>对于 <code>flag.Bool</code> 你可以设置布尔型 flag 来测试你的代码，例如定义一个 flag <code>processedFlag</code>:</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> processedFlag <span class="token operator">=</span> flag<span class="token punctuation">.</span><span class="token function">Bool</span><span class="token punctuation">(</span><span class="token string">&quot;proc&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">&quot;nothing processed yet&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>在后面用如下代码来测试：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> <span class="token operator">*</span>processedFlag <span class="token punctuation">{</span> <span class="token comment">// found flag -proc</span>
	r <span class="token operator">=</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>要给 flag 定义其它类型，可以使用 <code>flag.Int()</code>，<code>flag.Float64()</code>，<code>flag.String()</code>。</p><p>在<a href="">第 15.8 章</a>你将找到一个具体的例子。</p><h1 id="_12-5-用-buffer-读取文件" tabindex="-1"><a class="header-anchor" href="#_12-5-用-buffer-读取文件" aria-hidden="true">#</a> 12.5 用 buffer 读取文件</h1><p>在下面的例子中，我们结合使用了缓冲读取文件和命令行 flag 解析这两项技术。如果不加参数，那么你输入什么屏幕就打印什么。</p><p>参数被认为是文件名，如果文件存在的话就打印文件内容到屏幕。命令行执行 <code>cat test</code> 测试输出。</p><p>示例 12.11 <a href="examples/chapter_12/cat.go">cat.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;bufio&quot;</span>
	<span class="token string">&quot;flag&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;io&quot;</span>
	<span class="token string">&quot;os&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">cat</span><span class="token punctuation">(</span>r <span class="token operator">*</span>bufio<span class="token punctuation">.</span>Reader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		buf<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">ReadBytes</span><span class="token punctuation">(</span><span class="token char">&#39;\\n&#39;</span><span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdout<span class="token punctuation">,</span> <span class="token string">&quot;%s&quot;</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">==</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">{</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> flag<span class="token punctuation">.</span><span class="token function">NArg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token function">cat</span><span class="token punctuation">(</span>bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdin<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> flag<span class="token punctuation">.</span><span class="token function">NArg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		f<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>flag<span class="token punctuation">.</span><span class="token function">Arg</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">&quot;%s:error reading from %s: %s\\n&quot;</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> flag<span class="token punctuation">.</span><span class="token function">Arg</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		<span class="token function">cat</span><span class="token punctuation">(</span>bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span>
		f<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 <a href="">12.6 章节</a>，我们将看到如何使用缓冲写入。</p><p><strong>练习 12.6</strong>：<a href="exercises/chapter_12/cat_numbered.go">cat_numbered.go</a></p><p>扩展 <a href="exercises/chapter_12/cat.go">cat.go</a> 例子，使用 flag 添加一个选项，目的是为每一行头部加入一个行号。使用 <code>cat -n test</code> 测试输出。</p><h1 id="_12-6-用切片读写文件" tabindex="-1"><a class="header-anchor" href="#_12-6-用切片读写文件" aria-hidden="true">#</a> 12.6 用切片读写文件</h1><p>切片提供了 Go 中处理 I/O 缓冲的标准方式，下面 <code>cat</code> 函数的第二版中，在一个切片缓冲内使用无限 <code>for</code> 循环（直到文件尾部 <code>EOF</code>）读取文件，并写入到标准输出（<code>os.Stdout</code>）。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">cat</span><span class="token punctuation">(</span>f <span class="token operator">*</span>os<span class="token punctuation">.</span>File<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> NBUF <span class="token operator">=</span> <span class="token number">512</span>
	<span class="token keyword">var</span> buf <span class="token punctuation">[</span>NBUF<span class="token punctuation">]</span><span class="token builtin">byte</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token keyword">switch</span> nr<span class="token punctuation">,</span> err <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">{</span>
		<span class="token keyword">case</span> nr <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
			fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">&quot;cat: error reading: %s\\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> nr <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span> <span class="token comment">// EOF</span>
			<span class="token keyword">return</span>
		<span class="token keyword">case</span> nr <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
			<span class="token keyword">if</span> nw<span class="token punctuation">,</span> ew <span class="token operator">:=</span> os<span class="token punctuation">.</span>Stdout<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span>nr<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> nw <span class="token operator">!=</span> nr <span class="token punctuation">{</span>
				fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">&quot;cat: error writing: %s\\n&quot;</span><span class="token punctuation">,</span> ew<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面的代码来自于 <a href="examples/chapter_12/cat2.go">cat2.go</a>，使用了 os 包中的 <code>os.File</code> 和 <code>Read</code> 方法；<code>cat2.go</code> 与 <code>cat.go</code> 具有同样的功能。</p><p>示例 12.14 <a href="examples/chapter_12/cat2.go">cat2.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;flag&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;os&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">cat</span><span class="token punctuation">(</span>f <span class="token operator">*</span>os<span class="token punctuation">.</span>File<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> NBUF <span class="token operator">=</span> <span class="token number">512</span>
	<span class="token keyword">var</span> buf <span class="token punctuation">[</span>NBUF<span class="token punctuation">]</span><span class="token builtin">byte</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token keyword">switch</span> nr<span class="token punctuation">,</span> err <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token boolean">true</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> nr <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
			fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">&quot;cat: error reading: %s\\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> nr <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span> <span class="token comment">// EOF</span>
			<span class="token keyword">return</span>
		<span class="token keyword">case</span> nr <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
			<span class="token keyword">if</span> nw<span class="token punctuation">,</span> ew <span class="token operator">:=</span> os<span class="token punctuation">.</span>Stdout<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span>nr<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> nw <span class="token operator">!=</span> nr <span class="token punctuation">{</span>
				fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">&quot;cat: error writing: %s\\n&quot;</span><span class="token punctuation">,</span> ew<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Scans the arg list and sets up flags</span>
	<span class="token keyword">if</span> flag<span class="token punctuation">.</span><span class="token function">NArg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token function">cat</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdin<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> flag<span class="token punctuation">.</span><span class="token function">NArg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		f<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>flag<span class="token punctuation">.</span><span class="token function">Arg</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> f <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">&quot;cat: can&#39;t open %s: error %s\\n&quot;</span><span class="token punctuation">,</span> flag<span class="token punctuation">.</span><span class="token function">Arg</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token function">cat</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>
		f<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="_12-7-用-defer-关闭文件" tabindex="-1"><a class="header-anchor" href="#_12-7-用-defer-关闭文件" aria-hidden="true">#</a> 12.7 用 defer 关闭文件</h1><p><code>defer</code> 关键字（参看 <a href="">6.4</a>）对于在函数结束时关闭打开的文件非常有用，例如下面的代码片段：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">data</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	f<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">OpenFile</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> os<span class="token punctuation">.</span>O_RDONLY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> f<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// idiomatic Go code!</span>
	contents<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token function">string</span><span class="token punctuation">(</span>contents<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在函数 <code>return</code> 后执行了 <code>f.Close()</code></p><h1 id="_12-8-使用接口的实际例子-fmt-fprintf" tabindex="-1"><a class="header-anchor" href="#_12-8-使用接口的实际例子-fmt-fprintf" aria-hidden="true">#</a> 12.8 使用接口的实际例子：fmt.Fprintf</h1><p>例子程序 <code>io_interfaces.go</code> 很好的阐述了 <code>io</code> 包中的接口概念。</p><p>示例 12.15 <a href="examples/chapter_12/io_interfaces.go">io_interfaces.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// interfaces being used in the GO-package fmt</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;bufio&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;os&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// unbuffered</span>
	fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdout<span class="token punctuation">,</span> <span class="token string">&quot;%s\\n&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hello world! - unbuffered&quot;</span><span class="token punctuation">)</span>
	<span class="token comment">// buffered: os.Stdout implements io.Writer</span>
	buf <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewWriter</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdout<span class="token punctuation">)</span>
	<span class="token comment">// and now so does buf.</span>
	fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">&quot;%s\\n&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hello world! - buffered&quot;</span><span class="token punctuation">)</span>
	buf<span class="token punctuation">.</span><span class="token function">Flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>hello world! - unbuffered
hello world! - buffered
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>下面是 <code>fmt.Fprintf()</code> 函数的实际签名</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Fprintf</span><span class="token punctuation">(</span>w io<span class="token punctuation">.</span>Writer<span class="token punctuation">,</span> format <span class="token builtin">string</span><span class="token punctuation">,</span> a <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>不是写入一个文件，而是写入一个 <code>io.Writer</code> 接口类型的变量，下面是 <code>Writer</code> 接口在 <code>io</code> 包中的定义：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Writer <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Write</span><span class="token punctuation">(</span>p <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>fmt.Fprintf()</code> 依据指定的格式向第一个参数内写入字符串，第一个参数必须实现了 <code>io.Writer</code> 接口。<code>Fprintf()</code> 能够写入任何类型，只要其实现了 <code>Write</code> 方法，包括 <code>os.Stdout</code>，文件（例如 <code>os.File</code>），管道，网络连接，通道等等。同样地，也可以使用 <code>bufio</code> 包中缓冲写入。<code>bufio</code> 包中定义了 <code>type Writer struct{...}</code> 。</p><p><code>bufio.Writer</code> 实现了 <code>Write()</code> 方法：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Writer<span class="token punctuation">)</span> <span class="token function">Write</span><span class="token punctuation">(</span>p <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>nn <span class="token builtin">int</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>它还有一个工厂函数：传给它一个 <code>io.Writer</code> 类型的参数，它会返回一个带缓冲的 <code>bufio.Writer</code> 类型的 <code>io.Writer</code> ：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">NewWriter</span><span class="token punctuation">(</span>wr io<span class="token punctuation">.</span>Writer<span class="token punctuation">)</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Writer<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>适合任何形式的缓冲写入。</p><p>在缓冲写入的最后千万不要忘了使用 <code>Flush()</code>，否则最后的输出不会被写入。</p><p>在 <a href="">15.2</a>-<a href="">15.8</a> 章节，我们将使用 <code>fmt.Fprint()</code> 函数向 <code>http.ResponseWriter</code> 写入，其同样实现了 <code>io.Writer</code> 接口。</p><p><strong>练习 12.7</strong>：<a href="exercises/chapter_12/remove_3till5char.go">remove_3till5char.go</a></p><p>下面的代码有一个输入文件 <code>goprogram</code>，然后以每一行为单位读取，从读取的当前行中截取第 3 到第 5 的字节写入另一个文件。然而当你运行这个程序，输出的文件却是个空文件。找出程序逻辑中的 bug，修正它并测试。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;bufio&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;os&quot;</span>
	<span class="token string">&quot;io&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	inputFile<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token string">&quot;goprogram&quot;</span><span class="token punctuation">)</span>
	outputFile<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">OpenFile</span><span class="token punctuation">(</span><span class="token string">&quot;goprogramT&quot;</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>O_WRONLY<span class="token operator">|</span>os<span class="token punctuation">.</span>O_CREATE<span class="token punctuation">,</span> <span class="token number">0666</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> inputFile<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> outputFile<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	inputReader <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>inputFile<span class="token punctuation">)</span>
	outputWriter <span class="token operator">:=</span> bufio<span class="token punctuation">.</span><span class="token function">NewWriter</span><span class="token punctuation">(</span>outputFile<span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		inputString<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> readerError <span class="token operator">:=</span> inputReader<span class="token punctuation">.</span><span class="token function">ReadLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> readerError <span class="token operator">==</span> io<span class="token punctuation">.</span>EOF <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;EOF&quot;</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		outputString <span class="token operator">:=</span> <span class="token function">string</span><span class="token punctuation">(</span>inputString<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;\\r\\n&quot;</span>
		<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> outputWriter<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>outputString<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Conversion done&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="_12-9-json-数据格式" tabindex="-1"><a class="header-anchor" href="#_12-9-json-数据格式" aria-hidden="true">#</a> 12.9 JSON 数据格式</h1><p>数据结构要在网络中传输或保存到文件，就必须对其编码和解码；目前存在很多编码格式：JSON，XML，gob，Google 缓冲协议等等。Go 语言支持所有这些编码格式；在后面的章节，我们将讨论前三种格式。</p><p>结构可能包含二进制数据，如果将其作为文本打印，那么可读性是很差的。另外结构内部可能包含匿名字段，而不清楚数据的用意。</p><p>通过把数据转换成纯文本，使用命名的字段来标注，让其具有可读性。这样的数据格式可以通过网络传输，而且是与平台无关的，任何类型的应用都能够读取和输出，不与操作系统和编程语言的类型相关。</p><p>下面是一些术语说明：</p><ul><li>数据结构 --&gt; 指定格式 = <strong>序列化</strong> 或 <strong>编码</strong>（传输之前）</li><li>指定格式 --&gt; 数据结构 = <strong>反序列化</strong> 或 <strong>解码</strong>（传输之后）</li></ul><p>序列化是在内存中把数据转换成指定格式（数据 -&gt; 字符串），反之亦然（字符串 -&gt; 数据）。</p><p>编码也是一样的，只是输出一个数据流（实现了 <code>io.Writer</code> 接口）；解码是从一个数据流（实现了 <code>io.Reader</code>）输出到一个数据结构。</p>`,115),it=n("a",{href:""},"12.10",-1),lt={href:"http://json.org",target:"_blank",rel:"noopener noreferrer"},ut=t(`<p>这是一个简短的 JSON 片段：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token punctuation">{</span>
    <span class="token string-property property">&quot;Person&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">&quot;FirstName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Laura&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;LastName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Lynn&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>尽管 XML 被广泛的应用，但是 JSON 更加简洁、轻量（占用更少的内存、磁盘及网络带宽）和更好的可读性，这也使它越来越受欢迎。</p><p>Go 语言的 <code>json</code> 包可以让你在程序中方便的读取和写入 JSON 数据。</p><p>我们将在下面的例子里使用 <code>json</code> 包，并使用练习 10.1 <a href="exercises/chapter_10/vcard.go">vcard.go</a> 中一个简化版本的 <code>Address</code> 和 <code>VCard</code> 结构（为了简单起见，我们忽略了很多错误处理，不过在实际应用中你必须要合理的处理这些错误，参阅 <a href="">13 章</a>）。</p><p>示例 12.16 <a href="examples/chapter_12/json.go">json.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// json.go</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;encoding/json&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;os&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Address <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Type    <span class="token builtin">string</span>
	City    <span class="token builtin">string</span>
	Country <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> VCard <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	FirstName <span class="token builtin">string</span>
	LastName  <span class="token builtin">string</span>
	Addresses <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Address
	Remark    <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	pa <span class="token operator">:=</span> <span class="token operator">&amp;</span>Address<span class="token punctuation">{</span><span class="token string">&quot;private&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Aartselaar&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Belgium&quot;</span><span class="token punctuation">}</span>
	wa <span class="token operator">:=</span> <span class="token operator">&amp;</span>Address<span class="token punctuation">{</span><span class="token string">&quot;work&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Boom&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Belgium&quot;</span><span class="token punctuation">}</span>
	vc <span class="token operator">:=</span> VCard<span class="token punctuation">{</span><span class="token string">&quot;Jan&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Kersschot&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Address<span class="token punctuation">{</span>pa<span class="token punctuation">,</span> wa<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;none&quot;</span><span class="token punctuation">}</span>
	<span class="token comment">// fmt.Printf(&quot;%v: \\n&quot;, vc) // {Jan Kersschot [0x126d2b80 0x126d2be0] none}:</span>
	<span class="token comment">// JSON format:</span>
	js<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Marshal</span><span class="token punctuation">(</span>vc<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;JSON format: %s&quot;</span><span class="token punctuation">,</span> js<span class="token punctuation">)</span>
	<span class="token comment">// using an encoder:</span>
	file<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">OpenFile</span><span class="token punctuation">(</span><span class="token string">&quot;vcard.json&quot;</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>O_CREATE<span class="token operator">|</span>os<span class="token punctuation">.</span>O_WRONLY<span class="token punctuation">,</span> <span class="token number">0666</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	enc <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
	err <span class="token operator">:=</span> enc<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>vc<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Error in encoding json&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>json.Marshal()</code> 的函数签名是 <code>func Marshal(v interface{}) ([]byte, error)</code>，下面是数据编码后的 JSON 文本（实际上是一个 <code>[]byte</code>）：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token punctuation">{</span>
    <span class="token string-property property">&quot;FirstName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Jan&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;LastName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Kersschot&quot;</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;Addresses&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        <span class="token string-property property">&quot;Type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;private&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;City&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Aartselaar&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;Country&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Belgium&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token string-property property">&quot;Type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;work&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;City&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Boom&quot;</span><span class="token punctuation">,</span>
        <span class="token string-property property">&quot;Country&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Belgium&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">&quot;Remark&quot;</span><span class="token operator">:</span> <span class="token string">&quot;none&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>出于安全考虑，在 web 应用中最好使用 <code>json.MarshalforHTML()</code> 函数，其对数据执行 HTML 转码，所以文本可以被安全地嵌在 HTML <code>&lt;script&gt;</code> 标签中。</p><p><code>json.NewEncoder()</code> 的函数签名是 <code>func NewEncoder(w io.Writer) *Encoder</code>，返回的 <code>Encoder</code> 类型的指针可调用方法 <code>Encode(v interface{})</code>，将数据对象 <code>v</code> 的 json 编码写入 <code>io.Writer</code> <code>w</code> 中。</p><p>JSON 与 Go 类型对应如下：</p><ul><li><code>bool</code> 对应 JSON 的 boolean</li><li><code>float64</code> 对应 JSON 的 number</li><li><code>string</code> 对应 JSON 的 string</li><li><code>nil</code> 对应 JSON 的 null</li></ul><p>不是所有的数据都可以编码为 JSON 类型，只有验证通过的数据结构才能被编码：</p><ul><li>JSON 对象只支持字符串类型的 key；要编码一个 Go <code>map</code> 类型，<code>map</code> 必须是 <code>map[string]T</code>（<code>T</code> 是 <code>json</code> 包中支持的任何类型）</li><li>Channel，复杂类型和函数类型不能被编码</li><li>不支持循环数据结构；它将引起序列化进入一个无限循环</li><li>指针可以被编码，实际上是对指针指向的值进行编码（或者指针是 <code>nil</code>）</li></ul><h3 id="反序列化" tabindex="-1"><a class="header-anchor" href="#反序列化" aria-hidden="true">#</a> 反序列化：</h3><p><code>json.Unmarshal()</code> 的函数签名是 <code>func Unmarshal(data []byte, v interface{}) error</code> 把 JSON 解码为数据结构。</p><p>示例 12.16 中对 <code>vc</code> 编码后的数据为 <code>js</code> ，对其解码时，我们首先创建结构 <code>VCard</code> 用来保存解码的数据：<code>var v VCard</code> 并调用 <code>json.Unmarshal(js, &amp;v)</code>，解析 <code>[]byte</code> 中的 JSON 数据并将结果存入指针 <code>&amp;v</code> 指向的值。</p><p>虽然反射能够让 JSON 字段去尝试匹配目标结构字段；但是只有真正匹配上的字段才会填充数据。字段没有匹配不会报错，而是直接忽略掉。</p><p>（练习 15.2b <a href="exercises/chapter_15/twitter_status_json.go">twitter_status_json.go</a> 中用到了 <code>Unmarshal()</code>）</p><h3 id="解码任意的数据" tabindex="-1"><a class="header-anchor" href="#解码任意的数据" aria-hidden="true">#</a> 解码任意的数据：</h3><p>json 包使用 <code>map[string]interface{}</code> 和 <code>[]interface{}</code> 储存任意的 JSON 对象和数组；其可以被反序列化为任何的 JSON blob 存储到接口值中。</p><p>来看这个 JSON 数据，被存储在变量 <code>b</code> 中：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>b <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">\`{&quot;Name&quot;: &quot;Wednesday&quot;, &quot;Age&quot;: 6, &quot;Parents&quot;: [&quot;Gomez&quot;, &quot;Morticia&quot;]}\`</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>不用理解这个数据的结构，我们可以直接使用 <code>Unmarshal()</code> 把这个数据编码并保存在接口值中：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> f <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token operator">&amp;</span>f<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>f 指向的值是一个 <code>map</code>，key 是一个字符串，value 是自身存储作为空接口类型的值：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
	<span class="token string">&quot;Name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Wednesday&quot;</span><span class="token punctuation">,</span>
	<span class="token string">&quot;Age&quot;</span><span class="token punctuation">:</span>  <span class="token number">6</span><span class="token punctuation">,</span>
	<span class="token string">&quot;Parents&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
		<span class="token string">&quot;Gomez&quot;</span><span class="token punctuation">,</span>
		<span class="token string">&quot;Morticia&quot;</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>要访问这个数据，我们可以使用类型断言</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>m <span class="token operator">:=</span> f<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>我们可以通过 for range 语法和 type switch 来访问其实际类型：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> m <span class="token punctuation">{</span>
	<span class="token keyword">switch</span> vv <span class="token operator">:=</span> v<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> <span class="token builtin">string</span><span class="token punctuation">:</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> <span class="token string">&quot;is string&quot;</span><span class="token punctuation">,</span> vv<span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token builtin">int</span><span class="token punctuation">:</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> <span class="token string">&quot;is int&quot;</span><span class="token punctuation">,</span> vv<span class="token punctuation">)</span>

	<span class="token keyword">case</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">:</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> <span class="token string">&quot;is an array:&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> i<span class="token punctuation">,</span> u <span class="token operator">:=</span> <span class="token keyword">range</span> vv <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> u<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> <span class="token string">&quot;is of a type I don’t know how to handle&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过这种方式，你可以处理未知的 JSON 数据，同时可以确保类型安全。</p><h3 id="解码数据到结构" tabindex="-1"><a class="header-anchor" href="#解码数据到结构" aria-hidden="true">#</a> 解码数据到结构</h3><p>如果我们事先知道 JSON 数据，我们可以定义一个适当的结构并对 JSON 数据反序列化。下面的例子中，我们将定义：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> FamilyMember <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Name    <span class="token builtin">string</span>
	Age     <span class="token builtin">int</span>
	Parents <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>并对其反序列化：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> m FamilyMember
err <span class="token operator">:=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token operator">&amp;</span>m<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>程序实际上是分配了一个新的切片。这是一个典型的反序列化引用类型（指针、切片和 <code>map</code>）的例子。</p><h3 id="编码和解码流" tabindex="-1"><a class="header-anchor" href="#编码和解码流" aria-hidden="true">#</a> 编码和解码流</h3><p><code>json</code> 包提供 <code>Decoder</code> 和 <code>Encoder</code> 类型来支持常用 JSON 数据流读写。<code>NewDecoder()</code> 和 <code>NewEncoder()</code> 函数分别封装了 <code>io.Reader</code> 和 <code>io.Writer</code> 接口。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">NewDecoder</span><span class="token punctuation">(</span>r io<span class="token punctuation">.</span>Reader<span class="token punctuation">)</span> <span class="token operator">*</span>Decoder
<span class="token keyword">func</span> <span class="token function">NewEncoder</span><span class="token punctuation">(</span>w io<span class="token punctuation">.</span>Writer<span class="token punctuation">)</span> <span class="token operator">*</span>Encoder
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>要想把 JSON 直接写入文件，可以使用 <code>json.NewEncoder</code> 初始化文件（或者任何实现 <code>io.Writer</code> 的类型），并调用 <code>Encode()</code>；反过来与其对应的是使用 <code>json.NewDecoder</code> 和 <code>Decode()</code> 函数：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">NewDecoder</span><span class="token punctuation">(</span>r io<span class="token punctuation">.</span>Reader<span class="token punctuation">)</span> <span class="token operator">*</span>Decoder
<span class="token keyword">func</span> <span class="token punctuation">(</span>dec <span class="token operator">*</span>Decoder<span class="token punctuation">)</span> <span class="token function">Decode</span><span class="token punctuation">(</span>v <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>来看下接口是如何对实现进行抽象的：数据结构可以是任何类型，只要其实现了某种接口，目标或源数据要能够被编码就必须实现 <code>io.Writer</code> 或 <code>io.Reader</code> 接口。由于 Go 语言中到处都实现了 Reader 和 Writer，因此 <code>Encoder</code> 和 <code>Decoder</code> 可被应用的场景非常广泛，例如读取或写入 HTTP 连接、websockets 或文件。</p><h1 id="_12-10-xml-数据格式" tabindex="-1"><a class="header-anchor" href="#_12-10-xml-数据格式" aria-hidden="true">#</a> 12.10 XML 数据格式</h1><p>下面是与 <a href="">12.9 节</a> JSON 例子等价的 XML 版本：</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Person</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FirstName</span><span class="token punctuation">&gt;</span></span>Laura<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>FirstName</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LastName</span><span class="token punctuation">&gt;</span></span>Lynn<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>LastName</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Person</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如同 <code>json</code> 包一样，也有 <code>xml.Marshal()</code> 和 <code>xml.Unmarshal()</code> 从 XML 中编码和解码数据；但这个更通用，可以从文件中读取和写入（或者任何实现了 <code>io.Reader</code> 和 <code>io.Writer</code> 接口的类型）</p><p>和 JSON 的方式一样，XML 数据可以序列化为结构，或者从结构反序列化为 XML 数据；这些可以在例子 15.8（<a href="examples/chapter_15/twitter_status.go">twitter_status.go</a>）中看到。</p><p><code>encoding</code>/<code>xml</code> 包实现了一个简单的 XML 解析器（SAX），用来解析 XML 数据内容。下面的例子说明如何使用解析器：</p><p>示例 12.17 <a href="examples/chapter_12/xml.go">xml.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// xml.go</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;encoding/xml&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;strings&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> t<span class="token punctuation">,</span> token xml<span class="token punctuation">.</span>Token
<span class="token keyword">var</span> err <span class="token builtin">error</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	input <span class="token operator">:=</span> <span class="token string">&quot;&lt;Person&gt;&lt;FirstName&gt;Laura&lt;/FirstName&gt;&lt;LastName&gt;Lynn&lt;/LastName&gt;&lt;/Person&gt;&quot;</span>
	inputReader <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span>
	p <span class="token operator">:=</span> xml<span class="token punctuation">.</span><span class="token function">NewDecoder</span><span class="token punctuation">(</span>inputReader<span class="token punctuation">)</span>

	<span class="token keyword">for</span> t<span class="token punctuation">,</span> err <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">Token</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span><span class="token punctuation">;</span> t<span class="token punctuation">,</span> err <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">Token</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">switch</span> token <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> xml<span class="token punctuation">.</span>StartElement<span class="token punctuation">:</span>
			name <span class="token operator">:=</span> token<span class="token punctuation">.</span>Name<span class="token punctuation">.</span>Local
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Token name: %s\\n&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span>
			<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> attr <span class="token operator">:=</span> <span class="token keyword">range</span> token<span class="token punctuation">.</span>Attr <span class="token punctuation">{</span>
				attrName <span class="token operator">:=</span> attr<span class="token punctuation">.</span>Name<span class="token punctuation">.</span>Local
				attrValue <span class="token operator">:=</span> attr<span class="token punctuation">.</span>Value
				fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;An attribute is: %s %s\\n&quot;</span><span class="token punctuation">,</span> attrName<span class="token punctuation">,</span> attrValue<span class="token punctuation">)</span>
				<span class="token comment">// ...</span>
			<span class="token punctuation">}</span>
		<span class="token keyword">case</span> xml<span class="token punctuation">.</span>EndElement<span class="token punctuation">:</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;End of token&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> xml<span class="token punctuation">.</span>CharData<span class="token punctuation">:</span>
			content <span class="token operator">:=</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;This is the content: %v\\n&quot;</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span>
			<span class="token comment">// ...</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			<span class="token comment">// ...</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Token name: Person
Token name: FirstName
This is the content: Laura
End of token
Token name: LastName
This is the content: Lynn
End of token
End of token
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>包中定义了若干 XML 标签类型：StartElement，Chardata（这是从开始标签到结束标签之间的实际文本），EndElement，Comment，Directive 或 ProcInst。</p><p>包中同样定义了一个结构解析器：<code>NewParser()</code> 方法持有一个 <code>io.Reader</code>（这里具体类型是 <code>strings.NewReader</code>）并生成一个解析器类型的对象。还有一个 <code>Token()</code> 方法返回输入流里的下一个 XML token。在输入流的结尾处，会返回 (<code>nil</code>,<code>io.EOF</code>)</p><p>XML 文本被循环处理直到 <code>Token()</code> 返回一个错误，因为已经到达文件尾部，再没有内容可供处理了。通过一个 type-switch 可以根据一些 XML 标签进一步处理。Chardata 中的内容只是一个 <code>[]byte</code>，通过字符串转换让其变得可读性强一些。</p><h1 id="_12-11-用-gob-传输数据" tabindex="-1"><a class="header-anchor" href="#_12-11-用-gob-传输数据" aria-hidden="true">#</a> 12.11 用 Gob 传输数据</h1><p>Gob 是 Go 自己的以二进制形式序列化和反序列化程序数据的格式；可以在 <code>encoding</code> 包中找到。这种格式的数据简称为 Gob （即 Go binary 的缩写）。类似于 Python 的 &quot;pickle&quot; 和 Java 的 &quot;Serialization&quot;。</p><p>Gob 通常用于远程方法调用（RPCs，参见 <a href="">15.9 节</a>的 <code>rpc</code> 包）参数和结果的传输，以及应用程序和机器之间的数据传输。 它和 JSON 或 XML 有什么不同呢？Gob 特定地用于纯 Go 的环境中，例如，两个用 Go 写的服务之间的通信。这样的话服务可以被实现得更加高效和优化。 Gob 不是可外部定义，语言无关的编码方式。因此它的首选格式是二进制，而不是像 JSON 和 XML 那样的文本格式。 Gob 并不是一种不同于 Go 的语言，而是在编码和解码过程中用到了 Go 的反射。</p><p>Gob 文件或流是完全自描述的：里面包含的所有类型都有一个对应的描述，并且总是可以用 Go 解码，而不需要了解文件的内容。</p><p>只有可导出的字段会被编码，零值会被忽略。在解码结构体的时候，只有同时匹配名称和可兼容类型的字段才会被解码。当源数据类型增加新字段后，Gob 解码客户端仍然可以以这种方式正常工作：解码客户端会继续识别以前存在的字段。并且还提供了很大的灵活性，比如在发送者看来，整数被编码成没有固定长度的可变长度，而忽略具体的 Go 类型。</p><p>假如在发送者这边有一个有结构 T：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> T <span class="token keyword">struct</span> <span class="token punctuation">{</span> X<span class="token punctuation">,</span> Y<span class="token punctuation">,</span> Z <span class="token builtin">int</span> <span class="token punctuation">}</span>
<span class="token keyword">var</span> t <span class="token operator">=</span> T<span class="token punctuation">{</span>X<span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span> Y<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> Z<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>而在接收者这边可以用一个结构体 U 类型的变量 u 来接收这个值：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> U <span class="token keyword">struct</span> <span class="token punctuation">{</span> X<span class="token punctuation">,</span> Y <span class="token operator">*</span><span class="token builtin">int8</span> <span class="token punctuation">}</span>
<span class="token keyword">var</span> u U
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>在接收者中，<code>X</code> 的值是 <code>7</code>，<code>Y</code> 的值是 <code>0</code>（<code>Y</code> 的值并没有从 <code>t</code> 中传递过来，因为它是零值）</p><p>和 JSON 的使用方式一样，Gob 使用通用的 <code>io.Writer</code> 接口，通过 <code>NewEncoder()</code> 函数创建 <code>Encoder</code> 对象并调用 <code>Encode()</code>；相反的过程使用通用的 <code>io.Reader</code> 接口，通过 <code>NewDecoder()</code> 函数创建 <code>Decoder</code> 对象并调用 <code>Decode()</code>。</p><p>我们把示例 12.12 的信息写进名为 vcard.gob 的文件作为例子。这会产生一个文本可读数据和二进制数据的混合，当你试着在文本编辑中打开的时候会看到。</p><p>在示例 12.18 中你会看到一个编解码，并且以字节缓冲模拟网络传输的简单例子：</p><p>示例 12.18 <a href="examples/chapter_12/gob1.go">gob1.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// gob1.go</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;bytes&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;encoding/gob&quot;</span>
	<span class="token string">&quot;log&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> P <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	X<span class="token punctuation">,</span> Y<span class="token punctuation">,</span> Z <span class="token builtin">int</span>
	Name    <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> Q <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	X<span class="token punctuation">,</span> Y <span class="token operator">*</span><span class="token builtin">int32</span>
	Name <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Initialize the encoder and decoder.  Normally enc and dec would be      </span>
	<span class="token comment">// bound to network connections and the encoder and decoder would      </span>
	<span class="token comment">// run in different processes.      </span>
	<span class="token keyword">var</span> network bytes<span class="token punctuation">.</span>Buffer   <span class="token comment">// Stand-in for a network connection      </span>
	enc <span class="token operator">:=</span> gob<span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>network<span class="token punctuation">)</span> <span class="token comment">// Will write to network.      </span>
	dec <span class="token operator">:=</span> gob<span class="token punctuation">.</span><span class="token function">NewDecoder</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>network<span class="token punctuation">)</span>	<span class="token comment">// Will read from network.      </span>
	<span class="token comment">// Encode (send) the value.      </span>
	err <span class="token operator">:=</span> enc<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>P<span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string">&quot;Pythagoras&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;encode error:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Decode (receive) the value.      </span>
	<span class="token keyword">var</span> q Q
	err <span class="token operator">=</span> dec<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>q<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;decode error:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%q: {%d,%d}\\n&quot;</span><span class="token punctuation">,</span> q<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> q<span class="token punctuation">.</span>X<span class="token punctuation">,</span> q<span class="token punctuation">.</span>Y<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// Output:   &quot;Pythagoras&quot;: {3,4}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>示例 12.19 <a href="examples/chapter_12/gob2.go">gob2.go</a> 编码到文件：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// gob2.go</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;encoding/gob&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;os&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Address <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Type             <span class="token builtin">string</span>
	City             <span class="token builtin">string</span>
	Country          <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> VCard <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	FirstName	<span class="token builtin">string</span>
	LastName	<span class="token builtin">string</span>
	Addresses	<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Address
	Remark		<span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> content	<span class="token builtin">string</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	pa <span class="token operator">:=</span> <span class="token operator">&amp;</span>Address<span class="token punctuation">{</span><span class="token string">&quot;private&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Aartselaar&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Belgium&quot;</span><span class="token punctuation">}</span>
	wa <span class="token operator">:=</span> <span class="token operator">&amp;</span>Address<span class="token punctuation">{</span><span class="token string">&quot;work&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Boom&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Belgium&quot;</span><span class="token punctuation">}</span>
	vc <span class="token operator">:=</span> VCard<span class="token punctuation">{</span><span class="token string">&quot;Jan&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Kersschot&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Address<span class="token punctuation">{</span>pa<span class="token punctuation">,</span>wa<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;none&quot;</span><span class="token punctuation">}</span>
	<span class="token comment">// fmt.Printf(&quot;%v: \\n&quot;, vc) // {Jan Kersschot [0x126d2b80 0x126d2be0] none}:</span>
	<span class="token comment">// using an encoder:</span>
	file<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">OpenFile</span><span class="token punctuation">(</span><span class="token string">&quot;vcard.gob&quot;</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>O_CREATE<span class="token operator">|</span>os<span class="token punctuation">.</span>O_WRONLY<span class="token punctuation">,</span> <span class="token number">0666</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> file<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	enc <span class="token operator">:=</span> gob<span class="token punctuation">.</span><span class="token function">NewEncoder</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
	err <span class="token operator">:=</span> enc<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>vc<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Error in encoding gob&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>练习 12.8</strong>：<a href="exercises/chapter_12/degob.go">degob.go</a>：</p><p>写一个程序读取 vcard.gob 文件，解码并打印它的内容。</p><h1 id="_12-12-go-中的密码学" tabindex="-1"><a class="header-anchor" href="#_12-12-go-中的密码学" aria-hidden="true">#</a> 12.12 Go 中的密码学</h1><p>通过网络传输的数据必须加密，以防止被 hacker（黑客）读取或篡改，并且保证发出的数据和收到的数据检验和一致。 鉴于 Go 母公司的业务，我们毫不惊讶地看到 Go 的标准库为该领域提供了超过 30 个的包：</p><ul><li><code>hash</code> 包：实现了 <code>adler32</code>、<code>crc32</code>、<code>crc64</code> 和 <code>fnv</code> 校验；</li><li><code>crypto</code> 包：实现了其它的 hash 算法，比如 <code>md4</code>、<code>md5</code>、<code>sha1</code> 等。以及完整地实现了 <code>aes</code>、<code>blowfish</code>、<code>rc4</code>、<code>rsa</code>、<code>xtea</code> 等加密算法。</li></ul><p>下面的示例用 <code>sha1</code> 和 <code>md5</code> 计算并输出了一些校验值。</p><p>示例 12.20 <a href="examples/chapter_12/hash_sha1.go">hash_sha1.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// hash_sha1.go</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;crypto/sha1&quot;</span>
	<span class="token string">&quot;io&quot;</span>
	<span class="token string">&quot;log&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	hasher <span class="token operator">:=</span> sha1<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	io<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>hasher<span class="token punctuation">,</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span>
	b <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Result: %x\\n&quot;</span><span class="token punctuation">,</span> hasher<span class="token punctuation">.</span><span class="token function">Sum</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Result: %d\\n&quot;</span><span class="token punctuation">,</span> hasher<span class="token punctuation">.</span><span class="token function">Sum</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">//</span>
	hasher<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	data <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">&quot;We shall overcome!&quot;</span><span class="token punctuation">)</span>
	n<span class="token punctuation">,</span> err <span class="token operator">:=</span> hasher<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
	<span class="token keyword">if</span> n<span class="token operator">!=</span><span class="token function">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">||</span> err<span class="token operator">!=</span><span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Hash write error: %v / %v&quot;</span><span class="token punctuation">,</span> n<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	checksum <span class="token operator">:=</span> hasher<span class="token punctuation">.</span><span class="token function">Sum</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Result: %x\\n&quot;</span><span class="token punctuation">,</span> checksum<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Result: a94a8fe5ccb19ba61c4c0873d391e987982fbbd3
Result: [169 74 143 229 204 177 155 166 28 76 8 115 211 145 233 135 152 47 187 211]
Result: e2222bfc59850bbb00a722e764a555603bb59b2a
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过调用 <code>sha1.New()</code> 创建了一个新的 <code>hash.Hash</code> 对象，用来计算 SHA1 校验值。<code>Hash</code> 类型实际上是一个接口，它实现了 <code>io.Writer</code> 接口：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Hash <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token comment">// Write (via the embedded io.Writer interface) adds more data to the running hash.</span>
	<span class="token comment">// It never returns an error.</span>
	io<span class="token punctuation">.</span>Writer

	<span class="token comment">// Sum appends the current hash to b and returns the resulting slice.</span>
	<span class="token comment">// It does not change the underlying hash state.</span>
	<span class="token function">Sum</span><span class="token punctuation">(</span>b <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>

	<span class="token comment">// Reset resets the Hash to its initial state.</span>
	<span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// Size returns the number of bytes Sum will return.</span>
	<span class="token function">Size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span>

	<span class="token comment">// BlockSize returns the hash&#39;s underlying block size.</span>
	<span class="token comment">// The Write method must be able to accept any amount</span>
	<span class="token comment">// of data, but it may operate more efficiently if all writes</span>
	<span class="token comment">// are a multiple of the block size.</span>
	<span class="token function">BlockSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过 <code>io.WriteString</code> 或 <code>hasher.Write</code> 将给定的 <code>[]byte</code> 附加到当前的 <code>hash.Hash</code> 对象中。</p><p><strong>练习 12.9</strong>：<a href="exercises/chapter_12/hash_md5.go">hash_md5.go</a>：</p><p>在示例 12.20 中检验 md5 算法。</p><h2 id="第-13-章-错误处理与测试" tabindex="-1"><a class="header-anchor" href="#第-13-章-错误处理与测试" aria-hidden="true">#</a> 第 13 章：错误处理与测试</h2><p>Go 没有像 Java 和 .NET 那样的 <code>try/catch</code> 异常机制：不能执行抛异常操作。但是有一套 <code>defer-panic-and-recover</code> 机制（参见 <a href="">13.2</a>-<a href="">13.3</a> 节）。</p><p>Go 的设计者觉得 <code>try/catch</code> 机制的使用太泛滥了，而且从底层向更高的层级抛异常太耗费资源。他们给 Go 设计的机制也可以“捕捉”异常，但是更轻量，并且只应该作为（处理错误的）最后的手段。</p><p>Go 是怎么处理普通错误的呢？通过在函数和方法中返回错误对象作为它们的唯一或最后一个返回值——如果返回 <code>nil</code>，则没有错误发生——并且主调 (calling) 函数总是应该检查收到的错误。</p><p><strong>永远不要忽略错误，否则可能会导致程序崩溃！！</strong></p><p>处理错误并且在函数发生错误的地方给用户返回错误信息：照这样处理就算真的出了问题，你的程序也能继续运行并且通知给用户。<code>panic()</code> 和 <code>recover()</code> 是用来处理真正的异常（无法预测的错误）而不是普通的错误。</p><p>库函数通常必须返回某种错误提示给主调函数。</p><p>在前面的章节中我们了解了 Go 检查和报告错误条件的惯有方式：</p><ul><li><p>产生错误的函数会返回两个变量，一个值和一个错误码；如果后者是 <code>nil</code> 就是成功，非 <code>nil</code> 就是发生了错误。</p></li><li><p>为了防止发生错误时正在执行的函数（如果有必要的话甚至会是整个程序）被中止，在调用函数后必须检查错误。</p></li></ul><p>下面这段来自 <code>pack1</code> 包的代码 <code>Func1()</code> 测试了它的返回值：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> value<span class="token punctuation">,</span> err <span class="token operator">:=</span> pack1<span class="token punctuation">.</span><span class="token function">Func1</span><span class="token punctuation">(</span>param1<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Error %s in pack1.Func1 with parameter %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> param1<span class="token punctuation">)</span>
	<span class="token keyword">return</span>    <span class="token comment">// or: return err</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
	<span class="token comment">// Process(value)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><em>为了更清晰的代码，应该总是使用包含错误值变量的 if 复合语句</em></p><p>上例除了 <code>fmt.Printf()</code> 还可以使用 <code>log</code> 中对应的方法（参见 <a href="">13.3</a> 节和 <a href="">15.2</a> 节），如果程序中止也没关系的话甚至可以使用 <code>panic()</code>（参见后面的章节）。</p><h1 id="_13-1-错误处理" tabindex="-1"><a class="header-anchor" href="#_13-1-错误处理" aria-hidden="true">#</a> 13.1 错误处理</h1><p>Go 有一个预先定义的 error 接口类型</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> <span class="token builtin">error</span> <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>错误值用来表示异常状态；我们可以在 <a href="">5.2 节</a>中看到它的标准用法。处理文件操作的例子可以在 <a href="">12 章</a>找到；我们将在 <a href="">15 章</a>看到网络操作的例子。<code>errors</code> 包中有一个 <code>errorString</code> 结构体实现了 <code>error</code> 接口。当程序处于错误状态时可以用 <code>os.Exit(1)</code> 来中止运行。</p><h2 id="_13-1-1-定义错误" tabindex="-1"><a class="header-anchor" href="#_13-1-1-定义错误" aria-hidden="true">#</a> 13.1.1 定义错误</h2><p>任何时候当你需要一个新的错误类型，都可以用 <code>errors</code> 包（必须先 <code>import</code>）的 <code>errors.New()</code> 函数接收合适的错误信息来创建，像下面这样：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>err <span class="token operator">:=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;math - square root of negative number&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>在示例 13.1 中你可以看到一个简单的用例：</p><p>示例 13.1 <a href="examples/chapter_13/errors.go">errors.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// errors.go</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;errors&quot;</span>
	<span class="token string">&quot;fmt&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">var</span> errNotFound <span class="token builtin">error</span> <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;Not found error&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;error: %v&quot;</span><span class="token punctuation">,</span> errNotFound<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// error: Not found error</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以把它用于计算平方根函数的参数测试：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Sqrt</span><span class="token punctuation">(</span>f <span class="token builtin">float64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">float64</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> f <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span>New <span class="token punctuation">(</span><span class="token string">&quot;math - square root of negative number&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
   <span class="token comment">// implementation of Sqrt</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>你可以像下面这样调用 <code>Sqrt()</code> 函数：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> f<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">Sqrt</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Error: %s\\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>由于 <code>fmt.Printf</code> 会自动调用 <code>String()</code> 方法 （参见 <a href="">10.7 节</a>），所以错误信息 “<code>Error: math - square root of negative number</code>” 会打印出来。通常（错误信息）都会有像 <code>Error:...</code> 这样的前缀，所以你的错误信息不要以大写字母开头（注：英文只有句首单词首字母大写，这里应当是考虑到这一点）。</p><p>在大部分情况下自定义错误结构类型很有意义的，可以包含除了（低层级的）错误信息以外的其它有用信息，例如，正在进行的操作（打开文件等），全路径或名字。看下面例子中 <code>os.Open()</code> 操作触发的 <code>PathError</code> 错误：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// PathError records an error and the operation and file path that caused it.</span>
<span class="token keyword">type</span> PathError <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Op <span class="token builtin">string</span>    <span class="token comment">// &quot;open&quot;, &quot;unlink&quot;, etc.</span>
	Path <span class="token builtin">string</span>  <span class="token comment">// The associated file.</span>
	Err <span class="token builtin">error</span>  <span class="token comment">// Returned by the system call.</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>PathError<span class="token punctuation">)</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> e<span class="token punctuation">.</span>Op <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>Path <span class="token operator">+</span> <span class="token string">&quot;: &quot;</span><span class="token operator">+</span> e<span class="token punctuation">.</span>Err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果有不同错误条件可能发生，那么对实际的错误使用类型断言或类型判断（type-switch）是很有用的，并且可以根据错误场景做一些补救和恢复操作。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">//  err != nil</span>
<span class="token keyword">if</span> e<span class="token punctuation">,</span> ok <span class="token operator">:=</span> err<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>os<span class="token punctuation">.</span>PathError<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
	<span class="token comment">// remedy situation</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>或：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">switch</span> err <span class="token operator">:=</span> err<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> ParseError<span class="token punctuation">:</span>
		<span class="token function">PrintParseError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token keyword">case</span> PathError<span class="token punctuation">:</span>
		<span class="token function">PrintPathError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token operator">...</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Not a special error, just %s\\n&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>作为第二个例子考虑用 <code>json</code> 包的情况。当 <code>json.Decode()</code> 在解析 JSON 文档发生语法错误时，指定返回一个 <code>SyntaxError</code> 类型的错误：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> SyntaxError <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	msg    <span class="token builtin">string</span> <span class="token comment">// description of error</span>
<span class="token comment">// error occurred after reading Offset bytes, from which line and columnnr can be obtained</span>
	Offset <span class="token builtin">int64</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>SyntaxError<span class="token punctuation">)</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> e<span class="token punctuation">.</span>msg <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在调用代码中你可以像这样用类型断言测试错误是不是上面的类型：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> serr<span class="token punctuation">,</span> ok <span class="token operator">:=</span> err<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>json<span class="token punctuation">.</span>SyntaxError<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
	line<span class="token punctuation">,</span> col <span class="token operator">:=</span> <span class="token function">findLine</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> serr<span class="token punctuation">.</span>Offset<span class="token punctuation">)</span>
	<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;%s:%d:%d: %v&quot;</span><span class="token punctuation">,</span> f<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> line<span class="token punctuation">,</span> col<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>包也可以用额外的方法 (methods)定义特定的错误，比如 <code>net.Error</code>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> net
<span class="token keyword">type</span> Error <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>   <span class="token comment">// Is the error a timeout?</span>
	<span class="token function">Temporary</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token comment">// Is the error temporary?</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 <a href="">15.1 节</a> 我们可以看到怎么使用它。</p><p>正如你所看到的一样，所有的例子都遵循同一种命名规范：错误类型以 <code>...Error</code> 结尾，错误变量以 <code>err...</code> 或 <code>Err...</code> 开头或者直接叫 <code>err</code> 或 <code>Err</code>。</p><p><code>syscall</code> 是低阶外部包，用来提供系统基本调用的原始接口。它们返回封装整数类型错误码的 <code>syscall.Errno</code>；类型 <code>syscall.Errno</code> 实现了 <code>Error</code> 接口。</p><p>大部分 <code>syscall</code> 函数都返回一个结果和可能的错误，比如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>r<span class="token punctuation">,</span> err <span class="token operator">:=</span> syscall<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> mode<span class="token punctuation">,</span> perm<span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>os</code> 包也提供了一套像 <code>os.EINAL</code> 这样的标准错误，它们基于 <code>syscall</code> 错误：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> <span class="token punctuation">(</span>
	EPERM		Error <span class="token operator">=</span> <span class="token function">Errno</span><span class="token punctuation">(</span>syscall<span class="token punctuation">.</span>EPERM<span class="token punctuation">)</span>
	ENOENT		Error <span class="token operator">=</span> <span class="token function">Errno</span><span class="token punctuation">(</span>syscall<span class="token punctuation">.</span>ENOENT<span class="token punctuation">)</span>
	ESRCH		Error <span class="token operator">=</span> <span class="token function">Errno</span><span class="token punctuation">(</span>syscall<span class="token punctuation">.</span>ESRCH<span class="token punctuation">)</span>
	EINTR		Error <span class="token operator">=</span> <span class="token function">Errno</span><span class="token punctuation">(</span>syscall<span class="token punctuation">.</span>EINTR<span class="token punctuation">)</span>
	EIO			Error <span class="token operator">=</span> <span class="token function">Errno</span><span class="token punctuation">(</span>syscall<span class="token punctuation">.</span>EIO<span class="token punctuation">)</span>
	<span class="token operator">...</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_13-1-2-用-fmt-创建错误对象" tabindex="-1"><a class="header-anchor" href="#_13-1-2-用-fmt-创建错误对象" aria-hidden="true">#</a> 13.1.2 用 fmt 创建错误对象</h2><p>通常你想要返回包含错误参数的更有信息量的字符串，例如：可以用 <code>fmt.Errorf()</code> 来实现：它和 <code>fmt.Printf()</code> 完全一样，接收一个或多个格式占位符的格式化字符串和相应数量的占位变量。和打印信息不同的是它用信息生成错误对象。</p><p>比如在前面的平方根例子中使用：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> f <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;math: square root of negative number %g&quot;</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第二个例子：从命令行读取输入时，如果加了 <code>--help</code> 或 <code>-h</code> 标志，我们可以用有用的信息产生一个错误：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Args<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">&quot;-h&quot;</span> <span class="token operator">||</span> os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">&quot;--help&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	err <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;usage: %s infile.txt outfile.txt&quot;</span><span class="token punctuation">,</span> filepath<span class="token punctuation">.</span><span class="token function">Base</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="_13-2-运行时异常和-panic" tabindex="-1"><a class="header-anchor" href="#_13-2-运行时异常和-panic" aria-hidden="true">#</a> 13.2 运行时异常和 panic</h1><p>当发生像数组下标越界或类型断言失败这样的运行错误时，Go 运行时会触发<em>运行时 panic</em>，伴随着程序的崩溃抛出一个 <code>runtime.Error</code> 接口类型的值。这个错误值有个 <code>RuntimeError()</code> 方法用于区别普通错误。</p><p><code>panic()</code> 可以直接从代码初始化：当错误条件（我们所测试的代码）很严苛且不可恢复，程序不能继续运行时，可以使用 <code>panic()</code> 函数产生一个中止程序的运行时错误。<code>panic()</code> 接收一个做任意类型的参数，通常是字符串，在程序死亡时被打印出来。Go 运行时负责中止程序并给出调试信息。在示例 13.2 <a href="examples/chapter_13/panic.go">panic.go</a> 中阐明了它的工作方式：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Starting the program&quot;</span><span class="token punctuation">)</span>
	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;A severe error occurred: stopping the program!&quot;</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Ending the program&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出如下：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Starting the program
panic: A severe error occurred: stopping the program!
panic PC=0x4f3038
runtime.panic+0x99 /go/src/pkg/runtime/proc.c:1032
       runtime.panic(0x442938, 0x4f08e8)
main.main+0xa5 E:/Go/GoBoek/code examples/chapter 13/panic.go:8
       main.main()
runtime.mainstart+0xf 386/asm.s:84
       runtime.mainstart()
runtime.goexit /go/src/pkg/runtime/proc.c:148
       runtime.goexit()
---- Error run E:/Go/GoBoek/code examples/chapter 13/panic.exe with code Crashed
---- Program exited with code -1073741783
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>一个检查程序是否被已知用户启动的具体例子：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> user <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">Getenv</span><span class="token punctuation">(</span><span class="token string">&quot;USER&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> user <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;Unknown user: no value for $USER&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以在导入包的 <code>init()</code> 函数中检查这些。</p><p>当发生错误必须中止程序时，<code>panic()</code> 可以用于错误处理模式：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;ERROR occurred:&quot;</span> <span class="token operator">+</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><u>Go panicking</u>：</p><p>在多层嵌套的函数调用中调用 <code>panic()</code>，可以马上中止当前函数的执行，所有的 <code>defer</code> 语句都会保证执行并把控制权交还给接收到 panic 的函数调用者。这样向上冒泡直到最顶层，并执行（每层的） <code>defer</code>，在栈顶处程序崩溃，并在命令行中用传给 <code>panic()</code> 的值报告错误情况：这个终止过程就是 <em>panicking</em>。</p><p>标准库中有许多包含 <code>Must</code> 前缀的函数，像 <code>regexp.MustComplie()</code> 和 <code>template.Must()</code>；当正则表达式或模板中转入的转换字符串导致错误时，这些函数会 <code>panic()</code>。</p><p>不能随意地用 <code>panic()</code> 中止程序，必须尽力补救错误让程序能继续执行。</p><h1 id="_13-3-从-panic-中恢复-recover" tabindex="-1"><a class="header-anchor" href="#_13-3-从-panic-中恢复-recover" aria-hidden="true">#</a> 13.3 从 panic 中恢复 (recover)</h1><p>正如名字一样，这个 (<code>recover()</code>) 内建函数被用于从 panic 或错误场景中恢复：让程序可以从 panicking 重新获得控制权，停止终止过程进而恢复正常执行。</p><p><code>recover</code> 只能在 <code>defer</code> 修饰的函数（参见 <a href="">6.4 节</a>）中使用：用于取得 <code>panic()</code> 调用中传递过来的错误值，如果是正常执行，调用 <code>recover()</code> 会返回 <code>nil</code>，且没有其它效果。</p><p><u>总结</u>：<code>panic()</code> 会导致栈被展开直到 <code>defer</code> 修饰的 <code>recover()</code> 被调用或者程序中止。</p><p>下面例子中的 <code>protect()</code> 函数调用函数参数 <code>g</code> 来保护调用者防止从 <code>g</code> 中抛出的运行时 panic，并展示 panic 中的信息：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">protect</span><span class="token punctuation">(</span>g <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;done&quot;</span><span class="token punctuation">)</span>
		<span class="token comment">// Println executes normally even if there is a panic</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;run time panic: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;start&quot;</span><span class="token punctuation">)</span>
	<span class="token function">g</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//   possible runtime-error</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这跟 Java 和 .NET 这样的语言中的 catch 块类似。</p><p><code>log</code> 包实现了简单的日志功能：默认的 log 对象向标准错误输出中写入并打印每条日志信息的日期和时间。除了 <code>Println</code> 和 <code>Printf</code> 函数，其它的致命性函数都会在写完日志信息后调用 <code>os.Exit(1)</code>，那些退出函数也是如此。而 Panic 效果的函数会在写完日志信息后调用 <code>panic()</code>；可以在程序必须中止或发生了临界错误时使用它们，就像当 web 服务器不能启动时那样（参见 <a href="">15.4 节</a> 中的例子）。</p>`,166),dt=n("code",null,"Logger",-1),rt={href:"http://golang.org/pkg/log/#Logger",target:"_blank",rel:"noopener noreferrer"},kt=t(`<p>这是一个展示 <code>panic()</code>，<code>defer</code> 和 <code>recover()</code> 怎么结合使用的完整例子：</p><p>示例 13.3 <a href="examples/chapter_13/panic_recover.go">panic_recover.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// panic_recover.go</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">badCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;bad end&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> e <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> e <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Panicing %s\\r\\n&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">badCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;After bad call\\r\\n&quot;</span><span class="token punctuation">)</span> <span class="token comment">// &lt;-- would not reach</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Calling test\\r\\n&quot;</span><span class="token punctuation">)</span>
	<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Test completed\\r\\n&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Calling test
Panicing bad end
Test completed
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>defer</code>-<code>panic()</code>-<code>recover()</code> 在某种意义上也是一种像 <code>if</code>，<code>for</code> 这样的控制流机制。</p><p>Go 标准库中许多地方都用了这个机制，例如，<code>json</code> 包中的解码和 <code>regexp</code> 包中的 <code>Complie()</code> 函数。Go 库的原则是即使在包的内部使用了 <code>panic()</code>，在它的对外接口 (API) 中也必须用 <code>recover()</code> 处理成显式返回的错误。</p><h1 id="_13-4-自定义包中的错误处理和-panicking" tabindex="-1"><a class="header-anchor" href="#_13-4-自定义包中的错误处理和-panicking" aria-hidden="true">#</a> 13.4 自定义包中的错误处理和 panicking</h1><p>这是所有自定义包实现者应该遵守的最佳实践：</p><p>1）<em>在包内部，总是应该从 panic 中 recover</em>：不允许显式的超出包范围的 <code>panic()</code></p><p>2）<em>向包的调用者返回错误值（而不是 panic）。</em></p><p>在包内部，特别是在非导出函数中有很深层次的嵌套调用时，将 panic 转换成 <code>error</code> 来告诉调用方为何出错，是很实用的（且提高了代码可读性）。</p><p>下面的代码则很好地阐述了这一点。我们有一个简单的 <code>parse</code> 包（示例 13.4）用来把输入的字符串解析为整数切片；这个包有自己特殊的 <code>ParseError</code>。</p><p>当没有东西需要转换或者转换成整数失败时，这个包会 <code>panic()</code>（在函数 <code>fields2numbers()</code> 中）。但是可导出的 <code>Parse()</code> 函数会从 <code>panic()</code> 中 <code>recover()</code> 并用所有这些信息返回一个错误给调用者。为了演示这个过程，在 <a href="examples/chapter_13/panic_recover.go">panic_recover.go</a> 中 调用了 <code>parse</code> 包（示例 13.5）；不可解析的字符串会导致错误并被打印出来。</p><p>示例 13.4 <a href="examples/chapter_13/parse/parse.go">parse.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// parse.go</span>
<span class="token keyword">package</span> parse

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;strings&quot;</span>
	<span class="token string">&quot;strconv&quot;</span>
<span class="token punctuation">)</span>

<span class="token comment">// A ParseError indicates an error in converting a word into an integer.</span>
<span class="token keyword">type</span> ParseError <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Index <span class="token builtin">int</span>      <span class="token comment">// The index into the space-separated list of words.</span>
    Word  <span class="token builtin">string</span>   <span class="token comment">// The word that generated the parse error.</span>
    Err <span class="token builtin">error</span> <span class="token comment">// The raw error that precipitated this error, if any.</span>
<span class="token punctuation">}</span>

<span class="token comment">// String returns a human-readable error message.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>ParseError<span class="token punctuation">)</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;pkg parse: error parsing %q as int&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>Word<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Parse parses the space-separated words in in put as integers.</span>
<span class="token keyword">func</span> <span class="token function">Parse</span><span class="token punctuation">(</span>input <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>numbers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> r <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> r <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> ok <span class="token builtin">bool</span>
            err<span class="token punctuation">,</span> ok <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">error</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
                err <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;pkg: %v&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    fields <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Fields</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span>
    numbers <span class="token operator">=</span> <span class="token function">fields2numbers</span><span class="token punctuation">(</span>fields<span class="token punctuation">)</span>
    <span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">fields2numbers</span><span class="token punctuation">(</span>fields <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>numbers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>fields<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;no words to parse&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> idx<span class="token punctuation">,</span> field <span class="token operator">:=</span> <span class="token keyword">range</span> fields <span class="token punctuation">{</span>
        num<span class="token punctuation">,</span> err <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">Atoi</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token function">panic</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ParseError<span class="token punctuation">{</span>idx<span class="token punctuation">,</span> field<span class="token punctuation">,</span> err<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        numbers <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>numbers<span class="token punctuation">,</span> num<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>示例 13.5 <a href="examples/chapter_13/panic_package.go">panic_package.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// panic_package.go</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;./parse/parse&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> examples <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>
            <span class="token string">&quot;1 2 3 4 5&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;100 50 25 12.5 6.25&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;2 + 2 = 4&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;1st class&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ex <span class="token operator">:=</span> <span class="token keyword">range</span> examples <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Parsing %q:\\n  &quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span>
        nums<span class="token punctuation">,</span> err <span class="token operator">:=</span> parse<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token comment">// here String() method from ParseError is used</span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>nums<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Parsing &quot;1 2 3 4 5&quot;:
  [1 2 3 4 5]
Parsing &quot;100 50 25 12.5 6.25&quot;:
  pkg: pkg parse: error parsing &quot;12.5&quot; as int
Parsing &quot;2 + 2 = 4&quot;:
  pkg: pkg parse: error parsing &quot;+&quot; as int
Parsing &quot;1st class&quot;:
  pkg: pkg parse: error parsing &quot;1st&quot; as int
Parsing &quot;&quot;:
  pkg: no words to parse
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="_13-5-一种用闭包处理错误的模式" tabindex="-1"><a class="header-anchor" href="#_13-5-一种用闭包处理错误的模式" aria-hidden="true">#</a> 13.5 一种用闭包处理错误的模式</h1><p>每当函数返回时，我们应该检查是否有错误发生：但是这会导致重复乏味的代码。结合 defer/panic/recover 机制和闭包可以得到一个我们马上要讨论的更加优雅的模式。不过这个模式只有当所有的函数都是同一种签名时可用，这样就有相当大的限制。一个很好的使用它的例子是 web 应用，所有的处理函数都是下面这样：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">handler1</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>假设所有的函数都有这样的签名：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">f</span><span class="token punctuation">(</span>a type1<span class="token punctuation">,</span> b type2<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>参数的数量和类型是不相关的。</p><p>我们给这个类型一个名字：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>fType1 <span class="token operator">=</span> <span class="token keyword">func</span> <span class="token function">f</span><span class="token punctuation">(</span>a type1<span class="token punctuation">,</span> b type2<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>在我们的模式中使用了两个帮助函数：</p><p>1）<code>check()</code>：这是用来检查是否有错误和 panic 发生的函数：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">check</span><span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> <span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>2）<code>errorhandler()</code>：这是一个包装函数。接收一个 <code>fType1</code> 类型的函数 <code>fn</code> 并返回一个调用 <code>fn</code> 的函数。里面就包含有 defer/recover 机制，这在 <a href="">13.3 节</a>中有相应描述。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">errorHandler</span><span class="token punctuation">(</span>fn fType1<span class="token punctuation">)</span> fType1 <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>a type1<span class="token punctuation">,</span> b type2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> err<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">error</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
				log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;run time panic: %v&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token function">fn</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当错误发生时会 recover 并打印在日志中；除了简单的打印，应用也可以用 <code>template</code> 包（参见 <a href="">15.7 节</a>）为用户生成自定义的输出。<code>check()</code> 函数会在所有的被调函数中调用，像这样：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">f1</span><span class="token punctuation">(</span>a type1<span class="token punctuation">,</span> b type2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	f<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token comment">// call function/method</span>
	<span class="token function">check</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	t<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token comment">// call function/method</span>
	<span class="token function">check</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> err2 <span class="token operator">:=</span> <span class="token comment">// call function/method</span>
	<span class="token function">check</span><span class="token punctuation">(</span>err2<span class="token punctuation">)</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过这种机制，所有的错误都会被 recover，并且调用函数后的错误检查代码也被简化为调用 <code>check(err)</code> 即可。在这种模式下，不同的错误处理必须对应不同的函数类型；它们（错误处理）可能被隐藏在错误处理包内部。可选的更加通用的方式是用一个空接口类型的切片作为参数和返回值。</p><p>我们会在 <a href="">15.5 节</a> 的 web 应用中使用这种模式。</p><p><strong>练习 13.1</strong>：<a href="exercises/chapter_13/recover_divbyzero.go">recover_dividebyzero.go</a></p><p>用示例 13.3 中的编码模式通过整数除以 0 触发一个运行时 panic。</p><p><strong>练习 13.2</strong>：<a href="exercises/chapter_13/panic_defer.go">panic_defer.go</a></p><p>阅读下面的完整程序。不要执行它，写出程序的输出结果。然后编译执行并验证你的预想。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// panic_defer.go</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Returned normally from f.&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> r <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> r <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Recovered in f&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Calling g.&quot;</span><span class="token punctuation">)</span>
	<span class="token function">g</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Returned normally from g.&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">g</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> i <span class="token operator">&gt;</span> <span class="token number">3</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Panicking!&quot;</span><span class="token punctuation">)</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%v&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">defer</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Defer in g&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Printing in g&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
	<span class="token function">g</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Calling g.
Printing in g 0
Printing in g 1
Printing in g 2
Printing in g 3
Panicking!
Defer in g 3
Defer in g 2
Defer in g 1
Defer in g 0
Recovered in f 4
Returned normally from f.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>练习 13.3</strong>：<a href="exercises/chapter_13/panic_defer_convint.go">panic_defer_convint.go</a></p><p>写一个 <code>ConvertInt64ToInt()</code> 函数把 <code>int64</code> 值转换为 <code>int</code> 值，如果发生错误（提示：参见 <a href="">4.5.2.1 节</a>）就 <code>panic()</code> 。然后在函数 <code>IntFromInt64</code> 中调用这个函数并 <code>recover()</code>，返回一个整数和一个错误。请测试这个函数！</p><h1 id="_13-6-启动外部命令和程序" tabindex="-1"><a class="header-anchor" href="#_13-6-启动外部命令和程序" aria-hidden="true">#</a> 13.6 启动外部命令和程序</h1><p><code>os</code> 包有一个 <code>StartProcess</code> 函数可以调用或启动外部系统命令和二进制可执行文件；它的第一个参数是要运行的进程，第二个参数用来传递选项或参数，第三个参数是含有系统环境基本信息的结构体。</p><p>这个函数返回被启动进程的 id (pid)，或者启动失败返回错误。</p><p><code>exec</code> 包中也有同样功能的更简单的结构体和函数；主要是 <code>exec.Command(name string, arg ...string)</code> 和 <code>Run()</code>。首先需要用系统命令或可执行文件的名字创建一个 <code>Command</code> 对象，然后用这个对象作为接收者调用 <code>Run()</code>。下面的程序（因为是执行 Linux 命令，只能在 Linux 下面运行）演示了它们的使用：</p><p>示例 13.6 <a href="examples/chapter_13/exec.go">exec.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// exec.go</span>
<span class="token keyword">package</span> main
<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
    <span class="token string">&quot;os/exec&quot;</span>
	<span class="token string">&quot;os&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// 1) os.StartProcess //</span>
<span class="token comment">/*********************/</span>
<span class="token comment">/* Linux: */</span>
env <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Environ</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
procAttr <span class="token operator">:=</span> <span class="token operator">&amp;</span>os<span class="token punctuation">.</span>ProcAttr<span class="token punctuation">{</span>
			Env<span class="token punctuation">:</span> env<span class="token punctuation">,</span>
			Files<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>os<span class="token punctuation">.</span>File<span class="token punctuation">{</span>
				os<span class="token punctuation">.</span>Stdin<span class="token punctuation">,</span>
				os<span class="token punctuation">.</span>Stdout<span class="token punctuation">,</span>
				os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
<span class="token comment">// 1st example: list files</span>
pid<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">StartProcess</span><span class="token punctuation">(</span><span class="token string">&quot;/bin/ls&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;ls&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-l&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> procAttr<span class="token punctuation">)</span>  
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Error %v starting process!&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>  <span class="token comment">//</span>
		os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The process id is %v&quot;</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>The process id is <span class="token operator">&amp;</span><span class="token punctuation">{</span><span class="token number">2054</span> <span class="token number">0</span><span class="token punctuation">}</span>total <span class="token number">2056</span>
<span class="token operator">-</span>rwxr<span class="token operator">-</span>xr<span class="token operator">-</span>x <span class="token number">1</span> ivo ivo <span class="token number">1157555</span> <span class="token number">2011</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">16</span><span class="token punctuation">:</span><span class="token number">48</span> Mieken_exec
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">--</span>r<span class="token operator">--</span> <span class="token number">1</span> ivo ivo    <span class="token number">2124</span> <span class="token number">2011</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">16</span><span class="token punctuation">:</span><span class="token number">48</span> Mieken_exec<span class="token punctuation">.</span><span class="token keyword">go</span>
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">--</span>r<span class="token operator">--</span> <span class="token number">1</span> ivo ivo   <span class="token number">18528</span> <span class="token number">2011</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">16</span><span class="token punctuation">:</span><span class="token number">48</span> Mieken_exec_go_<span class="token punctuation">.</span><span class="token number">6</span>
<span class="token operator">-</span>rwxr<span class="token operator">-</span>xr<span class="token operator">-</span>x <span class="token number">1</span> ivo ivo  <span class="token number">913920</span> <span class="token number">2011</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">03</span> <span class="token number">16</span><span class="token punctuation">:</span><span class="token number">13</span> <span class="token builtin">panic</span><span class="token punctuation">.</span>exe
<span class="token operator">-</span>rw<span class="token operator">-</span>r<span class="token operator">--</span>r<span class="token operator">--</span> <span class="token number">1</span> ivo ivo     <span class="token number">180</span> <span class="token number">2011</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">11</span> <span class="token number">20</span><span class="token punctuation">:</span><span class="token number">39</span> <span class="token builtin">panic</span><span class="token punctuation">.</span><span class="token keyword">go</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 2nd example: show all processes</span>
pid<span class="token punctuation">,</span> err <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">StartProcess</span><span class="token punctuation">(</span><span class="token string">&quot;/bin/ps&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;ps&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-e&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-opid,ppid,comm&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> procAttr<span class="token punctuation">)</span>  

<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Error %v starting process!&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>  <span class="token comment">//</span>
		os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The process id is %v&quot;</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// 2) exec.Run //</span>
<span class="token comment">/***************/</span>
<span class="token comment">// Linux:  OK, but not for ls ?</span>
<span class="token comment">// cmd := exec.Command(&quot;ls&quot;, &quot;-l&quot;)  // no error, but doesn&#39;t show anything ?</span>
<span class="token comment">// cmd := exec.Command(&quot;ls&quot;)  		// no error, but doesn&#39;t show anything ?</span>
	cmd <span class="token operator">:=</span> exec<span class="token punctuation">.</span><span class="token function">Command</span><span class="token punctuation">(</span><span class="token string">&quot;gedit&quot;</span><span class="token punctuation">)</span>  <span class="token comment">// this opens a gedit-window</span>
	err <span class="token operator">=</span> cmd<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Error %v executing command!&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The command is %v&quot;</span><span class="token punctuation">,</span> cmd<span class="token punctuation">)</span>
<span class="token comment">// The command is &amp;{/bin/ls [ls -l] []  &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; 0xf840000210 &lt;nil&gt; true [0xf84000ea50 0xf84000e9f0 0xf84000e9c0] [0xf84000ea50 0xf84000e9f0 0xf84000e9c0] [] [] 0xf8400128c0}</span>
<span class="token punctuation">}</span>
<span class="token comment">// in Windows: uitvoering: Error fork/exec /bin/ls: The system cannot find the path specified. starting process!</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="_13-7-go-中的单元测试和基准测试" tabindex="-1"><a class="header-anchor" href="#_13-7-go-中的单元测试和基准测试" aria-hidden="true">#</a> 13.7 Go 中的单元测试和基准测试</h1><p>首先所有的包都应该有一定的必要文档，然后同样重要的是对包的测试。</p><p>在第 3 章中提到了 Go 的测试工具 gotest， 我们已经在 <a href="">9.8 节</a>中使用过了。这里我们会用更多的例子进行详细说明。</p><p>名为 testing 的包被专门用来进行自动化测试，日志和错误报告。并且还包含一些基准测试函数的功能。</p><p><u>备注：</u>gotest 是 Unix bash 脚本，所以在 Windows 下你需要配置 MINGW 环境（参见 <a href="">2.5 节</a>）；在 Windows 环境下把所有的 pkg/linux_amd64 替换成 pkg/windows。</p><p>对一个包做（单元）测试，需要写一些可以频繁（每次更新后）执行的小块测试单元来检查代码的正确性。于是我们必须写一些 Go 源文件来测试代码。测试程序必须属于被测试的包，并且文件名满足这种形式 <code>*_test.go</code>，所以测试代码和包中的业务代码是分开的。</p><p><code>_test</code> 程序不会被普通的 Go 编译器编译，所以当放应用部署到生产环境时它们不会被部署；只有 gotest 会编译所有的程序：普通程序和测试程序。</p><p>测试文件中必须导入 <code>&quot;testing&quot;</code> 包，并写一些名字以 <code>TestZzz</code> 打头的全局函数，这里的 <code>Zzz</code> 是被测试函数的字母描述，如 <code>TestFmtInterface()</code>，<code>TestPayEmployees()</code> 等。</p><p>测试函数必须有这种形式的头部：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">TestAbcde</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>T</code> 是传给测试函数的结构类型，用来管理测试状态，支持格式化测试日志，如 <code>t.Log</code>，<code>t.Error</code>，<code>t.ErrorF</code> 等。在函数的结尾把输出跟想要的结果对比，如果不等就打印一个错误，成功的测试则直接返回。</p><p>用下面这些函数来通知测试失败：</p><p>1）<code>func (t *T) Fail()</code></p><pre><code>	标记测试函数为失败，然后继续执行（剩下的测试）。
</code></pre><p>2）<code>func (t *T) FailNow()</code></p><pre><code>	标记测试函数为失败并中止执行；文件中别的测试也被略过，继续执行下一个文件。
</code></pre><p>3）<code>func (t *T) Log(args ...interface{})</code></p><pre><code>	args 被用默认的格式格式化并打印到错误日志中。
</code></pre><p>4）<code>func (t *T) Fatal(args ...interface{})</code></p><pre><code>	结合 先执行 3），然后执行 2）的效果。
</code></pre><p>运行 go test 来编译测试程序，并执行程序中所有的 <code>TestZZZ</code> 函数。如果所有的测试都通过会打印出 <code>PASS</code>。</p><p>gotest 可以接收一个或多个函数程序作为参数，并指定一些选项。</p><p>结合 <code>--chatty</code> 或 <code>-v</code> 选项，每个执行的测试函数以及测试状态会被打印。</p><p>例如：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>go <span class="token builtin class-name">test</span> fmt_test.go <span class="token parameter variable">--chatty</span>
<span class="token operator">==</span><span class="token operator">=</span> RUN fmt.TestFlagParser
--- PASS: fmt.TestFlagParser
<span class="token operator">==</span><span class="token operator">=</span> RUN fmt.TestArrayPrinter
--- PASS: fmt.TestArrayPrinter
<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>testing</code> 包中有一些类型和函数可以用来做简单的基准测试；测试代码中必须包含以 <code>BenchmarkZzz</code> 打头的函数并接收一个 <code>*testing.B</code> 类型的参数，比如：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">BenchmarkReverse</span><span class="token punctuation">(</span>b <span class="token operator">*</span>testing<span class="token punctuation">.</span>B<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>命令 <code>go test –test.bench=.*</code> 会运行所有的基准测试函数；代码中的函数会被调用 <code>N</code> 次（<code>N</code> 是非常大的数，如 <code>N = 1000000</code>），并展示 <code>N</code> 的值和函数执行的平均时间，单位为 ns（纳秒，ns/op）。如果是用 <code>testing.Benchmark()</code> 调用这些函数，直接运行程序即可。</p><p>具体可以参见 <a href="">14.16 节</a> 中用 goroutines 运行基准测试的例子以及练习 13.4：<a href="exercises/chapter_13/string_reverse_test.go">string_reverse_test.go</a></p><h1 id="_13-8-测试的具体例子" tabindex="-1"><a class="header-anchor" href="#_13-8-测试的具体例子" aria-hidden="true">#</a> 13.8 测试的具体例子</h1><p>在练习 9.4 中你写了一个叫 <a href="exercises/chapter_9/main_oddeven.go">main_oddeven.go</a> 的程序用来测试前 100 个整数是否是偶数。这个函数属于 <code>even</code> 包。</p><p>下面是一种可能的方案：</p><p>示例 13.7 <a href="examples/chapter_13/even/even_main/even_main.go">even_main.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;even/even&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i<span class="token operator">:=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;=</span><span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Is the integer %d even? %v\\n&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> even<span class="token punctuation">.</span><span class="token function">Even</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面使用了 even.go 中的 <code>even</code> 包：</p><p>示例 13.8 <a href="examples/chapter_13/even/even/even.go">even/even.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> even

<span class="token keyword">func</span> <span class="token function">Even</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>		<span class="token comment">// Exported function</span>
	<span class="token keyword">return</span> i<span class="token operator">%</span><span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Odd</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>		<span class="token comment">// Exported function</span>
	<span class="token keyword">return</span> i<span class="token operator">%</span><span class="token number">2</span> <span class="token operator">!=</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 <code>even</code> 包的路径下，我们创建一个名为 oddeven_test.go 的测试程序：</p><p>示例 13.9 <a href="examples/chapter_13/even/even/oddeven_test.go">even/oddeven_test.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> even

<span class="token keyword">import</span> <span class="token string">&quot;testing&quot;</span>

<span class="token keyword">func</span> <span class="token function">TestEven</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">Even</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">&quot; 10 must be even!&quot;</span><span class="token punctuation">)</span>
		t<span class="token punctuation">.</span><span class="token function">Fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token function">Even</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">&quot; 7 is not even!&quot;</span><span class="token punctuation">)</span>
		t<span class="token punctuation">.</span><span class="token function">Fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestOdd</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">Odd</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">&quot; 11 must be odd!&quot;</span><span class="token punctuation">)</span>
		t<span class="token punctuation">.</span><span class="token function">Fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token function">Odd</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">&quot; 10 is not odd!&quot;</span><span class="token punctuation">)</span>
		t<span class="token punctuation">.</span><span class="token function">Fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>由于测试需要具体的输入用例且不可能测试到所有的用例（非常像一个无穷的数），所以我们必须对要使用的测试用例思考再三。</p><p>至少应该包括：</p><ul><li>正常的用例</li><li>反面的用例（错误的输入，如用负数或字母代替数字，没有输入等）</li><li>边界检查用例（如果参数的取值范围是 0 到 1000，检查 0 和 1000 的情况）</li></ul><p>可以直接执行 go install 安装 <code>even</code> 或者创建一个 以下内容的 Makefile：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>include <span class="token variable"><span class="token variable">$(</span>GOROOT<span class="token variable">)</span></span>/src/Make.inc
<span class="token assign-left variable">TARG</span><span class="token operator">=</span>even
<span class="token assign-left variable">GOFILES</span><span class="token operator">=</span><span class="token punctuation">\\</span>
       even.go<span class="token punctuation">\\</span>
include <span class="token variable"><span class="token variable">$(</span>GOROOT<span class="token variable">)</span></span>/src/Make.pkg
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后执行 make（或 gomake）命令来构建归档文件 even.a</p><p>测试代码不能在 GOFILES 参数中引用，因为我们不希望生成的程序中有测试代码。如果包含了测试代码，go test 会给出错误提示！go test 会生成一个单独的包含测试代码的 <code>_test</code> 程序。</p><p>现在我们可以用命令：<code>go test</code>（或 <code>make test</code>）来测试 even 包。</p><p>因为示例 13.5 中的测试函数不会调用 t.Log 和 t.Fail，所以会得到一个 <code>PASS</code> 的结果。在这个简单例子中一切都正常执行。</p><p>为了看到失败时的输出，把函数 <code>TestEven()</code> 改为：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">TestEven</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token function">Even</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token string">&quot;Everything OK: 10 is even, just a test to see failed output!&quot;</span><span class="token punctuation">)</span>
		t<span class="token punctuation">.</span><span class="token function">Fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>现在会调用 t.Log 和 t.Fail，得到的结果如下：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token operator">--</span><span class="token operator">-</span> FAIL<span class="token punctuation">:</span> even<span class="token punctuation">.</span>TestEven <span class="token punctuation">(</span><span class="token number">0.00</span> seconds<span class="token punctuation">)</span>
Everything OK<span class="token punctuation">:</span> <span class="token number">10</span> is even<span class="token punctuation">,</span> just a test to see failed output<span class="token operator">!</span>
FAIL
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>练习 13.4：</strong><a href="exercises/chapter_13/string_reverse_test.go">string_reverse_test.go</a></p><p>为练习 7.14 <a href="exercises/chapter_7/string_reverse.go">string_reverse.go</a> 写一个单元测试。</p><p>把 string_reverse 放到自己的包 <code>strev</code> 中，只包含一个可导出函数 <code>Reverse()</code>。</p><p>实现并测试它。</p><h1 id="_13-9-用-测试数据-表驱动测试" tabindex="-1"><a class="header-anchor" href="#_13-9-用-测试数据-表驱动测试" aria-hidden="true">#</a> 13.9 用（测试数据）表驱动测试</h1><p>编写测试代码时，一个较好的办法是把测试的输入数据和期望的结果写在一起组成一个数据表：表中的每条记录都是一个含有输入和期望值的完整测试用例，有时还可以结合像测试名字这样的额外信息来让测试输出更多的信息。</p><p>实际测试时简单迭代表中的每条记录，并执行必要的测试。这在练习 <a href="exercises/chapter_13/string_reverse_test.go">13.4</a> 中有具体的应用。</p><p>可以抽象为下面的代码段：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> tests <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{</span> 	<span class="token comment">// Test table</span>
	in  <span class="token builtin">string</span>
	out <span class="token builtin">string</span>

<span class="token punctuation">}</span><span class="token punctuation">{</span>
	<span class="token punctuation">{</span><span class="token string">&quot;in1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;exp1&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">{</span><span class="token string">&quot;in2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;exp2&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">{</span><span class="token string">&quot;in3&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;exp3&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestFunction</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i<span class="token punctuation">,</span> tt <span class="token operator">:=</span> <span class="token keyword">range</span> tests <span class="token punctuation">{</span>
		s <span class="token operator">:=</span> <span class="token function">FuncToBeTested</span><span class="token punctuation">(</span>tt<span class="token punctuation">.</span>in<span class="token punctuation">)</span>
		<span class="token keyword">if</span> s <span class="token operator">!=</span> tt<span class="token punctuation">.</span>out <span class="token punctuation">{</span>
			t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;%d. %q =&gt; %q, wanted: %q&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> tt<span class="token punctuation">.</span>in<span class="token punctuation">,</span> s<span class="token punctuation">,</span> tt<span class="token punctuation">.</span>out<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果大部分函数都可以写成这种形式，那么写一个帮助函数 <code>verify()</code> 对实际测试会很有帮助：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">verify</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">,</span> testnum <span class="token builtin">int</span><span class="token punctuation">,</span> testcase<span class="token punctuation">,</span> input<span class="token punctuation">,</span> output<span class="token punctuation">,</span> expected <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> expected <span class="token operator">!=</span> output <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;%d. %s with input = %s: output %s != %s&quot;</span><span class="token punctuation">,</span> testnum<span class="token punctuation">,</span> testcase<span class="token punctuation">,</span> input<span class="token punctuation">,</span> output<span class="token punctuation">,</span> expected<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>TestFunction()</code> 则变为：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">TestFunction</span><span class="token punctuation">(</span>t <span class="token operator">*</span>testing<span class="token punctuation">.</span>T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i<span class="token punctuation">,</span> tt <span class="token operator">:=</span> <span class="token keyword">range</span> tests <span class="token punctuation">{</span>
		s <span class="token operator">:=</span> <span class="token function">FuncToBeTested</span><span class="token punctuation">(</span>tt<span class="token punctuation">.</span>in<span class="token punctuation">)</span>
		<span class="token function">verify</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token string">&quot;FuncToBeTested: &quot;</span><span class="token punctuation">,</span> tt<span class="token punctuation">.</span>in<span class="token punctuation">,</span> s<span class="token punctuation">,</span> tt<span class="token punctuation">.</span>out<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="_13-10-性能调试-分析并优化-go-程序" tabindex="-1"><a class="header-anchor" href="#_13-10-性能调试-分析并优化-go-程序" aria-hidden="true">#</a> 13.10 性能调试：分析并优化 Go 程序</h1><h2 id="_13-10-1-时间和内存消耗" tabindex="-1"><a class="header-anchor" href="#_13-10-1-时间和内存消耗" aria-hidden="true">#</a> 13.10.1 时间和内存消耗</h2><p>可以用这个便捷脚本 <em>xtime</em> 来测量：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token shebang important">#!/bin/sh</span>
/usr/bin/time <span class="token parameter variable">-f</span> <span class="token string">&#39;%Uu %Ss %er %MkB %C&#39;</span> <span class="token string">&quot;<span class="token variable">$@</span>&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>在 Unix 命令行中像这样使用 <code>xtime goprogexec</code>，这里的 progexec 是一个 Go 可执行程序，这句命令行输出类似：56.63u 0.26s 56.92r 1642640kB progexec，分别对应用户时间，系统时间，实际时间和最大内存占用。</p><h2 id="_13-10-2-用-go-test-调试" tabindex="-1"><a class="header-anchor" href="#_13-10-2-用-go-test-调试" aria-hidden="true">#</a> 13.10.2 用 go test 调试</h2><p>如果代码使用了 Go 中 <code>testing</code> 包的基准测试功能，我们可以用 gotest 标准的 <code>-cpuprofile</code> 和 <code>-memprofile</code> 标志向指定文件写入 CPU 或 内存使用情况报告。</p><p>使用方式：<code>go test -x -v -cpuprofile=prof.out -file x_test.go</code></p><p>编译执行 x_test.go 中的测试，并向 prof.out 文件中写入 cpu 性能分析信息。</p><h2 id="_13-10-3-用-pprof-调试" tabindex="-1"><a class="header-anchor" href="#_13-10-3-用-pprof-调试" aria-hidden="true">#</a> 13.10.3 用 pprof 调试</h2><p>你可以在单机程序 progexec 中引入 <code>runtime/pprof</code> 包；这个包以 pprof 可视化工具需要的格式写入运行时报告数据。对于 CPU 性能分析来说你需要添加一些代码：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> cpuprofile <span class="token operator">=</span> flag<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">&quot;cpuprofile&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;write cpu profile to file&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">*</span>cpuprofile <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
		f<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">*</span>cpuprofile<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		pprof<span class="token punctuation">.</span><span class="token function">StartCPUProfile</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>
		<span class="token keyword">defer</span> pprof<span class="token punctuation">.</span><span class="token function">StopCPUProfile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token operator">...</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>代码定义了一个名为 cpuprofile 的 flag，调用 Go flag 库来解析命令行 flag，如果命令行设置了 cpuprofile flag，则开始 CPU 性能分析并把结果重定向到那个文件（<code>os.Create</code> 用拿到的名字创建了用来写入分析数据的文件）。这个分析程序最后需要在程序退出之前调用 <code>StopCPUProfile()</code> 来刷新挂起的写操作到文件中；我们用 <code>defer</code> 来保证这一切会在 <code>main()</code> 返回时触发。</p><p>现在用这个 flag 运行程序：<code>progexec -cpuprofile=progexec.prof</code></p><p>然后可以像这样用 gopprof 工具：<code>gopprof progexec progexec.prof</code></p>`,137),vt={href:"https://github.com/gperftools/gperftools",target:"_blank",rel:"noopener noreferrer"},mt=t(`<p>如果开启了 CPU 性能分析，Go 程序会以大约每秒 100 次的频率阻塞，并记录当前执行的 goroutine 栈上的程序计数器样本。</p><p>此工具一些有趣的命令：</p><p>1）<code>topN</code></p><p>用来展示分析结果中最开头的 N 份样本，例如：<code>top5</code> 它会展示在程序运行期间调用最频繁的 5 个函数，输出如下：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Total: 3099 samples
626 20.2% 20.2% 626 20.2% scanblock
309 10.0% 30.2% 2839 91.6% main.FindLoops
...
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第 5 列表示函数的调用频度。</p><p>2）<code>web</code> 或 <code>web 函数名</code></p><p>该命令生成一份 SVG 格式的分析数据图表，并在网络浏览器中打开它（还有一个 gv 命令可以生成 PostScript 格式的数据，并在 GhostView 中打开，这个命令需要安装 graphviz）。函数被表示成不同的矩形（被调用越多，矩形越大），箭头指示函数调用链。</p><p>3）<code>list 函数名</code> 或 <code>weblist 函数名</code></p><p>展示对应函数名的代码行列表，第 2 列表示当前行执行消耗的时间，这样就很好地指出了运行过程中消耗最大的代码。</p><p>如果发现函数 <code>runtime.mallocgc</code>（分配内存并执行周期性的垃圾回收）调用频繁，那么是应该进行内存分析的时候了。找出垃圾回收频繁执行的原因，和内存大量分配的根源。</p><p>为了做到这一点必须在合适的地方添加下面的代码：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> memprofile <span class="token operator">=</span> flag<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">&quot;memprofile&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;write memory profile to this file&quot;</span><span class="token punctuation">)</span>
<span class="token operator">...</span>

<span class="token function">CallToFunctionWhichAllocatesLotsOfMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token operator">*</span>memprofile <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
	f<span class="token punctuation">,</span> err <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token operator">*</span>memprofile<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	pprof<span class="token punctuation">.</span><span class="token function">WriteHeapProfile</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>
	f<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>用 <code>-memprofile flag</code> 运行这个程序：<code>progexec -memprofile=progexec.mprof</code></p><p>然后你可以像这样再次使用 gopprof 工具：<code>gopprof progexec progexec.mprof</code></p><p><code>top5</code>，<code>list 函数名</code> 等命令同样适用，只不过现在是以 Mb 为单位测量内存分配情况，这是 top 命令输出的例子：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Total: 118.3 MB
	66.1 55.8% 55.8% 103.7 87.7% main.FindLoops
	30.5 25.8% 81.6% 30.5 25.8% main.*LSG·NewLoop
	...
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从第 1 列可以看出，最上面的函数占用了最多的内存。</p><p>同样有一个报告内存分配计数的有趣工具：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>gopprof <span class="token parameter variable">--inuse_objects</span> progexec progexec.mprof
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>对于 web 应用来说，有标准的 HTTP 接口可以分析数据。在 HTTP 服务中添加</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">import</span> <span class="token boolean">_</span> <span class="token string">&quot;http/pprof&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>会为 /debug/pprof/ 下的一些 URL 安装处理器。然后你可以用一个唯一的参数——你服务中的分析数据的 URL 来执行 gopprof 命令——它会下载并执行在线分析。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>gopprof http://localhost:6060/debug/pprof/profile <span class="token comment"># 30-second CPU profile</span>
gopprof http://localhost:6060/debug/pprof/heap <span class="token comment"># heap profile</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>在 Go-blog（引用 15）中有一篇很好的文章用具体的例子进行了分析：分析 Go 程序（2011年6月）。</p><h2 id="第-14-章-协程-goroutine-与通道-channel" tabindex="-1"><a class="header-anchor" href="#第-14-章-协程-goroutine-与通道-channel" aria-hidden="true">#</a> 第 14 章：协程 (goroutine) 与通道 (channel)</h2><p>作为一门 21 世纪的语言，Go 原生支持应用之间的通信（网络，客户端和服务端，分布式计算，参见<a href="">第 15 章</a>和程序的并发。程序可以在不同的处理器和计算机上同时执行不同的代码段。Go 语言为构建并发程序的基本代码块是协程 (goroutine) 与通道 (channel)。他们需要语言，编译器，和 runtime 的支持。Go 语言提供的垃圾回收器对并发编程至关重要。</p><p><strong>不要通过共享内存来通信，而通过通信来共享内存。</strong></p><p>通信强制协作。</p><h1 id="_14-1-并发、并行和协程" tabindex="-1"><a class="header-anchor" href="#_14-1-并发、并行和协程" aria-hidden="true">#</a> 14.1 并发、并行和协程</h1><h2 id="_14-1-1-什么是协程" tabindex="-1"><a class="header-anchor" href="#_14-1-1-什么是协程" aria-hidden="true">#</a> 14.1.1 什么是协程</h2><p>一个应用程序是运行在机器上的一个进程；进程是一个运行在自己内存地址空间里的独立执行体。一个进程由一个或多个操作系统线程组成，这些线程其实是共享同一个内存地址空间的一起工作的执行体。几乎所有&#39;正式&#39;的程序都是多线程的，以便让用户或计算机不必等待，或者能够同时服务多个请求（如 Web 服务器），或增加性能和吞吐量（例如，通过对不同的数据集并行执行代码）。一个并发程序可以在一个处理器或者内核上使用多个线程来执行任务，但是只有同一个程序在某个时间点同时运行在多核或者多处理器上才是真正的并行。</p><p>并行是一种通过使用多处理器以提高速度的能力。所以并发程序可以是并行的，也可以不是。</p><p>公认的，使用多线程的应用难以做到准确，最主要的问题是内存中的数据共享，它们会被多线程以无法预知的方式进行操作，导致一些无法重现或者随机的结果（称作<em>竞态</em>）。</p><p><strong>不要使用全局变量或者共享内存，它们会给你的代码在并发运算的时候带来危险。</strong></p><p>解决之道在于同步不同的线程，对数据加锁，这样同时就只有一个线程可以变更数据。在 Go 的标准库 <code>sync</code> 中有一些工具用来在低级别的代码中实现加锁；我们在第 <a href="">9.3</a> 节中讨论过这个问题。不过过去的软件开发经验告诉我们这会带来更高的复杂度，更容易使代码出错以及更低的性能，所以这个经典的方法明显不再适合现代多核/多处理器编程：<code>thread-per-connection</code> 模型不够有效。</p><p>Go 更倾向于其他的方式，在诸多比较合适的范式中，有个被称作 <code>Communicating Sequential Processes（顺序通信处理）</code>（CSP, C. Hoare 发明的）还有一个叫做 <code>message passing-model（消息传递）</code>（已经运用在了其他语言中，比如 Erlang）。</p><p>在 Go 中，应用程序并发处理的部分被称作 <code>goroutines（协程）</code>，它可以进行更有效的并发运算。在协程和操作系统线程之间并无一对一的关系：协程是根据一个或多个线程的可用性，映射（多路复用，执行于）在他们之上的；协程调度器在 Go 运行时很好的完成了这个工作。</p><p>协程工作在相同的地址空间中，所以共享内存的方式一定是同步的；这个可以使用 <code>sync</code> 包来实现（参见第 <a href="">9.3</a> 节），不过我们很不鼓励这样做：Go 使用 <code>channels</code> 来同步协程（可以参见第 <a href="">14.2</a> 节等章节）</p><p>当系统调用（比如等待 I/O）阻塞协程时，其他协程会继续在其他线程上工作。协程的设计隐藏了许多线程创建和管理方面的复杂工作。</p><p>协程是轻量的，比线程更轻。它们痕迹非常不明显（使用少量的内存和资源）：使用 4K 的栈内存就可以在堆中创建它们。因为创建非常廉价，必要的时候可以轻松创建并运行大量的协程（在同一个地址空间中 100,000 个连续的协程）。并且它们对栈进行了分割，从而动态的增加（或缩减）内存的使用；栈的管理是自动的，但不是由垃圾回收器管理的，而是在协程退出后自动释放。</p><p>协程可以运行在多个操作系统线程之间，也可以运行在线程之内，让你可以很小的内存占用就可以处理大量的任务。由于操作系统线程上的协程时间片，你可以使用少量的操作系统线程就能拥有任意多个提供服务的协程，而且 Go 运行时可以聪明的意识到哪些协程被阻塞了，暂时搁置它们并处理其他协程。</p><p>存在两种并发方式：确定性的（明确定义排序）和非确定性的（加锁/互斥从而未定义排序）。Go 的协程和通道理所当然的支持确定性的并发方式（例如通道具有一个 sender 和一个 receiver）。我们会在第 <a href="">14.7</a> 节中使用一个常见的算法问题（工人问题）来对比两种处理方式。</p><p>协程是通过使用关键字 <code>go</code> 调用（执行）一个函数或者方法来实现的（也可以是匿名或者 lambda 函数）。这样会在当前的计算过程中开始一个同时进行的函数，在相同的地址空间中并且分配了独立的栈，比如：<code>go sum(bigArray)</code>，在后台计算总和。</p><p>协程的栈会根据需要进行伸缩，不出现栈溢出；开发者不需要关心栈的大小。当协程结束的时候，它会静默退出：用来启动这个协程的函数不会得到任何的返回值。</p><p>任何 Go 程序都必须有的 <code>main()</code> 函数也可以看做是一个协程，尽管它并没有通过 <code>go</code> 来启动。协程可以在程序初始化的过程中运行（在 <code>init()</code> 函数中）。</p><p>在一个协程中，比如它需要进行非常密集的运算，你可以在运算循环中周期的使用 <code>runtime.Gosched()</code>：这会让出处理器，允许运行其他协程；它并不会使当前协程挂起，所以它会自动恢复执行。使用 <code>Gosched()</code> 可以使计算均匀分布，使通信不至于迟迟得不到响应。</p><h2 id="_14-1-2-并发和并行的差异" tabindex="-1"><a class="header-anchor" href="#_14-1-2-并发和并行的差异" aria-hidden="true">#</a> 14.1.2 并发和并行的差异</h2><p>Go 的并发原语提供了良好的并发设计基础：表达程序结构以便表示独立地执行的动作；所以 Go 的重点不在于并行的首要位置：并发程序可能是并行的，也可能不是。并行是一种通过使用多处理器以提高速度的能力。但往往是，一个设计良好的并发程序在并行方面的表现也非常出色。</p><p>在当前的运行时（2012 年一月）实现中，Go 默认没有并行指令，只有一个独立的核心或处理器被专门用于 Go 程序，不论它启动了多少个协程；所以这些协程是并发运行的，但他们不是并行运行的：同一时间只有一个协程会处在运行状态。</p><p>这个情况在以后可能会发生改变，不过届时，为了使你的程序可以使用多个核心运行，这时协程就真正的是并行运行了，你必须使用 <code>GOMAXPROCS</code> 变量。</p><p>这会告诉运行时有多少个协程同时执行。</p><p>并且只有 gc 编译器真正实现了协程，适当的把协程映射到操作系统线程。使用 <code>gccgo</code> 编译器，会为每一个协程创建操作系统线程。</p><h2 id="_14-1-3-使用-gomaxprocs" tabindex="-1"><a class="header-anchor" href="#_14-1-3-使用-gomaxprocs" aria-hidden="true">#</a> 14.1.3 使用 GOMAXPROCS</h2><p>在 gc 编译器下（6g 或者 8g）你必须设置 <code>GOMAXPROCS</code> 为一个大于默认值 <code>1</code> 的数值来允许运行时支持使用多于 1 个的操作系统线程，所有的协程都会共享同一个线程除非将 <code>GOMAXPROCS</code> 设置为一个大于 1 的数。当 <code>GOMAXPROCS</code> 大于 1 时，会有一个线程池管理许多的线程。通过 <code>gccgo</code> 编译器 <code>GOMAXPROCS</code> 有效的与运行中的协程数量相等。假设 <code>n</code> 是机器上处理器或者核心的数量。如果你设置环境变量 <code>GOMAXPROCS&gt;=n</code>，或者执行 <code>runtime.GOMAXPROCS(n)</code>，接下来协程会被分割（分散）到 <code>n</code> 个处理器上。更多的处理器并不意味着性能的线性提升。有这样一个经验法则，对于 n 个核心的情况设置 <code>GOMAXPROCS</code> 为 <code>n-1</code> 以获得最佳性能，也同样需要遵守这条规则：协程的数量 &gt; <code>1 + GOMAXPROCS</code> &gt; 1。</p><p>所以如果在某一时间只有一个协程在执行，不要设置 <code>GOMAXPROCS</code>！</p><p>还有一些通过实验观察到的现象：在一台 1 颗 CPU 的笔记本电脑上，增加 <code>GOMAXPROCS</code> 到 9 会带来性能提升。在一台 32 核的机器上，设置 <code>GOMAXPROCS=8</code> 会达到最好的性能，在测试环境中，更高的数值无法提升性能。如果设置一个很大的 <code>GOMAXPROCS</code> 只会带来轻微的性能下降；设置 <code>GOMAXPROCS=100</code>，使用 <code>top</code> 命令和 <code>H</code> 选项查看到只有 7 个活动的线程。</p><p>增加 <code>GOMAXPROCS</code> 的数值对程序进行并发计算是有好处的；</p><p>请看 <a href="examples/chapter_14/goroutine_select2.go">goroutine_select2.go</a></p><p>总结：<code>GOMAXPROCS</code> 等同于（并发的）线程数量，在一台核心数多于 1 个的机器上，会尽可能有等同于核心数的线程在并行运行。</p><h2 id="_14-1-4-如何用命令行指定使用的核心数量" tabindex="-1"><a class="header-anchor" href="#_14-1-4-如何用命令行指定使用的核心数量" aria-hidden="true">#</a> 14.1.4 如何用命令行指定使用的核心数量</h2><p>使用 <code>flags</code> 包，如下：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> numCores <span class="token operator">=</span> flag<span class="token punctuation">.</span><span class="token function">Int</span><span class="token punctuation">(</span><span class="token string">&quot;n&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;number of CPU cores to use&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>在 main() 中：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
runtime<span class="token punctuation">.</span><span class="token function">GOMAXPROCS</span><span class="token punctuation">(</span><span class="token operator">*</span>numCores<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>协程可以通过调用 <code>runtime.Goexit()</code> 来停止，尽管这样做几乎没有必要。</p><p>示例 14.1-<a href="examples/chapter_14/goroutine1.go">goroutine1.go</a> 介绍了概念：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;In main()&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">longWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">shortWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;About to sleep in main()&quot;</span><span class="token punctuation">)</span>
	<span class="token comment">// sleep works with a Duration in nanoseconds (ns) !</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1e9</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;At the end of main()&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">longWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Beginning longWait()&quot;</span><span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> <span class="token number">1e9</span><span class="token punctuation">)</span> <span class="token comment">// sleep for 5 seconds</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;End of longWait()&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">shortWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Beginning shortWait()&quot;</span><span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> <span class="token number">1e9</span><span class="token punctuation">)</span> <span class="token comment">// sleep for 2 seconds</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;End of shortWait()&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>In main()
About to sleep in main()
Beginning longWait()
Beginning shortWait()
End of shortWait()
End of longWait()
At the end of main() // after 10s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>main()</code>，<code>longWait()</code> 和 <code>shortWait()</code> 三个函数作为独立的处理单元按顺序启动，然后开始并行运行。每一个函数都在运行的开始和结束阶段输出了消息。为了模拟他们运算的时间消耗，我们使用了 <code>time</code> 包中的 <code>Sleep</code> 函数。<code>Sleep()</code> 可以按照指定的时间来暂停函数或协程的执行，这里使用了纳秒（<code>ns</code>，符号 <code>1e9</code> 表示 1 乘 10 的 9 次方，<code>e</code>=指数）。</p><p>他们按照我们期望的顺序打印出了消息，几乎都一样，可是我们明白这是模拟出来的，以并行的方式。我们让 <code>main()</code> 函数暂停 10 秒从而确定它会在另外两个协程之后结束。如果不这样（如果我们让 <code>main()</code> 函数停止 4 秒），<code>main()</code> 会提前结束，<code>longWait()</code> 则无法完成。如果我们不在 <code>main()</code> 中等待，协程会随着程序的结束而消亡。</p><p>当 <code>main()</code> 函数返回的时候，程序退出：它不会等待任何其他非 main 协程的结束。这就是为什么在服务器程序中，每一个请求都会启动一个协程来处理，<code>server()</code> 函数必须保持运行状态。通常使用一个无限循环来达到这样的目的。</p><p>另外，协程是独立的处理单元，一旦陆续启动一些协程，你无法确定他们是什么时候真正开始执行的。你的代码逻辑必须独立于协程调用的顺序。</p><p>为了对比使用一个线程，连续调用的情况，移除 <code>go</code> 关键字，重新运行程序。</p><p>现在输出：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>In main()
Beginning longWait()
End of longWait()
Beginning shortWait()
End of shortWait()
About to sleep in main()
At the end of main() // after 17 s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>协程更有用的一个例子应该是在一个非常长的数组中查找一个元素。</p><p>将数组分割为若干个不重复的切片，然后给每一个切片启动一个协程进行查找计算。这样许多并行的协程可以用来进行查找任务，整体的查找时间会缩短（除以协程的数量）。</p><h2 id="_14-1-5-go-协程-goroutines-和协程-coroutines" tabindex="-1"><a class="header-anchor" href="#_14-1-5-go-协程-goroutines-和协程-coroutines" aria-hidden="true">#</a> 14.1.5 Go 协程 (goroutines) 和协程 (coroutines)</h2><p>（译者注：标题中的“Go协程 (goroutines)”即是 14 章讲的协程，指的是 Go 语言中的协程。而“协程(coroutines)”指的是其他语言中的协程概念，仅在本节出现。）</p><p>在其他语言中，比如 C#，Lua 或者 Python 都有协程的概念。这个名字表明它和 Go 协程有些相似，不过有两点不同：</p><ul><li>Go 协程意味着并行（或者可以以并行的方式部署），协程一般来说不是这样的</li><li>Go 协程通过通道来通信；协程通过让出和恢复操作来通信</li></ul><p>Go 协程比协程更强大，也很容易从协程的逻辑复用到 Go 协程。</p><h1 id="_14-2-协程间的信道" tabindex="-1"><a class="header-anchor" href="#_14-2-协程间的信道" aria-hidden="true">#</a> 14.2 协程间的信道</h1><h2 id="_14-2-1-概念" tabindex="-1"><a class="header-anchor" href="#_14-2-1-概念" aria-hidden="true">#</a> 14.2.1 概念</h2><p>在第一个例子中，协程是独立执行的，他们之间没有通信。他们必须通信才会变得更有用：彼此之间发送和接收信息并且协调/同步他们的工作。协程可以使用共享变量来通信，但是很不提倡这样做，因为这种方式给所有的共享内存的多线程都带来了困难。</p><p>而 Go 有一种特殊的类型，<em>通道（channel）</em>，就像一个可以用于发送类型化数据的管道，由其负责协程之间的通信，从而避开所有由共享内存导致的陷阱；这种通过通道进行通信的方式保证了同步性。数据在通道中进行传递：<em>在任何给定时间，一个数据被设计为只有一个协程可以对其访问，所以不会发生数据竞争。</em> 数据的所有权（可以读写数据的能力）也因此被传递。</p><p>工厂的传送带是个很有用的例子。一个机器（生产者协程）在传送带上放置物品，另外一个机器（消费者协程）拿到物品并打包。</p><p>通道服务于通信的两个目的：值的交换，同步的，保证了两个计算（协程）任何时候都是可知状态。</p><figure><img src="`+L+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>通常使用这样的格式来声明通道：<code>var identifier chan datatype</code></p><p>未初始化的通道的值是 <code>nil</code>。</p><p>所以通道只能传输一种类型的数据，比如 <code>chan int</code> 或者 <code>chan string</code>，所有的类型都可以用于通道，空接口 <code>interface{}</code> 也可以，甚至可以（有时非常有用）创建通道的通道。</p><p>通道实际上是类型化消息的队列：使数据得以传输。它是先进先出(FIFO) 的结构所以可以保证发送给他们的元素的顺序（有些人知道，通道可以比作 Unix shells 中的双向管道 (two-way pipe) ）。通道也是引用类型，所以我们使用 <code>make()</code> 函数来给它分配内存。这里先声明了一个字符串通道 ch1，然后创建了它（实例化）：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> ch1 <span class="token keyword">chan</span> <span class="token builtin">string</span>
ch1 <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>当然可以更短： <code>ch1 := make(chan string)</code>。</p><p>这里我们构建一个 int 通道的通道： <code>chanOfChans := make(chan chan int)</code>。</p><p>或者函数通道：<code>funcChan := make(chan func())</code>（相关示例请看第 <a href="">14.17</a> 节）。</p><p>所以通道是第一类对象：可以存储在变量中，作为函数的参数传递，从函数返回以及通过通道发送它们自身。另外它们是类型化的，允许类型检查，比如尝试使用整数通道发送一个指针。</p><h2 id="_14-2-2-通信操作符" tabindex="-1"><a class="header-anchor" href="#_14-2-2-通信操作符" aria-hidden="true">#</a> 14.2.2 通信操作符 &lt;-</h2><p>这个操作符直观的标示了数据的传输：信息按照箭头的方向流动。</p><p>流向通道（发送）</p><p><code>ch &lt;- int1</code> 表示：用通道 <code>ch</code> 发送变量 <code>int1</code>（双目运算符，中缀 = 发送）</p><p>从通道流出（接收），三种方式：</p><p><code>int2 = &lt;- ch</code> 表示：变量 <code>int2</code> 从通道 ch（一元运算的前缀操作符，前缀 = 接收）接收数据（获取新值）；假设 <code>int2</code> 已经声明过了，如果没有的话可以写成：<code>int2 := &lt;- ch</code>。</p><p><code>&lt;- ch</code> 可以单独调用获取通道的（下一个）值，当前值会被丢弃，但是可以用来验证，所以以下代码是合法的：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> <span class="token operator">&lt;-</span> ch <span class="token operator">!=</span> <span class="token number">1000</span><span class="token punctuation">{</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>同一个操作符 <code>&lt;-</code> 既用于<strong>发送</strong>也用于<strong>接收</strong>，但 Go 会根据操作对象弄明白该干什么 。虽非强制要求，但为了可读性通道的命名通常以 <code>ch</code> 开头或者包含 <code>chan</code> 。通道的发送和接收都是原子操作：它们总是互不干扰地完成。下面的示例展示了通信操作符的使用。</p><p>示例 14.2-<a href="examples/chapter_14/goroutine2.go">goroutine2.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">)</span>

	<span class="token keyword">go</span> <span class="token function">sendData</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">getData</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>

	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1e9</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">sendData</span><span class="token punctuation">(</span>ch <span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ch <span class="token operator">&lt;-</span> <span class="token string">&quot;Washington&quot;</span>
	ch <span class="token operator">&lt;-</span> <span class="token string">&quot;Tripoli&quot;</span>
	ch <span class="token operator">&lt;-</span> <span class="token string">&quot;London&quot;</span>
	ch <span class="token operator">&lt;-</span> <span class="token string">&quot;Beijing&quot;</span>
	ch <span class="token operator">&lt;-</span> <span class="token string">&quot;Tokyo&quot;</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">getData</span><span class="token punctuation">(</span>ch <span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> input <span class="token builtin">string</span>
	<span class="token comment">// time.Sleep(2e9)</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		input <span class="token operator">=</span> <span class="token operator">&lt;-</span>ch
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s &quot;</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Washington Tripoli London Beijing tokyo
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>main()</code> 函数中启动了两个协程：<code>sendData()</code> 通过通道 ch 发送了 5 个字符串，<code>getData()</code> 按顺序接收它们并打印出来。</p><p>如果 2 个协程需要通信，你必须给他们同一个通道作为参数才行。</p><p>尝试一下如果注释掉 <code>time.Sleep(1e9)</code> 会如何。</p><p>我们发现协程之间的同步非常重要：</p><ul><li><code>main()</code> 等待了 1 秒让两个协程完成，如果不这样，<code>sendData()</code> 就没有机会输出。</li><li><code>getData()</code> 使用了无限循环：它随着 <code>sendData()</code> 的发送完成和 <code>ch</code> 变空也结束了。</li><li>如果我们移除一个或所有 <code>go</code> 关键字，程序无法运行，Go 运行时会抛出 panic：</li></ul><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>---- Error run E:/Go/Goboek/code examples/chapter 14/goroutine2.exe with code Crashed ---- Program exited with code -2147483645: panic: all goroutines are asleep-deadlock!
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>为什么会这样？运行时 (runtime) 会检查所有的协程（像本例中只有一个）是否在等待着什么东西（可从某个通道读取或者写入某个通道），这意味着程序将无法继续执行。这是死锁 (deadlock) 的一种形式，而运行时 (runtime) 可以为我们检测到这种情况。</p><p>注意：不要使用打印状态来表明通道的发送和接收顺序：由于打印状态和通道实际发生读写的时间延迟会导致和真实发生的顺序不同。</p><p>练习 14.4：解释一下为什么如果在函数 <code>getData()</code> 的一开始插入 <code>time.Sleep(2e9)</code>，不会出现错误但也没有输出呢。</p><h2 id="_14-2-3-通道阻塞" tabindex="-1"><a class="header-anchor" href="#_14-2-3-通道阻塞" aria-hidden="true">#</a> 14.2.3 通道阻塞</h2><p>默认情况下，通信是同步且无缓冲的：在有接受者接收数据之前，发送不会结束。可以想象一个无缓冲的通道在没有空间来保存数据的时候：必须要一个接收者准备好接收通道的数据然后发送者可以直接把数据发送给接收者。所以通道的发送/接收操作在对方准备好之前是阻塞的：</p><p>1）对于同一个通道，发送操作（协程或者函数中的），在接收者准备好之前是阻塞的：如果 <code>ch</code> 中的数据无人接收，就无法再给通道传入其他数据：新的输入无法在通道非空的情况下传入。所以发送操作会等待 <code>ch</code> 再次变为可用状态：就是通道值被接收时（可以传入变量）。</p><p>2）对于同一个通道，接收操作是阻塞的（协程或函数中的），直到发送者可用：如果通道中没有数据，接收者就阻塞了。</p><p>尽管这看上去是非常严格的约束，实际在大部分情况下工作的很不错。</p><p>程序 <a href="examples/chapter_14/channel_block.go">channel_block.go</a> 验证了以上理论，一个协程在无限循环中给通道发送整数数据。不过因为没有接收者，只输出了一个数字 <code>0</code>。</p><p>示例 14.3-<a href="examples/chapter_14/channel_block.go">channel_block.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ch1 <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">pump</span><span class="token punctuation">(</span>ch1<span class="token punctuation">)</span>       <span class="token comment">// pump hangs</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">&lt;-</span>ch1<span class="token punctuation">)</span> <span class="token comment">// prints only 0</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">pump</span><span class="token punctuation">(</span>ch <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		ch <span class="token operator">&lt;-</span> i
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>0
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>pump()</code> 函数为通道提供数值，也被叫做生产者。</p><p>为通道解除阻塞定义了 <code>suck()</code> 函数来在无限循环中读取通道，参见示例 14.4-<a href="examples/chapter_14/channel_block2.go">channel_block2.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">suck</span><span class="token punctuation">(</span>ch <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">&lt;-</span>ch<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 <code>main()</code> 中使用协程开始它：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">go</span> <span class="token function">pump</span><span class="token punctuation">(</span>ch1<span class="token punctuation">)</span>
<span class="token keyword">go</span> <span class="token function">suck</span><span class="token punctuation">(</span>ch1<span class="token punctuation">)</span>
time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1e9</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>给程序 1 秒的时间来运行：输出了上万个整数。</p><p>练习 14.1：<a href="exercises/chapter_14/channel_block3.go">channel_block3.go</a>：写一个通道证明它的阻塞性，开启一个协程接收通道的数据，持续 15 秒，然后给通道放入一个值。在不同的阶段打印消息并观察输出。</p><h2 id="_14-2-4-通过一个-或多个-通道交换数据进行协程同步。" tabindex="-1"><a class="header-anchor" href="#_14-2-4-通过一个-或多个-通道交换数据进行协程同步。" aria-hidden="true">#</a> 14.2.4 通过一个（或多个）通道交换数据进行协程同步。</h2><p>通信是一种同步形式：通过通道，两个协程在通信（协程会合）中某刻同步交换数据。无缓冲通道成为了多个协程同步的完美工具。</p><p>甚至可以在通道两端互相阻塞对方，形成了叫做<strong>死锁</strong>的状态。Go 运行时会检查并 <code>panic()</code>，停止程序。死锁几乎完全是由糟糕的设计导致的。</p><p>无缓冲通道会被阻塞。设计无阻塞的程序可以避免这种情况，或者使用带缓冲的通道。</p><p>练习 14.2： <a href="exercises/chapter_14/blocking.go">blocking.go</a></p><p>解释为什么下边这个程序会导致 panic：所有的协程都休眠了 - 死锁！</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">f1</span><span class="token punctuation">(</span>in <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">&lt;-</span>in<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	out <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
	out <span class="token operator">&lt;-</span> <span class="token number">2</span>
	<span class="token keyword">go</span> <span class="token function">f1</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_14-2-5-同步通道-使用带缓冲的通道" tabindex="-1"><a class="header-anchor" href="#_14-2-5-同步通道-使用带缓冲的通道" aria-hidden="true">#</a> 14.2.5 同步通道-使用带缓冲的通道</h2><p>一个无缓冲通道只能包含 1 个元素，有时显得很局限。我们给通道提供了一个缓存，可以在扩展的 <code>make</code> 命令中设置它的容量，如下：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>buf <span class="token operator">:=</span> <span class="token number">100</span>
ch1 <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p><code>buf</code> 是通道可以同时容纳的元素（这里是 <code>string</code>）个数</p><p>在缓冲满载（缓冲被全部使用）之前，给一个带缓冲的通道发送数据是不会阻塞的，而从通道读取数据也不会阻塞，直到缓冲空了。</p><p>缓冲容量和类型无关，所以可以（尽管可能导致危险）给一些通道设置不同的容量，只要他们拥有同样的元素类型。内置的 <code>cap()</code> 函数可以返回缓冲区的容量。</p><p>如果容量大于 0，通道就是异步的了：缓冲满载（发送）或变空（接收）之前通信不会阻塞，元素会按照发送的顺序被接收。如果容量是 0 或者未设置，通信仅在收发双方准备好的情况下才可以成功。</p><p>同步：<code>ch :=make(chan type, value)</code></p><ul><li><code>value == 0 -&gt; synchronous</code>, unbuffered （阻塞）</li><li><code>value &gt; 0 -&gt; asynchronous</code>, buffered（非阻塞）取决于 <code>value</code> 元素</li></ul><p>若使用通道的缓冲，你的程序会在“请求”激增的时候表现更好：更具弹性，专业术语叫：更具有伸缩性(scalable)。在设计算法时首先考虑使用无缓冲通道，只在不确定的情况下使用缓冲。</p><p>练习 14.3：<a href="exercises/chapter_14/channel_buffer.go">channel_buffer.go</a>：给 <a href="exercises/chapter_14/channel_block3.go">channel_block3.go</a> 的通道增加缓冲并观察输出有何不同。</p><h2 id="_14-2-6-协程中用通道输出结果" tabindex="-1"><a class="header-anchor" href="#_14-2-6-协程中用通道输出结果" aria-hidden="true">#</a> 14.2.6 协程中用通道输出结果</h2><p>为了知道计算何时完成，可以通过信道回报。在例子 <code>go sum(bigArray)</code> 中，要这样写：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
<span class="token keyword">go</span> <span class="token function">sum</span><span class="token punctuation">(</span>bigArray<span class="token punctuation">,</span> ch<span class="token punctuation">)</span> <span class="token comment">// bigArray puts the calculated sum on ch</span>
<span class="token comment">// .. do something else for a while</span>
sum <span class="token operator">:=</span> <span class="token operator">&lt;-</span> ch <span class="token comment">// wait for, and retrieve the sum</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>也可以使用通道来达到同步的目的，这个很有效的用法在传统计算机中称为信号量 (semaphore)。或者换个方式：通过通道发送信号告知处理已经完成（在协程中）。</p><p>在其他协程运行时让 <code>main</code> 程序无限阻塞的通常做法是在 <code>main()</code> 函数的最后放置一个 <code>select {}</code>。</p><p>也可以使用通道让 <code>main</code> 程序等待协程完成，就是所谓的信号量模式，我们会在接下来的部分讨论。</p><h2 id="_14-2-7-信号量模式" tabindex="-1"><a class="header-anchor" href="#_14-2-7-信号量模式" aria-hidden="true">#</a> 14.2.7 信号量模式</h2><p>下边的片段阐明：协程通过在通道 <code>ch</code> 中放置一个值来处理结束的信号。<code>main()</code> 协程等待 <code>&lt;-ch</code> 直到从中获取到值。</p><p>我们期望从这个通道中获取返回的结果，像这样：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">compute</span><span class="token punctuation">(</span>ch <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	ch <span class="token operator">&lt;-</span> <span class="token function">someComputation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// when it completes, signal on the channel.</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> 	<span class="token comment">// allocate a channel.</span>
	<span class="token keyword">go</span> <span class="token function">compute</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>		<span class="token comment">// start something in a goroutines</span>
	<span class="token function">doSomethingElseForAWhile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	result <span class="token operator">:=</span> <span class="token operator">&lt;-</span> ch
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个信号也可以是其他的，不返回结果，比如下面这个协程中的匿名函数 (lambda) 协程：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">// doSomething</span>
	ch <span class="token operator">&lt;-</span> <span class="token number">1</span> <span class="token comment">// Send a signal; value does not matter</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">doSomethingElseForAWhile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&lt;-</span> ch	<span class="token comment">// Wait for goroutine to finish; discard sent value.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>或者等待两个协程完成，每一个都会对切片 <code>s</code> 的一部分进行排序，片段如下：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>done <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">bool</span><span class="token punctuation">)</span>
<span class="token comment">// doSort is a lambda function, so a closure which knows the channel done:</span>
doSort <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>s <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token function">sort</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
	done <span class="token operator">&lt;-</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
i <span class="token operator">:=</span> <span class="token function">pivot</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token keyword">go</span> <span class="token function">doSort</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">go</span> <span class="token function">doSort</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">&lt;-</span>done
<span class="token operator">&lt;-</span>done
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>下边的代码，用完整的信号量模式对长度为 <code>N</code> 的 <code>float64</code> 切片进行了 <code>N</code> 个 <code>doSomething()</code> 计算并同时完成，通道 <code>sem</code> 分配了相同的长度（且包含空接口类型的元素），待所有的计算都完成后，发送信号（通过放入值）。在循环中从通道 <code>sem</code> 不停的接收数据来等待所有的协程完成。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Empty <span class="token keyword">interface</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">var</span> empty Empty
<span class="token operator">...</span>
data <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">float64</span><span class="token punctuation">,</span> N<span class="token punctuation">)</span>
res <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">float64</span><span class="token punctuation">,</span> N<span class="token punctuation">)</span>
sem <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> Empty<span class="token punctuation">,</span> N<span class="token punctuation">)</span>
<span class="token operator">...</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> xi <span class="token operator">:=</span> <span class="token keyword">range</span> data <span class="token punctuation">{</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">,</span> xi <span class="token builtin">float64</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		res<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">doSomething</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> xi<span class="token punctuation">)</span>
		sem <span class="token operator">&lt;-</span> empty
	<span class="token punctuation">}</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> xi<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// wait for goroutines to finish</span>
<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span> <span class="token operator">&lt;-</span>sem <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意上述代码中闭合函数的用法：<code>i</code>、<code>xi</code> 都是作为参数传入闭合函数的，这一做法使得每个协程（译者注：在其启动时）获得一份 <code>i</code> 和 <code>xi</code> 的单独拷贝，从而向闭合函数内部屏蔽了外层循环中的 <code>i</code> 和 <code>xi</code> 变量；否则，<code>for</code> 循环的下一次迭代会更新所有协程中 <code>i</code> 和 <code>xi</code> 的值。另一方面，切片 <code>res</code> 没有传入闭合函数，因为协程不需要 <code>res</code> 的单独拷贝。切片 <code>res</code> 也在闭合函数中但并不是参数。</p><h2 id="_14-2-8-实现并行的-for-循环" tabindex="-1"><a class="header-anchor" href="#_14-2-8-实现并行的-for-循环" aria-hidden="true">#</a> 14.2.8 实现并行的 <code>for</code> 循环</h2><p>在上一部分章节 <a href="">14.2.7</a> 的代码片段中：<code>for</code> 循环的每一个迭代是并行完成的：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">for</span> i<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> data <span class="token punctuation">{</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span> <span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">,</span> v <span class="token builtin">float64</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">doSomething</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
		<span class="token operator">...</span>
	<span class="token punctuation">}</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 <code>for</code> 循环中并行计算迭代可能带来很好的性能提升。不过所有的迭代都必须是独立完成的。有些语言比如 Fortress 或者其他并行框架以不同的结构实现了这种方式，在 Go 中用协程实现起来非常容易：</p><h2 id="_14-2-9-用带缓冲通道实现一个信号量" tabindex="-1"><a class="header-anchor" href="#_14-2-9-用带缓冲通道实现一个信号量" aria-hidden="true">#</a> 14.2.9 用带缓冲通道实现一个信号量</h2><p>信号量是实现互斥锁（排外锁）常见的同步机制，限制对资源的访问，解决读写问题，比如没有实现信号量的 <code>sync</code> 的 Go 包，使用带缓冲的通道可以轻松实现：</p><ul><li>带缓冲通道的容量和要同步的资源容量相同</li><li>通道的长度（当前存放的元素个数）与当前资源被使用的数量相同</li><li>容量减去通道的长度就是未处理的资源个数（标准信号量的整数值）</li></ul><p>不用管通道中存放的是什么，只关注长度；因此我们创建了一个长度可变但容量为 0（字节）的通道：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Empty <span class="token keyword">interface</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">type</span> semaphore <span class="token keyword">chan</span> Empty
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>将可用资源的数量 <code>N</code> 来初始化信号量 <code>semaphore</code>：<code>sem = make(semaphore, N)</code></p><p>然后直接对信号量进行操作：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// acquire n resources</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s semaphore<span class="token punctuation">)</span> <span class="token function">P</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	e <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>Empty<span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		s <span class="token operator">&lt;-</span> e
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// release n resources</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s semaphore<span class="token punctuation">)</span> <span class="token function">V</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i<span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">{</span>
		<span class="token operator">&lt;-</span> s
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以用来实现一个互斥的例子：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">/* mutexes */</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s semaphore<span class="token punctuation">)</span> <span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	s<span class="token punctuation">.</span><span class="token function">P</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s semaphore<span class="token punctuation">)</span> <span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	s<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/* signal-wait */</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s semaphore<span class="token punctuation">)</span> <span class="token function">Wait</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	s<span class="token punctuation">.</span><span class="token function">P</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s semaphore<span class="token punctuation">)</span> <span class="token function">Signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	s<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>练习 14.5：<a href="exercises/chapter_14/gosum.go">gosum.go</a>：用这种习惯用法写一个程序，开启一个协程来计算 2 个整数的和并等待计算结果并打印出来。</p><p>练习 14.6：<a href="exercises/chapter_14/producer_consumer.go">producer_consumer.go</a>：用这种习惯用法写一个程序，有两个协程，第一个提供数字 0，10，20，...，90 并将他们放入通道，第二个协程从通道中读取并打印。<code>main()</code> 等待两个协程完成后再结束。</p><p><strong>习惯用法：通道工厂模式</strong></p><p>编程中常见的另外一种模式如下：不将通道作为参数传递给协程，而用函数来生成一个通道并返回（工厂角色）；函数内有个匿名函数被协程调用。</p><p>在 <a href="examples/chapter_14/channel_block2.go">channel_block2.go</a> 加入这种模式便有了示例 14.5-<a href="examples/chapter_14/channel_idiom.go">channel_idiom.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	stream <span class="token operator">:=</span> <span class="token function">pump</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">suck</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1e9</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">pump</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
			ch <span class="token operator">&lt;-</span> i
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> ch
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">suck</span><span class="token punctuation">(</span>ch <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">&lt;-</span>ch<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_14-2-10-给通道使用-for-循环" tabindex="-1"><a class="header-anchor" href="#_14-2-10-给通道使用-for-循环" aria-hidden="true">#</a> 14.2.10 给通道使用 for 循环</h2><p><code>for</code> 循环的 <code>range</code> 语句可以用在通道 <code>ch</code> 上，便可以从通道中获取值，像这样：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">for</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> ch <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;The value is %v\\n&quot;</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>它从指定通道中读取数据直到通道关闭，才继续执行下边的代码。很明显，另外一个协程必须写入 <code>ch</code>（不然代码就阻塞在 <code>for</code> 循环了），而且必须在写入完成后才关闭。<code>suck()</code> 函数可以这样写，且在协程中调用这个动作，程序变成了这样：</p><p>示例 14.6-<a href="examples/chapter_14/channel_idiom2.go">channel_idiom2.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;time&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">suck</span><span class="token punctuation">(</span><span class="token function">pump</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1e9</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">pump</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
			ch <span class="token operator">&lt;-</span> i
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> ch
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">suck</span><span class="token punctuation">(</span>ch <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> ch <span class="token punctuation">{</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>习惯用法：通道迭代器模式</strong></p><p>这个模式用到了后边 <a href="">14.6 章</a>示例 <a href="exercises/chapter_14/producer_consumer.go">producer_consumer.go</a> 的生产者-消费者模式。通常，需要从包含了地址索引字段 <code>items</code> 的容器给通道填入元素。为容器的类型定义一个方法 <code>Iter()</code>，返回一个只读的通道（参见第 <a href="">14.2.11</a> 节）<code>items</code>，如下：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>container<span class="token punctuation">)</span> Iter <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span> <span class="token keyword">chan</span> item <span class="token punctuation">{</span>
	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> item<span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> i<span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> c<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">{</span>	<span class="token comment">// or use a for-range loop</span>
			ch <span class="token operator">&lt;-</span> c<span class="token punctuation">.</span>items<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> ch
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在协程里，一个 <code>for</code> 循环迭代容器 <code>c</code> 中的元素（对于树或图的算法，这种简单的 <code>for</code> 循环可以替换为深度优先搜索）。</p><p>调用这个方法的代码可以这样迭代容器：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">for</span> x <span class="token operator">:=</span> <span class="token keyword">range</span> container<span class="token punctuation">.</span><span class="token function">Iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>其运行在自己启动的协程中，所以上边的迭代用到了一个通道和两个协程（可能运行在不同的线程上）。 这样我们就有了一个典型的生产者-消费者模式。如果在程序结束之前，向通道写值的协程未完成工作，则这个协程不会被垃圾回收；这是设计使然。这种看起来并不符合预期的行为正是由通道这种线程安全的通信方式所导致的。如此一来，一个协程为了写入一个永远无人读取的通道而被挂起就成了一个 bug ，而并非你预想中的那样被悄悄回收掉 (garbage-collected) 了。</p><p><strong>习惯用法：生产者消费者模式</strong></p><p>假设你有 <code>Produce()</code> 函数来产生 <code>Consume()</code> 函数需要的值。它们都可以运行在独立的协程中，生产者在通道中放入给消费者读取的值。整个处理过程可以替换为无限循环：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">for</span> <span class="token punctuation">{</span>
	<span class="token function">Consume</span><span class="token punctuation">(</span><span class="token function">Produce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_14-2-11-通道的方向" tabindex="-1"><a class="header-anchor" href="#_14-2-11-通道的方向" aria-hidden="true">#</a> 14.2.11 通道的方向</h2><p>通道类型可以用注解来表示它只发送或者只接收：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> send_only <span class="token keyword">chan</span><span class="token operator">&lt;-</span> <span class="token builtin">int</span> 		<span class="token comment">// channel can only receive data</span>
<span class="token keyword">var</span> recv_only <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span>		<span class="token comment">// channel can only send data</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>只接收的通道 (<code>&lt;-chan T</code>) 无法关闭，因为关闭通道是发送者用来表示不再给通道发送值了，所以对只接收通道是没有意义的。通道创建的时候都是双向的，但也可以分配给有方向的通道变量，就像以下代码：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token comment">// bidirectional</span>
<span class="token keyword">go</span> <span class="token function">source</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
<span class="token keyword">go</span> <span class="token function">sink</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">source</span><span class="token punctuation">(</span>ch <span class="token keyword">chan</span><span class="token operator">&lt;-</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span> ch <span class="token operator">&lt;-</span> <span class="token number">1</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">sink</span><span class="token punctuation">(</span>ch <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span> <span class="token operator">&lt;-</span>ch <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>习惯用法：管道和选择器模式</strong></p><p>更具体的例子还有协程处理它从通道接收的数据并发送给输出通道：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>sendChan <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
receiveChan <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">)</span>
<span class="token keyword">go</span> <span class="token function">processChannel</span><span class="token punctuation">(</span>sendChan<span class="token punctuation">,</span> receiveChan<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">processChannel</span><span class="token punctuation">(</span>in <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> out <span class="token keyword">chan</span><span class="token operator">&lt;-</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> inValue <span class="token operator">:=</span> <span class="token keyword">range</span> in <span class="token punctuation">{</span>
		result <span class="token operator">:=</span> <span class="token operator">...</span> <span class="token comment">/// processing inValue</span>
		out <span class="token operator">&lt;-</span> result
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>通过使用方向注解来限制协程对通道的操作。</p><p>这里有一个来自 Go 指导的很赞的例子，打印了输出的素数，使用选择器（‘筛’）作为它的算法。每个 prime 都有一个选择器，如下图：</p><figure><img src="`+B+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>版本1：示例 14.7-<a href="examples/chapter_14/sieve1.go">sieve1.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// Copyright 2009 The Go Authors. All rights reserved.</span>
<span class="token comment">// Use of this source code is governed by a BSD-style</span>
<span class="token comment">// license that can be found in the LICENSE file.package main</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token comment">// Send the sequence 2, 3, 4, ... to channel &#39;ch&#39;.</span>
<span class="token keyword">func</span> <span class="token function">generate</span><span class="token punctuation">(</span>ch <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		ch <span class="token operator">&lt;-</span> i <span class="token comment">// Send &#39;i&#39; to channel &#39;ch&#39;.</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Copy the values from channel &#39;in&#39; to channel &#39;out&#39;,</span>
<span class="token comment">// removing those divisible by &#39;prime&#39;.</span>
<span class="token keyword">func</span> <span class="token function">filter</span><span class="token punctuation">(</span>in<span class="token punctuation">,</span> out <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> prime <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		i <span class="token operator">:=</span> <span class="token operator">&lt;-</span>in <span class="token comment">// Receive value of new variable &#39;i&#39; from &#39;in&#39;.</span>
		<span class="token keyword">if</span> i<span class="token operator">%</span>prime <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			out <span class="token operator">&lt;-</span> i <span class="token comment">// Send &#39;i&#39; to channel &#39;out&#39;.</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// The prime sieve: Daisy-chain filter processes together.</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token comment">// Create a new channel.</span>
	<span class="token keyword">go</span> <span class="token function">generate</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>      <span class="token comment">// Start generate() as a goroutine.</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		prime <span class="token operator">:=</span> <span class="token operator">&lt;-</span>ch
		fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>prime<span class="token punctuation">,</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">)</span>
		ch1 <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
		<span class="token keyword">go</span> <span class="token function">filter</span><span class="token punctuation">(</span>ch<span class="token punctuation">,</span> ch1<span class="token punctuation">,</span> prime<span class="token punctuation">)</span>
		ch <span class="token operator">=</span> ch1
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>协程 <code>filter(in, out chan int, prime int)</code> 拷贝整数到输出通道，丢弃掉可以被 <code>prime</code> 整除的数字。然后每个 <code>prime</code> 又开启了一个新的协程，生成器和选择器并发请求。</p><p>输出：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>2 3 5 7 11 13 17 19 23 29 31 37 41 43 47 53 59 61 67 71 73 79 83 89 97 101
103 107 109 113 127 131 137 139 149 151 157 163 167 173 179 181 191 193 197 199 211 223
227 229 233 239 241 251 257 263 269 271 277 281 283 293 307 311 313 317 331 337 347 349
353 359 367 373 379 383 389 397 401 409 419 421 431 433 439 443 449 457 461 463 467 479
487 491 499 503 509 521 523 541 547 557 563 569 571 577 587 593 599 601 607 613 617 619
631 641 643 647 653 659 661 673 677 683 691 701 709 719 727 733 739 743 751 757 761 769
773 787 797 809 811 821 823 827 829 839 853 857 859 863 877 881 883 887 907 911 919 929
937 941 947 953 967 971 977 983 991 997 1009 1013...
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第二个版本引入了上边的习惯用法：函数 <code>sieve()</code>、<code>generate()</code> 和 <code>filter()</code> 都是工厂；它们创建通道并返回，而且使用了协程的 lambda 函数。<code>main()</code> 函数现在短小清晰：它调用 <code>sieve()</code> 返回了包含素数的通道，然后通过 <code>fmt.Println(&lt;-primes)</code> 打印出来。</p><p>版本2：示例 14.8-<a href="examples/chapter_14/sieve2.go">sieve2.go</a></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// Copyright 2009 The Go Authors. All rights reserved.</span>
<span class="token comment">// Use of this source code is governed by a BSD-style</span>
<span class="token comment">// license that can be found in the LICENSE file.</span>

<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
<span class="token punctuation">)</span>

<span class="token comment">// Send the sequence 2, 3, 4, ... to returned channel</span>
<span class="token keyword">func</span> <span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
			ch <span class="token operator">&lt;-</span> i
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> ch
<span class="token punctuation">}</span>

<span class="token comment">// Filter out input values divisible by &#39;prime&#39;, send rest to returned channel</span>
<span class="token keyword">func</span> <span class="token function">filter</span><span class="token punctuation">(</span>in <span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> prime <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	out <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> i <span class="token operator">:=</span> <span class="token operator">&lt;-</span>in<span class="token punctuation">;</span> i<span class="token operator">%</span>prime <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				out <span class="token operator">&lt;-</span> i
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> out
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">sieve</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	out <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		ch <span class="token operator">:=</span> <span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token punctuation">{</span>
			prime <span class="token operator">:=</span> <span class="token operator">&lt;-</span>ch
			ch <span class="token operator">=</span> <span class="token function">filter</span><span class="token punctuation">(</span>ch<span class="token punctuation">,</span> prime<span class="token punctuation">)</span>
			out <span class="token operator">&lt;-</span> prime
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> out
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	primes <span class="token operator">:=</span> <span class="token function">sieve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token operator">&lt;-</span>primes<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="_14-3-协程的同步-关闭通道-测试阻塞的通道" tabindex="-1"><a class="header-anchor" href="#_14-3-协程的同步-关闭通道-测试阻塞的通道" aria-hidden="true">#</a> 14.3 协程的同步：关闭通道-测试阻塞的通道</h1><p>通道可以被显式的关闭；尽管它们和文件不同：不必每次都关闭。只有在当需要告诉接收者不会再提供新的值的时候，才需要关闭通道。只有发送者需要关闭通道，接收者永远不会需要。</p><p>继续看示例 <a href="examples/chapter_14/goroutine2.go">goroutine2.go</a>（示例 14.2）：我们如何在通道的 <code>sendData()</code> 完成的时候发送一个信号，<code>getData()</code> 又如何检测到通道是否关闭或阻塞？</p><p>第一个可以通过函数 <code>close(ch)</code> 来完成：这个将通道标记为无法通过发送操作 <code>&lt;-</code> 接受更多的值；给已经关闭的通道发送或者再次关闭都会导致运行时的 <code>panic()</code>。在创建一个通道后使用 <code>defer</code> 语句是个不错的办法（类似这种情况）：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">float64</span><span class="token punctuation">)</span>
<span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>第二个问题可以使用逗号 ok 模式用来检测通道是否被关闭。</p><p>如何来检测可以收到没有被阻塞（或者通道没有被关闭）？</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>v<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token operator">&lt;-</span>ch   <span class="token comment">// ok is true if v received value</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>通常和 <code>if</code> 语句一起使用：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">if</span> v<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token operator">&lt;-</span>ch<span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
  <span class="token function">process</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>或者在 <code>for</code> 循环中接收的时候，当关闭的时候使用 <code>break</code>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>v<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token operator">&lt;-</span>ch
<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
  <span class="token keyword">break</span>
<span class="token punctuation">}</span>
<span class="token function">process</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>而检测通道当前是否阻塞，需要使用 <code>select</code>（参见第 <a href="">14.4</a> 节）。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">select</span> <span class="token punctuation">{</span>
<span class="token keyword">case</span> v<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token operator">&lt;-</span>ch<span class="token punctuation">:</span>
  <span class="token keyword">if</span> ok <span class="token punctuation">{</span>
    <span class="token function">process</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;The channel is closed&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token keyword">default</span><span class="token punctuation">:</span>
  fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;The channel is blocked&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在示例程序 14.2 中使用这些可以改进为版本 <a href="examples/chapter_14/goroutine3.go">goroutine3.go</a>，输出相同。</p><p>实现非阻塞通道的读取，需要使用 <code>select</code>（参见第 <a href="">14.4</a> 节）。</p><p>示例 14.9-<a href="examples/chapter_14/goroutine3.go">goroutine3.go</a>：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">&quot;fmt&quot;</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">sendData</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
	<span class="token function">getData</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">sendData</span><span class="token punctuation">(</span>ch <span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ch <span class="token operator">&lt;-</span> <span class="token string">&quot;Washington&quot;</span>
	ch <span class="token operator">&lt;-</span> <span class="token string">&quot;Tripoli&quot;</span>
	ch <span class="token operator">&lt;-</span> <span class="token string">&quot;London&quot;</span>
	ch <span class="token operator">&lt;-</span> <span class="token string">&quot;Beijing&quot;</span>
	ch <span class="token operator">&lt;-</span> <span class="token string">&quot;Tokio&quot;</span>
	<span class="token function">close</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">getData</span><span class="token punctuation">(</span>ch <span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		input<span class="token punctuation">,</span> open <span class="token operator">:=</span> <span class="token operator">&lt;-</span>ch
		<span class="token keyword">if</span> <span class="token operator">!</span>open <span class="token punctuation">{</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s &quot;</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>改变了以下代码：</p><ul><li>现在只有 <code>sendData()</code> 是协程，<code>getData()</code> 和 <code>main()</code> 在同一个线程中：</li></ul><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">go</span> <span class="token function">sendData</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
<span class="token function">getData</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>在 <code>sendData()</code> 函数的最后，关闭了通道：</li></ul><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">sendData</span><span class="token punctuation">(</span>ch <span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	ch <span class="token operator">&lt;-</span> <span class="token string">&quot;Washington&quot;</span>
	ch <span class="token operator">&lt;-</span> <span class="token string">&quot;Tripoli&quot;</span>
	ch <span class="token operator">&lt;-</span> <span class="token string">&quot;London&quot;</span>
	ch <span class="token operator">&lt;-</span> <span class="token string">&quot;Beijing&quot;</span>
	ch <span class="token operator">&lt;-</span> <span class="token string">&quot;Tokio&quot;</span>
	<span class="token function">close</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>在 <code>for</code> 循环的 <code>getData()</code> 中，在每次接收通道的数据之前都使用 <code>if !open</code> 来检测：</li></ul><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">for</span> <span class="token punctuation">{</span>
		input<span class="token punctuation">,</span> open <span class="token operator">:=</span> <span class="token operator">&lt;-</span>ch
		<span class="token keyword">if</span> <span class="token operator">!</span>open <span class="token punctuation">{</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s &quot;</span><span class="token punctuation">,</span> input<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用 for-range 语句来读取通道是更好的办法，因为这会自动检测通道是否关闭：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">for</span> input <span class="token operator">:=</span> <span class="token keyword">range</span> ch <span class="token punctuation">{</span>
  	<span class="token function">process</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>阻塞和生产者-消费者模式：</p><p>在<a href="">第 14.2.10 节</a>的通道迭代器中，两个协程经常是一个阻塞另外一个。如果程序工作在多核心的机器上，大部分时间只用到了一个处理器。可以通过使用带缓冲（缓冲空间大于 0）的通道来改善。比如，缓冲大小为 100，迭代器在阻塞之前，至少可以从容器获得 100 个元素。如果消费者协程在独立的内核运行，就有可能让协程不会出现阻塞。</p><p>由于容器中元素的数量通常是已知的，需要让通道有足够的容量放置所有的元素。这样，迭代器就不会阻塞（尽管消费者协程仍然可能阻塞）。然而，这实际上加倍了迭代容器所需要的内存使用量，所以通道的容量需要限制一下最大值。记录运行时间和性能测试可以帮助你找到最小的缓存容量带来最好的性能。</p><h2 id="第-15-章-网络、模板与网页应用" tabindex="-1"><a class="header-anchor" href="#第-15-章-网络、模板与网页应用" aria-hidden="true">#</a> 第 15 章：网络、模板与网页应用</h2><h2 id="第-16-章-常见的陷阱与错误" tabindex="-1"><a class="header-anchor" href="#第-16-章-常见的陷阱与错误" aria-hidden="true">#</a> 第 16 章：常见的陷阱与错误</h2><h2 id="第-17-章-模式" tabindex="-1"><a class="header-anchor" href="#第-17-章-模式" aria-hidden="true">#</a> 第 17 章：模式</h2><h2 id="第-18-章-出于性能考虑的实用代码片段" tabindex="-1"><a class="header-anchor" href="#第-18-章-出于性能考虑的实用代码片段" aria-hidden="true">#</a> 第 18 章：出于性能考虑的实用代码片段</h2><h2 id="第-19-章-构建一个完整的应用程序" tabindex="-1"><a class="header-anchor" href="#第-19-章-构建一个完整的应用程序" aria-hidden="true">#</a> 第 19 章：构建一个完整的应用程序</h2><h2 id="第-20-章-go-语言在-google-app-engine-的使用" tabindex="-1"><a class="header-anchor" href="#第-20-章-go-语言在-google-app-engine-的使用" aria-hidden="true">#</a> 第 20 章：Go 语言在 Google App Engine 的使用</h2><h2 id="第-21-章-真实世界中-go-的使用" tabindex="-1"><a class="header-anchor" href="#第-21-章-真实世界中-go-的使用" aria-hidden="true">#</a> 第 21 章：真实世界中 Go 的使用</h2>`,266);function bt(gt,ft){const e=c("ExternalLinkIcon"),p=c("center");return l(),u("div",null,[D,n("p",null,[s("你可以通过访问本书的 "),n("a",U,[s("官方网站"),a(e)]),s(" 下载书中的代码，并获得有关本书的勘误情况和内容更新。")]),j,a(p,null,{default:o(()=>[s("图 1.1 Go 语言设计者：Griesemer、Thompson 和 Pike")]),_:1}),V,H,z,n("p",null,[s("作为一个开源项目，Go 语言借助开源社区的有生力量达到快速地发展，并吸引更多的开发者来使用并改善它。自该开源项目发布以来，超过 200 名非谷歌员工的贡献者对 Go 语言核心部分提交了超过 1000 个修改建议。在过去的 18 个月里，又有 150 开发者贡献了新的核心代码。这俨然形成了世界上最大的开源团队，并使该项目跻身 "),n("a",J,[s("Ohloh"),a(e)]),s(" 前 2% 的行列。大约在 2011 年 4 月 10 日，谷歌开始抽调员工进入全职开发 Go 语言项目。开源化的语言显然能够让更多的开发者参与其中并加速它的发展速度。Andrew Gerrand 在 2010 年加入到开发团队中成为共同开发者与支持者。")]),n("p",null,[s("在 Go 语言在 2010 年 1 月 8 日被 "),n("a",X,[s("Tiobe"),a(e)]),s("（闻名于它的编程语言流行程度排名）宣布为 “2009 年年度语言” 后，引起各界很大的反响。目前 Go 语言在这项排名中的最高记录是在 2017 年 1 月创下的第13名，流行程度 2.325%。")]),K,$,Y,n("p",null,[s("Go 语言的官方网站是 "),n("a",Z,[s("golang.org"),a(e)]),s("，这个站点采用 Python 作为前端，并且使用 Go 语言自带的工具 godoc 运行在 Google App Engine 上来作为 Web 服务器提供文本内容。在官网的首页有一个功能叫做 Go Playground，是一个 Go 代码的简单编辑器的沙盒，它可以在没有安装 Go 语言的情况下在你的浏览器中编译并运行 Go，它提供了一些示例，其中包括国际惯例 “Hello, World!”。")]),n("p",null,[s("更多的信息详见 "),n("a",Q,[s("github.com/golang/go"),a(e)]),s("，Go 项目 Bug 追踪和功能预期详见 "),n("a",nn,[s("github.com/golang/go/issues"),a(e)]),s("。")]),sn,an,a(p,null,{default:o(()=>[s("图1.2 Go 语言 Logo")]),_:1}),n("p",null,[s("谷歌邮件列表 "),n("a",en,[s("golang-nuts"),a(e)]),s(" 非常活跃，每天的讨论和问题解答数以百计。")]),n("p",null,[s("关于 Go 语言在 Google App Engine 的应用，这里有一个单独的邮件列表 "),n("a",tn,[s("google-appengine-go"),a(e)]),s("，不过 2 个邮件列表的讨论内容并不是分得很清楚，都会涉及到相关的话题。"),n("a",pn,[s("go-lang.cat-v.org/"),a(e)]),s(" 是 Go 语言开发社区的资源站，"),n("a",on,[s("irc.freenode.net"),a(e)]),s(" 的 #go-nuts 是官方的 Go IRC 频道。")]),n("p",null,[n("a",cn,[s("@golang"),a(e)]),s(" 是 Go 语言在 Twitter 的官方帐号，大家一般使用 #golang 作为话题标签。")]),n("p",null,[s("这里还有一个在 Linked-in 的小组："),n("a",ln,[s("www.linkedin.com/groups?gid=2524765&trk=myg_ugrp_ovr"),a(e)]),s("。")]),n("p",null,[s("Go 编程语言的维基百科："),n("a",un,[s("en.wikipedia.org/wiki/Go_(programming_language)"),a(e)])]),n("p",null,[s("Go 语言相关资源的搜索引擎页面："),n("a",dn,[s("gowalker.org"),a(e)])]),n("p",null,[s("Go 语言还有一个运行在 Google App Engine 上的 "),n("a",rn,[s("Go Tour"),a(e)]),s("，你也可以通过执行命令 "),kn,s(" 安装到你的本地机器上。对于中文读者，可以访问该指南的 "),n("a",vn,[s("中文版本"),a(e)]),s("，或通过命令 "),mn,s(" 进行安装。")]),bn,n("p",null,[s("Go 语言有一套完整的编码规范，你可以在 "),n("a",gn,[s("Go 语言编码规范"),a(e)]),s(" 页面进行查看。")]),fn,n("p",null,[n("a",hn,[s("LALR"),a(e)]),s(" 是 Go 语言的语法标准，你也可以在 "),n("a",yn,[wn,a(e)]),s(" 中查看到，这种语法标准在编译时不需要符号表来协助解析。")]),qn,n("p",null,[s("Go 语言一个非常好的目标就是实现所谓的复杂事件处理（"),n("a",_n,[s("CEP"),a(e)]),s("），这项技术要求海量并行支持，高度的抽象化和高性能。当我们进入到物联网时代，CEP 必然会成为人们关注的焦点。")]),xn,Gn,Pn,n("p",null,[s("如果你想知道一些其它组织使用Go语言开发的实际应用项目，你可以到 "),n("a",Sn,[s("使用 Go 的组织"),a(e)]),s(" 页面进行查看。出于隐私保护的考虑，许多公司的项目都没有展示在这个页面。我们将会在"),Tn,s(" 讨论到一个使用 Go 语言开发的大型存储区域网络 (SAN) 案例。")]),Cn,n("p",null,[s("关于 Go 语言开发团队对于这些方面的讨论，你可以通过 "),n("a",An,[s("Go 常见问题"),a(e)]),s(" 页面查看。")]),On,n("ol",null,[n("li",null,[In,Fn,Nn,En,Rn,Mn,a(p,null,{default:o(()=>[s("图2.1 gc 编译器支持的处理器架构")]),_:1}),Ln,n("p",null,[s("如果你想获得更深层次的信息，你可以在目录 "),n("a",Bn,[Wn,a(e)]),s(" 下找到编译器和链接器的源代码。Go 语言本身是由 C 语言开发的，而不是 Go 语言（Go 1.5 开始自举）。词法分析程序是 GNU bison，语法分析程序是名为 "),n("a",Dn,[Un,a(e)]),s(" 的 yacc 文件，它会在同一目录输出 "),jn,s(" 文件。如果你想知道更多有关构建过程的信息，你可以在 "),n("a",Vn,[Hn,a(e)]),s(" 中找到。")]),zn]),Jn]),Xn,n("p",null,[s("在接下来的章节中，我们将会讨论如何在 Linux、Mac OS X 和 Windows 上安装 Go 语言。在 FreeBSD 上的安装和 Linux 非常类似。开发团队正在尝试将 Go 语言移植到其它例如 OpenBSD、DragonFlyBSD、NetBSD、Plan 9、Haiku 和 Solaris 操作系统上，你可以在这个页面找到最近的动态："),n("a",Kn,[s("Go Porting Efforts"),a(e)]),s("。")]),$n,n("p",null,[s("如果你能够自己下载并编译 Go 的源代码的话,对你来说是非常有教育意义的，你可以根据这个页面找到安装指南和下载地址："),n("a",Yn,[s("Download the Go distribution"),a(e)]),s("。")]),Zn,n("ol",null,[Qn,n("li",null,[ns,n("p",null,[s("从 "),n("a",ss,[s("官方页面"),a(e)]),s(" 或 "),n("a",as,[s("国内镜像"),a(e)]),s(" 下载 Go 的源码包到你的计算机上，然后将解压后的目录 "),es,s(" 通过命令移动到 "),ts,s(" 所指向的位置。")]),ps]),n("li",null,[os,a(p,null,{default:o(()=>[s("图 2.3 完成编译后在终端打印的信息")]),_:1}),cs]),is,n("li",null,[ls,n("p",null,[s("你可以在 "),n("a",us,[s("发布历史"),a(e)]),s(" 页面查看到最新的稳定版。")]),ds,rs,ks,vs])]),ms,bs,n("p",null,[s("你可以通过该页面查看有关在 PowerPC 处理器上的移植进度："),n("a",gs,[s("https://codedr-go-ppc.googlecode.com/hg/"),a(e)]),s("。")]),fs,hs,n("p",null,[s("你可以在 "),n("a",ys,[s("下载页面"),a(e)]),s(" 页面下载到 Mac 系统下的一键安装包或源代码自行编译。")]),ws,qs,n("p",null,[s("你可以在 "),n("a",_s,[s("下载页面"),a(e)]),s(" 页面下载到 Windows 系统下的一键安装包。")]),xs,n("p",null,[s("如果你想要在 Windows 下使用 cgo （调用 C 语言写的代码），则需要安装 "),n("a",Gs,[s("MinGW"),a(e)]),s("，一般推荐安装 "),n("a",Ps,[s("TDM-GCC"),a(e)]),s("。如果你使用的是 64 位操作系统，请务必安装 64 位版本的 MinGW。安装完成进行环境变量等相关配置即可使用。")]),Ss,n("p",null,[s("如果你想要在 Windows 下的虚拟机里的 Linux 系统上安装 Go，你可以选择使用虚拟机软件 "),n("a",Ts,[s("VMware"),a(e)]),s("，下载 "),n("a",Cs,[s("VMware player"),a(e)]),s("，搜索并下载一个你喜欢的 Linux 发行版镜像，然后安装到虚拟机里，安装 Go 的流程参考第 2.3 节中的内容。")]),As,Os,n("p",null,[n("a",Is,[s("README.md"),a(e)]),s(", AUTHORS, CONTRIBUTORS, LICENSE")]),Fs,n("p",null,[s("runtime 主要由 C 语言编写（Go 1.5 开始自举），并且是每个 Go 包的最顶级包。你可以在目录 "),n("a",Ns,[Es,a(e)]),s(" 中找到相关内容。")]),Rs,Ms,Ls,n("p",null,[s("因为 Go 具有像动态语言那样快速编译的能力，自然而然地就有人会问 Go 语言能否在 REPL (read-eval-print loop) 编程环境下实现。Sebastien Binet 已经使用这种环境实现了一个 Go 解释器，你可以在这个页面找到："),n("a",Bs,[s("https://github.com/sbinet/igo"),a(e)]),s("。")]),Ws,Ds,n("p",null,[s("你可以通过查阅 "),n("a",Us,[s("编辑器和 IDE 扩展"),a(e)]),s(" 页面来获取 Go 开发工具的最新信息。")]),js,n("p",null,[n("strong",null,[n("a",Vs,[s("Sublime Text"),a(e)])]),s(" 是一个革命性的跨平台 (Linux、Mac OS X、Windows)文本编辑器，它支持编写非常多的编程语言代码。对于 Go 而言，它有一个插件叫做 "),n("a",Hs,[s("GoSublime"),a(e)]),s(" 来支持代码补全和代码模版。")]),zs,n("p",null,[n("strong",null,[n("a",Js,[s("IntelliJ Idea Plugin"),a(e)])]),s(" 是一个 IntelliJ IDEA 的插件，具有很好的操作体验和代码补全功能。")]),n("p",null,[n("strong",null,[n("a",Xs,[s("LiteIDE"),a(e)])]),s(" 这是一款专门针对 Go 开发的集成开发环境，在编辑、编译和运行 Go 程序和项目方面都有非常好的支持。同时还包括了对源代码的抽象语法树视图和一些内置工具（此开发环境由国人 vfc 大叔开发）。")]),n("p",null,[n("strong",null,[n("a",Ks,[s("GoClipse"),a(e)])]),s(" 是一款 Eclipse IDE 的插件，拥有非常多的特性以及通过 GoCode 来实现代码补全功能。")]),$s,Ys,Zs,Qs,n("p",null,[s("这款 IDE 的当前最新版本号为 X27，你可以从 "),n("a",na,[s("GitHub"),a(e)]),s(" 页面获取详情。")]),sa,aa,ea,ta,pa,n("p",null,[s("该款插件的当前最新版本号为 0.9.1，你可以从 "),n("a",oa,[s("GitHub"),a(e)]),s(" 页面获取详情。")]),ca,n("p",null,[s("如果想要了解有关 "),ia,s(" 的更多信息，请访问该页面："),n("a",la,[s("http://golang.org/cmd/gofmt/"),a(e)]),s("。")]),ua,da,n("p",null,[s("它也可以作为一个提供在线文档浏览的 web 服务器，"),n("a",ra,[s("http://golang.org"),a(e)]),s(" 就是通过这种形式实现的。")]),ka,n("p",null,[s("这个工具只能获取在 Go 安装目录下 "),va,s(" 中的注释内容。此外，它还可以作为一个本地文档浏览 web 服务器。在命令行输入 "),ma,s("，然后使用浏览器打开 "),n("a",ba,[s("http://localhost:6060"),a(e)]),s(" 后，你就可以看到本地文档浏览服务器提供的页面。")]),ga,n("p",null,[s("如果想要获取更多有关 "),fa,s(" 的信息，请访问该页面："),n("a",ha,[s("http://golang.org/cmd/godoc/"),a(e)]),s("（在线版的第三方包 godoc 可以使用 "),n("a",ya,[s("Go Walker"),a(e)]),s("）。")]),wa,n("p",null,[s("时下流行的语言大都是运行在虚拟机上，如：Java 和 Scala 使用的 JVM，C# 和 "),n("a",qa,[s("VB.NET"),a(e)]),s(" 使用的 .NET CLR。尽管虚拟机的性能已经有了很大的提升，但任何使用 JIT 编译器和脚本语言解释器的编程语言（Ruby、Python、Perl 和 JavaScript）在 C 和 C++ 的绝对优势下甚至都无法在性能上望其项背。")]),_a,n("p",null,[s("其实比较多门语言之间的性能是一种非常猥琐的行为，因为任何一种语言都有其所擅长和薄弱的方面。例如在处理文本方面，那些只处理纯字节的语言显然要比处理 Unicode 这种更为复杂编码的语言要出色的多。有些人可能认为使用两种不同的语言实现同一个目标能够得出正确的结论，但是很多时候测试者可能对一门语言非常了解而对另一门语言只是大概明白，测试者对程序编写的手法在一定程度也会影响结果的公平性，因此测试程序应该分别由各自语言的擅长者来编写，这样才能得到具有可比性的结果。另外，像在统计学方面，人们很难避免人为因素对结果的影响，所以这在严格意义上并不是科学。还要注意的是，测试结果的可比性还要根据测试目标来区别，例如很多发展十多年的语言已经针对各类问题拥有非常成熟的类库，而作为一门新生语言的 Go 语言，并没有足够的时间来推导各类问题的最佳解决方案。如果你想获取更多有关性能的资料，请访问 "),n("a",xa,[s("Computer Language Benchmark Game"),a(e)]),s("（详见引用 27）。")]),Ga,n("ul",null,[n("li",null,[Pa,n("p",null,[s("原生的 Go http 包要比 "),n("a",Sa,[s("web.py"),a(e)]),s(" 快 7 至 8 倍，如果使用 web.go 框架则稍微差点，比 "),n("a",Ta,[s("web.py"),a(e)]),s(" 快 6 至 7 倍。在 Python 中被广泛使用的 tornado 异步服务器和框架在 web 环境下要比 "),n("a",Ca,[s("web.py"),a(e)]),s(" 快很多，Go 大概只比它快 1.2 至 1.5 倍（详见引用 26）。")])]),Aa,Oa]),Ia,Fa,n("p",null,[s("工具 cgo 提供了对 FFI（外部函数接口）的支持，能够使用 Go 代码安全地调用 C 语言库，你可以访问 cgo 文档主页："),n("a",Na,[s("http://golang.org/cmd/cgo"),a(e)]),s("。cgo 会替代 Go 编译器来产生可以组合在同一个包中的 Go 和 C 代码。在实际开发中一般使用 cgo 创建单独的 C 代码包。")]),Ea,n("p",null,[n("em",null,[s("引用："),n("a",Ra,[s("Go programs cannot use relative import paths within a work space."),a(e)])])]),Ma,n("p",null,[s("首先，它是为了避免像 C 语言中那样含糊不清的声明形式，例如："),La,s("。在这个例子中，只有 "),Ba,s(" 是指针而 "),Wa,s(" 不是。如果你想要这两个变量都是指针，则需要将它们分开书写（你可以在 "),n("a",Da,[s("Go 语言的声明语法"),a(e)]),s(" 页面找到有关于这个话题的更多讨论）。")]),Ua,n("p",null,[s("Go 语言支持整型和浮点型数字，并且原生支持复数，其中位的运算采用补码（详情参见 "),n("a",ja,[s("二的补码"),a(e)]),s(" 页面）。")]),Va,Ha,za,n("p",null,[s("其它有关字符串操作的文档请参阅 "),n("a",Ja,[s("官方文档"),a(e)]),s("（ "),n("strong",null,[s("译者注：国内用户可访问 "),n("a",Xa,[s("该页面"),a(e)])]),s(" ）。")]),Ka,n("p",null,[s("更多有关该包的讨论，请参阅 "),n("a",$a,[s("官方文档"),a(e)]),s("（ "),n("strong",null,[s("译者注：国内用户可访问 "),n("a",Ya,[s("该页面"),a(e)])]),s(" ）。")]),Za,n("p",null,[s("其它有关时间操作的文档请参阅 "),n("a",Qa,[s("官方文档"),a(e)]),s("（ "),n("strong",null,[s("译者注：国内用户可访问 "),n("a",ne,[s("该页面"),a(e)])]),s(" ）。")]),se,n("p",null,[s("所以说，Go 语言和 C、C++ 以及 D 语言这些低级（系统）语言一样，都有指针的概念。但是对于经常导致 C 语言内存泄漏继而程序崩溃的指针运算（所谓的指针算法，如："),ae,s("，移动指针指向字符串的字节数或数组的某个位置）是不被允许的。Go 语言中的指针保证了内存安全，更像是 Java、C# 和 "),n("a",ee,[s("VB.NET"),a(e)]),s(" 中的引用。")]),te,n("p",null,[s("在使用递归函数时经常会遇到的一个重要问题就是栈溢出：一般出现在大量的递归调用导致的程序栈内存分配耗尽。这个问题可以通过一个名为 "),n("a",pe,[s("懒惰求值"),a(e)]),s(" 的技术解决，在 Go 语言中，我们可以使用管道 (channel) 和 goroutine（详见"),oe,s("）来实现。"),ce,s(" 也会通过这个方案来优化斐波那契数列的生成问题。")]),ie,n("p",null,[s("您可以通过查看 "),n("a",le,[s("官方文档"),a(e)]),s(" 来获取更详细的信息。")]),ue,n("p",null,[s("如果您需要更加完整的方案，可以学习一下 Eleanor McHugh 编写的几个包："),n("a",de,[re,a(e)]),s("、"),n("a",ke,[ve,a(e)]),s(" 和 "),n("a",me,[be,a(e)]),s("。")]),ge,n("p",null,[s("编写一个程序，使用冒泡排序的方法排序一个包含整数的切片（算法的定义可参考 "),n("a",fe,[s("维基百科"),a(e)]),s("）。")]),he,n("p",null,[s("像 "),ye,s("、"),we,s(" 等这样具有常用功能的内置包在 Go 语言中有 150 个以上，它们被称为标准库，大部分(一些底层的除外)内置于 Go 本身。完整列表可以在 "),n("a",qe,[s("Go Walker"),a(e)]),s(" 查看。")]),_e,n("p",null,[s("正则表达式语法和使用的详细信息请参考 "),n("a",xe,[s("维基百科"),a(e)]),s("。")]),Ge,n("ul",null,[n("li",null,[s("在浏览器打开地址："),n("a",Pe,[s("http://localhost:6060"),a(e)])])]),Se,n("p",null,[s("假设我们要安装一个有趣的包 "),Te,s("（它包含了许多帮助示例，参见"),n("a",Ce,[s("项目主页"),a(e)]),s("）。")]),Ae,n("p",null,[s("更多信息可以在 "),n("a",Oe,[s("官方网站"),a(e)]),s(" 找到。")]),Ie,n("p",null,[s("在 Linux 和 OS X 的机器上 Git 是默认安装的，在 Windows 上你必须先自行安装，参见 "),n("a",Fe,[s("GitHub 帮助页面"),a(e)]),s("。")]),Ne,n("p",null,[s("每一个 Git 项目都需要一个对包进行描述的 "),n("a",Ee,[s("README.md"),a(e)]),s(" 文件，所以需要打开你的文本编辑器（gedit、notepad 或 LiteIde）并添加一些说明进去。")]),Re,n("p",null,[s("现在必须登录 "),n("a",Me,[s("GitHub 网站"),a(e)]),s("。")]),n("p",null,[s("如果您还没有账号，可以去注册一个开源项目的免费帐号。输入正确的帐号密码和有效的邮箱地址并进一步创建用户。然后你将获得一个 Git 命令的列表。本地仓库的操作命令已经完成。一个优秀的系统在你遇到任何问题的时候将 "),n("a",Le,[s("引导你"),a(e)]),s("。")]),Be,n("p",null,[n("a",We,[s("Go Walker"),a(e)]),s(" 支持根据包名在海量数据中查询。")]),De,n("p",null,[s("作为一个例子，我们将使用谷歌的 API 的 urlshortener 编写一个小程序：你可以尝试一下在 "),n("a",Ue,[s("http://goo.gl/"),a(e)]),s(' 输入一个像 "'),n("a",je,[s("http://www.destandaard.be"),a(e)]),s('" 这样的 URL，你会看到一个像 "'),n("a",Ve,[s("http://goo.gl/O9SUO"),a(e)]),s('" 这样更短的 URL 返回，也就是说，在 Twitter 之类的服务中这是非常容易嵌入的。谷歌 urlshortener 服务的文档可以在 "'),n("a",He,[s("http://code.google.com/apis/urlshortener/"),a(e)]),s('" 找到。('),ze,s("，我们将开发自己版本的 urlshortener)。")]),Je,n("p",null,[s("备注：谷歌让通过使用 Google API Go 客户端服务的开发者生活变得更简单，Go 客户端程序自动生成于 Google 库的 JSON 描述。更多详情在 "),n("a",Xe,[s("项目页面"),a(e)]),s(" 查看。")]),Ke,n("p",null,[s("在浏览器打开你的 Web应用："),n("a",$e,[s("http://localhost:8080"),a(e)]),s("。")]),Ye,n("p",null,[s("如果真的需要更多面向对象的能力，看一下 "),n("a",Ze,[Qe,a(e)]),s(" 包 (Go Object-Oriented Programming)，它由 Scott Pakin 编写: 它给 Go 提供了 JavaScript 风格的对象（基于原型的对象），并且支持多重继承和类型独立分派，通过它可以实现你喜欢的其他编程语言里的一些结构。")]),nt,n("p",null,[s("上面的程序会给出已分配内存的总量，单位是 Kb。进一步的测量参考 "),n("a",st,[s("文档页面"),a(e)]),s("。")]),at,n("p",null,[s("原因是它们俩在内存中的布局是不一样的（参考 "),n("a",et,[s("Go wiki"),a(e)]),s("）。")]),tt,n("p",null,[s("关于解析 CSV 文件，"),pt,s(" 包提供了相应的功能。具体请参考 "),n("a",ot,[s("http://golang.org/pkg/encoding/csv/"),a(e)]),s(" 。")]),ct,n("p",null,[s("我们都比较熟悉 XML 格式(参阅 "),it,s(")；但有些时候 JSON（JavaScript Object Notation，参阅 "),n("a",lt,[s("http://json.org"),a(e)]),s("）被作为首选，主要是由于其格式上非常简洁。通常 JSON 被用于 web 后端和浏览器之间的通讯，但是在其它场景也同样的有用。")]),ut,n("p",null,[s("log 包用那些方法 (methods) 定义了一个 "),dt,s(" 接口类型，如果你想自定义日志系统的话可以参考 "),n("a",rt,[s("http://golang.org/pkg/log/#Logger"),a(e)]),s(" 。")]),kt,n("p",null,[s("gopprof 程序是 Google pprofC++ 分析器的一个轻微变种；关于此工具更多的信息，参见"),n("a",vt,[s("https://github.com/gperftools/gperftools"),a(e)]),s(" 。")]),mt])}const yt=i(W,[["render",bt],["__file","Go入门指南.html.vue"]]);export{yt as default};
